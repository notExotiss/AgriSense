(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[26],{116:function(e,i,l){"use strict";l.d(i,{Z:function(){return t}});let t=(0,l(1373).Z)("triangle-alert",[["path",{d:"m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3",key:"wmoenq"}],["path",{d:"M12 9v4",key:"juzpu7"}],["path",{d:"M12 17h.01",key:"p32p05"}]])},528:function(e,i,l){(window.__NEXT_P=window.__NEXT_P||[]).push(["/dashboard",function(){return l(535)}])},2355:function(e,i,l){"use strict";l.d(i,{q:function(){return n},x:function(){return a}});var t=l(2370);async function n(e){if(e.currentUser)return e.currentUser;let i=new t.hJ;i.setCustomParameters({prompt:"select_account"}),await (0,t.Fb)(e,t.a$).catch(()=>{});try{return(await (0,t.rh)(e,i)).user}catch(n){var l;if("auth/popup-blocked"===(l=String((null==n?void 0:n.code)||""))||"auth/popup-closed-by-user"===l||"auth/cancelled-popup-request"===l||"auth/operation-not-supported-in-this-environment"===l)return await (0,t.F6)(e,i),null;throw n}}function a(e){let i=String((null==e?void 0:e.code)||"");return"auth/unauthorized-domain"===i?"Google sign-in failed: add this app domain to Firebase Auth Authorized domains.":"auth/configuration-not-found"===i?"Google sign-in failed: enable Google provider in Firebase Auth.":"auth/operation-not-allowed"===i?"Google sign-in failed: Google provider is disabled in Firebase Auth.":"auth/network-request-failed"===i?"Google sign-in failed due to a network error. Try again.":(null==e?void 0:e.message)||"Google sign-in failed."}},8625:function(e,i,l){"use strict";l.d(i,{a8:function(){return a},dL:function(){return r}});var t=l(8098);function n(e,i){if(!e.length)return Number.NaN;if(1===e.length)return e[0];let l=(0,t.uZ)(i,0,1)*(e.length-1),n=Math.floor(l),a=Math.ceil(l);return n===a?e[n]:(0,t.t7)(e[n],e[a],l-n)}function a(e){let{metric:i,grid:l,outputWidth:a=l.width,outputHeight:r=l.height,contours:o=!1}=e;if("undefined"==typeof document)throw Error("metric_canvas_requires_dom");if(!l||!l.width||!l.height||!l.values||l.values.length<l.width*l.height)throw Error("metric_grid_missing");let s=function(e,i,l){let t=Number.POSITIVE_INFINITY,n=Number.NEGATIVE_INFINITY;for(let i=0;i<e.length;i++){let l=Number(e[i]);Number.isFinite(l)&&(l<t&&(t=l),l>n&&(n=l))}let a=Number.isFinite(i)&&Number.isFinite(l)&&Number(l)>Number(i),r=a?Number(i):t,o=a?Number(l):n;return Number.isFinite(r)&&Number.isFinite(o)&&!(o<=r)||(r=0,o=1),{min:r,max:o,range:Math.max(1e-6,o-r)}}(l.values,l.min,l.max),{min:d,max:c,range:u}=function(e,i,l,a){let r=Math.max(1,Math.floor(e.length/8192)),o=[];for(let l=0;l<e.length;l+=r){if(i&&0>=Number(i[l]))continue;let t=Number(e[l]);Number.isFinite(t)&&o.push(t)}if(o.length<64)return{min:l,max:a,range:Math.max(1e-6,a-l)};o.sort((e,i)=>e-i);let s=n(o,.1),d=n(o,.9);if(!Number.isFinite(s)||!Number.isFinite(d)||d<=s)return{min:l,max:a,range:Math.max(1e-6,a-l)};let c=Math.max(1e-6,a-l),u=(0,t.t7)(l,s,.42),v=(0,t.t7)(a,d,.42);return Number.isFinite(u)&&Number.isFinite(v)&&!(v-u<.22*c)?{min:u,max:v,range:Math.max(1e-6,v-u)}:{min:l,max:a,range:c}}(l.values,l.validMask,s.min,s.max),v=Math.max(1,Math.floor(a)),m=Math.max(1,Math.floor(r)),x=document.createElement("canvas");x.width=v,x.height=m;let h=x.getContext("2d");if(!h)throw Error("metric_canvas_context_failed");let p=h.createImageData(v,m),b=p.data;for(let e=0;e<m;e++)for(let n=0;n<v;n++){let a=4*(e*v+n),r=n/Math.max(1,v-1)*(l.width-1),s=e/Math.max(1,m-1)*(l.height-1),c=function(e,i,l,n,a,r){let o=(0,t.uZ)(n,0,i-1),s=(0,t.uZ)(a,0,l-1),d=Math.floor(o),c=Math.floor(s),u=Math.min(i-1,d+1),v=Math.min(l-1,c+1),m=o-d,x=s-c,h=0,p=0;for(let l of[{idx:c*i+d,weight:(1-m)*(1-x)},{idx:c*i+u,weight:m*(1-x)},{idx:v*i+d,weight:(1-m)*x},{idx:v*i+u,weight:m*x}]){if(!(!r||Number(r[l.idx])>0))continue;let i=Number(e[l.idx]);Number.isFinite(i)&&(h+=i*l.weight,p+=l.weight)}return p<=1e-9?Number.NaN:h/p}(l.values,l.width,l.height,r,s,l.validMask);if(!Number.isFinite(c)){b[a]=0,b[a+1]=0,b[a+2]=0,b[a+3]=0;continue}let x=(0,t.uZ)((c-d)/u,0,1),[h,p,g]=(0,t.TU)(i,x),f=h,y=p,N=g;if(o){let e=16*x,i=Math.abs(e-Math.round(e));if(i<.014){let e=i<.006?.22:.12;f=Math.round((0,t.t7)(f,26,e)),y=Math.round((0,t.t7)(y,40,e)),N=Math.round((0,t.t7)(N,64,e))}}b[a]=f,b[a+1]=y,b[a+2]=N,b[a+3]=255}return h.putImageData(p,0,0),{canvas:x,range:{min:d,max:c}}}function r(e){return e.toDataURL("image/png").replace(/^data:image\/png;base64,/,"")}},8098:function(e,i,l){"use strict";l.d(i,{CS:function(){return t},G5:function(){return o},TU:function(){return r},t7:function(){return a},uZ:function(){return n}});let t={ndvi:[{stop:0,color:[93,123,223]},{stop:.16,color:[110,177,236]},{stop:.32,color:[106,219,226]},{stop:.5,color:[129,216,156]},{stop:.68,color:[232,220,124]},{stop:.84,color:[242,176,114]},{stop:1,color:[226,126,134]}],soil:[{stop:0,color:[106,128,214]},{stop:.2,color:[122,182,232]},{stop:.4,color:[121,219,196]},{stop:.58,color:[152,214,149]},{stop:.76,color:[236,204,126]},{stop:1,color:[214,139,102]}],et:[{stop:0,color:[98,120,218]},{stop:.2,color:[109,165,232]},{stop:.4,color:[114,217,223]},{stop:.6,color:[146,214,149]},{stop:.78,color:[241,197,116]},{stop:1,color:[226,126,110]}]};function n(e,i,l){return Math.max(i,Math.min(l,e))}function a(e,i,l){return e+(i-e)*l}function r(e,i){let l=t[e],a=n(i,0,1);for(let e=0;e<l.length-1;e++){let i=l[e],t=l[e+1];if(a<=t.stop){var r,o,s;let e=(a-i.stop)/Math.max(1e-6,t.stop-i.stop);return[Math.round((r=i.color[0])+(t.color[0]-r)*e),Math.round((o=i.color[1])+(t.color[1]-o)*e),Math.round((s=i.color[2])+(t.color[2]-s)*e)]}}return l[l.length-1].color}function o(e){return"linear-gradient(90deg, ".concat(t[e].map(e=>"rgb(".concat(e.color[0],", ").concat(e.color[1],", ").concat(e.color[2],") ").concat(Math.round(100*e.stop),"%")).join(", "),")")}},535:function(e,i,l){"use strict";l.r(i),l.d(i,{default:function(){return Q}});var t=l(5893),n=l(7294),a=l(5152),r=l.n(a),o=l(6316),s=l(1373);let d=(0,s.Z)("activity",[["path",{d:"M22 12h-2.48a2 2 0 0 0-1.93 1.46l-2.35 8.36a.25.25 0 0 1-.48 0L9.24 2.18a.25.25 0 0 0-.48 0l-2.35 8.36A2 2 0 0 1 4.49 12H2",key:"169zse"}]]),c=(0,s.Z)("save",[["path",{d:"M15.2 3a2 2 0 0 1 1.4.6l3.8 3.8a2 2 0 0 1 .6 1.4V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z",key:"1c8476"}],["path",{d:"M17 21v-7a1 1 0 0 0-1-1H8a1 1 0 0 0-1 1v7",key:"1ydtos"}],["path",{d:"M7 3v4a1 1 0 0 0 1 1h7",key:"t51u73"}]]),u=(0,s.Z)("database",[["ellipse",{cx:"12",cy:"5",rx:"9",ry:"3",key:"msslwz"}],["path",{d:"M3 5V19A9 3 0 0 0 21 19V5",key:"1wlel7"}],["path",{d:"M3 12A9 3 0 0 0 21 12",key:"mv7ke4"}]]),v=(0,s.Z)("shield-check",[["path",{d:"M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z",key:"oel41y"}],["path",{d:"m9 12 2 2 4-4",key:"dzmm74"}]]);var m=l(116);let x=(0,s.Z)("leaf",[["path",{d:"M11 20A7 7 0 0 1 9.8 6.1C15.5 5 17 4.48 19 2c1 2 2 4.18 2 8 0 5.5-4.78 10-10 10Z",key:"nnexq3"}],["path",{d:"M2 21c0-3 1.85-5.36 5.08-6C9.5 14.52 12 13 13 12",key:"mt58a7"}]]),h=(0,s.Z)("droplets",[["path",{d:"M7 16.3c2.2 0 4-1.83 4-4.05 0-1.16-.57-2.26-1.71-3.19S7.29 6.75 7 5.3c-.29 1.45-1.14 2.84-2.29 3.76S3 11.1 3 12.25c0 2.22 1.8 4.05 4 4.05z",key:"1ptgy4"}],["path",{d:"M12.56 6.6A10.97 10.97 0 0 0 14 3.02c.5 2.5 2 4.9 4 6.5s3 3.5 3 5.5a6.98 6.98 0 0 1-11.91 4.97",key:"1sl1rz"}]]),p=(0,s.Z)("waves",[["path",{d:"M2 6c.6.5 1.2 1 2.5 1C7 7 7 5 9.5 5c2.6 0 2.4 2 5 2 2.5 0 2.5-2 5-2 1.3 0 1.9.5 2.5 1",key:"knzxuh"}],["path",{d:"M2 12c.6.5 1.2 1 2.5 1 2.5 0 2.5-2 5-2 2.6 0 2.4 2 5 2 2.5 0 2.5-2 5-2 1.3 0 1.9.5 2.5 1",key:"2jd2cc"}],["path",{d:"M2 18c.6.5 1.2 1 2.5 1 2.5 0 2.5-2 5-2 2.6 0 2.4 2 5 2 2.5 0 2.5-2 5-2 1.3 0 1.9.5 2.5 1",key:"rd2r6e"}]]),b=(0,s.Z)("cloud",[["path",{d:"M17.5 19H9a7 7 0 1 1 6.71-9h1.79a4.5 4.5 0 1 1 0 9Z",key:"p7xjir"}]]);var g=l(9448),f=l(4712),y=l(3945);let N=(0,s.Z)("message-circle",[["path",{d:"M2.992 16.342a2 2 0 0 1 .094 1.167l-1.065 3.29a1 1 0 0 0 1.236 1.168l3.413-.998a2 2 0 0 1 1.099.092 10 10 0 1 0-4.777-4.719",key:"1sd12s"}]]),w=(0,s.Z)("send",[["path",{d:"M14.536 21.686a.5.5 0 0 0 .937-.024l6.5-19a.496.496 0 0 0-.635-.635l-19 6.5a.5.5 0 0 0-.024.937l7.93 3.18a2 2 0 0 1 1.112 1.11z",key:"1ffxy3"}],["path",{d:"m21.854 2.147-10.94 10.939",key:"12cjpa"}]]);function j(e){let i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,l=Number(e);return Number.isFinite(l)?l:i}function z(e){return e&&"object"==typeof e?{min:j(e.min),max:j(e.max),mean:j(e.mean)}:null}function S(e){let{context:i,objective:l="balanced"}=e,[a,r]=(0,n.useState)(!1),[s,d]=(0,n.useState)(""),[c,u]=(0,n.useState)([]),[v,x]=(0,n.useState)("idle"),[h,p]=(0,n.useState)("unavailable"),[b,g]=(0,n.useState)(null),[f,y]=(0,n.useState)({model:null,retries:0,degraded:!1,attempted:[]}),S=(0,n.useRef)(null),k=(0,n.useMemo)(()=>!!((null==i?void 0:i.ndviStats)||(null==i?void 0:i.weather)||(null==i?void 0:i.timeSeries)),[i]);async function M(e,t){let n=(e||s).trim();if(n){u(e=>[...e,{role:"user",text:n}]),e||d(""),x("loading");try{let e=function(e){var i,l,t,n,a,r,o,s,d,c,u,v,m,x,h,p,b,g,f,y,N,w,S,k,M,A,C,F,I,T,P,D,E,O,R,G,_,L,Z,V;let W=e||{};return{ndviStats:z(W.ndviStats),soilStats:z(W.soilStats),etStats:z(W.etStats),weather:{source:(null==W?void 0:null===(i=W.weather)||void 0===i?void 0:i.source)||(null==W?void 0:null===(t=W.weather)||void 0===t?void 0:null===(l=t.data)||void 0===l?void 0:l.source)||void 0,isSimulated:!!(null==W?void 0:null===(n=W.weather)||void 0===n?void 0:n.isSimulated),current:{temperature:j(null!==(_=null==W?void 0:null===(o=W.weather)||void 0===o?void 0:null===(r=o.data)||void 0===r?void 0:null===(a=r.current)||void 0===a?void 0:a.temperature)&&void 0!==_?_:null==W?void 0:null===(d=W.weather)||void 0===d?void 0:null===(s=d.current)||void 0===s?void 0:s.temperature),humidity:j(null!==(L=null==W?void 0:null===(v=W.weather)||void 0===v?void 0:null===(u=v.data)||void 0===u?void 0:null===(c=u.current)||void 0===c?void 0:c.humidity)&&void 0!==L?L:null==W?void 0:null===(x=W.weather)||void 0===x?void 0:null===(m=x.current)||void 0===m?void 0:m.humidity),precipitation:j(null!==(Z=null==W?void 0:null===(b=W.weather)||void 0===b?void 0:null===(p=b.data)||void 0===p?void 0:null===(h=p.current)||void 0===h?void 0:h.precipitation)&&void 0!==Z?Z:null==W?void 0:null===(f=W.weather)||void 0===f?void 0:null===(g=f.current)||void 0===g?void 0:g.precipitation),windSpeed:j(null!==(V=null==W?void 0:null===(w=W.weather)||void 0===w?void 0:null===(N=w.data)||void 0===N?void 0:null===(y=N.current)||void 0===y?void 0:y.windSpeed)&&void 0!==V?V:null==W?void 0:null===(k=W.weather)||void 0===k?void 0:null===(S=k.current)||void 0===S?void 0:S.windSpeed)}},timeSeries:{source:(null==W?void 0:null===(M=W.timeSeries)||void 0===M?void 0:M.source)||(null==W?void 0:null===(C=W.timeSeries)||void 0===C?void 0:null===(A=C.data)||void 0===A?void 0:A.source)||void 0,isSimulated:!!(null==W?void 0:null===(F=W.timeSeries)||void 0===F?void 0:F.isSimulated),summary:(null==W?void 0:null===(T=W.timeSeries)||void 0===T?void 0:null===(I=T.data)||void 0===I?void 0:I.summary)||(null==W?void 0:null===(P=W.timeSeries)||void 0===P?void 0:P.summary)||null},inference:{confidence:j(null==W?void 0:null===(D=W.inference)||void 0===D?void 0:D.confidence),anomalyLevel:(null==W?void 0:null===(O=W.inference)||void 0===O?void 0:null===(E=O.anomaly)||void 0===E?void 0:E.level)||null,trend:(null==W?void 0:null===(G=W.inference)||void 0===G?void 0:null===(R=G.forecast)||void 0===R?void 0:R.trend)||null},grid3x3:Array.isArray(null==W?void 0:W.grid3x3)?W.grid3x3.slice(0,9):[],selectedCell:"string"==typeof(null==W?void 0:W.selectedCell)?W.selectedCell:null,warnings:Array.isArray(null==W?void 0:W.warnings)?W.warnings.slice(0,8):[],providersTried:Array.isArray(null==W?void 0:W.providersTried)?W.providersTried.slice(0,8).map(e=>({provider:null==e?void 0:e.provider,ok:!!(null==e?void 0:e.ok),reason:(null==e?void 0:e.reason)||void 0})):[]}}(i),a={prompt:n,context:e,objective:l,analysisType:"chat",mode:t,history:c.slice(-8).map(e=>({role:e.role,text:e.text}))};JSON.stringify(a).length>12e4&&(a={...a,context:{...e,providersTried:[],warnings:[]}});let r=await fetch("/api/gemini",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)}),o=await r.json().catch(()=>({}));if(!r.ok){let e=String((null==o?void 0:o.error)||r.statusText||"analysis_failed"),i=(null==o?void 0:o.message)||"Analysis unavailable right now.";x(e.includes("provider")?"provider-outage":"partial-data"),u(e=>[...e,{role:"assistant",text:i}]);return}let s=function(e){let i=String(e||"").trim();if(!i)return"";let l=i.match(/```(?:json)?\s*([\s\S]*?)```/i);(null==l?void 0:l[1])&&(i=l[1].trim());try{let e=JSON.parse(i);if("string"==typeof e)return e.trim();if(e&&"object"==typeof e){let i=e.answer||e.response||e.text;if("string"==typeof i&&i.trim())return i.trim()}}catch(l){let e=i.match(/"answer"\s*:\s*"([\s\S]*?)"/i);(null==e?void 0:e[1])&&(i=e[1].replace(/\\n/g,"\n").trim())}return i.replace(/^["'`{[]+/,"").replace(/["'`\]}]+$/,"").trim()}((null==o?void 0:o.answer)||(null==o?void 0:o.suggestion)||(null==o?void 0:o.output))||"No recommendation generated.",d=(null==o?void 0:o.assistantBackend)==="llm-gemini"?"llm-gemini":"unavailable",v=!!(null==o?void 0:o.unavailable)||"unavailable"===d;p(d);let m=Array.isArray(null==o?void 0:o.warnings)&&o.warnings.length>0?String(o.warnings[0]):null;g(m),y({model:"string"==typeof(null==o?void 0:o.llmFinalModel)?o.llmFinalModel:null,retries:Number((null==o?void 0:o.llmRetries)||0),degraded:!!(null==o?void 0:o.llmDegraded),attempted:Array.isArray(null==o?void 0:o.llmAttemptedModels)?o.llmAttemptedModels.slice(0,4):[]});let h={sections:(null==o?void 0:o.sections)||void 0,evidence:Array.isArray(null==o?void 0:o.evidence)?o.evidence.slice(0,5):[],tasks:Array.isArray(null==o?void 0:o.tasks)?o.tasks.slice(0,4):[],renderModel:null==o?void 0:o.renderModel},b=!!(null==o?void 0:o.isSimulatedInputs);x(v?"unavailable":b?"partial-data":"idle"),u(e=>[...e,{role:"assistant",text:s,detail:h}])}catch(e){p("unavailable"),g("network_unreachable"),x("unavailable"),u(e=>[...e,{role:"assistant",text:"Gemini could not be reached right now. Retry in a few seconds."}])}}}return(0,n.useEffect)(()=>{var e;null===(e=S.current)||void 0===e||e.scrollTo({top:1e7,behavior:"smooth"})},[c,v]),(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)("button",{onClick:()=>r(e=>!e),className:"fixed bottom-5 right-5 z-50 flex h-14 w-14 items-center justify-center rounded-2xl border border-zinc-700/20 bg-zinc-950 text-zinc-50 shadow-lg shadow-black/25","aria-label":"Open AI Assistant",children:(0,t.jsx)(N,{className:"h-6 w-6"})}),a&&(0,t.jsxs)("section",{className:"liquid-glass fixed bottom-24 right-5 z-50 w-[min(96vw,25rem)] overflow-hidden rounded-2xl border border-zinc-200 bg-white shadow-2xl shadow-black/15",children:[(0,t.jsxs)("header",{className:"border-b border-zinc-200 bg-zinc-950 px-4 py-3 text-zinc-50",children:[(0,t.jsxs)("div",{className:"flex items-center justify-between gap-3",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)("p",{className:"text-sm font-semibold tracking-wide",children:"AI Assistant"}),(0,t.jsx)("p",{className:"text-xs text-zinc-300",children:"Question-first agronomy guidance"})]}),(0,t.jsxs)("div",{className:"flex items-center gap-1",children:[(0,t.jsx)("span",{className:"rounded-full border border-zinc-600 px-2 py-0.5 text-[11px]",children:"llm-gemini"===h?"Gemini online":"Gemini unavailable"}),(0,t.jsx)("span",{className:"rounded-full border border-zinc-600 px-2 py-0.5 text-[11px]",children:"loading"===v?"Analyzing":"partial-data"===v?"Partial data":"provider-outage"===v?"Provider outage":"unavailable"===v?"Gemini unavailable":"offline"===v?"Offline fallback":"Ready"})]})]}),(0,t.jsxs)("p",{className:"mt-2 text-[11px] text-zinc-300",children:[f.model?"Model: ".concat(f.model):"Model: n/a",f.attempted.length>0?" | attempted: ".concat(f.attempted.join(", ")):"",f.retries>0?" | retries ".concat(f.retries):"",f.degraded?" | degraded":""]}),b&&"llm-gemini"!==h&&(0,t.jsxs)("p",{className:"mt-1 text-[11px] text-amber-300",children:["Reason: ",b]})]}),(0,t.jsxs)("div",{ref:S,className:"max-h-80 space-y-3 overflow-auto bg-zinc-50 px-4 py-4 text-sm",children:[!c.length&&(0,t.jsx)("div",{className:"rounded-xl border border-dashed border-zinc-300 bg-white p-3 text-zinc-600",children:k?"Ask direct questions like: Why is P5 stressed? What should I do tomorrow?":"Run an analysis first to provide data-aware recommendations."}),(0,t.jsxs)("div",{className:"flex flex-wrap gap-2",children:[(0,t.jsx)("button",{onClick:()=>void M("Why is this selected plot point stressed right now?","stress-debug"),className:"rounded-full border border-zinc-300 bg-white px-2 py-1 text-[11px] text-zinc-700 hover:bg-zinc-100",children:"Explain anomaly"}),(0,t.jsx)("button",{onClick:()=>void M("Give me a water-saving plan for tomorrow.","irrigation-plan"),className:"rounded-full border border-zinc-300 bg-white px-2 py-1 text-[11px] text-zinc-700 hover:bg-zinc-100",children:"Water-saving plan"}),(0,t.jsx)("button",{onClick:()=>void M("What should I do next to protect yield?","next-actions"),className:"rounded-full border border-zinc-300 bg-white px-2 py-1 text-[11px] text-zinc-700 hover:bg-zinc-100",children:"Yield-priority plan"}),(0,t.jsx)("button",{onClick:()=>void M("Run through a what-if setup for irrigation and risk.","what-if-explainer"),className:"rounded-full border border-zinc-300 bg-white px-2 py-1 text-[11px] text-zinc-700 hover:bg-zinc-100",children:"Run what-if"})]}),c.map((e,i)=>{var l,n,a,r,o,s;let d="assistant"===e.role?function(e){var i,l;let t=[...Array.isArray(null==e?void 0:null===(i=e.sections)||void 0===i?void 0:i.actions)&&(null==e?void 0:null===(l=e.sections)||void 0===l?void 0:l.actions)||[],...Array.isArray(null==e?void 0:e.tasks)?e.tasks.map(e=>"string"==typeof e?e:(null==e?void 0:e.title)||"").filter(Boolean):[]],n=new Set,a=[];for(let e of t){let i=e.trim().toLowerCase();if(!(!i||n.has(i))&&(n.add(i),a.push(e.trim()),a.length>=4))break}return a}(e.detail):[],c="assistant"===e.role&&Array.isArray(null===(l=e.detail)||void 0===l?void 0:l.evidence)&&(null===(n=e.detail)||void 0===n?void 0:n.evidence)||[];return(0,t.jsxs)("div",{className:"user"===e.role?"ml-auto w-fit max-w-[85%] rounded-2xl rounded-br-sm bg-emerald-900 px-3 py-2 text-emerald-50":"w-fit max-w-[92%] rounded-2xl rounded-bl-sm border border-zinc-200 bg-white px-3 py-2 text-zinc-800",children:[(0,t.jsx)("p",{className:"assistant"===e.role?"whitespace-pre-wrap":"",children:e.text}),"assistant"===e.role&&(null===(r=e.detail)||void 0===r?void 0:null===(a=r.sections)||void 0===a?void 0:a.rationale)&&(0,t.jsxs)("p",{className:"mt-2 text-xs text-zinc-600",children:[(0,t.jsx)("span",{className:"font-semibold text-zinc-700",children:"Why:"})," ",e.detail.sections.rationale]}),"assistant"===e.role&&(null===(s=e.detail)||void 0===s?void 0:null===(o=s.sections)||void 0===o?void 0:o.forecast)&&(0,t.jsxs)("p",{className:"mt-2 text-xs text-zinc-600",children:[(0,t.jsx)("span",{className:"font-semibold text-zinc-700",children:"Forecast:"})," ",e.detail.sections.forecast]}),"assistant"===e.role&&d.length>0&&(0,t.jsxs)("div",{className:"mt-2",children:[(0,t.jsx)("p",{className:"text-xs font-semibold text-zinc-700",children:"Suggested actions"}),(0,t.jsx)("ul",{className:"mt-1 list-disc space-y-0.5 pl-4 text-xs text-zinc-600",children:d.map((e,i)=>(0,t.jsx)("li",{children:e},"".concat(i,"-").concat(e)))})]}),"assistant"===e.role&&c.length>0&&(0,t.jsxs)("div",{className:"mt-2",children:[(0,t.jsx)("p",{className:"text-xs font-semibold text-zinc-700",children:"Evidence"}),(0,t.jsx)("ul",{className:"mt-1 list-disc space-y-0.5 pl-4 text-xs text-zinc-600",children:c.map((e,i)=>(0,t.jsx)("li",{children:e},"".concat(i,"-").concat(e)))})]})]},"".concat(e.role,"-").concat(i))}),"loading"===v&&(0,t.jsxs)("div",{className:"inline-flex items-center gap-2 rounded-xl border border-zinc-200 bg-white px-3 py-2 text-zinc-600",children:[(0,t.jsx)(o.Z,{className:"h-4 w-4 animate-spin"}),"Building recommendation"]}),("partial-data"===v||"provider-outage"===v)&&(0,t.jsxs)("div",{className:"inline-flex items-center gap-2 rounded-xl border border-amber-200 bg-amber-50 px-3 py-2 text-amber-800",children:[(0,t.jsx)(m.Z,{className:"h-4 w-4"}),"Some providers are degraded. Guidance is conservative."]}),"unavailable"===v&&(0,t.jsxs)("div",{className:"inline-flex items-center gap-2 rounded-xl border border-rose-200 bg-rose-50 px-3 py-2 text-rose-800",children:[(0,t.jsx)(m.Z,{className:"h-4 w-4"}),"Gemini unavailable right now. Retry in a few seconds."]})]}),(0,t.jsx)("footer",{className:"border-t border-zinc-200 bg-white p-3",children:(0,t.jsxs)("div",{className:"flex items-end gap-2",children:[(0,t.jsx)("textarea",{value:s,onChange:e=>d(e.target.value),onKeyDown:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),M())},rows:2,placeholder:"Ask a direct field question...",className:"min-h-[2.5rem] flex-1 resize-none rounded-xl border border-zinc-300 px-3 py-2 text-sm outline-none transition focus:border-emerald-700 focus:ring-2 focus:ring-emerald-200"}),(0,t.jsx)("button",{onClick:()=>void M(),disabled:"loading"===v||!s.trim(),className:"inline-flex h-10 w-10 items-center justify-center rounded-xl bg-emerald-900 text-emerald-50 disabled:cursor-not-allowed disabled:bg-zinc-300","aria-label":"Send",children:(0,t.jsx)(w,{className:"h-4 w-4"})})]})})]})]})}var k=l(5133);function M(e,i){return i?"#22d3ee":"high"===e?"#dc2626":"moderate"===e?"#d97706":"low"===e?"#15803d":"#64748b"}function A(e){let i=3*e.row+e.col+1;return"P".concat(i)}function C(e){let{cells:i,cellFootprints:l,alignmentBbox:n,selectedCell:a,onSelectCell:r,visible:o=!0,frame:s}=e;if(!o)return null;let d=function(e){if(Array.isArray(e)&&e.length)return e;let i=[];for(let e=0;e<3;e++)for(let l=0;l<3;l++)i.push({cellId:"".concat(e,"-").concat(l),row:e,col:l,mean:0,min:0,max:0,validPixelRatio:0,stressLevel:"unknown"});return i}(i),c=Array.isArray(l)&&l.length>0&&!!n,u=s?{left:Math.max(0,Math.round(s.left)),top:Math.max(0,Math.round(s.top)),width:Math.max(1,Math.floor(s.width)),height:Math.max(1,Math.floor(s.height)),boxSizing:"border-box"}:{inset:0};return c?(0,t.jsx)("div",{className:"pointer-events-none absolute overflow-hidden",style:u,children:d.map(e=>{let i=a===e.cellId,o=M(e.stressLevel,i),s=null==l?void 0:l.find(i=>i.cellId===e.cellId),d=function(e,i){var l,t;if(!i)return null;let n=null==e?void 0:null===(t=e.polygon)||void 0===t?void 0:null===(l=t.coordinates)||void 0===l?void 0:l[0];if(!Array.isArray(n)||n.length<4)return null;let a=i[0],r=i[1],o=i[2],s=i[3],d=Math.max(1e-9,o-a),c=Math.max(1e-9,s-r),u=n.map(e=>{let i=Number(null==e?void 0:e[0]),l=Number(null==e?void 0:e[1]);return Number.isFinite(i)&&Number.isFinite(l)?"".concat(((i-a)/d*100).toFixed(4),"% ").concat(((s-l)/c*100).toFixed(4),"%"):null}).filter(e=>"string"==typeof e);return u.length>=4?"polygon(".concat(u.join(", "),")"):null}(s,n),c=function(e,i){var l,t;if(!i)return null;let n=null==e?void 0:null===(t=e.polygon)||void 0===t?void 0:null===(l=t.coordinates)||void 0===l?void 0:l[0];if(!Array.isArray(n)||n.length<4)return null;let a=i[0],r=i[1],o=i[2],s=i[3],d=0,c=0,u=0;for(let e of n){let i=Number(null==e?void 0:e[0]),l=Number(null==e?void 0:e[1]);Number.isFinite(i)&&Number.isFinite(l)&&(d+=i,c+=l,u+=1)}if(!u)return null;let v=d/u,m=c/u;return{left:"".concat(((v-a)/Math.max(1e-9,o-a)*100).toFixed(3),"%"),top:"".concat(((s-m)/Math.max(1e-9,s-r)*100).toFixed(3),"%")}}(s,n);return d?(0,t.jsx)("button",{type:"button",onClick:()=>null==r?void 0:r(e.cellId),className:"pointer-events-auto absolute inset-0 transition-colors",style:{clipPath:d,WebkitClipPath:d,border:"".concat(i?2:1,"px solid ").concat(i?"#67e8f9":o),backgroundColor:i?"".concat(o,"1f"):"transparent",boxShadow:i?"inset 0 0 0 1px rgba(254,240,138,0.92)":"inset 0 0 0 1px rgba(226,232,240,0.18)"},"aria-label":"Select plot point ".concat(A(e)),children:c&&(0,t.jsx)("span",{className:"absolute -translate-x-1/2 -translate-y-1/2 rounded bg-black/55 px-1.5 py-0.5 text-[10px] text-white",style:{left:c.left,top:c.top},children:A(e)})},"grid-image-poly-".concat(e.cellId)):null})}):(0,t.jsx)("div",{className:"pointer-events-none absolute grid grid-cols-3 grid-rows-3 overflow-hidden",style:u,children:d.map(e=>{let i=a===e.cellId,l=M(e.stressLevel,i);return(0,t.jsx)("button",{type:"button",onClick:()=>null==r?void 0:r(e.cellId),className:"pointer-events-auto relative border transition-colors",style:{borderColor:i?"#67e8f9":"".concat(l),borderWidth:i?2:1,backgroundColor:i?"".concat(l,"1f"):"transparent",boxShadow:i?"inset 0 0 0 1px rgba(254,240,138,0.92)":"inset 0 0 0 1px rgba(226,232,240,0.18)"},"aria-label":"Select plot point ".concat(A(e)),children:(0,t.jsx)("span",{className:"absolute left-1 top-1 rounded bg-black/55 px-1.5 py-0.5 text-[10px] text-white",children:A(e)})},"grid-image-".concat(e.cellId))})})}var F=l(7497),I=l(2003),T=l(1966);let P=(0,I.j)("inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2",{variants:{variant:{default:"border-transparent bg-primary text-primary-foreground hover:opacity-90",secondary:"border-transparent bg-secondary text-secondary-foreground",outline:"text-foreground"}},defaultVariants:{variant:"default"}});function D(e){let{className:i,variant:l,...n}=e;return(0,t.jsx)("div",{className:(0,T.cn)(P({variant:l}),i),...n})}var E=l(6394),O=l(2355),R=l(8704),G=l(8625);let _=r()(()=>Promise.all([l.e(269),l.e(468),l.e(99)]).then(l.bind(l,4246)),{loadableGenerated:{webpack:()=>[4246]},ssr:!1}),L=r()(()=>Promise.all([l.e(934),l.e(737),l.e(365),l.e(499)]).then(l.bind(l,8499)),{loadableGenerated:{webpack:()=>[8499]},ssr:!1});function Z(e){let i=e.split(",").map(e=>Number(e.trim()));return 4!==i.length||i.some(e=>Number.isNaN(e))?null:i}function V(e){var i,l,t;let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{min:0,max:0,mean:0};return{min:Number(null!==(i=null==e?void 0:e.min)&&void 0!==i?i:n.min),max:Number(null!==(l=null==e?void 0:e.max)&&void 0!==l?l:n.max),mean:Number(null!==(t=null==e?void 0:e.mean)&&void 0!==t?t:n.mean)}}function W(e){let i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,l=Number(e);return Number.isFinite(l)?l:i}function Y(e,i,l){if(!e)return null;try{let t=window.atob(e),n=new Uint8Array(t.length);for(let e=0;e<t.length;e++)n[e]=t.charCodeAt(e);let a=i*l,r=new Float32Array(n.buffer,n.byteOffset,Math.min(a,Math.floor(n.byteLength/4))),o=Array(a);for(let e=0;e<a;e++){let i=r[e];o[e]=Number.isFinite(i)?Number(i):Number.NaN}return o}catch(e){return null}}function B(e,i,l){if(!e)return null;try{let t=window.atob(e),n=i*l,a=Array(n);for(let e=0;e<n;e++)a[e]=e<t.length&&t.charCodeAt(e)>0?1:0;return a}catch(e){return null}}function H(e,i){let l=!!(null==e?void 0:e.unavailable),t=null==e?void 0:e.data,n=null==t?void 0:t.metricGrid,a=null;if((null==n?void 0:n.encoded)&&(null==n?void 0:n.validMaskEncoded)&&Number(null==n?void 0:n.width)>1&&Number(null==n?void 0:n.height)>1){let l=Y(n.encoded,Number(n.width),Number(n.height));l&&l.length>=Number(n.width)*Number(n.height)&&(a={values:l,validMask:B(String(n.validMaskEncoded),Number(n.width),Number(n.height))||void 0,normalizationMode:(null==n?void 0:n.normalizationMode)==="fixedPhysicalRange"?"fixedPhysicalRange":"sceneAdaptiveRange",width:Number(n.width),height:Number(n.height),min:Number.isFinite(Number(null==n?void 0:n.min))?Number(n.min):0,max:Number.isFinite(Number(null==n?void 0:n.max))?Number(n.max):1,source:String((null==t?void 0:t.source)||(null==e?void 0:e.source)||i),units:"soil"===i?"m3/m3":"mm/day",isSimulated:!!(null==e?void 0:e.isSimulated)})}return{unavailable:l,message:"string"==typeof(null==e?void 0:e.message)?e.message:void 0,source:null==e?void 0:e.source,isSimulated:!!(null==e?void 0:e.isSimulated),representation:null==e?void 0:e.representation,stats:V((null==t?void 0:t.stats)||(null==e?void 0:e.stats)),overlayPng:"string"==typeof(null==t?void 0:t.overlayPng)?t.overlayPng:void 0,metricGrid:a,alignment:null==e?void 0:e.alignment,baseline:null==e?void 0:e.baseline,proxy:null==e?void 0:e.proxy}}function U(e){return e?{source:(null==e?void 0:e.source)||null,isSimulated:!!(null==e?void 0:e.isSimulated),stats:V(null==e?void 0:e.stats)}:null}function q(e){if(!Array.isArray(e)||!e.length)return null;let i=[];for(let a of e){var l,t,n;let e=Number(null!==(l=null==a?void 0:a.lat)&&void 0!==l?l:null==a?void 0:a[0]),r=Number(null!==(n=null!==(t=null==a?void 0:a.lng)&&void 0!==t?t:null==a?void 0:a[1])&&void 0!==n?n:null==a?void 0:a[0]);Number.isFinite(e)&&Number.isFinite(r)&&i.push([r,e])}if(i.length<3)return null;let a=i[0],r=i[i.length-1];return((a[0]!==r[0]||a[1]!==r[1])&&i.push(a),i.length<4)?null:{type:"Polygon",coordinates:[i]}}function J(e){let{label:i,isSimulated:l}=e;return(0,t.jsx)("span",{className:l?"status-chip border-amber-300 bg-amber-50 text-amber-800":"status-chip border-emerald-300 bg-emerald-50 text-emerald-800",children:i})}function Q(){var e,i,l,a,r,s,N,w,j,z,M,A,I,T,P,Q,$,K,X,ee,ei,el,et,en,ea,er,eo,es,ed,ec,eu,ev,em,ex,eh,ep,eb,eg,ef,ey,eN,ew,ej,ez,eS,ek,eM,eA,eC,eF,eI,eT,eP,eD,eE,eO,eR,eG,e_,eL,eZ,eV,eW;let eY=E.oy,[eB,eH]=(0,n.useState)("Edison, New Jersey"),[eU,eq]=(0,n.useState)([]),[eJ,eQ]=(0,n.useState)("-74.49,40.45,-74.33,40.59"),[e$,eK]=(0,n.useState)([]),[eX,e0]=(0,n.useState)("2025-12-01/2026-01-30"),[e1,e2]=(0,n.useState)("balanced"),[e3,e5]=(0,n.useState)("ndvi"),[e4,e6]=(0,n.useState)(!1),[e9,e7]=(0,n.useState)(!1),[e8,ie]=(0,n.useState)(!1),[ii,il]=(0,n.useState)(!1),[it,ia]=(0,n.useState)(!0),[ir,io]=(0,n.useState)(null),[is,id]=(0,n.useState)(!1),[ic,iu]=(0,n.useState)(0),iv=(0,n.useRef)(null),im=(0,n.useRef)(null),[ix,ih]=(0,n.useState)(null),[ip,ib]=(0,n.useState)(null),[ig,iy]=(0,n.useState)(null),[iN,iw]=(0,n.useState)(null),[ij,iz]=(0,n.useState)(null),[iS,ik]=(0,n.useState)(null),[iM,iA]=(0,n.useState)(null),[iC,iF]=(0,n.useState)(!1),[iI,iT]=(0,n.useState)({irrigationDelta:0,waterBudget:.5,targetRisk:.35,fertilizerDelta:0}),[iP,iD]=(0,n.useState)(null),[iE,iO]=(0,n.useState)([]),[iR,iG]=(0,n.useState)([]),[i_,iL]=(0,n.useState)({criticalNdvi:.28,warningNdvi:.42,highAnomaly:.66}),iZ=(0,n.useMemo)(()=>{var e;return V(null==ip?void 0:null===(e=ip.ndvi)||void 0===e?void 0:e.stats)},[ip]),iV=(0,n.useMemo)(()=>V(null==iN?void 0:iN.stats),[iN]),iW=(0,n.useMemo)(()=>V(null==ij?void 0:ij.stats),[ij]),iY=(null==ip?void 0:null===(e=ip.ndvi)||void 0===e?void 0:e.grid3x3)||[],iB=(0,n.useMemo)(()=>iY.find(e=>e.cellId===ir)||null,[iY,ir]),iH=(0,n.useMemo)(()=>iB?"P".concat(3*iB.row+iB.col+1):null,[iB]),iU="ndvi"===e3?null==ip?void 0:null===(i=ip.ndvi)||void 0===i?void 0:i.previewPng:"soil"===e3?null==iN?void 0:iN.overlayPng:null==ij?void 0:ij.overlayPng,iq="soil"===e3?iN:"et"===e3?ij:null,iJ=(0,n.useMemo)(()=>{var e;let i=null==ip?void 0:null===(e=ip.ndvi)||void 0===e?void 0:e.metricGrid;if(!(null==i?void 0:i.encoded)||!(null==i?void 0:i.validMaskEncoded)||!(null==i?void 0:i.width)||!(null==i?void 0:i.height))return null;let l=Y(i.encoded,i.width,i.height);return l&&l.length?{values:l,validMask:B(String(i.validMaskEncoded),i.width,i.height)||void 0,normalizationMode:"fixedPhysicalRange"===i.normalizationMode?"fixedPhysicalRange":"sceneAdaptiveRange",width:i.width,height:i.height,min:Number.isFinite(i.min)?i.min:iZ.min,max:Number.isFinite(i.max)?i.max:iZ.max,source:(null==ip?void 0:ip.provider)||"NDVI",units:"NDVI",isSimulated:!1}:null},[null==ip?void 0:null===(a=ip.ndvi)||void 0===a?void 0:null===(l=a.metricGrid)||void 0===l?void 0:l.encoded,null==ip?void 0:null===(s=ip.ndvi)||void 0===s?void 0:null===(r=s.metricGrid)||void 0===r?void 0:r.validMaskEncoded,null==ip?void 0:null===(w=ip.ndvi)||void 0===w?void 0:null===(N=w.metricGrid)||void 0===N?void 0:N.width,null==ip?void 0:null===(z=ip.ndvi)||void 0===z?void 0:null===(j=z.metricGrid)||void 0===j?void 0:j.height,null==ip?void 0:null===(A=ip.ndvi)||void 0===A?void 0:null===(M=A.metricGrid)||void 0===M?void 0:M.min,null==ip?void 0:null===(T=ip.ndvi)||void 0===T?void 0:null===(I=T.metricGrid)||void 0===I?void 0:I.max,null==ip?void 0:ip.provider,iZ.min,iZ.max]),iQ=(0,n.useMemo)(()=>"soil"===e3?(null==iN?void 0:iN.metricGrid)||null:"et"===e3?(null==ij?void 0:ij.metricGrid)||null:iJ,[e3,iJ,null==iN?void 0:iN.metricGrid,null==ij?void 0:ij.metricGrid]),i$=(0,n.useMemo)(()=>{if("undefined"==typeof document||!iQ||!Array.isArray(iQ.values)||iQ.width<2||iQ.height<2||iQ.values.length<iQ.width*iQ.height)return null;try{let e=(0,G.a8)({metric:e3,grid:{values:iQ.values,validMask:iQ.validMask,width:iQ.width,height:iQ.height,min:iQ.min,max:iQ.max},outputWidth:iQ.width,outputHeight:iQ.height,contours:!1}),i=e.canvas.getContext("2d");return i&&(i.save(),i.globalCompositeOperation="destination-over",i.fillStyle="ndvi"===e3?"#b8d9c6":"soil"===e3?"#d7dfd2":"#d3dde7",i.fillRect(0,0,e.canvas.width,e.canvas.height),i.restore()),(0,G.dL)(e.canvas)}catch(e){return null}},[e3,iQ]),iK=(0,n.useMemo)(()=>{if("undefined"==typeof document||!iJ||!Array.isArray(iJ.values)||iJ.width<2||iJ.height<2||iJ.values.length<iJ.width*iJ.height)return null;try{let e=(0,G.a8)({metric:"ndvi",grid:{values:iJ.values,validMask:iJ.validMask,width:iJ.width,height:iJ.height,min:iJ.min,max:iJ.max},outputWidth:iJ.width,outputHeight:iJ.height,contours:!1}),i=e.canvas.getContext("2d");return i&&(i.save(),i.globalCompositeOperation="destination-over",i.fillStyle="#b8d9c6",i.fillRect(0,0,e.canvas.width,e.canvas.height),i.restore()),(0,G.dL)(e.canvas)}catch(e){return null}},[iJ]),iX=i$||iU,i0=()=>{let e=iv.current,i=im.current;if(!e||!i){ih(null);return}let l=e.clientWidth,t=e.clientHeight,n=i.naturalWidth||0,a=i.naturalHeight||0;if(!l||!t||!n||!a){ih(null);return}let r=Math.min(l/n,t/a),o=Math.max(1,Math.floor(n*r)),s=Math.max(1,Math.floor(a*r));ih({left:Math.max(0,Math.round((l-o)/2)),top:Math.max(0,Math.round((t-s)/2)),width:o,height:s})};async function i1(){if(!eY||!E.I8)throw Error("Firebase Auth is not configured");try{return await (0,O.q)(E.I8)}catch(e){throw Error((0,O.x)(e))}}async function i2(){if(eB.trim()){e6(!0);try{let e=await fetch("/api/geocode?q=".concat(encodeURIComponent(eB.trim()))),i=await e.json().catch(()=>({}));if(!e.ok)throw Error((null==i?void 0:i.message)||(null==i?void 0:i.error)||"Geocoding failed");let l=Array.isArray(null==i?void 0:i.places)?i.places:[];eq(l),l.length||f.toast.warning("No matching places found.")}catch(e){f.toast.error((null==e?void 0:e.message)||"Geocoding failed")}finally{e6(!1)}}}async function i3(){let e=Z(eJ);if(!e){f.toast.error("Bounding box must be in format minLon,minLat,maxLon,maxLat");return}let i=q(e$);e6(!0),iO([]),iG([]),iA(null),iw(null),iz(null);try{var l,t,n,a,r,o,s,d,c,u,v,m,x,h,p,b,g,y,N,w,j,z,S,k,M,A,C,F,I,T,P,D,E,O,R,G;let _=await fetch("/api/ingest/fetch",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({bbox:e,geometry:i,date:eX,targetSize:512,policy:"balanced"})}),L=await _.json().catch(()=>({}));if(!_.ok||!(null==L?void 0:L.success))throw Error((null==L?void 0:L.message)||(null==L?void 0:L.error)||"Ingest failed");let Z=L.data,V=(null==Z?void 0:null===(t=Z.ndvi)||void 0===t?void 0:null===(l=t.grid3x3)||void 0===l?void 0:l.some(e=>"1-1"===e.cellId))?"1-1":(null==Z?void 0:null===(r=Z.ndvi)||void 0===r?void 0:null===(a=r.grid3x3)||void 0===a?void 0:null===(n=a[0])||void 0===n?void 0:n.cellId)||null;ib(Z);let W=(null==Z?void 0:null===(o=Z.alignment)||void 0===o?void 0:o.bbox)||(null==Z?void 0:Z.bbox);Array.isArray(W)&&4===W.length&&eQ(W.join(",")),io(V);let Y=Array.isArray(null==L?void 0:L.warnings)?L.warnings:[],[B,U,q,J]=await Promise.allSettled([fetch("/api/weather",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({bbox:e})}).then(e=>e.json()),fetch("/api/soil",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({bbox:e,geometry:i,date:eX,targetSize:512})}).then(e=>e.json()),fetch("/api/et",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({bbox:e,geometry:i,date:eX,targetSize:512})}).then(e=>e.json()),fetch("/api/timeseries",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({bbox:e,interval:"weekly"})}).then(e=>e.json())]),Q=[...Y],$=[];if("fulfilled"===B.status?(iy(B.value),$.push(...(null===(I=B.value)||void 0===I?void 0:I.providersTried)||[]),Array.isArray(null===(T=B.value)||void 0===T?void 0:T.warnings)&&Q.push(...B.value.warnings)):Q.push("Weather provider unavailable."),"fulfilled"===U.status){let e=H(U.value,"soil");iw(e),$.push(...(null===(P=U.value)||void 0===P?void 0:P.providersTried)||[]),Array.isArray(null===(D=U.value)||void 0===D?void 0:D.warnings)&&Q.push(...U.value.warnings),e.unavailable&&Q.push(e.message||"Soil layer unavailable in strict real-only mode.")}else iw({unavailable:!0,message:"Soil provider unavailable."}),Q.push("Soil provider unavailable.");if("fulfilled"===q.status){let e=H(q.value,"et");iz(e),$.push(...(null===(E=q.value)||void 0===E?void 0:E.providersTried)||[]),Array.isArray(null===(O=q.value)||void 0===O?void 0:O.warnings)&&Q.push(...q.value.warnings),e.unavailable&&Q.push(e.message||"ET layer unavailable in strict real-only mode.")}else iz({unavailable:!0,message:"ET provider unavailable."}),Q.push("ET provider unavailable.");"fulfilled"===J.status?(ik(J.value),$.push(...(null===(R=J.value)||void 0===R?void 0:R.providersTried)||[]),Array.isArray(null===(G=J.value)||void 0===G?void 0:G.warnings)&&Q.push(...J.value.warnings)):Q.push("Time-series provider unavailable.");let K=await fetch("/api/gemini",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({prompt:"Generate an AI assistant field recommendation summary.",objective:e1,ndviData:{stats:null==Z?void 0:null===(s=Z.ndvi)||void 0===s?void 0:s.stats},weatherData:"fulfilled"===B.status?{source:null===(d=B.value)||void 0===d?void 0:d.source,isSimulated:null===(c=B.value)||void 0===c?void 0:c.isSimulated,current:(null===(v=B.value)||void 0===v?void 0:null===(u=v.data)||void 0===u?void 0:u.current)||{}}:null,soilData:"fulfilled"===U.status?{source:null===(m=U.value)||void 0===m?void 0:m.source,isSimulated:null===(x=U.value)||void 0===x?void 0:x.isSimulated,stats:(null===(p=U.value)||void 0===p?void 0:null===(h=p.data)||void 0===h?void 0:h.stats)||{}}:null,etData:"fulfilled"===q.status?{source:null===(b=q.value)||void 0===b?void 0:b.source,isSimulated:null===(g=q.value)||void 0===g?void 0:g.isSimulated,stats:(null===(N=q.value)||void 0===N?void 0:null===(y=N.data)||void 0===y?void 0:y.stats)||{}}:null,timeSeriesData:"fulfilled"===J.status?{source:null===(w=J.value)||void 0===w?void 0:w.source,isSimulated:null===(j=J.value)||void 0===j?void 0:j.isSimulated,summary:null===(S=J.value)||void 0===S?void 0:null===(z=S.data)||void 0===z?void 0:z.summary,timeSeries:((null===(M=J.value)||void 0===M?void 0:null===(k=M.data)||void 0===k?void 0:k.timeSeries)||[]).slice(-12)}:null,providersTried:$,context:{bbox:(null==Z?void 0:null===(A=Z.alignment)||void 0===A?void 0:A.bbox)||(null==Z?void 0:Z.bbox)||e,ndviStats:null==Z?void 0:null===(C=Z.ndvi)||void 0===C?void 0:C.stats,grid3x3:(null==Z?void 0:null===(F=Z.ndvi)||void 0===F?void 0:F.grid3x3)||[],selectedCell:V,warnings:Q.slice(0,12)}})}),X=await K.json().catch(()=>({}));if(!K.ok)throw Error((null==X?void 0:X.message)||"ML analysis failed");iA((null==X?void 0:X.inference)||null),iO(Q.filter(Boolean)),iG($),f.toast.success("Analysis complete")}catch(e){f.toast.error((null==e?void 0:e.message)||"Analysis failed")}finally{e6(!1)}}async function i5(){if(ip){e7(!0);try{let e=await i1();if(!e)return;let i=await e.getIdToken(!0),l=q(e$),t={type:"Polygon",coordinates:[[[ip.bbox[0],ip.bbox[1]],[ip.bbox[2],ip.bbox[1]],[ip.bbox[2],ip.bbox[3]],[ip.bbox[0],ip.bbox[3]],[ip.bbox[0],ip.bbox[1]]]]},n={name:"AOI ".concat(new Date().toLocaleDateString()),locationName:eB,description:"Provider: ".concat(ip.provider).concat(ip.fallbackUsed?" (fallback used)":""),ndviStats:iZ,previewPng:ip.ndvi.previewPng,bbox:ip.bbox,geojson:l||t,grid3x3:ip.ndvi.grid3x3||[],inferenceSnapshot:iM||null,sourceQuality:{ingestProvider:ip.provider,fallbackUsed:ip.fallbackUsed,warnings:iE,providersTried:iR}};try{await (0,R.pb)(i,n)}catch(e){if(e instanceof R.GY&&401===e.status&&(null===E.I8||void 0===E.I8?void 0:E.I8.currentUser)){let e=await E.I8.currentUser.getIdToken(!0);await (0,R.pb)(e,n)}else throw e}f.toast.success("Plot saved")}catch(e){f.toast.error((0,R.$D)(e))}finally{e7(!1)}}}async function i4(){if(!ip){f.toast.error("Run analysis before scenario simulation.");return}iF(!0);try{let e=await fetch("/api/ai/simulate",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({objective:e1,scenario:iI,ndviData:{stats:ip.ndvi.stats},weatherData:function(e){var i;if(!e)return null;let l=(null==e?void 0:null===(i=e.data)||void 0===i?void 0:i.current)||(null==e?void 0:e.current)||{};return{source:(null==e?void 0:e.source)||null,isSimulated:!!(null==e?void 0:e.isSimulated),current:{temperature:W(null==l?void 0:l.temperature),humidity:W(null==l?void 0:l.humidity),precipitation:W(null==l?void 0:l.precipitation),windSpeed:W(null==l?void 0:l.windSpeed)}}}(ig),soilData:U(iN),etData:U(ij),timeSeriesData:function(e){var i,l;if(!e)return null;let t=Array.isArray(null==e?void 0:null===(i=e.data)||void 0===i?void 0:i.timeSeries)?e.data.timeSeries:Array.isArray(null==e?void 0:e.timeSeries)?e.timeSeries:[];return{source:(null==e?void 0:e.source)||null,isSimulated:!!(null==e?void 0:e.isSimulated),summary:(null==e?void 0:null===(l=e.data)||void 0===l?void 0:l.summary)||(null==e?void 0:e.summary)||null,timeSeries:t.slice(-12).map(e=>({date:String((null==e?void 0:e.date)||""),ndvi:W(null==e?void 0:e.ndvi),cloudCover:"number"==typeof(null==e?void 0:e.cloudCover)?e.cloudCover:null,confidence:"number"==typeof(null==e?void 0:e.confidence)?e.confidence:null}))}}(iS),providersTried:iR,context:{ndviStats:ip.ndvi.stats,grid3x3:(ip.ndvi.grid3x3||[]).slice(0,9),selectedCell:ir},selectedCell:ir})}),i=await e.json().catch(()=>({}));if(!e.ok)throw Error((null==i?void 0:i.message)||(null==i?void 0:i.error)||"Simulation failed");iD((null==i?void 0:i.scenario)||null),f.toast.success("Scenario simulation completed")}catch(e){f.toast.error((null==e?void 0:e.message)||"Scenario simulation failed")}finally{iF(!1)}}async function i6(){ie(!0);try{let e=await fetch("/api/cache/clear",{method:"POST",headers:{"Content-Type":"application/json"}}),i=await e.json().catch(()=>({}));if(!e.ok||!(null==i?void 0:i.success))throw Error((null==i?void 0:i.message)||(null==i?void 0:i.error)||"Cache clear failed");let l=Number((null==i?void 0:i.memoryCleared)||0),t=Number((null==i?void 0:i.firestoreCleared)||0);f.toast.success("Cache cleared (memory: ".concat(l,", firestore: ").concat(t,")")),(null==i?void 0:i.warning)&&f.toast.warning(String(i.warning))}catch(e){f.toast.error((null==e?void 0:e.message)||"Cache clear failed")}finally{ie(!1)}}return(0,n.useEffect)(()=>{let e=window.localStorage.getItem("agrisense.alertThresholds.v1");if(e)try{let i=JSON.parse(e);iL({criticalNdvi:Number(null==i?void 0:i.criticalNdvi)||.28,warningNdvi:Number(null==i?void 0:i.warningNdvi)||.42,highAnomaly:Number(null==i?void 0:i.highAnomaly)||.66})}catch(e){}},[]),(0,n.useEffect)(()=>{window.localStorage.setItem("agrisense.alertThresholds.v1",JSON.stringify(i_))},[i_]),(0,n.useEffect)(()=>{var e,i,l,t;if(!ip)return;let n=[];iZ.mean<i_.criticalNdvi?n.push({id:"ndvi-critical",type:"critical",message:"Critical vegetation stress risk",details:"NDVI mean is ".concat(iZ.mean.toFixed(3),"."),plotName:"Current AOI"}):iZ.mean<i_.warningNdvi&&n.push({id:"ndvi-warning",type:"warning",message:"Moderate canopy stress detected",details:"NDVI mean is ".concat(iZ.mean.toFixed(3),"."),plotName:"Current AOI"}),(Number((null==iM?void 0:null===(e=iM.anomaly)||void 0===e?void 0:e.score)||0)>=i_.highAnomaly||(null==iM?void 0:null===(i=iM.anomaly)||void 0===i?void 0:i.level)==="high")&&n.push({id:"anomaly-high",type:"critical",message:"High anomaly score",details:(null==iM?void 0:null===(t=iM.anomaly)||void 0===t?void 0:null===(l=t.signals)||void 0===l?void 0:l[0])||"Unusual field behavior detected.",plotName:"Current AOI"}),window.dispatchEvent(new CustomEvent("agrisense:alerts",{detail:n}))},[ip,iZ.mean,null==iM?void 0:null===(P=iM.anomaly)||void 0===P?void 0:P.level,null==iM?void 0:null===(Q=iM.anomaly)||void 0===Q?void 0:Q.score,null==iM?void 0:null===($=iM.anomaly)||void 0===$?void 0:$.signals,i_]),(0,n.useEffect)(()=>{i0();let e=()=>i0();window.addEventListener("resize",e);let i="undefined"!=typeof ResizeObserver?new ResizeObserver(()=>i0()):null;return i&&(iv.current&&i.observe(iv.current),im.current&&i.observe(im.current)),()=>{window.removeEventListener("resize",e),null==i||i.disconnect()}},[iX,null==ip?void 0:null===(X=ip.alignment)||void 0===X?void 0:null===(K=X.bbox)||void 0===K?void 0:K.join(","),null==ip?void 0:null===(ee=ip.bbox)||void 0===ee?void 0:ee.join(","),e3]),(0,t.jsxs)("div",{className:"min-h-screen",children:[(0,t.jsx)(y.Z,{}),(0,t.jsxs)("main",{className:"app-shell py-6",children:[(0,t.jsxs)(g.E.section,{className:"mb-6 grid gap-4 lg:grid-cols-[1.35fr_0.9fr]",initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{duration:.28,ease:"easeOut"},children:[(0,t.jsxs)("article",{id:"pipeline",className:"surface-card p-5",children:[(0,t.jsxs)("div",{className:"mb-4 flex flex-wrap items-center justify-between gap-3",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)("h1",{className:"text-2xl font-semibold text-zinc-900",children:"Field Operations Workbench"}),(0,t.jsx)("p",{className:"mt-1 text-sm text-zinc-600",children:"Data pipeline, AOI controls, analysis, planning, and save flows are unified here."})]}),(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[(0,t.jsx)(F.z,{variant:"balanced"===e1?"default":"outline",onClick:()=>e2("balanced"),children:"Balanced"}),(0,t.jsx)(F.z,{variant:"yield"===e1?"default":"outline",onClick:()=>e2("yield"),children:"Yield"}),(0,t.jsx)(F.z,{variant:"water"===e1?"default":"outline",onClick:()=>e2("water"),children:"Water"})]})]}),(0,t.jsxs)("div",{className:"grid gap-3 md:grid-cols-2",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)("label",{className:"mb-1 block text-xs font-semibold uppercase tracking-wide text-zinc-500",children:"Search location"}),(0,t.jsxs)("div",{className:"flex gap-2",children:[(0,t.jsx)("input",{value:eB,onChange:e=>eH(e.target.value),className:"w-full rounded-xl border border-zinc-300 px-3 py-2 text-sm outline-none focus:border-emerald-800",placeholder:"Edison, New Jersey"}),(0,t.jsx)(F.z,{variant:"outline",disabled:e4,onClick:i2,children:"Find"})]}),eU.length>0&&(0,t.jsx)("div",{className:"mt-2 max-h-44 overflow-auto rounded-xl border border-zinc-200 bg-white",children:eU.map(e=>(0,t.jsx)("button",{onClick:()=>{eQ(function(e){let[i,l,t,n]=e.bbox;return"".concat(t,",").concat(i,",").concat(n,",").concat(l)}(e)),eq([])},className:"block w-full border-b border-zinc-100 px-3 py-2 text-left text-sm text-zinc-700 hover:bg-zinc-50",children:e.display_name},"".concat(e.display_name,"-").concat(e.lat,"-").concat(e.lon)))})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)("label",{className:"mb-1 block text-xs font-semibold uppercase tracking-wide text-zinc-500",children:"Date range"}),(0,t.jsx)("input",{value:eX,onChange:e=>e0(e.target.value),className:"w-full rounded-xl border border-zinc-300 px-3 py-2 text-sm outline-none focus:border-emerald-800",placeholder:"YYYY-MM-DD/YYYY-MM-DD"}),(0,t.jsx)("p",{className:"mt-1 text-[11px] text-zinc-500",children:"Policy: balanced freshness + cloud | Output: 512x512"})]})]}),(0,t.jsxs)("div",{className:"mt-3",children:[(0,t.jsx)("label",{className:"mb-1 block text-xs font-semibold uppercase tracking-wide text-zinc-500",children:"Bounding box"}),(0,t.jsx)("input",{value:eJ,onChange:e=>eQ(e.target.value),className:"w-full rounded-xl border border-zinc-300 px-3 py-2 text-sm outline-none focus:border-emerald-800"})]}),(0,t.jsx)("div",{className:"mt-4 h-[26rem] overflow-hidden rounded-2xl border border-zinc-200",children:(0,t.jsx)(_,{bbox:Z(eJ)||void 0,onBboxChange:e=>eQ(e.join(",")),polygon:e$,onPolygonChange:e=>{eK(e),function(e){if(!Array.isArray(e)||!e.length)return;let i=Number.POSITIVE_INFINITY,l=Number.POSITIVE_INFINITY,t=Number.NEGATIVE_INFINITY,n=Number.NEGATIVE_INFINITY;for(let s of e){var a,r,o;let e=Number(null!==(a=null==s?void 0:s.lat)&&void 0!==a?a:null==s?void 0:s[0]),d=Number(null!==(o=null!==(r=null==s?void 0:s.lng)&&void 0!==r?r:null==s?void 0:s[1])&&void 0!==o?o:null==s?void 0:s[0]);Number.isFinite(d)&&Number.isFinite(e)&&(i=Math.min(i,d),l=Math.min(l,e),t=Math.max(t,d),n=Math.max(n,e))}Number.isFinite(i)&&Number.isFinite(l)&&Number.isFinite(t)&&Number.isFinite(n)&&eQ("".concat(i,",").concat(l,",").concat(t,",").concat(n))}(e)},ndviPng:iK||(null==ip?void 0:null===(ei=ip.ndvi)||void 0===ei?void 0:ei.previewPng),ndviBounds:(null==ip?void 0:null===(el=ip.alignment)||void 0===el?void 0:el.bbox)||(null==ip?void 0:ip.bbox),grid3x3:null==ip?void 0:null===(et=ip.ndvi)||void 0===et?void 0:et.grid3x3,cellFootprints:null==ip?void 0:null===(en=ip.ndvi)||void 0===en?void 0:en.cellFootprints,selectedCell:ir,onSelectCell:io,showGrid:it,smoothOverlay:!0,debugMode:ii,debugMetricGrid:iJ,debugAlignmentBbox:(null==ip?void 0:null===(ea=ip.alignment)||void 0===ea?void 0:ea.bbox)||(null==ip?void 0:ip.bbox),debugResolutionMeters:null!==(eG=null!==(eR=null==ip?void 0:null===(er=ip.alignment)||void 0===er?void 0:er.pixelSizeMetersApprox)&&void 0!==eR?eR:null==ip?void 0:ip.dataResolutionMeters)&&void 0!==eG?eG:null,debugCoverage:null!==(e_=null==ip?void 0:null===(es=ip.ndvi)||void 0===es?void 0:null===(eo=es.aoiMaskMeta)||void 0===eo?void 0:eo.coveredPixelRatio)&&void 0!==e_?e_:null,clearAoiSignal:ic})}),(0,t.jsxs)("div",{className:"mt-4 flex flex-wrap gap-2",children:[(0,t.jsxs)(F.z,{disabled:e4,onClick:i3,children:[e4?(0,t.jsx)(o.Z,{className:"mr-2 h-4 w-4 animate-spin"}):(0,t.jsx)(d,{className:"mr-2 h-4 w-4"}),"Analyze AOI"]}),(0,t.jsxs)(F.z,{variant:"outline",disabled:!ip||e9,onClick:i5,children:[e9?(0,t.jsx)(o.Z,{className:"mr-2 h-4 w-4 animate-spin"}):(0,t.jsx)(c,{className:"mr-2 h-4 w-4"}),"Save Plot"]}),(0,t.jsx)(F.z,{variant:it?"default":"outline",onClick:()=>ia(e=>!e),children:it?"Hide 3x3 Grid":"Show 3x3 Grid"}),(0,t.jsx)(F.z,{variant:is?"default":"outline",onClick:()=>id(e=>!e),children:is?"Hide 3D Terrain":"Open 3D Terrain"}),(0,t.jsx)(F.z,{variant:"outline",onClick:()=>{eK([]),io(null),iu(e=>e+1)},children:"Clear AOI"}),(0,t.jsxs)(F.z,{variant:"outline",disabled:e8,onClick:i6,children:[e8?(0,t.jsx)(o.Z,{className:"mr-2 h-4 w-4 animate-spin"}):(0,t.jsx)(u,{className:"mr-2 h-4 w-4"}),"Clear Cache"]}),(0,t.jsxs)(F.z,{variant:"outline",onClick:()=>il(e=>!e),children:[(0,t.jsx)(u,{className:"mr-2 h-4 w-4"}),ii?"Hide Debug":"Show Debug"]})]})]}),(0,t.jsxs)("article",{className:"surface-card p-5",children:[(0,t.jsx)("h2",{className:"text-lg font-semibold text-zinc-900",children:"System Diagnostics"}),(0,t.jsx)("p",{className:"mt-1 text-sm text-zinc-600",children:"Source quality, fallback state, and model confidence."}),(0,t.jsxs)("div",{className:"mt-4 grid gap-3",children:[(0,t.jsxs)("div",{className:"rounded-xl border border-zinc-200 bg-zinc-50 p-3",children:[(0,t.jsxs)("div",{className:"flex items-center justify-between",children:[(0,t.jsx)("p",{className:"text-xs uppercase tracking-wide text-zinc-500",children:"Satellite source"}),(null==ip?void 0:ip.fallbackUsed)?(0,t.jsx)(J,{label:"fallback",isSimulated:!0}):(0,t.jsx)(J,{label:"primary"})]}),(0,t.jsx)("p",{className:"mt-1 text-sm font-semibold text-zinc-900",children:(null==ip?void 0:ip.provider)||"Not analyzed"}),(0,t.jsxs)("p",{className:"text-xs text-zinc-600",children:["Scene: ",(null==ip?void 0:null===(ed=ip.imagery)||void 0===ed?void 0:ed.date)?new Date(ip.imagery.date).toLocaleDateString():"N/A"," | Cloud: ","number"==typeof(null==ip?void 0:null===(ec=ip.imagery)||void 0===ec?void 0:ec.cloudCover)?"".concat(ip.imagery.cloudCover.toFixed(1),"%"):"N/A"]})]}),(0,t.jsxs)("div",{className:"rounded-xl border border-zinc-200 bg-zinc-50 p-3",children:[(0,t.jsxs)("div",{className:"flex items-center justify-between",children:[(0,t.jsx)("p",{className:"text-xs uppercase tracking-wide text-zinc-500",children:"ML confidence"}),(0,t.jsx)(v,{className:"h-4 w-4 text-emerald-700"})]}),(0,t.jsx)("p",{className:"mt-1 text-sm font-semibold text-zinc-900",children:iM?"".concat(Math.round(100*(iM.confidence||0)),"%"):"Pending"}),(0,t.jsxs)("p",{className:"text-xs text-zinc-600",children:["Data quality: ",iM?"".concat(Math.round(100*((null==iM?void 0:null===(eu=iM.dataQuality)||void 0===eu?void 0:eu.score)||0)),"%"):"N/A"," | Objective: ",e1]})]}),(0,t.jsxs)("div",{className:"rounded-xl border border-zinc-200 bg-zinc-50 p-3",children:[(0,t.jsxs)("div",{className:"flex items-center justify-between",children:[(0,t.jsx)("p",{className:"text-xs uppercase tracking-wide text-zinc-500",children:"Layer quality"}),(0,t.jsxs)("div",{className:"flex gap-1",children:[(0,t.jsx)(J,{label:"weather",isSimulated:null==ig?void 0:ig.isSimulated}),(0,t.jsx)(J,{label:"soil",isSimulated:null==iN?void 0:iN.isSimulated}),(0,t.jsx)(J,{label:"et",isSimulated:null==ij?void 0:ij.isSimulated})]})]}),(0,t.jsxs)("p",{className:"mt-1 text-xs text-zinc-600",children:["Time series: ",(null==iS?void 0:iS.source)||"N/A"," ",(null==iS?void 0:iS.cacheHit)?"(cache)":""]})]})]}),iE.length>0&&(0,t.jsxs)("div",{className:"mt-4 rounded-xl border border-amber-200 bg-amber-50 p-3",children:[(0,t.jsxs)("p",{className:"flex items-center gap-2 text-sm font-semibold text-amber-900",children:[(0,t.jsx)(m.Z,{className:"h-4 w-4"}),"Warnings"]}),(0,t.jsx)("ul",{className:"mt-2 list-disc space-y-1 pl-4 text-xs text-amber-800",children:iE.slice(0,6).map((e,i)=>(0,t.jsx)("li",{children:e},"".concat(e,"-").concat(i)))})]}),(0,t.jsxs)("div",{className:"mt-4 rounded-xl border border-zinc-200 bg-zinc-50 p-3",children:[(0,t.jsx)("p",{className:"text-xs uppercase tracking-wide text-zinc-500",children:"Proactive Alert Thresholds"}),(0,t.jsxs)("div",{className:"mt-2 space-y-2",children:[(0,t.jsxs)("label",{className:"block text-xs text-zinc-700",children:["Critical NDVI (",i_.criticalNdvi.toFixed(2),")",(0,t.jsx)("input",{type:"range",min:.12,max:.45,step:.01,value:i_.criticalNdvi,onChange:e=>iL(i=>({...i,criticalNdvi:Number(e.target.value)})),className:"mt-1 w-full"})]}),(0,t.jsxs)("label",{className:"block text-xs text-zinc-700",children:["Warning NDVI (",i_.warningNdvi.toFixed(2),")",(0,t.jsx)("input",{type:"range",min:.2,max:.6,step:.01,value:i_.warningNdvi,onChange:e=>iL(i=>({...i,warningNdvi:Number(e.target.value)})),className:"mt-1 w-full"})]}),(0,t.jsxs)("label",{className:"block text-xs text-zinc-700",children:["High anomaly (",(100*i_.highAnomaly).toFixed(0),"%)",(0,t.jsx)("input",{type:"range",min:.35,max:.9,step:.01,value:i_.highAnomaly,onChange:e=>iL(i=>({...i,highAnomaly:Number(e.target.value)})),className:"mt-1 w-full"})]})]})]}),ii&&(0,t.jsxs)("div",{className:"mt-4 rounded-xl border border-zinc-200 bg-zinc-950 p-3 text-xs text-zinc-100",children:[(0,t.jsx)("p",{className:"mb-2 font-semibold",children:"Provider Diagnostics"}),(0,t.jsxs)("div",{className:"space-y-2",children:[0===iR.length&&(0,t.jsx)("p",{className:"text-zinc-300",children:"No diagnostics available yet."}),iR.map((e,i)=>(0,t.jsxs)("div",{className:"rounded border border-zinc-700 bg-zinc-900 p-2",children:[(0,t.jsx)("p",{className:"font-semibold",children:e.provider}),(0,t.jsxs)("p",{className:"text-zinc-300",children:["status: ",e.ok?"ok":"failed"," ",e.reason?"| ".concat(e.reason):"",e.durationMs?" | ".concat(e.durationMs,"ms"):""]})]},"".concat(e.provider,"-").concat(i)))]})]})]})]}),(0,t.jsxs)(g.E.section,{className:"grid gap-4 lg:grid-cols-[1.25fr_1fr]",initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{duration:.3,ease:"easeOut",delay:.05},children:[(0,t.jsxs)("article",{className:"surface-card p-5",children:[(0,t.jsxs)("div",{className:"mb-3 flex items-center justify-between gap-2",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)("h3",{className:"text-lg font-semibold text-zinc-900",children:"Layer Viewer"}),(0,t.jsx)("p",{className:"text-sm text-zinc-600",children:"Switch between NDVI, soil moisture, and ET overlays."})]}),(0,t.jsxs)("div",{className:"flex gap-2",children:[(0,t.jsxs)(F.z,{variant:"ndvi"===e3?"default":"outline",onClick:()=>e5("ndvi"),children:[(0,t.jsx)(x,{className:"mr-2 h-4 w-4"}),"NDVI"]}),(0,t.jsxs)(F.z,{variant:"soil"===e3?"default":"outline",onClick:()=>e5("soil"),children:[(0,t.jsx)(h,{className:"mr-2 h-4 w-4"}),"Soil"]}),(0,t.jsxs)(F.z,{variant:"et"===e3?"default":"outline",onClick:()=>e5("et"),children:[(0,t.jsx)(p,{className:"mr-2 h-4 w-4"}),"ET"]})]})]}),iX?(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)("div",{ref:iv,className:"relative overflow-hidden rounded-2xl border border-zinc-200 bg-zinc-100",children:[(0,t.jsx)("img",{ref:im,src:"data:image/png;base64,".concat(iX),alt:"".concat(e3," preview"),className:"h-[24rem] w-full object-contain",onLoad:i0}),(0,t.jsx)(C,{cells:null==ip?void 0:null===(ev=ip.ndvi)||void 0===ev?void 0:ev.grid3x3,cellFootprints:null==ip?void 0:null===(em=ip.ndvi)||void 0===em?void 0:em.cellFootprints,alignmentBbox:(null==ip?void 0:null===(ex=ip.alignment)||void 0===ex?void 0:ex.bbox)||(null==ip?void 0:ip.bbox),selectedCell:ir,onSelectCell:io,visible:it,frame:ix})]}),(0,t.jsxs)("p",{className:"mt-2 text-xs text-zinc-600",children:["Color source:"," ",i$?"Quantitative metric grid (matches 3D terrain legend).":"Provider preview image (grid values unavailable).",(null==iQ?void 0:iQ.normalizationMode)?" | Normalization: ".concat(iQ.normalizationMode):""]}),("soil"===e3||"et"===e3)&&(null==iq?void 0:iq.representation)&&(0,t.jsxs)("p",{className:"mt-1 text-xs text-zinc-600",children:["Representation: ",iq.representation," | Baseline ",(null===(eh=iq.baseline)||void 0===eh?void 0:eh.provider)||"n/a"," | Proxy ",(null===(ep=iq.proxy)||void 0===ep?void 0:ep.provider)||"n/a"," | Pixel ~",(null===(eb=iq.alignment)||void 0===eb?void 0:eb.pixelSizeMetersApprox)?"".concat(iq.alignment.pixelSizeMetersApprox.toFixed(1),"m"):"n/a"]}),(null==iq?void 0:iq.unavailable)&&(0,t.jsx)("p",{className:"mt-1 text-xs text-amber-700",children:iq.message||"".concat(e3.toUpperCase()," layer unavailable under strict real-only mode.")})]}):(0,t.jsx)("div",{className:"rounded-2xl border border-dashed border-zinc-300 bg-zinc-50 p-8 text-center text-sm text-zinc-600",children:"Run analysis to generate layer outputs."}),(0,t.jsxs)("div",{className:"mt-4 grid gap-3 md:grid-cols-3",children:[(0,t.jsxs)("div",{className:"rounded-xl border border-zinc-200 bg-zinc-50 p-3",children:[(0,t.jsx)("p",{className:"text-xs uppercase tracking-wide text-zinc-500",children:"NDVI mean"}),(0,t.jsx)("p",{className:"mt-1 text-lg font-semibold text-zinc-900",children:iZ.mean.toFixed(3)})]}),(0,t.jsxs)("div",{className:"rounded-xl border border-zinc-200 bg-zinc-50 p-3",children:[(0,t.jsx)("p",{className:"text-xs uppercase tracking-wide text-zinc-500",children:"Soil moisture mean"}),(0,t.jsx)("p",{className:"mt-1 text-lg font-semibold text-zinc-900",children:(null==iN?void 0:iN.unavailable)?"n/a":iV.mean.toFixed(3)})]}),(0,t.jsxs)("div",{className:"rounded-xl border border-zinc-200 bg-zinc-50 p-3",children:[(0,t.jsx)("p",{className:"text-xs uppercase tracking-wide text-zinc-500",children:"ET mean (mm/day)"}),(0,t.jsx)("p",{className:"mt-1 text-lg font-semibold text-zinc-900",children:(null==ij?void 0:ij.unavailable)?"n/a":iW.mean.toFixed(3)})]})]}),iB&&(0,t.jsxs)("div",{className:"mt-3 rounded-xl border border-sky-200 bg-sky-50 p-3",children:[(0,t.jsxs)("p",{className:"text-xs uppercase tracking-wide text-sky-700",children:["Selected Plot Point ",iH]}),(0,t.jsxs)("p",{className:"mt-1 text-sm text-sky-900",children:["NDVI mean ",iB.mean.toFixed(3)," | stress ",iB.stressLevel," | valid pixels"," ",(100*iB.validPixelRatio).toFixed(1),"%"]})]}),is&&(0,t.jsx)("div",{className:"mt-3",children:(0,t.jsx)(L,{open:is,bbox:(null==ip?void 0:null===(eg=ip.alignment)||void 0===eg?void 0:eg.bbox)||(null==ip?void 0:ip.bbox),geometry:q(e$),alignmentBbox:(null==ip?void 0:null===(ef=ip.alignment)||void 0===ef?void 0:ef.bbox)||(null==ip?void 0:ip.bbox),cellFootprints:(null==ip?void 0:null===(ey=ip.ndvi)||void 0===ey?void 0:ey.cellFootprints)||null,texturePng:iX||(null==ip?void 0:null===(eN=ip.ndvi)||void 0===eN?void 0:eN.previewPng),metricGrid:iQ,layer:e3,selectedCell:ir})})]}),(0,t.jsxs)("article",{className:"surface-card p-5",children:[(0,t.jsxs)("div",{className:"flex items-center justify-between",children:[(0,t.jsx)("h3",{className:"text-lg font-semibold text-zinc-900",children:"Recommendations"}),(null==iM?void 0:iM.isSimulatedInputs)&&(0,t.jsx)(D,{variant:"outline",children:"Simulated inputs"})]}),(0,t.jsx)("p",{className:"mt-1 text-sm text-zinc-600",children:"Deterministic ML guidance for field operations."}),iM?(0,t.jsxs)("div",{className:"mt-4 space-y-3",children:[iB&&(0,t.jsxs)("div",{className:"rounded-xl border border-sky-200 bg-sky-50 p-3",children:[(0,t.jsxs)("p",{className:"text-xs uppercase tracking-wide text-sky-700",children:["Plot Point focus (",iH,")"]}),(0,t.jsxs)("ul",{className:"mt-2 list-disc space-y-1 pl-4 text-xs text-sky-900",children:["high"===iB.stressLevel&&(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)("li",{children:"Prioritize irrigation uniformity check in this cell within 24 hours."}),(0,t.jsx)("li",{children:"Scout canopy stress causes and compare emitter pressure."})]}),"moderate"===iB.stressLevel&&(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)("li",{children:"Schedule targeted scouting and soil check in this cell this week."}),(0,t.jsx)("li",{children:"Re-check NDVI after next irrigation cycle."})]}),"low"===iB.stressLevel&&(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)("li",{children:"Maintain baseline schedule and monitor trend drift."}),(0,t.jsx)("li",{children:"Use this cell as healthy reference for comparisons."})]}),"unknown"===iB.stressLevel&&(0,t.jsx)(t.Fragment,{children:(0,t.jsx)("li",{children:"Data quality is low in this cell; re-run analysis with cleaner scene dates."})})]})]}),(0,t.jsxs)("div",{className:"rounded-xl border border-zinc-200 bg-zinc-50 p-3",children:[(0,t.jsx)("p",{className:"text-xs uppercase tracking-wide text-zinc-500",children:"What changed"}),(0,t.jsx)("p",{className:"mt-1 text-sm text-zinc-800",children:null==iM?void 0:null===(ew=iM.summary)||void 0===ew?void 0:ew.whatChanged})]}),(0,t.jsxs)("div",{className:"rounded-xl border border-zinc-200 bg-zinc-50 p-3",children:[(0,t.jsx)("p",{className:"text-xs uppercase tracking-wide text-zinc-500",children:"Why"}),(0,t.jsx)("p",{className:"mt-1 text-sm text-zinc-800",children:null==iM?void 0:null===(ej=iM.summary)||void 0===ej?void 0:ej.why})]}),(0,t.jsxs)("div",{className:"rounded-xl border border-zinc-200 bg-zinc-50 p-3",children:[(0,t.jsx)("p",{className:"text-xs uppercase tracking-wide text-zinc-500",children:"Next actions"}),(0,t.jsx)("p",{className:"mt-1 text-sm text-zinc-800",children:null==iM?void 0:null===(ez=iM.summary)||void 0===ez?void 0:ez.nextActions}),(0,t.jsxs)("p",{className:"mt-1 text-xs text-zinc-500",children:["Re-check in ",null==iM?void 0:null===(eS=iM.summary)||void 0===eS?void 0:eS.recheckIn]})]}),((null==iM?void 0:iM.recommendations)||[]).map(e=>(0,t.jsxs)("div",{className:"rounded-xl border border-zinc-200 p-3",children:[(0,t.jsxs)("div",{className:"mb-1 flex items-center justify-between",children:[(0,t.jsx)("p",{className:"text-sm font-semibold text-zinc-900",children:e.title}),(0,t.jsx)(J,{label:e.priority,isSimulated:"high"===e.priority})]}),(0,t.jsx)("p",{className:"text-xs text-zinc-600",children:e.reason}),(0,t.jsx)("ul",{className:"mt-2 list-disc space-y-1 pl-4 text-xs text-zinc-700",children:(e.actions||[]).slice(0,3).map((i,l)=>(0,t.jsx)("li",{children:i},"".concat(e.id,"-").concat(l)))})]},e.id)),(0,t.jsxs)("div",{className:"rounded-xl border border-zinc-200 bg-zinc-50 p-3",children:[(0,t.jsx)("p",{className:"text-xs uppercase tracking-wide text-zinc-500",children:"What-if Simulator"}),(0,t.jsxs)("div",{className:"mt-2 grid gap-2",children:[(0,t.jsxs)("label",{className:"text-xs text-zinc-700",children:["Irrigation delta (",iI.irrigationDelta>=0?"+":"",Math.round(100*iI.irrigationDelta),"%)"]}),(0,t.jsx)("input",{type:"range",min:-.3,max:.6,step:.05,value:iI.irrigationDelta,onChange:e=>iT(i=>({...i,irrigationDelta:Number(e.target.value)}))}),(0,t.jsxs)("label",{className:"text-xs text-zinc-700",children:["Water budget (",Math.round(100*iI.waterBudget),"%)"]}),(0,t.jsx)("input",{type:"range",min:0,max:1,step:.05,value:iI.waterBudget,onChange:e=>iT(i=>({...i,waterBudget:Number(e.target.value)}))}),(0,t.jsxs)("label",{className:"text-xs text-zinc-700",children:["Target risk (",Math.round(100*iI.targetRisk),"%)"]}),(0,t.jsx)("input",{type:"range",min:.05,max:.9,step:.05,value:iI.targetRisk,onChange:e=>iT(i=>({...i,targetRisk:Number(e.target.value)}))}),(0,t.jsxs)(F.z,{variant:"outline",disabled:iC,onClick:i4,children:[iC?(0,t.jsx)(o.Z,{className:"mr-2 h-4 w-4 animate-spin"}):null,"Run What-if"]})]}),iP&&(0,t.jsxs)("div",{className:"mt-3 rounded-lg border border-sky-200 bg-sky-50 p-2 text-xs text-sky-900",children:[(0,t.jsxs)("p",{children:["Risk: ",(100*iP.baselineRisk7d).toFixed(1),"% -> ",(100*iP.scenarioRisk7d).toFixed(1),"%"]}),(0,t.jsxs)("p",{children:["NDVI30: ",iP.baselineNdvi30d.toFixed(3)," -> ",iP.scenarioNdvi30d.toFixed(3)]}),(0,t.jsxs)("p",{children:["Water delta: ",iP.waterUseDeltaPct.toFixed(1),"% | Yield proxy: ",iP.yieldProxyDeltaPct.toFixed(1),"%"]}),(0,t.jsx)("p",{className:"mt-1",children:iP.recommendation})]})]})]}):(0,t.jsx)("div",{className:"mt-4 rounded-xl border border-dashed border-zinc-300 bg-zinc-50 p-6 text-sm text-zinc-600",children:"Run analysis to generate recommendations."})]})]}),(0,t.jsxs)(g.E.section,{className:"mt-4 grid gap-4 lg:grid-cols-[1.4fr_0.9fr]",initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{duration:.33,ease:"easeOut",delay:.1},children:[(0,t.jsxs)("article",{className:"surface-card p-5",children:[(0,t.jsxs)("div",{className:"mb-3 flex items-center justify-between",children:[(0,t.jsx)("h3",{className:"text-lg font-semibold text-zinc-900",children:"Historical NDVI Trend"}),(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[(0,t.jsx)(J,{label:(null==iS?void 0:iS.source)||"n/a",isSimulated:null==iS?void 0:iS.isSimulated}),(null==iS?void 0:iS.cacheHit)&&(0,t.jsx)(J,{label:"cache"})]})]}),(0,t.jsx)(k.Z,{data:((null==iS?void 0:null===(ek=iS.data)||void 0===ek?void 0:ek.timeSeries)||[]).map(e=>({date:e.date,ndvi:Number(e.ndvi),confidence:Number(e.confidence),cloudCover:"number"==typeof e.cloudCover?e.cloudCover:void 0})),title:"AOI NDVI timeline",showConfidence:!0,showCloudCover:!0})]}),(0,t.jsxs)("article",{className:"surface-card p-5",children:[(0,t.jsxs)("h3",{className:"flex items-center gap-2 text-lg font-semibold text-zinc-900",children:[(0,t.jsx)(b,{className:"h-5 w-5 text-emerald-700"}),"Weather Snapshot"]}),(0,t.jsxs)("p",{className:"mt-1 text-sm text-zinc-600",children:[(null==ig?void 0:ig.source)||"No weather data"," ",(null==ig?void 0:ig.isSimulated)?"(simulated)":""]}),(0,t.jsxs)("div",{className:"mt-4 grid grid-cols-2 gap-3",children:[(0,t.jsxs)("div",{className:"rounded-xl border border-zinc-200 bg-zinc-50 p-3",children:[(0,t.jsx)("p",{className:"text-xs uppercase tracking-wide text-zinc-500",children:"Temp"}),(0,t.jsxs)("p",{className:"mt-1 text-lg font-semibold text-zinc-900",children:[null!==(eL=null==ig?void 0:null===(eA=ig.data)||void 0===eA?void 0:null===(eM=eA.current)||void 0===eM?void 0:eM.temperature)&&void 0!==eL?eL:"--","F"]})]}),(0,t.jsxs)("div",{className:"rounded-xl border border-zinc-200 bg-zinc-50 p-3",children:[(0,t.jsx)("p",{className:"text-xs uppercase tracking-wide text-zinc-500",children:"Humidity"}),(0,t.jsxs)("p",{className:"mt-1 text-lg font-semibold text-zinc-900",children:[null!==(eZ=null==ig?void 0:null===(eF=ig.data)||void 0===eF?void 0:null===(eC=eF.current)||void 0===eC?void 0:eC.humidity)&&void 0!==eZ?eZ:"--","%"]})]}),(0,t.jsxs)("div",{className:"rounded-xl border border-zinc-200 bg-zinc-50 p-3",children:[(0,t.jsx)("p",{className:"text-xs uppercase tracking-wide text-zinc-500",children:"Precip"}),(0,t.jsxs)("p",{className:"mt-1 text-lg font-semibold text-zinc-900",children:[null!==(eV=null==ig?void 0:null===(eT=ig.data)||void 0===eT?void 0:null===(eI=eT.current)||void 0===eI?void 0:eI.precipitation)&&void 0!==eV?eV:"--"," mm"]})]}),(0,t.jsxs)("div",{className:"rounded-xl border border-zinc-200 bg-zinc-50 p-3",children:[(0,t.jsx)("p",{className:"text-xs uppercase tracking-wide text-zinc-500",children:"Wind"}),(0,t.jsxs)("p",{className:"mt-1 text-lg font-semibold text-zinc-900",children:[null!==(eW=null==ig?void 0:null===(eD=ig.data)||void 0===eD?void 0:null===(eP=eD.current)||void 0===eP?void 0:eP.windSpeed)&&void 0!==eW?eW:"--"," mph"]})]})]})]})]})]}),(0,t.jsx)(S,{objective:e1,context:{bbox:(null==ip?void 0:null===(eE=ip.alignment)||void 0===eE?void 0:eE.bbox)||(null==ip?void 0:ip.bbox),ndviStats:iZ,grid3x3:(null==ip?void 0:null===(eO=ip.ndvi)||void 0===eO?void 0:eO.grid3x3)||[],selectedCell:ir,selectedCellData:iB,soilStats:iV,etStats:iW,weather:ig||null,timeSeries:iS||null,inference:iM||null,warnings:iE,providersTried:iR}})]})}}},function(e){e.O(0,[551,23,712,500,448,850,888,774,179],function(){return e(e.s=528)}),_N_E=e.O()}]);