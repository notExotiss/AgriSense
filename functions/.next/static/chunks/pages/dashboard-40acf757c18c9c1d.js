(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[26],{528:function(e,t,a){(window.__NEXT_P=window.__NEXT_P||[]).push(["/dashboard",function(){return a(4754)}])},4754:function(e,t,a){"use strict";a.r(t),a.d(t,{default:function(){return ei}});var s=a(5893),i=a(7294),n=a(5250);function l(e){let{onNDVIReady:t}=e,[a,l]=(0,i.useState)("idle");async function r(e){var t;let a=null===(t=e.target.files)||void 0===t?void 0:t[0];if(!a)return;l("reading");let s=await a.arrayBuffer();await o(s)}async function o(e){l("parsing");let a=await (0,n.go)(e),s=await a.getImage(),i=s.getWidth(),r=s.getHeight(),o=await s.readRasters({interleave:!1}),d=o[3]||o[0],c=o[7]||o[1],m=new Float32Array(d.length),u=1,x=-1,h=0;for(let e=0;e<d.length;e++){let t=d[e],a=c[e],s=a+t,i=0===s?0:(a-t)/s;m[e]=i,i<u&&(u=i),i>x&&(x=i),h+=i}let g=h/m.length;l("done"),t({ndvi:m,width:i,height:r,stats:{min:u,max:x,mean:g}})}return(0,s.jsxs)("div",{className:"space-y-2",children:[(0,s.jsx)("input",{type:"file",accept:".tif,.tiff",onChange:r}),(0,s.jsxs)("div",{className:"text-xs text-muted-foreground",children:["Status: ",a]})]})}function r(e){let{ndvi:t,width:a,height:n}=e,l=(0,i.useRef)(null);return(0,i.useEffect)(()=>{if(!l.current)return;let e=l.current;e.width=a,e.height=n;let s=e.getContext("2d"),i=s.createImageData(a,n);for(let e=0;e<t.length;e++){var r;let a=(r=t[e])<=-.2?[128,0,38,255]:r<=0?[189,0,38,255]:r<=.2?[255,255,178,255]:r<=.4?[127,201,127,255]:[27,120,55,255],s=4*e;i.data[s]=a[0],i.data[s+1]=a[1],i.data[s+2]=a[2],i.data[s+3]=a[3]}s.putImageData(i,0,0)},[t,a,n]),(0,s.jsx)("canvas",{ref:l,className:"w-full h-auto border rounded"})}var o=a(5477),d=a(7497),c=a(1966);function m(e){let{value:t=0,className:a,...i}=e;return(0,s.jsx)("div",{className:(0,c.cn)("relative w-full overflow-hidden rounded-full bg-muted",a),...i,children:(0,s.jsx)("div",{className:"h-full w-full flex-1 bg-primary transition-all",style:{transform:"translateX(-".concat(100-Math.min(100,Math.max(0,t)),"%)"),height:"100%"}})})}var u=e=>{let{assets:t,onNDVIReady:a}=e,[l,r]=(0,i.useState)(!1),[c,u]=(0,i.useState)(0),[x,h]=(0,i.useState)(null),g=async()=>{r(!0),u(0),h(null);let e=0,s=window.setInterval(()=>u(t=>t<e?t+1:t),50);try{e=10;let s=await (0,n.W0)(t.b04),i=await s.getImage(),l=await (0,n.W0)(t.b08),r=await l.getImage();e=30;let d=i.getWidth(),c=i.getHeight(),m=Math.max(d,c),u=m>512?512/m:1,x=Math.max(1,Math.round(d*u)),h=Math.max(1,Math.round(c*u));e=40;let g=await i.readRasters({samples:[0],width:x,height:h,resampleMethod:"bilinear"}),p=await r.readRasters({samples:[0],width:x,height:h,resampleMethod:"bilinear"});e=50;let f=Array.isArray(g)?g[0]:g,v=Array.isArray(p)?p[0]:p;if(!f||!v||f.length!==v.length)throw Error("Invalid band data");let j=e=>{let t=-1/0;for(let a=0;a<e.length;a++){let s=Number(e[a]);Number.isFinite(s)&&s>t&&(t=s)}if(t>1e3){let t=new Float32Array(e.length);for(let a=0;a<e.length;a++)t[a]=Number(e[a])/1e4;return{arr:t,scaled:!0}}if(e instanceof Float32Array)return{arr:e,scaled:!1};let a=new Float32Array(e.length);for(let t=0;t<e.length;t++)a[t]=Number(e[t]);return{arr:a,scaled:!1}},N=j(f).arr,b=j(v).arr;e=60;let y=N.length,w=1/0,k=-1/0,S=0,I=0,D=new Float32Array(y);for(let e=0;e<y;e++){let t=N[e],a=b[e];if(!Number.isFinite(t)||!Number.isFinite(a))continue;let s=a+t;if(0===s)continue;let i=(a-t)/s;D[e]=i,i<w&&(w=i),i>k&&(k=i),S+=i,I++}let C=I>0?S/I:0,F=Number.isFinite(w)?Math.max(-1,Math.min(1,w)):0,A=Number.isFinite(k)?Math.max(-1,Math.min(1,k)):0;e=80;let P=new o.y({width:x,height:h}),T=e=>{let t=Math.max(-1,Math.min(1,e));return t<-.2?[128,0,38,255]:t<0?[189,0,38,255]:t<.2?[255,255,178,255]:t<.4?[127,201,127,255]:[27,120,55,255]};for(let e=0;e<y;e++){let t=D[e],a=T(t),s=4*e;P.data[s]=a[0],P.data[s+1]=a[1],P.data[s+2]=a[2],P.data[s+3]=a[3]}let E=o.y.sync.write(P).toString("base64");e=100,a({ndvi:D,width:x,height:h,stats:{min:F,max:A,mean:C},previewPng:E})}catch(e){console.error("Client-side NDVI processing error:",e),h((null==e?void 0:e.message)||"Failed to process NDVI")}finally{r(!1),window.clearInterval(s),u(100)}};return(0,s.jsxs)("div",{className:"space-y-4",children:[(0,s.jsx)(d.z,{onClick:g,disabled:l,className:"w-full",children:l?"Processing... ".concat(c,"%"):"Process Location"}),l&&(0,s.jsx)(m,{value:c,className:"mt-3"}),x&&(0,s.jsxs)("div",{className:"text-red-500 text-sm mt-3",children:["Error: ",x]})]})},x=a(5133);function h(e){let{className:t,...a}=e;return(0,s.jsx)("div",{className:(0,c.cn)("rounded-xl border bg-card text-card-foreground shadow",t),...a})}function g(e){let{className:t,...a}=e;return(0,s.jsx)("div",{className:(0,c.cn)("flex flex-col space-y-1.5 p-6",t),...a})}function p(e){let{className:t,...a}=e;return(0,s.jsx)("h3",{className:(0,c.cn)("text-2xl font-semibold leading-none tracking-tight",t),...a})}function f(e){let{className:t,...a}=e;return(0,s.jsx)("p",{className:(0,c.cn)("text-sm text-muted-foreground",t),...a})}function v(e){let{className:t,...a}=e;return(0,s.jsx)("div",{className:(0,c.cn)("p-6 pt-0",t),...a})}let j=(0,a(2003).j)("inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2",{variants:{variant:{default:"border-transparent bg-primary text-primary-foreground hover:opacity-90",secondary:"border-transparent bg-secondary text-secondary-foreground",outline:"text-foreground"}},defaultVariants:{variant:"default"}});function N(e){let{className:t,variant:a,...i}=e;return(0,s.jsx)("div",{className:(0,c.cn)(j({variant:a}),t),...i})}function b(e){let{children:t,className:a,...i}=e;return(0,s.jsx)("div",{className:(0,c.cn)("relative",a),...i,children:t})}function y(e){let{children:t,className:a,...i}=e;return(0,s.jsx)("div",{className:(0,c.cn)("flex overflow-x-auto scrollbar-hide scroll-smooth",a),...i,children:t})}function w(e){let{children:t,className:a,...i}=e;return(0,s.jsx)("div",{className:(0,c.cn)("flex-shrink-0",a),...i,children:t})}function k(e){let{className:t,...a}=e;return(0,s.jsx)("button",{className:(0,c.cn)("absolute left-2 top-1/2 -translate-y-1/2 z-10 h-8 w-8 rounded-full bg-background/80 border shadow-md hover:bg-accent transition-colors",t),...a,children:(0,s.jsx)("svg",{className:"h-4 w-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,s.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 19l-7-7 7-7"})})})}function S(e){let{className:t,...a}=e;return(0,s.jsx)("button",{className:(0,c.cn)("absolute right-2 top-1/2 -translate-y-1/2 z-10 h-8 w-8 rounded-full bg-background/80 border shadow-md hover:bg-accent transition-colors",t),...a,children:(0,s.jsx)("svg",{className:"h-4 w-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,s.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 5l7 7-7 7"})})})}var I=a(8532),D=a(9828),C=a(2922),F=a(154),A=a(758),P=a(5951),T=a(4464);let E=(e,t)=>({Clear:(0,s.jsx)(I.Z,{className:"h-6 w-6 text-yellow-500"}),Clouds:(0,s.jsx)(D.Z,{className:"h-6 w-6 text-gray-500"}),Rain:(0,s.jsx)(C.Z,{className:"h-6 w-6 text-blue-500"}),Snow:(0,s.jsx)(C.Z,{className:"h-6 w-6 text-blue-200"}),Thunderstorm:(0,s.jsx)(C.Z,{className:"h-6 w-6 text-purple-500"}),Drizzle:(0,s.jsx)(C.Z,{className:"h-6 w-6 text-blue-400"}),Mist:(0,s.jsx)(D.Z,{className:"h-6 w-6 text-gray-400"}),Fog:(0,s.jsx)(D.Z,{className:"h-6 w-6 text-gray-300"})})[e]||(0,s.jsx)(I.Z,{className:"h-6 w-6 text-yellow-500"}),M=e=>({Clear:"bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200",Clouds:"bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-200",Rain:"bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200",Snow:"bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200",Thunderstorm:"bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-200",Drizzle:"bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200",Mist:"bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-200",Fog:"bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-200"})[e]||"bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-200";function V(e){let{bbox:t,date:a,searchLocation:n}=e,[l,r]=(0,i.useState)(null),[o,d]=(0,i.useState)(!1),[c,m]=(0,i.useState)(null),[u,x]=(0,i.useState)(null);if((0,i.useEffect)(()=>{if(!(n?n.lat&&n.lon:t&&4===t.length))return;let e=n?"".concat(n.lat,",").concat(n.lon):null==t?void 0:t.join(",");e!==u&&(x(e),d(!0),m(null),(async()=>{try{console.log("Fetching weather for:",n?"location ".concat(n.lat,",").concat(n.lon):"bbox ".concat(t));let e=await fetch("/api/weather",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({bbox:t,date:a,location:n})});if(!e.ok)throw Error("Weather API error: ".concat(e.status));let s=await e.json();if(console.log("Weather data received:",s),s.data)r(s.data);else throw Error("No weather data received")}catch(e){console.error("Weather fetch error:",e),m(e.message||"Failed to fetch weather data")}finally{d(!1)}})())},[t,a,n,u]),o)return(0,s.jsxs)(h,{className:"w-full",children:[(0,s.jsx)(g,{className:"pb-3",children:(0,s.jsxs)(p,{className:"text-lg flex items-center gap-2",children:[(0,s.jsx)(D.Z,{className:"h-5 w-5"}),"Weather Data"]})}),(0,s.jsx)(v,{children:(0,s.jsxs)("div",{className:"flex items-center justify-center py-8",children:[(0,s.jsx)("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary"}),(0,s.jsx)("span",{className:"ml-2 text-sm text-muted-foreground",children:"Loading weather..."})]})})]});if(c)return(0,s.jsxs)(h,{className:"w-full",children:[(0,s.jsx)(g,{className:"pb-3",children:(0,s.jsxs)(p,{className:"text-lg flex items-center gap-2",children:[(0,s.jsx)(D.Z,{className:"h-5 w-5"}),"Weather Data"]})}),(0,s.jsx)(v,{children:(0,s.jsx)("div",{className:"text-center py-4",children:(0,s.jsx)("p",{className:"text-sm text-destructive",children:c})})})]});if(!l)return(0,s.jsxs)(h,{className:"w-full",children:[(0,s.jsx)(g,{className:"pb-3",children:(0,s.jsxs)(p,{className:"text-lg flex items-center gap-2",children:[(0,s.jsx)(D.Z,{className:"h-5 w-5"}),"Weather Data"]})}),(0,s.jsx)(v,{children:(0,s.jsx)("div",{className:"text-center py-4",children:(0,s.jsx)("p",{className:"text-sm text-muted-foreground",children:"No weather data available"})})})]});let{location:f,current:j,forecast:I}=l;return(0,s.jsxs)(h,{className:"w-full",children:[(0,s.jsxs)(g,{className:"pb-3",children:[(0,s.jsxs)(p,{className:"text-lg flex items-center gap-2",children:[(0,s.jsx)(D.Z,{className:"h-5 w-5"}),"Weather Data"]}),(0,s.jsxs)("p",{className:"text-sm text-muted-foreground",children:[f.name,f.state?", ".concat(f.state):"",f.country?", ".concat(f.country):""]})]}),(0,s.jsxs)(v,{className:"space-y-4",children:[(0,s.jsxs)("div",{className:"flex items-center justify-between p-4 rounded-lg bg-muted/50",children:[(0,s.jsxs)("div",{className:"flex items-center gap-3",children:[E(j.condition,j.icon),(0,s.jsxs)("div",{children:[(0,s.jsxs)("div",{className:"text-2xl font-bold",children:[j.temperature,"\xb0F"]}),(0,s.jsx)("div",{className:"text-sm text-muted-foreground capitalize",children:j.description})]})]}),(0,s.jsx)(N,{className:M(j.condition),children:j.condition})]}),(0,s.jsxs)("div",{className:"grid grid-cols-2 gap-3",children:[(0,s.jsxs)("div",{className:"flex items-center gap-2 p-2 rounded bg-muted/30",children:[(0,s.jsx)(F.Z,{className:"h-4 w-4 text-muted-foreground"}),(0,s.jsxs)("div",{className:"text-sm",children:[(0,s.jsx)("div",{className:"font-medium",children:"Feels like"}),(0,s.jsxs)("div",{className:"text-muted-foreground",children:[j.feelsLike,"\xb0F"]})]})]}),(0,s.jsxs)("div",{className:"flex items-center gap-2 p-2 rounded bg-muted/30",children:[(0,s.jsx)(A.Z,{className:"h-4 w-4 text-muted-foreground"}),(0,s.jsxs)("div",{className:"text-sm",children:[(0,s.jsx)("div",{className:"font-medium",children:"Humidity"}),(0,s.jsxs)("div",{className:"text-muted-foreground",children:[j.humidity,"%"]})]})]}),(0,s.jsxs)("div",{className:"flex items-center gap-2 p-2 rounded bg-muted/30",children:[(0,s.jsx)(P.Z,{className:"h-4 w-4 text-muted-foreground"}),(0,s.jsxs)("div",{className:"text-sm",children:[(0,s.jsx)("div",{className:"font-medium",children:"Wind"}),(0,s.jsxs)("div",{className:"text-muted-foreground",children:[j.windSpeed," mph"]})]})]}),(0,s.jsxs)("div",{className:"flex items-center gap-2 p-2 rounded bg-muted/30",children:[(0,s.jsx)(T.Z,{className:"h-4 w-4 text-muted-foreground"}),(0,s.jsxs)("div",{className:"text-sm",children:[(0,s.jsx)("div",{className:"font-medium",children:"Visibility"}),(0,s.jsxs)("div",{className:"text-muted-foreground",children:[j.visibility," mi"]})]})]})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("h4",{className:"text-sm font-medium mb-3",children:"7-Day Forecast"}),(0,s.jsxs)(b,{className:"w-full",children:[(0,s.jsx)(y,{className:"-ml-2 md:-ml-4",children:I.map((e,t)=>(0,s.jsx)(w,{className:"pl-2 md:pl-4 basis-1/3 md:basis-1/4",children:(0,s.jsxs)("div",{className:"p-3 rounded-lg border bg-card text-center",children:[(0,s.jsx)("div",{className:"text-xs text-muted-foreground mb-1",children:0===t?"Today":new Date(e.date).toLocaleDateString("en",{weekday:"short"})}),(0,s.jsx)("div",{className:"mb-2",children:E(e.condition,e.icon)}),(0,s.jsxs)("div",{className:"text-sm font-medium",children:[e.temp_max,"\xb0F"]}),(0,s.jsxs)("div",{className:"text-xs text-muted-foreground",children:[e.temp_min,"\xb0F"]}),(0,s.jsx)("div",{className:"text-xs mt-1",children:e.precipitation>0&&(0,s.jsxs)("span",{className:"text-blue-500",children:[e.precipitation,"mm"]})})]})},e.date))}),(0,s.jsx)(k,{}),(0,s.jsx)(S,{})]})]})]})]})}var z=a(3727),O=a(5097),Z=a(2841);function L(e){let{context:t}=e,[a,n]=(0,i.useState)(!1),[l,r]=(0,i.useState)(""),[o,d]=(0,i.useState)([]),c=(0,i.useRef)(null);async function m(){if(!l.trim())return;let e=l.trim();d(t=>[...t,{role:"user",text:e}]),r("");try{let a="You are an agronomy assistant. Use the provided context (NDVI, soil moisture, ET, weather, AOI) to answer clearly and practically. If numeric values exist, reference them succinctly.\n\nContext:\n".concat(JSON.stringify(t).slice(0,6e3),"\n\nQuestion: ").concat(e),s=await fetch("/api/gemini",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({prompt:a,ndviData:null==t?void 0:t.ndvi,soilData:null==t?void 0:t.soil,etData:null==t?void 0:t.et,weatherData:null==t?void 0:t.weather})});if(429===s.status){let e=await s.json().catch(()=>({}));d(t=>[...t,{role:"ai",text:e.message||"Rate limit exceeded. Please wait a moment and try again."}]);return}if(!s.ok){let e=await s.json().catch(()=>({}));d(t=>[...t,{role:"ai",text:e.message||"Error: ".concat(s.statusText)}]);return}let i=await s.json().catch(()=>({})),n=(null==i?void 0:i.suggestion)||(null==i?void 0:i.output)||"No response.";d(e=>[...e,{role:"ai",text:n}])}catch(e){d(t=>{var a;return[...t,{role:"ai",text:(null==e?void 0:null===(a=e.message)||void 0===a?void 0:a.includes("rate limit"))?"Rate limit exceeded. Please wait a moment and try again.":(null==e?void 0:e.message)||"An error occurred. Please try again."}]})}}return(0,i.useEffect)(()=>{var e;null===(e=c.current)||void 0===e||e.scrollTo({top:999999,behavior:"smooth"})},[o]),(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)("button",{onClick:()=>n(e=>!e),className:"fixed bottom-4 right-4 z-50 rounded-full bg-primary text-primary-foreground shadow h-12 w-12 flex items-center justify-center",children:(0,s.jsx)(O.Z,{className:"h-6 w-6"})}),a&&(0,s.jsxs)("div",{className:"fixed bottom-20 right-4 z-50 w-96 rounded-lg border bg-background shadow-lg flex flex-col",children:[(0,s.jsx)("div",{className:"p-3 border-b font-medium",children:"AI Assistant"}),(0,s.jsxs)("div",{ref:c,className:"p-3 space-y-3 max-h-80 overflow-auto text-sm",children:[0===o.length&&(0,s.jsx)("div",{className:"text-muted-foreground",children:"Ask about NDVI, soil, ET, or weather for this plot."}),o.map((e,t)=>(0,s.jsx)("div",{className:"p-2 rounded ".concat("user"===e.role?"bg-primary/10":"bg-muted"),children:e.text},t))]}),(0,s.jsxs)("div",{className:"p-3 flex gap-2",children:[(0,s.jsx)("input",{className:"flex-1 border rounded px-2 py-1 bg-background",value:l,onChange:e=>r(e.target.value),onKeyDown:e=>{"Enter"===e.key&&m()},placeholder:"Type a question..."}),(0,s.jsxs)("button",{onClick:m,className:"rounded bg-primary text-primary-foreground px-3 text-sm flex items-center gap-1",children:[(0,s.jsx)(Z.Z,{className:"h-4 w-4"}),"Send"]})]})]})]})}var R=a(7716),J=a(4976),_=a(8142),W=a(5324),H=a(9858),U=a(3025),G=a(116),B=a(1012),q=a(3510),X=a(1222),Y=a(4844),K=a(6394),Q=a(2370),$=a(5152),ee=a.n($),et=a(4712);let ea=ee()(()=>Promise.all([a.e(269),a.e(471),a.e(964)]).then(a.bind(a,9963)),{loadableGenerated:{webpack:()=>[9963]},ssr:!1}),es=ee()(()=>Promise.all([a.e(737),a.e(934),a.e(74)]).then(a.bind(a,8074)),{loadableGenerated:{webpack:()=>[8074]},ssr:!1});function ei(){var e,t,a,n,o,c,m,j,b,y,w,k,S,I,C,F;let A=K.oy,[P,T]=(0,i.useState)("auto-ingest"),[E,M]=(0,i.useState)(null),[O,Z]=(0,i.useState)(!1),[$,ee]=(0,i.useState)(""),[ei,en]=(0,i.useState)(null),[el,er]=(0,i.useState)(null);(0,i.useRef)(null);let[eo,ed]=(0,i.useState)("Edison, New Jersey"),[ec,em]=(0,i.useState)([]),[eu,ex]=(0,i.useState)(""),[eh,eg]=(0,i.useState)("2025-08-01/2025-08-10"),[ep,ef]=(0,i.useState)(null),[ev,ej]=(0,i.useState)(!1),[eN,eb]=(0,i.useState)([]),[ey,ew]=(0,i.useState)(null),[ek,eS]=(0,i.useState)({lat:40.5187,lon:-74.4121,name:"Edison, NJ"}),[eI,eD]=(0,i.useState)("Edison, NJ"),[eC,eF]=(0,i.useState)("ndvi"),[eA,eP]=(0,i.useState)(null),[eT,eE]=(0,i.useState)(null),[eM,eV]=(0,i.useState)("ndvi"),[ez,eO]=(0,i.useState)(!1),[eZ,eL]=(0,i.useState)([]),[eR,eJ]=(0,i.useState)(null),[e_,eW]=(0,i.useState)(null),[eH,eU]=(0,i.useState)("basic"),[eG,eB]=(0,i.useState)(!1),[eq,eX]=(0,i.useState)(!1),[eY,eK]=(0,i.useState)(""),[eQ,e$]=(0,i.useState)(!1),[e0,e2]=(0,i.useState)(!1);async function e1(){if(!A||!K.I8)throw Error("Firebase Auth is not configured");if(K.I8.currentUser)return K.I8.currentUser;let e=new Q.hJ;try{return(await (0,Q.rh)(K.I8,e)).user}catch(t){try{await (0,Q.F6)(K.I8,e)}catch(e){}throw Error("Sign-in required")}}async function e4(){if(E){Z(!0);try{let e=function(){try{let e=document.querySelector("canvas");if(!e)return null;return e.toDataURL("image/png").replace("data:image/png;base64,","")}catch(e){return null}}(),t=await fetch("/api/items",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:eI||"Farm Plot ".concat(new Date().toLocaleDateString()),ndviStats:E.stats,width:E.width,height:E.height,previewPng:e,timestamp:new Date().toISOString(),locationName:eI||(null==ek?void 0:ek.name)})}),a=await t.json();en(a.id),et.toast.success("Analysis saved successfully!")}catch(e){et.toast.error((null==e?void 0:e.message)||"Save failed")}finally{Z(!1)}}}async function e5(){if(!E)return;ee("Analyzing vegetation health...");let e="Analyze farm health based on NDVI data: min=".concat(E.stats.min.toFixed(3),", max=").concat(E.stats.max.toFixed(3),", mean=").concat(E.stats.mean.toFixed(3),". Provide health assessment and 3 actionable recommendations.");try{let t=await fetch("/api/gemini",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({prompt:e})});if(429===t.status){let e=await t.json().catch(()=>({}));ee(e.message||"Rate limit exceeded. Please wait a moment and try again.");return}if(!t.ok){let e=await t.json().catch(()=>({}));ee(e.message||"Error: ".concat(t.statusText,". Using fallback analysis."));return}let a=await t.json();ee(a.suggestion||a.output||"Analysis completed")}catch(e){console.error("AI Analysis error:",e),((null==e?void 0:e.message)||"").includes("rate limit")?ee("Rate limit exceeded. Please wait a moment and try again."):ee(e3(E.stats))}}function e3(e){let{min:t,max:a,mean:s}=e,i="",n=[];return s>.6?(i="\uD83C\uDF31 Excellent vegetation health detected",n=["Continue current management practices","Monitor for optimal harvest timing","Consider precision fertilization for peak areas"]):s>.4?(i="\uD83C\uDF3F Good vegetation health with some variation",n=["Investigate areas with lower NDVI values","Check irrigation uniformity across the field","Consider targeted nutrient application"]):s>.2?(i="⚠️ Moderate vegetation stress detected",n=["Immediate field inspection recommended","Check for pest, disease, or water stress","Consider soil testing in affected areas"]):(i="\uD83D\uDEA8 Significant vegetation stress or sparse coverage",n=["Urgent field assessment required","Investigate potential crop failure causes","Consider replanting in severely affected areas"]),"".concat(i,"\n\nRecommendations:\n").concat(n.map((e,t)=>"".concat(t+1,". ").concat(e)).join("\n"))}async function e8(e,t){try{if((null==e?void 0:e.soilMoisture)&&e.soilMoisture.startsWith("iVBOR"))return{...e,overlayPng:e.soilMoisture};if((null==e?void 0:e.evapotranspiration)&&e.evapotranspiration.startsWith("iVBOR"))return{...e,overlayPng:e.evapotranspiration};let a="soil"===t?null==e?void 0:e.soilMoisture:null==e?void 0:e.evapotranspiration;if(!a)return e;let s=JSON.parse(atob(a)),i=s.width||256,n=s.height||256,l=s.data||[],r=Number.POSITIVE_INFINITY,o=Number.NEGATIVE_INFINITY;for(let e of l)e<r&&(r=e),e>o&&(o=e);let d=document.createElement("canvas");d.width=i,d.height=n;let c=d.getContext("2d"),m=c.createImageData(i,n),u=e=>{let a=(e-r)/(o-r||1);return"soil"===t?[Math.round(150-150*a),Math.round(90+100*a),Math.round(40+180*a),255]:[Math.round(50+200*a),Math.round(200-140*a),Math.round(80-60*a),255]};for(let e=0;e<l.length;e++){let[t,a,s,i]=u(l[e]),n=4*e;m.data[n]=t,m.data[n+1]=a,m.data[n+2]=s,m.data[n+3]=i}c.putImageData(m,0,0);let x=d.toDataURL("image/png").replace("data:image/png;base64,","");return{...e,overlayPng:x}}catch(t){return e}}async function e6(){ej(!0);try{let e=await fetch("/api/geocode?q=".concat(encodeURIComponent(eo)));if(!e.ok)throw Error("Geocode failed");let t=await e.json();em(t.places||[]),et.toast.success("Found places")}catch(e){et.toast.error((null==e?void 0:e.message)||"Geocoding error")}finally{ej(!1)}}async function e7(){if(!eu)return et.toast.error("Please set a bounding box first");ej(!0),ef(null),ew(null),eP(null),eE(null);try{let e=eu.split(",").map(e=>Number(e.trim())),t=await fetch("/api/ingest/fetch",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({bbox:e,date:eh})});if(!t.ok)throw Error("NDVI fetch failed");let a=await t.json();ef(a);try{let t=await fetch("/api/soil",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({bbox:e})});if(t.ok){let e=await t.json(),a=await e8(e.data,"soil");eP(a)}}catch(e){console.warn("Soil data fetch failed:",e)}try{let t=await fetch("/api/et",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({bbox:e})});if(t.ok){let e=await t.json(),a=await e8(e.data,"et");eE(a)}}catch(e){console.warn("ET data fetch failed:",e)}et.toast.success("All data layers fetched successfully")}catch(e){et.toast.error((null==e?void 0:e.message)||"Data fetch error")}finally{ej(!1)}}async function e9(){if(!ey)return et.toast.error("No NDVI data to save");Z(!0);try{var e;let t=await fetch("/api/items",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:eI||"NDVI Analysis ".concat(new Date().toLocaleDateString()),description:"Auto-ingested NDVI analysis for ".concat((null==ep?void 0:null===(e=ep.imagery)||void 0===e?void 0:e.id)||"unknown imagery"),ndviStats:ey.stats,width:ey.width,height:ey.height,previewPng:ey.previewPng,locationName:eI||(null==ek?void 0:ek.name),geojson:(null==ep?void 0:ep.bbox)?{type:"Polygon",coordinates:[[[ep.bbox[0],ep.bbox[1]],[ep.bbox[2],ep.bbox[1]],[ep.bbox[2],ep.bbox[3]],[ep.bbox[0],ep.bbox[3]],[ep.bbox[0],ep.bbox[1]]]]}:null})});if(401===t.status){et.toast.error("Please sign in to save plots."),await e1(),Z(!1);return}let a=await t.json();et.toast.success("Plot saved with ID: ".concat(a.id))}catch(e){et.toast.error((null==e?void 0:e.message)||"Save failed")}finally{Z(!1)}}async function te(){if(!eu)return et.toast.error("Please set a bounding box first");eO(!0);try{let e=eu.split(",").map(e=>Number(e.trim())),t=await fetch("/api/soil",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({bbox:e})});if(!t.ok)throw Error("Soil moisture fetch failed");let a=await t.json(),s=await e8(a.data,"soil");eP(s),et.toast.success("Soil moisture data loaded")}catch(e){et.toast.error((null==e?void 0:e.message)||"Failed to fetch soil moisture")}finally{eO(!1)}}async function tt(){if(!eu)return et.toast.error("Please set a bounding box first");eO(!0);try{let e=eu.split(",").map(e=>Number(e.trim())),t=await fetch("/api/et",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({bbox:e})});if(!t.ok)throw Error("ET fetch failed");let a=await t.json(),s=await e8(a.data,"et");eE(s),et.toast.success("Evapotranspiration data loaded")}catch(e){et.toast.error((null==e?void 0:e.message)||"Failed to fetch evapotranspiration")}finally{eO(!1)}}async function ta(){let e=E||ey;if(!e)return et.toast.error("No NDVI data to export");try{let t=await fetch("/api/export/png",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({ndviData:e,soilData:eA,etData:eT,bbox:null==ep?void 0:ep.bbox,location:eo||"Unknown Location",layerType:eC})});if(!t.ok)throw Error("PNG export failed");let a=await t.json(),s=document.createElement("a");s.href="data:image/png;base64,".concat(a.image),s.download=a.filename,s.click(),et.toast.success("PNG exported successfully")}catch(e){et.toast.error((null==e?void 0:e.message)||"PNG export failed")}}async function ts(){let e=E||ey;if(!e)return et.toast.error("No NDVI data to export");try{let t=await fetch("/api/export/pdf",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({ndviData:e,soilData:eA,etData:eT,weatherData:e_,bbox:null==ep?void 0:ep.bbox,location:eo||"Unknown Location"})});if(!t.ok)throw Error("PDF export failed");let a=await t.json(),s=window.open("","_blank");s&&(s.document.write(a.html),s.document.close()),et.toast.success("PDF report generated successfully")}catch(e){et.toast.error((null==e?void 0:e.message)||"PDF export failed")}}function ti(e){var t,a,s,i,n,l;let r=[],o=new Date().toISOString();return e.mean<.3?r.push({id:"ndvi-low-".concat(o),type:"critical",message:"Low NDVI Detected",details:"Mean NDVI (".concat(e.mean.toFixed(3),") is below critical threshold (0.3). Vegetation may be stressed."),timestamp:o,category:"vegetation",severity:"high"}):e.mean<.4&&r.push({id:"ndvi-moderate-".concat(o),type:"warning",message:"Moderate NDVI Alert",details:"Mean NDVI (".concat(e.mean.toFixed(3),") is below optimal threshold (0.4). Monitor vegetation health."),timestamp:o,category:"vegetation",severity:"medium"}),e.min<.1&&r.push({id:"ndvi-min-".concat(o),type:"warning",message:"Very Low NDVI Areas Detected",details:"Minimum NDVI (".concat(e.min.toFixed(3),") indicates severely stressed vegetation in some areas."),timestamp:o,category:"vegetation",severity:"medium"}),(null==eA?void 0:null===(t=eA.stats)||void 0===t?void 0:t.mean)<.2?r.push({id:"soil-dry-".concat(o),type:"critical",message:"Low Soil Moisture",details:"Soil moisture (".concat(eA.stats.mean.toFixed(3)," m\xb3/m\xb3) is critically low. Irrigation recommended."),timestamp:o,category:"soil",severity:"high"}):(null==eA?void 0:null===(a=eA.stats)||void 0===a?void 0:a.mean)<.25&&r.push({id:"soil-moderate-".concat(o),type:"warning",message:"Moderate Soil Moisture",details:"Soil moisture (".concat(eA.stats.mean.toFixed(3)," m\xb3/m\xb3) is below optimal. Consider irrigation."),timestamp:o,category:"soil",severity:"medium"}),(null==eT?void 0:null===(s=eT.stats)||void 0===s?void 0:s.mean)>7&&r.push({id:"et-high-".concat(o),type:"warning",message:"High Evapotranspiration",details:"ET rate (".concat(eT.stats.mean.toFixed(2)," mm/day) is high. Monitor water usage closely."),timestamp:o,category:"water",severity:"medium"}),(null==e_?void 0:null===(i=e_.current)||void 0===i?void 0:i.temperature)>35&&r.push({id:"temp-high-".concat(o),type:"warning",message:"High Temperature Alert",details:"Temperature (".concat(e_.current.temperature,"\xb0C) is very high. Increase irrigation frequency."),timestamp:o,category:"weather",severity:"medium"}),(null==e_?void 0:null===(n=e_.current)||void 0===n?void 0:n.humidity)<30&&r.push({id:"humidity-low-".concat(o),type:"warning",message:"Low Humidity Alert",details:"Humidity (".concat(e_.current.humidity,"%) is very low. Monitor plant stress."),timestamp:o,category:"weather",severity:"medium"}),e.mean<.35&&(null==eA?void 0:null===(l=eA.stats)||void 0===l?void 0:l.mean)<.25&&(null==e_?void 0:e_.forecast)&&!e_.forecast.some(e=>{var t;return(null===(t=e.condition)||void 0===t?void 0:t.toLowerCase().includes("rain"))||e.precipitation>5})&&r.push({id:"irrigation-predictive-".concat(o),type:"critical",message:"Predictive Irrigation Alert",details:"Low NDVI and soil moisture detected with no rain forecast. Immediate irrigation recommended.",timestamp:o,category:"irrigation",severity:"high"}),eL(e=>[...e,...r]),r.forEach(e=>{"critical"===e.type?et.toast.error(e.message,{description:e.details}):"warning"===e.type&&et.toast.warning(e.message,{description:e.details})}),r}async function tn(){if(!eu)return et.toast.error("Please set a bounding box first");eX(!0);try{let e=eu.split(",").map(e=>Number(e.trim())),t=await fetch("/api/timeseries",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({bbox:e,startDate:"2024-01-01",endDate:new Date().toISOString().split("T")[0],interval:"monthly"})});if(!t.ok)throw Error("Time series fetch failed");let a=await t.json();eJ(a.data),et.toast.success("Time series data loaded")}catch(e){et.toast.error((null==e?void 0:e.message)||"Failed to fetch time series data")}finally{eX(!1)}}async function tl(){let e=E||ey;if(!e)return et.toast.error("No NDVI data to analyze");ee("Running enhanced analysis...");try{let t=await fetch("/api/gemini",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({prompt:"Analyze farm health based on NDVI data: min=".concat(e.stats.min.toFixed(3),", max=").concat(e.stats.max.toFixed(3),", mean=").concat(e.stats.mean.toFixed(3),". Provide health assessment and 3 actionable recommendations."),ndviData:e,weatherData:e_,timeSeriesData:eR,analysisType:eH})});if(429===t.status){let e=await t.json().catch(()=>({}));ee(e.message||"Rate limit exceeded. Please wait a moment and try again.");return}if(!t.ok){let e=await t.json().catch(()=>({}));ee(e.message||"Error: ".concat(t.statusText,". Using fallback analysis."));return}let a=await t.json();console.log("AI Analysis result:",a),ee(a.suggestion||a.output||"Analysis completed")}catch(t){console.error("Enhanced AI Analysis error:",t),((null==t?void 0:t.message)||"").includes("rate limit")?ee("Rate limit exceeded. Please wait a moment and try again."):ee(e3(e.stats))}}(0,i.useEffect)(()=>{(async()=>{try{if(!ek)return;let e=await fetch("/api/weather",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({location:ek})}),t=await e.json().catch(()=>null);t&&eW(t)}catch(e){}})()},[null==ek?void 0:ek.lat,null==ek?void 0:ek.lon]),(0,i.useEffect)(()=>{if(!A||!K.I8){er(null);return}return(0,Q.Aj)(K.I8,er)},[]),(0,i.useEffect)(()=>{try{let e=eZ.map(e=>{var t;return{...e,plotId:ei||(null==ep?void 0:null===(t=ep.imagery)||void 0===t?void 0:t.id)||"Current AOI",plotName:eI||(null==ek?void 0:ek.name)||"Current AOI"}});window.dispatchEvent(new CustomEvent("agrisense:alerts",{detail:e}))}catch(e){}},[JSON.stringify(eZ),ei,null==ep?void 0:null===(e=ep.imagery)||void 0===e?void 0:e.id,eI,null==ek?void 0:ek.name]),(0,i.useEffect)(()=>{if(!$){eK("");return}let e=0;eK("");let t=window.setInterval(()=>{e++,eK($.slice(0,e)),e>=$.length&&window.clearInterval(t)},15);return()=>window.clearInterval(t)},[$]);let tr=(null==ey?void 0:ey.previewPng)&&(null==ep?void 0:ep.bbox)?[{position:[(ep.bbox[1]+ep.bbox[3])/2,(ep.bbox[0]+ep.bbox[2])/2],label:"Center of AOI"}]:[];return(0,s.jsxs)("div",{className:"min-h-screen bg-gradient-to-br from-green-50 to-blue-50 dark:from-gray-900 dark:to-gray-800",children:[(0,s.jsx)(z.Z,{}),(0,s.jsxs)("main",{className:"max-w-7xl mx-auto px-6 py-8",children:[(0,s.jsxs)("div",{className:"text-center mb-8",children:[(0,s.jsxs)("div",{className:"flex items-center justify-center gap-2 mb-4",children:[(0,s.jsx)(R.Z,{className:"h-8 w-8 text-blue-600 dark:text-blue-400"}),(0,s.jsx)("h1",{className:"text-4xl font-bold bg-gradient-to-r from-green-600 to-blue-600 dark:from-green-400 dark:to-blue-400 bg-clip-text text-transparent",children:"AgriSense Dashboard"})]}),(0,s.jsx)("p",{className:"text-lg text-muted-foreground max-w-2xl mx-auto",children:"Upload satellite imagery or auto-ingest from Sentinel-2 to analyze vegetation health with NDVI"})]}),(0,s.jsx)("div",{className:"mb-8",children:(0,s.jsxs)("div",{className:"flex space-x-1 bg-muted p-1 rounded-lg w-fit mx-auto",children:[(0,s.jsxs)("button",{onClick:()=>T("auto-ingest"),className:"px-4 py-2 rounded-md text-sm font-medium transition-colors ".concat("auto-ingest"===P?"bg-background text-foreground shadow-sm":"text-muted-foreground hover:text-foreground"),children:[(0,s.jsx)(J.Z,{className:"h-4 w-4 inline mr-2"}),"Auto Ingest"]}),(0,s.jsxs)("button",{onClick:()=>T("upload"),className:"px-4 py-2 rounded-md text-sm font-medium transition-colors ".concat("upload"===P?"bg-background text-foreground shadow-sm":"text-muted-foreground hover:text-foreground"),children:[(0,s.jsx)(_.Z,{className:"h-4 w-4 inline mr-2"}),"Upload Analysis"]})]})}),"upload"===P&&(0,s.jsxs)("div",{className:"space-y-8",children:[(0,s.jsxs)("div",{className:"grid lg:grid-cols-2 gap-8",children:[(0,s.jsxs)(h,{children:[(0,s.jsxs)(g,{children:[(0,s.jsxs)(p,{className:"flex items-center gap-2",children:[(0,s.jsx)(W.Z,{className:"h-5 w-5 text-green-600 dark:text-green-400"}),"Upload & Analyze"]}),(0,s.jsx)(f,{children:"Upload a Sentinel GeoTIFF with Red (B4) and NIR (B8) bands"})]}),(0,s.jsxs)(v,{className:"space-y-4",children:[(0,s.jsx)(l,{onNDVIReady:e=>{M(e),ti(e.stats)}}),E&&(0,s.jsxs)("div",{className:"space-y-3",children:[(0,s.jsxs)("div",{className:"flex items-center justify-between",children:[(0,s.jsx)("span",{className:"text-sm font-medium",children:"Health Status:"}),(F=E.stats.mean)>.6?(0,s.jsx)(N,{className:"bg-green-500 text-white",children:"Excellent"}):F>.4?(0,s.jsx)(N,{className:"bg-yellow-500 text-white",children:"Good"}):F>.2?(0,s.jsx)(N,{className:"bg-orange-500 text-white",children:"Moderate"}):(0,s.jsx)(N,{className:"bg-red-500 text-white",children:"Poor"})]}),(0,s.jsxs)("div",{className:"grid grid-cols-3 gap-4 text-sm",children:[(0,s.jsxs)("div",{className:"text-center p-2 bg-muted rounded",children:[(0,s.jsx)("div",{className:"font-semibold text-red-600 dark:text-red-400",children:E.stats.min.toFixed(3)}),(0,s.jsx)("div",{className:"text-xs text-muted-foreground",children:"Min NDVI"})]}),(0,s.jsxs)("div",{className:"text-center p-2 bg-muted rounded",children:[(0,s.jsx)("div",{className:"font-semibold text-blue-600 dark:text-blue-400",children:E.stats.mean.toFixed(3)}),(0,s.jsx)("div",{className:"text-xs text-muted-foreground",children:"Mean NDVI"})]}),(0,s.jsxs)("div",{className:"text-center p-2 bg-muted rounded",children:[(0,s.jsx)("div",{className:"font-semibold text-green-600 dark:text-green-400",children:E.stats.max.toFixed(3)}),(0,s.jsx)("div",{className:"text-xs text-muted-foreground",children:"Max NDVI"})]})]})]}),(0,s.jsxs)("div",{className:"flex gap-2",children:[(0,s.jsx)(d.z,{onClick:e4,disabled:!E||O,className:"flex-1",children:O?"Saving...":"Save Analysis"}),(0,s.jsxs)(d.z,{variant:"outline",onClick:e5,disabled:!E,className:"flex-1",children:[(0,s.jsx)(H.Z,{className:"h-4 w-4 mr-2"}),"AI Analysis"]})]}),E&&(0,s.jsxs)("div",{className:"flex gap-2",children:[(0,s.jsxs)(d.z,{variant:"outline",onClick:ta,className:"flex-1",children:[(0,s.jsx)(U.Z,{className:"h-4 w-4 mr-2"}),"Export PNG"]}),(0,s.jsxs)(d.z,{variant:"outline",onClick:ts,className:"flex-1",children:[(0,s.jsx)(U.Z,{className:"h-4 w-4 mr-2"}),"Export PDF"]})]}),ei&&(0,s.jsxs)("div",{className:"text-sm text-green-600 dark:text-green-400 bg-green-50 dark:bg-green-900/20 p-2 rounded",children:["✓ Analysis saved with ID: ",ei]})]})]}),(0,s.jsxs)(h,{children:[(0,s.jsxs)(g,{children:[(0,s.jsx)(p,{children:"NDVI Heatmap"}),(0,s.jsx)(f,{children:"Green = Healthy vegetation, Red = Stressed/sparse vegetation"})]}),(0,s.jsx)(v,{className:"flex items-center justify-center min-h-[400px]",children:E?(0,s.jsxs)("div",{className:"space-y-4",children:[(0,s.jsx)(r,{ndvi:E.ndvi,width:E.width,height:E.height}),(0,s.jsxs)("div",{className:"flex items-center justify-center gap-4 text-xs",children:[(0,s.jsxs)("div",{className:"flex items-center gap-1",children:[(0,s.jsx)("div",{className:"w-3 h-3 bg-red-500 rounded"}),(0,s.jsx)("span",{children:"Stressed"})]}),(0,s.jsxs)("div",{className:"flex items-center gap-1",children:[(0,s.jsx)("div",{className:"w-3 h-3 bg-yellow-500 rounded"}),(0,s.jsx)("span",{children:"Moderate"})]}),(0,s.jsxs)("div",{className:"flex items-center gap-1",children:[(0,s.jsx)("div",{className:"w-3 h-3 bg-green-500 rounded"}),(0,s.jsx)("span",{children:"Healthy"})]})]})]}):(0,s.jsxs)("div",{className:"text-center text-muted-foreground",children:[(0,s.jsx)(R.Z,{className:"h-12 w-12 mx-auto mb-4 opacity-50"}),(0,s.jsx)("p",{children:"Upload satellite imagery to view NDVI heatmap"})]})})]})]}),$&&(0,s.jsxs)(h,{children:[(0,s.jsx)(g,{children:(0,s.jsxs)(p,{className:"flex items-center gap-2",children:[(0,s.jsx)(G.Z,{className:"h-5 w-5 text-orange-600 dark:text-orange-400"}),"AI Health Analysis"]})}),(0,s.jsx)(v,{children:(0,s.jsx)("div",{className:"whitespace-pre-wrap text-sm bg-muted p-4 rounded-lg",children:eY})})]})]}),"auto-ingest"===P&&(0,s.jsxs)("div",{className:"space-y-8",children:[(0,s.jsx)("div",{className:"grid gap-8",children:(0,s.jsx)("div",{children:(0,s.jsxs)(h,{children:[(0,s.jsxs)(g,{children:[(0,s.jsxs)(p,{className:"flex items-center gap-2",children:[(0,s.jsx)(J.Z,{className:"h-5 w-5 text-blue-600 dark:text-blue-400"}),"Location Selection Map"]}),(0,s.jsx)(f,{children:"Search a location, draw an area of interest, then fetch data automatically"})]}),(0,s.jsxs)(v,{children:[(0,s.jsx)("div",{className:"rounded-lg border bg-card overflow-hidden",style:{height:"600px",zIndex:0},children:(0,s.jsx)(ea,{bbox:eu?eu.split(",").map(Number):void 0,onBboxChange:e=>ex(e.join(",")),polygon:eN,onPolygonChange:e=>{try{eb(e),function(e){if(!e||!Array.isArray(e)||0===e.length)return;let t=1/0,a=1/0,s=-1/0,i=-1/0,n=e.flat();for(let e=0;e<n.length;e+=2){let l=n[e],r=n[e+1];"number"==typeof l&&"number"==typeof r&&(l<t&&(t=l),l>s&&(s=l),r<a&&(a=r),r>i&&(i=r))}t!==1/0&&a!==1/0&&s!==-1/0&&i!==-1/0&&ex("".concat(t,",").concat(a,",").concat(s,",").concat(i))}(e)}catch(e){console.warn("Error processing polygon coordinates:",e)}},ndviPng:null,ndviBounds:null==ep?void 0:ep.bbox,hotspots:tr})}),(0,s.jsxs)("div",{className:"grid md:grid-cols-4 gap-3 items-end",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"text-xs text-muted-foreground",children:"Search place"}),(0,s.jsxs)("div",{className:"flex gap-2",children:[(0,s.jsx)("input",{className:"border rounded px-2 py-1 w-full bg-background text-foreground",value:eo,onChange:e=>ed(e.target.value),placeholder:"e.g., Iowa City"}),(0,s.jsx)(d.z,{variant:"secondary",onClick:e6,disabled:ev,children:ev?"Searching…":"Find"})]}),ec.length>0&&(0,s.jsx)("div",{className:"mt-2 border rounded bg-background text-sm max-h-48 overflow-auto",children:ec.map(e=>(0,s.jsx)("div",{className:"px-2 py-1 hover:bg-accent cursor-pointer",onClick:()=>(function(e){var t;if((null==e?void 0:null===(t=e.bbox)||void 0===t?void 0:t.length)===4){let[t,a,s,i]=e.bbox;ex("".concat(s,",").concat(t,",").concat(i,",").concat(a))}(null==e?void 0:e.lat)&&(null==e?void 0:e.lon)&&eS({lat:e.lat,lon:e.lon,name:e.display_name||e.name||"Selected Location"}),em([])})(e),children:e.display_name},e.display_name))})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"text-xs text-muted-foreground",children:"BBox [minx,miny,maxx,maxy]"}),(0,s.jsx)("input",{className:"border rounded px-2 py-1 w-full bg-background text-foreground",value:eu,onChange:e=>ex(e.target.value),placeholder:"-122.52,37.70,-122.35,37.83"})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"text-xs text-muted-foreground",children:"Date range (ISO/ISO)"}),(0,s.jsx)("input",{className:"border rounded px-2 py-1 w-full bg-background text-foreground",value:eh,onChange:e=>eg(e.target.value),placeholder:"2025-08-01/2025-08-10"})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"text-xs text-muted-foreground",children:"Location name"}),(0,s.jsx)("input",{className:"border rounded px-2 py-1 w-full bg-background text-foreground",value:eI,onChange:e=>{eD(e.target.value),eS(t=>t?{...t,name:e.target.value}:null)},placeholder:"e.g., North Field"})]})]}),(0,s.jsxs)("div",{className:"mt-3 flex gap-2",children:[(0,s.jsx)(d.z,{onClick:e7,disabled:ev||!eu,className:"flex-1",children:ev?"Fetching…":"Fetch Data"}),(0,s.jsx)(d.z,{variant:"outline",onClick:()=>{ex(""),eb([]),ef(null),ew(null),eP(null),eE(null),eF("ndvi")},className:"px-3",children:(0,s.jsx)(B.Z,{className:"h-4 w-4"})})]})]})]})})}),(0,s.jsx)(V,{bbox:eu?eu.split(",").map(Number):void 0,date:eh,searchLocation:ek}),ep&&(0,s.jsxs)("div",{className:"space-y-4",children:[(0,s.jsxs)(h,{children:[(0,s.jsx)(g,{children:(0,s.jsx)(p,{children:"Imagery Found"})}),(0,s.jsxs)(v,{children:[(0,s.jsxs)("div",{className:"text-sm text-muted-foreground space-y-1",children:[(0,s.jsxs)("div",{className:"break-words overflow-hidden",children:["Imagery: ",(0,s.jsx)("span",{className:"break-all",children:null===(t=ep.imagery)||void 0===t?void 0:t.id})]}),(0,s.jsxs)("div",{className:"break-words overflow-hidden",children:["Date: ",(0,s.jsx)("span",{className:"break-all",children:null===(a=ep.imagery)||void 0===a?void 0:a.date})]}),(0,s.jsxs)("div",{className:"break-words overflow-hidden",children:["Cloud Cover: ",null===(o=ep.imagery)||void 0===o?void 0:null===(n=o.cloudCover)||void 0===n?void 0:n.toFixed(1),"%"]}),(0,s.jsxs)("div",{className:"break-words overflow-hidden",children:["Platform: ",(0,s.jsx)("span",{className:"break-all",children:null===(c=ep.imagery)||void 0===c?void 0:c.platform})]})]}),ep.message&&(0,s.jsx)("div",{className:"mt-3 p-2 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded text-xs text-blue-800 dark:text-blue-200 break-words overflow-hidden",children:ep.message})]})]}),ep.assets&&(0,s.jsxs)(h,{children:[(0,s.jsxs)(g,{className:"pb-4",children:[(0,s.jsx)(p,{className:"text-lg",children:"NDVI Processing"}),(0,s.jsx)(f,{children:"Process satellite imagery to generate NDVI heatmap"})]}),(0,s.jsxs)(v,{className:"space-y-6",children:[(0,s.jsx)(u,{assets:ep.assets,onNDVIReady:e=>{ew(e),eV("ndvi"),te(),tt(),ti(e.stats),et.toast.success("NDVI analysis completed! Loaded Soil & ET layers.")}}),ey&&(0,s.jsxs)("div",{className:"space-y-4",children:[eA&&eT&&(0,s.jsxs)("div",{className:"flex flex-wrap gap-2",children:[(0,s.jsx)(d.z,{size:"sm",variant:"ndvi"===eM?"default":"outline",onClick:()=>eV("ndvi"),children:"NDVI"}),(0,s.jsx)(d.z,{size:"sm",variant:"soil"===eM?"default":"outline",onClick:()=>eV("soil"),children:"Soil Moisture"}),(0,s.jsx)(d.z,{size:"sm",variant:"et"===eM?"default":"outline",onClick:()=>eV("et"),children:"Evapotranspiration"})]}),(0,s.jsxs)("div",{className:"grid md:grid-cols-2 gap-4 items-start",children:[(0,s.jsxs)("div",{className:"relative border rounded-lg p-2 bg-muted/30",children:[(0,s.jsxs)("div",{className:"absolute right-3 top-3 z-10 flex items-center gap-2",children:[(0,s.jsx)("label",{className:"text-xs",children:"Zones"}),(0,s.jsx)("input",{type:"checkbox",checked:eQ,onChange:e=>e$(e.target.checked)})]}),"ndvi"===eM&&(null==ey?void 0:ey.previewPng)&&(0,s.jsx)("img",{src:"data:image/png;base64,".concat(ey.previewPng),alt:"NDVI",className:"w-full h-[400px] object-contain rounded"}),"soil"===eM&&(null==eA?void 0:eA.overlayPng)&&(0,s.jsx)("img",{src:"data:image/png;base64,".concat(eA.overlayPng),alt:"Soil Moisture",className:"w-full h-[400px] object-contain rounded"}),"et"===eM&&(null==eT?void 0:eT.overlayPng)&&(0,s.jsx)("img",{src:"data:image/png;base64,".concat(eT.overlayPng),alt:"Evapotranspiration",className:"w-full h-[400px] object-contain rounded"}),eQ&&(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)("div",{className:"absolute inset-2 pointer-events-auto",style:{display:"grid",gridTemplateColumns:"repeat(3,1fr)",gridTemplateRows:"repeat(3,1fr)"},children:Array.from({length:9}).map((e,t)=>(0,s.jsx)("div",{onClick:()=>e2(!0),className:"relative border border-white/50 hover:bg-red-500/10 cursor-pointer",children:(0,s.jsxs)("span",{className:"absolute top-1 left-1 text-[10px] bg-black/40 text-white px-1 rounded",children:["Grid ",t+1]})},t))}),e0&&(0,s.jsxs)("div",{className:"absolute bottom-3 left-3 right-3 md:right-auto md:w-80 z-20 rounded-lg border bg-background/95 backdrop-blur p-3 shadow",children:[(0,s.jsxs)("div",{className:"flex items-start justify-between gap-2",children:[(0,s.jsx)("div",{className:"font-medium",children:"Zone Details"}),(0,s.jsx)("button",{className:"text-xs opacity-70 hover:opacity-100",onClick:()=>e2(!1),children:"Close"})]}),(0,s.jsxs)("div",{className:"mt-2 text-xs space-y-1",children:[(0,s.jsxs)("div",{children:["Health: ",(null==ey?void 0:null===(m=ey.stats)||void 0===m?void 0:m.mean)?Math.round((ey.stats.mean+1)*50):75,"%"]}),(0,s.jsxs)("div",{children:["Soil Moisture: ",null!==(I=null==eA?void 0:null===(y=eA.stats)||void 0===y?void 0:null===(b=y.mean)||void 0===b?void 0:null===(j=b.toFixed)||void 0===j?void 0:j.call(b,2))&&void 0!==I?I:"0.25"," m\xb3/m\xb3"]}),(0,s.jsxs)("div",{children:["ET: ",null!==(C=null==eT?void 0:null===(S=eT.stats)||void 0===S?void 0:null===(k=S.mean)||void 0===k?void 0:null===(w=k.toFixed)||void 0===w?void 0:w.call(k,1))&&void 0!==C?C:"3.5"," mm/day"]}),(0,s.jsx)("div",{className:"text-muted-foreground",children:"Sprinkler: Auto mode • Next run: 6:00 AM"})]})]})]})]}),(0,s.jsxs)("div",{className:"space-y-4",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("div",{className:"font-semibold mb-2",children:"Layer Information"}),(0,s.jsxs)("div",{className:"grid grid-cols-1 gap-3 text-sm",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("div",{className:"font-medium mb-1",children:"NDVI"}),(0,s.jsxs)("div",{className:"flex items-center gap-2 mb-1",children:[(0,s.jsx)("div",{className:"w-4 h-4 bg-red-500 rounded"})," ",(0,s.jsx)("span",{children:"Stressed (0.0 - 0.2)"})]}),(0,s.jsxs)("div",{className:"flex items-center gap-2 mb-1",children:[(0,s.jsx)("div",{className:"w-4 h-4 bg-yellow-500 rounded"})," ",(0,s.jsx)("span",{children:"Moderate (0.2 - 0.4)"})]}),(0,s.jsxs)("div",{className:"flex items-center gap-2",children:[(0,s.jsx)("div",{className:"w-4 h-4 bg-green-500 rounded"})," ",(0,s.jsx)("span",{children:"Healthy (0.4 - 0.8)"})]})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("div",{className:"font-medium mb-1",children:"Soil Moisture"}),(0,s.jsxs)("div",{className:"flex items-center gap-2 mb-1",children:[(0,s.jsx)("div",{className:"w-4 h-4 bg-amber-800 rounded"})," ",(0,s.jsx)("span",{children:"Dry"})]}),(0,s.jsxs)("div",{className:"flex items-center gap-2 mb-1",children:[(0,s.jsx)("div",{className:"w-4 h-4 bg-amber-400 rounded"})," ",(0,s.jsx)("span",{children:"Moderate"})]}),(0,s.jsxs)("div",{className:"flex items-center gap-2",children:[(0,s.jsx)("div",{className:"w-4 h-4 bg-blue-500 rounded"})," ",(0,s.jsx)("span",{children:"Wet"})]})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("div",{className:"font-medium mb-1",children:"Evapotranspiration"}),(0,s.jsxs)("div",{className:"flex items-center gap-2 mb-1",children:[(0,s.jsx)("div",{className:"w-4 h-4 bg-red-500 rounded"})," ",(0,s.jsx)("span",{children:"Low (0-2 mm/day)"})]}),(0,s.jsxs)("div",{className:"flex items-center gap-2 mb-1",children:[(0,s.jsx)("div",{className:"w-4 h-4 bg-yellow-500 rounded"})," ",(0,s.jsx)("span",{children:"Moderate (2-4)"})]}),(0,s.jsxs)("div",{className:"flex items-center gap-2",children:[(0,s.jsx)("div",{className:"w-4 h-4 bg-green-500 rounded"})," ",(0,s.jsx)("span",{children:"High (4+)"})]})]})]})]}),(0,s.jsxs)("div",{className:"grid grid-cols-2 gap-4 text-xs",children:[ey&&(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)("div",{className:"flex justify-between",children:[(0,s.jsx)("span",{className:"text-muted-foreground",children:"NDVI min:"}),(0,s.jsx)("span",{className:"font-medium",children:ey.stats.min.toFixed(3)})]}),(0,s.jsxs)("div",{className:"flex justify-between",children:[(0,s.jsx)("span",{className:"text-muted-foreground",children:"NDVI mean:"}),(0,s.jsx)("span",{className:"font-medium",children:ey.stats.mean.toFixed(3)})]}),(0,s.jsxs)("div",{className:"flex justify-between",children:[(0,s.jsx)("span",{className:"text-muted-foreground",children:"NDVI max:"}),(0,s.jsx)("span",{className:"font-medium",children:ey.stats.max.toFixed(3)})]})]}),(null==eA?void 0:eA.stats)&&(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)("div",{className:"flex justify-between",children:[(0,s.jsx)("span",{className:"text-muted-foreground",children:"Soil min:"}),(0,s.jsx)("span",{className:"font-medium",children:eA.stats.min.toFixed(3)})]}),(0,s.jsxs)("div",{className:"flex justify-between",children:[(0,s.jsx)("span",{className:"text-muted-foreground",children:"Soil mean:"}),(0,s.jsx)("span",{className:"font-medium",children:eA.stats.mean.toFixed(3)})]}),(0,s.jsxs)("div",{className:"flex justify-between",children:[(0,s.jsx)("span",{className:"text-muted-foreground",children:"Soil max:"}),(0,s.jsx)("span",{className:"font-medium",children:eA.stats.max.toFixed(3)})]})]}),(null==eT?void 0:eT.stats)&&(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)("div",{className:"flex justify-between",children:[(0,s.jsx)("span",{className:"text-muted-foreground",children:"ET min:"}),(0,s.jsx)("span",{className:"font-medium",children:eT.stats.min.toFixed(2)})]}),(0,s.jsxs)("div",{className:"flex justify-between",children:[(0,s.jsx)("span",{className:"text-muted-foreground",children:"ET mean:"}),(0,s.jsx)("span",{className:"font-medium",children:eT.stats.mean.toFixed(2)})]}),(0,s.jsxs)("div",{className:"flex justify-between",children:[(0,s.jsx)("span",{className:"text-muted-foreground",children:"ET max:"}),(0,s.jsx)("span",{className:"font-medium",children:eT.stats.max.toFixed(2)})]})]})]})]})]})]})]})]}),ey&&(0,s.jsxs)("div",{className:"flex gap-2",children:[(0,s.jsx)(d.z,{onClick:e9,disabled:O,className:"bg-green-600 hover:bg-green-700",children:O?"Saving...":"Save Analysis"}),(0,s.jsxs)(d.z,{variant:"outline",onClick:ta,children:[(0,s.jsx)(U.Z,{className:"h-4 w-4 mr-2"}),"Export PNG"]}),(0,s.jsxs)(d.z,{variant:"outline",onClick:ts,children:[(0,s.jsx)(U.Z,{className:"h-4 w-4 mr-2"}),"Export PDF"]})]})]})]}),eZ.length>0&&(0,s.jsxs)(h,{className:"mt-8",children:[(0,s.jsx)(g,{children:(0,s.jsxs)(p,{className:"flex items-center gap-2",children:[(0,s.jsx)(q.Z,{className:"h-5 w-5 text-orange-600 dark:text-orange-400"}),"Threshold Alerts"]})}),(0,s.jsx)(v,{children:(0,s.jsx)("div",{className:"space-y-3",children:eZ.map(e=>(0,s.jsxs)("div",{className:"p-3 rounded-lg border ".concat("critical"===e.type?"bg-red-50 dark:bg-red-900/20 border-red-200 dark:border-red-800 text-red-800 dark:text-red-200":"bg-yellow-50 dark:bg-yellow-900/20 border-yellow-200 dark:border-yellow-800 text-yellow-800 dark:text-yellow-200"),children:[(0,s.jsx)("div",{className:"font-medium",children:e.message}),(0,s.jsx)("div",{className:"text-sm opacity-80",children:e.details})]},e.id))})})]}),(E||ey)&&(0,s.jsxs)("div",{className:"mt-8 space-y-8",children:[(0,s.jsxs)(h,{children:[(0,s.jsxs)(g,{children:[(0,s.jsxs)(p,{className:"flex items-center gap-2",children:[(0,s.jsx)(H.Z,{className:"h-5 w-5 text-blue-600 dark:text-blue-400"}),"Historical Trends"]}),(0,s.jsx)(f,{children:"NDVI time series analysis and seasonal patterns"})]}),(0,s.jsx)(v,{children:(0,s.jsxs)("div",{className:"space-y-4",children:[(0,s.jsx)(d.z,{onClick:tn,disabled:!eu||eq,className:"w-full",children:eq?"Loading...":"Load Time Series Data"}),eR&&(0,s.jsxs)("div",{className:"space-y-4",children:[(0,s.jsx)(x.Z,{data:eR.timeSeries,title:"NDVI Time Series",showConfidence:!0,showCloudCover:!0}),eR.summary&&(0,s.jsxs)("div",{className:"grid md:grid-cols-3 gap-4",children:[(0,s.jsxs)("div",{className:"text-center p-3 bg-muted rounded",children:[(0,s.jsx)("div",{className:"text-lg font-semibold",children:eR.summary.trend}),(0,s.jsx)("div",{className:"text-xs text-muted-foreground",children:"Overall Trend"})]}),(0,s.jsxs)("div",{className:"text-center p-3 bg-muted rounded",children:[(0,s.jsx)("div",{className:"text-lg font-semibold",children:eR.summary.averageNDVI.toFixed(3)}),(0,s.jsx)("div",{className:"text-xs text-muted-foreground",children:"Average NDVI"})]}),(0,s.jsxs)("div",{className:"text-center p-3 bg-muted rounded",children:[(0,s.jsx)("div",{className:"text-lg font-semibold",children:eR.summary.totalPoints}),(0,s.jsx)("div",{className:"text-xs text-muted-foreground",children:"Data Points"})]})]})]})]})})]}),(0,s.jsxs)(h,{children:[(0,s.jsxs)(g,{children:[(0,s.jsxs)(p,{className:"flex items-center gap-2",children:[(0,s.jsx)(X.Z,{className:"h-5 w-5 text-purple-600 dark:text-purple-400"}),"Enhanced Analytics (Phase 2)"]}),(0,s.jsx)(f,{children:"Advanced analysis with weather integration and time series data"})]}),(0,s.jsx)(v,{children:(0,s.jsxs)("div",{className:"space-y-4",children:[(0,s.jsxs)("div",{className:"flex gap-2 flex-wrap",children:[(0,s.jsx)(d.z,{variant:"basic"===eH?"default":"outline",onClick:()=>eU("basic"),size:"sm",children:"Basic Analysis"}),(0,s.jsxs)(d.z,{variant:"weather"===eH?"default":"outline",onClick:()=>eU("weather"),size:"sm",disabled:!e_,children:[(0,s.jsx)(D.Z,{className:"h-4 w-4 mr-1"}),"Weather Analysis"]}),(0,s.jsxs)(d.z,{variant:"trend"===eH?"default":"outline",onClick:()=>eU("trend"),size:"sm",disabled:!eR,children:[(0,s.jsx)(H.Z,{className:"h-4 w-4 mr-1"}),"Trend Analysis"]}),(0,s.jsxs)(d.z,{variant:"comprehensive"===eH?"default":"outline",onClick:()=>eU("comprehensive"),size:"sm",disabled:!e_||!eR,children:[(0,s.jsx)(Y.Z,{className:"h-4 w-4 mr-1"}),"Comprehensive"]})]}),(0,s.jsxs)(d.z,{onClick:()=>{console.log("AI Analysis button clicked"),console.log("Current data:",E||ey),tl()},disabled:!E&&!ey,className:"w-full",children:[(0,s.jsx)(X.Z,{className:"h-4 w-4 mr-2"}),"Run Enhanced AI Analysis"]}),eY&&(0,s.jsxs)("div",{className:"mt-4 p-4 bg-muted rounded-lg",children:[(0,s.jsx)("h4",{className:"font-medium mb-2",children:"AI Analysis Results:"}),(0,s.jsx)("div",{className:"whitespace-pre-wrap text-sm",children:eY})]})]})})]}),(0,s.jsx)("div",{className:"lg:col-span-1",children:(0,s.jsxs)(h,{children:[(0,s.jsxs)(g,{children:[(0,s.jsxs)(p,{className:"flex items-center gap-2",children:[(0,s.jsx)(Y.Z,{className:"h-5 w-5 text-green-600 dark:text-green-400"}),"Interactive 3D Visualization"]}),(0,s.jsx)(f,{children:"Advanced 3D mapping with deck.gl"})]}),(0,s.jsx)(v,{children:(0,s.jsxs)("div",{className:"space-y-4",children:[(0,s.jsxs)(d.z,{onClick:()=>eB(!eG),className:"w-full",children:[eG?"Hide":"Show"," Interactive Map"]}),eG&&(E||ey)&&(0,s.jsx)(es,{ndviData:E||ey,bbox:null==ep?void 0:ep.bbox,show3D:!0,layerType:"scatter",location:ek})]})})]})})]}),(0,s.jsx)(L,{context:{location:ek,bbox:null==ep?void 0:ep.bbox,ndviStats:(null==ey?void 0:ey.stats)||(null==E?void 0:E.stats),soilStats:null==eA?void 0:eA.stats,etStats:null==eT?void 0:eT.stats,weather:e_,timeSeries:null==eR?void 0:eR.summary}})]})]})}},3752:function(){},3640:function(){}},function(e){e.O(0,[551,118,336,712,993,948,888,774,179],function(){return e(e.s=528)}),_N_E=e.O()}]);