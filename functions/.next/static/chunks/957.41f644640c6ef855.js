"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[957],{5957:function(e,t,n){n.r(t),n.d(t,{default:function(){return x}});var i=n(5893),o=n(7294),l=n(4250),r=n(9477),a=n(9365);let s=(0,n(1373).Z)("mountain",[["path",{d:"m8 3 4 8 5-5 5 15H2L8 3z",key:"otkl63"}]]);var d=n(6316);let u={ndvi:[{stop:0,color:[53,74,193]},{stop:.15,color:[69,138,223]},{stop:.32,color:[71,192,220]},{stop:.48,color:[95,205,116]},{stop:.64,color:[220,211,88]},{stop:.8,color:[239,163,68]},{stop:1,color:[214,83,90]}],soil:[{stop:0,color:[65,83,191]},{stop:.2,color:[80,145,220]},{stop:.4,color:[86,196,181]},{stop:.58,color:[122,203,117]},{stop:.76,color:[231,195,86]},{stop:1,color:[191,96,60]}],et:[{stop:0,color:[55,70,189]},{stop:.2,color:[64,124,221]},{stop:.4,color:[78,196,215]},{stop:.6,color:[108,205,112]},{stop:.78,color:[239,190,82]},{stop:1,color:[209,84,72]}]};function c(e,t,n){return Math.max(t,Math.min(n,e))}function h(e){if(!e||!e.includes("-"))return null;let[t,n]=e.split("-"),i=Number(t),o=Number(n);return Number.isFinite(i)&&Number.isFinite(o)?{row:i,col:o}:null}function m(e){let t=e.filter(e=>Number.isFinite(e)),n=t.length?Math.min(...t):0,i=t.length?Math.max(...t):1,o=Math.max(1e-6,i-n);return{min:n,max:i,range:o,apply:e=>(e-n)/o}}async function p(e){return await new Promise((t,n)=>{let i=new Image;i.crossOrigin="anonymous",i.onload=()=>t(i),i.onerror=()=>n(Error("metric_texture_load_failed")),i.src="data:image/png;base64,".concat(e)})}async function f(e,t,n,i,o){let r=i,a=o,s=new Float32Array(i*o),d=Number.POSITIVE_INFINITY,h=Number.NEGATIVE_INFINITY;if(t&&Array.isArray(t.values)&&t.width>0&&t.height>0&&t.values.length>=t.width*t.height){r=t.width,a=t.height,s=new Float32Array(r*a);for(let e=0;e<r*a;e++){let n=Number(t.values[e]),i=Number.isFinite(n)?n:0;s[e]=i,d=Math.min(d,i),h=Math.max(h,i)}}else if(e){let t=await p(e),n=document.createElement("canvas");n.width=i,n.height=o;let l=n.getContext("2d");if(!l)throw Error("metric_texture_context_failed");l.drawImage(t,0,0,i,o);let r=l.getImageData(0,0,i,o).data;s=new Float32Array(i*o);for(let e=0;e<i*o;e++){let t=4*e;if(r[t+3]<5){s[e]=0;continue}let n=(.2126*r[t]+.7152*r[t+1]+.0722*r[t+2])/255;s[e]=n,d=Math.min(d,n),h=Math.max(h,n)}}else throw Error("metric_texture_missing");Number.isFinite(d)&&Number.isFinite(h)||(t&&Number.isFinite(t.min)&&Number.isFinite(t.max)&&t.max>t.min?(d=t.min,h=t.max):(d=0,h=1));let m=Math.max(1e-6,h-d),f=(e,t)=>{var n,i;let o=c(e,0,r-1),l=c(t,0,a-1),d=Math.floor(o),u=Math.floor(l),h=Math.min(r-1,d+1),m=Math.min(a-1,u+1),p=o-d,f=u*r+d,g=u*r+h,x=m*r+d,v=m*r+h,w=(n=s[f])+(s[g]-n)*p;return w+((i=s[x])+(s[v]-i)*p-w)*(l-u)},g=(e,t)=>(f(e/Math.max(1,i-1)*(r-1),t/Math.max(1,o-1)*(a-1))-d)/m,x=document.createElement("canvas");x.width=i,x.height=o;let v=x.getContext("2d");if(!v)throw Error("metric_texture_output_failed");let w=v.createImageData(i,o),y=w.data;for(let e=0;e<o;e++)for(let t=0;t<i;t++){let o=4*(e*i+t),l=g(t,e),[r,a,s]=function(e,t){let n=u[e],i=c(t,0,1);for(let e=0;e<n.length-1;e++){let t=n[e],a=n[e+1];if(i<=a.stop){var o,l,r;let e=(i-t.stop)/Math.max(1e-6,a.stop-t.stop);return[Math.round((o=t.color[0])+(a.color[0]-o)*e),Math.round((l=t.color[1])+(a.color[1]-l)*e),Math.round((r=t.color[2])+(a.color[2]-r)*e)]}}return n[n.length-1].color}(n,l),d=r,h=a,m=s,p=18*l,f=Math.abs(p-Math.round(p));if(f<.02){var M,b,N;let e=f<.009?.5:.28;d=Math.round((M=d)+(12-M)*e),h=Math.round((b=h)+(22-b)*e),m=Math.round((N=m)+(42-N)*e)}y[o]=d,y[o+1]=h,y[o+2]=m,y[o+3]=255}v.putImageData(w,0,0);let j=new l.ROQ(x);return j.colorSpace=l.KI_,j.wrapS=l.uWy,j.wrapT=l.uWy,j.needsUpdate=!0,{texture:j,range:{min:d,max:h}}}function g(e){return"soil"===e?"Soil Moisture":"et"===e?"Evapotranspiration":"NDVI"}function x(e){var t,n,p,x;let{open:v,bbox:w,texturePng:y,metricGrid:M,layer:b,selectedCell:N,quality:j="high"}=e,I=(0,o.useRef)(null),[S,E]=(0,o.useState)(!1),[F,A]=(0,o.useState)(null),[_,z]=(0,o.useState)(null),[T,k]=(0,o.useState)(null),[P,D]=(0,o.useState)(null),O=(0,o.useMemo)(()=>h(N),[N]),W=(0,o.useMemo)(()=>(function(e){let t=h(e);return t?"P".concat(3*t.row+t.col+1):null})(N),[N]);return((0,o.useEffect)(()=>{if(!v||!w)return;let e=new AbortController,t="high"===j?[128,96,64]:"balanced"===j?[96,64]:[64];return async function(){E(!0),A(null),z(null);try{let r="Terrain fetch failed";for(let a of t){var n,i,o,l;let t=await fetch("/api/terrain/fetch",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({bbox:w,resolution:a,layer:b,quality:j}),signal:e.signal}),s=await t.json().catch(()=>({}));if(!t.ok||!(null==s?void 0:s.success)){r=String((null==s?void 0:s.message)||(null==s?void 0:s.error)||"Terrain fetch failed (".concat(t.status,")"));continue}let d=!!(null==s?void 0:s.degraded),u=null==s?void 0:s.data,c=u&&Array.isArray(u.demGrid)&&u.demGrid.length>0&&Number(u.width)>1&&Number(u.height)>1;if(d||!c){r=String((null==s?void 0:null===(o=s.warnings)||void 0===o?void 0:o[0])||(null==s?void 0:s.reason)||"Terrain unavailable for the selected AOI.");continue}z(u),k({smoothed:!!(null===(l=null==s?void 0:null===(n=s.meshMeta)||void 0===n?void 0:n.smoothed)||void 0===l||l),resolution:Number((null==s?void 0:null===(i=s.meshMeta)||void 0===i?void 0:i.resolution)||a)}),A(null);return}z(null),A(r)}catch(t){if(e.signal.aborted)return;z(null),A(String((null==t?void 0:t.message)||"Terrain fetch failed"))}finally{e.signal.aborted||E(!1)}}(),()=>e.abort()},[v,b,null==w?void 0:w.join(","),j]),(0,o.useEffect)(()=>{if(!v||!I.current||!_||!Array.isArray(_.demGrid)||0===_.demGrid.length||_.width<2||_.height<2)return;let e=I.current,t=new l.xsS;t.background=new l.Ilk(593690);let n=e.clientWidth||1e3,i=e.clientHeight||420,o=new l.cPb(50,n/i,.1,1400);o.position.set(0,90,148);let s=new r.CP7({antialias:!0,alpha:!1});s.setSize(n,i),s.setPixelRatio(Math.min(2,window.devicePixelRatio||1)),s.outputColorSpace=l.KI_,s.toneMapping=l.LY2,s.toneMappingExposure=1.02,e.innerHTML="",e.appendChild(s.domElement);let d=new a.z(o,s.domElement);d.enableDamping=!0,d.dampingFactor=.08,d.maxPolarAngle=Math.PI/2.03,d.minDistance=30,d.maxDistance=260,d.target.set(0,6,0),t.add(new l.Mig(16777215,.58));let u=new l.Ox3(16055295,1.02);u.position.set(130,140,60),t.add(u);let h=new l.Ox3(9090815,.42);h.position.set(-120,80,-120),t.add(h);let p=function(e,t,n,i){let o=t*n,l=new Float32Array(o);for(let t=0;t<o;t++){let n=Number(e[t]);l[t]=Number.isFinite(n)?n:0}if(i<=0||t<3||n<3)return l;let{min:r,max:a}=m(Array.from(l)),s=Math.max(.5,(a-r)*.18),d=l;for(let e=0;e<i;e++){let e=new Float32Array(o),i=new Float32Array(o);for(let i=0;i<n;i++)for(let n=0;n<t;n++){let o=i*t+n,l=d[i*t+Math.max(0,n-1)],r=d[o],a=d[i*t+Math.min(t-1,n+1)];e[o]=.2*l+.6*r+.2*a}for(let o=0;o<n;o++)for(let r=0;r<t;r++){let a=o*t+r,d=.2*e[Math.max(0,o-1)*t+r]+.6*e[a]+.2*e[Math.min(n-1,o+1)*t+r],u=l[a];i[a]=c(d,u-s,u+s)}d=i}return d}(_.demGrid,_.width,_.height,"high"===j?4:"balanced"===j?2:1),g=m(Array.from(p)),x="high"===j?42:"balanced"===j?36:31,w=new Float32Array(p.length),N="high"===j?80:"balanced"===j?64:52;for(let e=0;e<p.length;e++){let t=Math.pow(c(g.apply(p[e]),0,1),1.08),n=Math.round(t*N)/N;w[e]=(t+(n-t)*.68)*x}let S=new l._12(120,120,_.width-1,_.height-1),E=S.attributes.position;for(let e=0;e<w.length;e++)E.setZ(e,w[e]);E.needsUpdate=!0,S.computeVertexNormals();let F=new l.DvJ(126,9.5,126),A=new l.Wid({color:7041664,roughness:.78,metalness:.03}),z=new l.Kj0(F,A);z.position.set(0,-6.5,0),t.add(z);let T=new l.Wid({color:8228769,metalness:.04,roughness:.86}),k=new l.Kj0(S,T);k.rotation.x=-Math.PI/2,t.add(k);let P=new l.ejS(new l.Uk6(S),new l.nls({color:988970,transparent:!0,opacity:.075}));P.rotation.x=-Math.PI/2,t.add(P);let H=new l.jyz({uniforms:{uMaxHeight:{value:x},uDensity:{value:"high"===j?60:"balanced"===j?48:36},uThickness:{value:.04},uOpacity:{value:.66}},vertexShader:"\n        varying float vHeight;\n        uniform float uMaxHeight;\n        void main() {\n          vHeight = max(0.0, position.z / max(uMaxHeight, 0.001));\n          gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n        }\n      ",fragmentShader:"\n        varying float vHeight;\n        uniform float uDensity;\n        uniform float uThickness;\n        uniform float uOpacity;\n        void main() {\n          float f = fract(vHeight * uDensity);\n          float d = min(f, 1.0 - f);\n          float aa = fwidth(vHeight * uDensity) * 0.9;\n          float line = 1.0 - smoothstep(uThickness, uThickness + aa, d);\n          gl_FragColor = vec4(vec3(0.06, 0.09, 0.13), line * uOpacity);\n        }\n      ",transparent:!0,depthWrite:!1}),C=new l.Kj0(S,H);C.rotation.x=-Math.PI/2,C.position.y=.26,t.add(C);let R=[],V=!1,K=null;(async()=>{if(y||M)try{let e=await f(y,M,b,_.width,_.height);if(V){e.texture.dispose();return}let t=s.capabilities.getMaxAnisotropy();(K=e.texture).anisotropy=Math.max(2,Math.min(t,16)),T.map=K,T.needsUpdate=!0,D(e.range)}catch(e){D(null)}})();let G=function(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,i=-60+120*e,o=-60+120*t,r=function(e,t,n,i,o){var l,r;let a=c(i,0,1)*(t-1),s=c(o,0,1)*(n-1),d=Math.floor(a),u=Math.floor(s),h=Math.min(t-1,d+1),m=Math.min(n-1,u+1),p=a-d,f=(l=e[u*t+d])+(e[u*t+h]-l)*p;return f+((r=e[m*t+d])+(e[m*t+h]-r)*p-f)*(s-u)}(w,_.width,_.height,e,t)+n;return new l.Pa4(i,r,o)},L=(e,n,i,o,r)=>{var a,s,d,u,c,h,m;let p=[G(e,i,null!==(a=null==r?void 0:r.lift)&&void 0!==a?a:.18),G(n,i,null!==(s=null==r?void 0:r.lift)&&void 0!==s?s:.18),G(n,o,null!==(d=null==r?void 0:r.lift)&&void 0!==d?d:.18),G(e,o,null!==(u=null==r?void 0:r.lift)&&void 0!==u?u:.18)],f=new l.u9r().setFromPoints(p),g=new l.nls({color:null!==(c=null==r?void 0:r.color)&&void 0!==c?c:14870768,transparent:!0,opacity:null!==(h=null==r?void 0:r.opacity)&&void 0!==h?h:.42,linewidth:null!==(m=null==r?void 0:r.lineWidth)&&void 0!==m?m:1,depthTest:!1,depthWrite:!1}),x=new l.blk(f,g);return t.add(x),R.push(()=>{f.dispose(),g.dispose()}),x};for(let e=0;e<3;e++)for(let t=0;t<3;t++)L(t/3,(t+1)/3,e/3,(e+1)/3,{color:9684477,opacity:.5,lift:.2});if(O){let e=O.col/3,n=(O.col+1)/3,i=O.row/3,o=(O.row+1)/3,r=[{u:e,v:i},{u:n,v:i},{u:n,v:o},{u:e,v:o}],a=new l.u9r().setFromPoints([G(e,i,.2),G(n,i,.2),G(n,o,.2),G(e,o,.2)]);a.setIndex([0,1,2,0,2,3]),a.computeVertexNormals();let s=new l.vBJ({color:2282478,transparent:!0,opacity:.16,depthTest:!1,depthWrite:!1,side:l.ehD}),d=new l.Kj0(a,s);for(let u of(t.add(d),R.push(()=>{a.dispose(),s.dispose()}),L(e,n,i,o,{color:6809849,opacity:1,lift:.32}),L(e,n,i,o,{color:16707722,opacity:.72,lift:.42}),r)){let e=G(u.u,u.v,.4),n=e.clone();n.y+=2.8;let i=new l.fHI(.09,.09,2.8,10),o=new l.Wid({color:10875900,emissive:947344,emissiveIntensity:.6,roughness:.35}),r=new l.Kj0(i,o);r.position.set(e.x,(e.y+n.y)/2,e.z),t.add(r);let a=function(e){let t=document.createElement("canvas");t.width=64,t.height=64;let n=t.getContext("2d");if(!n)return null;n.clearRect(0,0,64,64),n.fillStyle=e,n.beginPath(),n.arc(32,32,11,0,2*Math.PI),n.fill(),n.strokeStyle="rgba(255,255,255,0.96)",n.lineWidth=4,n.stroke();let i=new l.ROQ(t);i.colorSpace=l.KI_;let o=new l.xeV({map:i,transparent:!0,depthTest:!1,depthWrite:!1}),r=new l.jyi(o);return r.scale.set(1.6,1.6,1),{sprite:r,texture:i,material:o}}("#67e8f9");a&&(a.sprite.position.set(n.x,n.y,n.z),t.add(a.sprite),R.push(()=>{a.texture.dispose(),a.material.dispose()})),R.push(()=>{i.dispose(),o.dispose()})}if(W){let r=G((e+n)/2,(i+o)/2,4.2),a=function(e){let t=document.createElement("canvas");t.width=256,t.height=80;let n=t.getContext("2d");if(!n)return null;n.clearRect(0,0,t.width,t.height),n.fillStyle="rgba(6, 11, 24, 0.82)",n.fillRect(8,12,240,56),n.strokeStyle="rgba(56, 189, 248, 0.95)",n.lineWidth=3,n.strokeRect(8,12,240,56),n.fillStyle="#e2f5ff",n.font='600 34px "IBM Plex Sans", sans-serif',n.textAlign="center",n.textBaseline="middle",n.fillText(e,t.width/2,t.height/2);let i=new l.ROQ(t);i.colorSpace=l.KI_;let o=new l.xeV({map:i,transparent:!0,depthTest:!1,depthWrite:!1}),r=new l.jyi(o);return r.scale.set(14,4.4,1),{sprite:r,texture:i,material:o}}(W);a&&(a.sprite.position.set(r.x,r.y,r.z),t.add(a.sprite),R.push(()=>{a.texture.dispose(),a.material.dispose()}))}}let U=!0,B=()=>{U&&(d.update(),s.render(t,o),requestAnimationFrame(B))};B();let J=()=>{let t=e.clientWidth||1e3,n=e.clientHeight||420;o.aspect=t/n,o.updateProjectionMatrix(),s.setSize(t,n)};return window.addEventListener("resize",J),()=>{var t;V=!0,U=!1,window.removeEventListener("resize",J),d.dispose(),S.dispose(),P.geometry.dispose(),P.material.dispose(),null===(t=T.map)||void 0===t||t.dispose(),T.dispose(),H.dispose(),F.dispose(),A.dispose(),null==K||K.dispose(),R.forEach(e=>e()),s.dispose(),s.domElement.parentNode===e&&e.removeChild(s.domElement)}},[v,_,y,M,N,b,j,W]),v)?(0,i.jsxs)("div",{className:"rounded-2xl border border-zinc-200 bg-zinc-950/95 p-3 text-zinc-100",children:[(0,i.jsxs)("div",{className:"mb-2 flex items-center justify-between",children:[(0,i.jsxs)("p",{className:"flex items-center gap-2 text-sm font-semibold",children:[(0,i.jsx)(s,{className:"h-4 w-4 text-sky-300"}),"3D Terrain Viewer"]}),(0,i.jsxs)("p",{className:"text-xs text-zinc-300",children:["Metric: ",g(b)," | ",(null==_?void 0:_.source)||"loading terrain"]})]}),S&&(0,i.jsxs)("div",{className:"mb-2 inline-flex items-center gap-2 rounded-lg border border-zinc-700 px-2 py-1 text-xs text-zinc-300",children:[(0,i.jsx)(d.Z,{className:"h-3.5 w-3.5 animate-spin"}),"Loading DEM for selected AOI"]}),F&&(0,i.jsx)("div",{className:"mb-2 rounded-lg border border-rose-800 bg-rose-950/60 px-2 py-1 text-xs text-rose-200",children:F}),(0,i.jsx)("div",{ref:I,className:"h-[24rem] w-full overflow-hidden rounded-xl border border-zinc-700/70"}),(0,i.jsxs)("div",{className:"mt-2 rounded-lg border border-zinc-700/70 bg-zinc-900/70 p-2",children:[(0,i.jsxs)("p",{className:"text-[11px] uppercase tracking-[0.14em] text-zinc-400",children:[g(b)," scale ",(null==M?void 0:M.isSimulated)?"(simulated)":"(measured)"]}),(0,i.jsx)("div",{className:"mt-1 h-3 w-full rounded",style:{backgroundImage:"linear-gradient(90deg, ".concat(u[b].map(e=>"rgb(".concat(e.color[0],", ").concat(e.color[1],", ").concat(e.color[2],") ").concat(Math.round(100*e.stop),"%")).join(", "),")")}}),(0,i.jsxs)("div",{className:"mt-1 flex items-center justify-between text-[11px] text-zinc-300",children:[(0,i.jsx)("span",{children:(null!==(n=null!==(t=null==P?void 0:P.min)&&void 0!==t?t:null==M?void 0:M.min)&&void 0!==n?n:0).toFixed(3)}),(0,i.jsx)("span",{children:(null==M?void 0:M.units)?M.units:"soil"===b?"m3/m3":"et"===b?"mm/day":"NDVI"}),(0,i.jsx)("span",{children:(null!==(x=null!==(p=null==P?void 0:P.max)&&void 0!==p?p:null==M?void 0:M.max)&&void 0!==x?x:1).toFixed(3)})]})]}),(0,i.jsx)("p",{className:"mt-2 text-[11px] text-zinc-400",children:_?"High-fidelity topographic surface using ".concat(g(b)," color mapping. Selected plot point: ").concat(W||"none").concat(T?" | mesh ".concat(T.resolution,"px").concat(T.smoothed?", smoothed":""):"","."):"Terrain will appear when providers return valid DEM coverage for this AOI."})]}):null}}}]);