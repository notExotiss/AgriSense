"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[780],{6316:function(e,t,n){n.d(t,{Z:function(){return i}});let i=(0,n(1373).Z)("loader-circle",[["path",{d:"M21 12a9 9 0 1 1-6.219-8.56",key:"13zald"}]])},116:function(e,t,n){n.d(t,{Z:function(){return i}});let i=(0,n(1373).Z)("triangle-alert",[["path",{d:"m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3",key:"wmoenq"}],["path",{d:"M12 9v4",key:"juzpu7"}],["path",{d:"M12 17h.01",key:"p32p05"}]])},9780:function(e,t,n){n.r(t),n.d(t,{default:function(){return v}});var i=n(5893),a=n(7294),r=n(3935),o=n(4250),l=n(9477),d=n(9365),s=n(6316),u=n(116);function c(e,t,n){return Math.max(t,Math.min(n,e))}function h(e,t,n){let i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:2;if(i<=0||t<3||n<3)return e;let a=e;for(let e=0;e<i;e++){let e=new Float32Array(t*n);for(let i=0;i<n;i++)for(let r=0;r<t;r++){let o=i*t+r,l=a[i*t+Math.max(0,r-1)],d=a[i*t+Math.min(t-1,r+1)],s=a[Math.max(0,i-1)*t+r],u=a[Math.min(n-1,i+1)*t+r];e[o]=(l+d+s+u+2*a[o])/6}a=e}return a}function m(e,t,n,i,a){var r,o;let l=c(i,0,1)*(t-1),d=c(a,0,1)*(n-1),s=Math.floor(l),u=Math.floor(d),h=Math.min(t-1,s+1),m=Math.min(n-1,u+1),p=l-s,v=(r=e[u*t+s])+(e[u*t+h]-r)*p;return v+((o=e[m*t+s])+(e[m*t+h]-o)*p-v)*(d-u)}async function p(e,t){let n=await new Promise((e,n)=>{let i=new Image;i.onload=()=>e(i),i.onerror=()=>n(Error("hero_texture_load_failed")),i.src="data:image/png;base64,".concat(t)}),i=new o.xEZ(n);i.colorSpace=o.KI_,i.wrapS=o.uWy,i.wrapT=o.uWy,i.needsUpdate=!0;let a=e.capabilities.getMaxAnisotropy();return i.anisotropy=Math.max(2,Math.min(a,16)),i}function v(){var e,t,n;let v=(0,a.useRef)(null),x=(0,a.useRef)(null),[f,g]=(0,a.useState)(null),[w,b]=(0,a.useState)(null),[y,M]=(0,a.useState)(null),[j,N]=(0,a.useState)(!0),[E,k]=(0,a.useState)(null),[S,F]=(0,a.useState)(null),[I,_]=(0,a.useState)("initializing"),[A,C]=(0,a.useState)(!0),P=(0,a.useRef)("initializing"),T=(0,a.useMemo)(()=>{var e;return(null==w?void 0:null===(e=w.legend)||void 0===e?void 0:e.stops)||[]},[null==w?void 0:null===(e=w.legend)||void 0===e?void 0:e.stops]);return((0,a.useEffect)(()=>{if("undefined"==typeof document)return;let e=document.createElement("div");return e.setAttribute("data-hero-cinematic-root","true"),document.body.appendChild(e),g(e),()=>{e.parentNode&&e.parentNode.removeChild(e)}},[]),(0,a.useEffect)(()=>{P.current="initializing",_("initializing"),C(!0)},[null==w?void 0:w.generatedAt]),(0,a.useEffect)(()=>{let e=!0;return N(!0),k(null),(async()=>{try{let t=await fetch("/api/home/hero-map"),n=await t.json().catch(()=>({}));if(!t.ok||!(null==n?void 0:n.success)||!(null==n?void 0:n.data))throw Error((null==n?void 0:n.message)||"hero_map_unavailable");if(!e)return;b(n.data)}catch(t){if(!e)return;k(String((null==t?void 0:t.message)||"hero_map_unavailable"))}finally{e&&N(!1)}})(),()=>{e=!1}},[]),(0,a.useEffect)(()=>{if(!(null==w?void 0:w.bbox))return;let e=!0;return(async()=>{try{var t,n,i,a;let r=await fetch("/api/terrain/fetch",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({bbox:w.bbox,resolution:128,layer:"ndvi",quality:"high"})}),o=await r.json().catch(()=>({}));if(!e)return;if(!r.ok||!(null==o?void 0:o.success)||(null==o?void 0:o.degraded)||!Array.isArray(null==o?void 0:null===(t=o.data)||void 0===t?void 0:t.demGrid)||!(null==o?void 0:null===(n=o.data)||void 0===n?void 0:n.width)||!(null==o?void 0:null===(i=o.data)||void 0===i?void 0:i.height)){M(null);return}let l=o.data.width*o.data.height,d=new Float32Array(l);for(let e=0;e<l;e++){let t=Number(null===(a=o.data.demGrid)||void 0===a?void 0:a[e]);d[e]=Number.isFinite(t)?t:0}M({values:d,width:o.data.width,height:o.data.height,source:String(o.data.source||"terrain")})}catch(t){e&&M(null)}})(),()=>{e=!1}},[null==w?void 0:null===(t=w.bbox)||void 0===t?void 0:t.join(",")]),(0,a.useEffect)(()=>{if(!v.current||!w||A&&f&&!x.current)return;let e=v.current,t=x.current,n=new o.xsS;n.background=new o.Ilk(14673128);let i=e.clientWidth||900,a=e.clientHeight||520,r=new o.cPb(37,i/a,.1,2200);r.position.set(-24,88,150);let s=new l.CP7({antialias:!0,alpha:!1});s.setPixelRatio(Math.min(2,window.devicePixelRatio||1)),s.outputColorSpace=o.KI_,s.toneMapping=o.LY2,s.toneMappingExposure=1;let u=(e,t)=>{let n=Math.max(1,Math.floor(e)),i=Math.max(1,Math.floor(t));s.setSize(n,i,!1),r.aspect=n/i,r.updateProjectionMatrix()};t?(t.innerHTML="",t.style.left="0px",t.style.top="0px",t.style.width="".concat(window.innerWidth,"px"),t.style.height="".concat(window.innerHeight,"px"),t.style.borderRadius="0px",t.style.opacity="1",t.style.boxShadow="none",t.appendChild(s.domElement),u(window.innerWidth,window.innerHeight)):(e.innerHTML="",e.appendChild(s.domElement),u(i,a)),n.add(new o.Mig(16777215,.86));let g=new o.Ox3(16777215,1.08);g.position.set(95,120,58),n.add(g);let b=new o.Ox3(15725558,.55);b.position.set(-95,90,-80),n.add(b);let M=h(function(e,t,n){let i=window.atob(e),a=new Uint8Array(i.length);for(let e=0;e<i.length;e++)a[e]=i.charCodeAt(e);let r=t*n,o=new Float32Array(a.buffer,a.byteOffset,Math.min(r,Math.floor(a.byteLength/4))),l=new Float32Array(r);for(let e=0;e<r;e++){var d;let t=Number(null!==(d=o[e])&&void 0!==d?d:0);l[e]=Number.isFinite(t)?t:0}return l}(w.metricGrid.encoded,w.metricGrid.width,w.metricGrid.height),w.metricGrid.width,w.metricGrid.height,2),j=y?h(y.values,y.width,y.height,1):M,N=y?y.width:w.metricGrid.width,E=y?y.height:w.metricGrid.height,S=Math.max(1e-6,Math.abs(w.bbox[2]-w.bbox[0])),I=c(Math.max(1e-6,Math.abs(w.bbox[3]-w.bbox[1]))/S,.62,1.65),T=c(Math.round(220*I),130,300),H=function(e,t,n,i,a){let r=new Float32Array(i*a);for(let o=0;o<a;o++){let l=o/Math.max(1,a-1);for(let a=0;a<i;a++){let d=a/Math.max(1,i-1);r[o*i+a]=m(e,t,n,d,l)}}return r}(j,N,E,220,T),z=function(e){let t=Number.POSITIVE_INFINITY,n=Number.NEGATIVE_INFINITY;for(let i=0;i<e.length;i++){let a=Number(e[i]);Number.isFinite(a)&&(a<t&&(t=a),a>n&&(n=a))}return Number.isFinite(t)&&Number.isFinite(n)&&!(n-t<1e-6)?{min:t,max:n}:{min:0,max:1}}(H),R=Math.max(1e-6,z.max-z.min),D=new Float32Array(H.length),L=y?84:68;for(let e=0;e<H.length;e++){let t=Math.pow(c((H[e]-z.min)/R,0,1),1.08),n=Math.round(t*L)/L;D[e]=t+(n-t)*.74}let W=162*I,G=new o._12(162,W,219,T-1),U=G.attributes.position,O=y?62:40;for(let e=0;e<D.length;e++)U.setZ(e,D[e]*O);U.needsUpdate=!0,G.computeVertexNormals();let Z=new d.z(r,s.domElement);Z.enabled=!1,Z.enableDamping=!0,Z.dampingFactor=.08,Z.maxPolarAngle=Math.PI/2.06,Z.minDistance=56,Z.maxDistance=260,Z.target.set(0,18,0);let V=null,K=null,q=!0,Y=0,B=[],J=null,X=null,Q=null,$=null,ee=new o.ZAu;ee.rotation.x=-.06,n.add(ee);let et=!t,en=!1,ei=new o.iMs,ea=new o.FM8(0,0),er=null,eo=e=>{if(!er)return;let t=s.domElement.getBoundingClientRect();ea.x=(e.clientX-t.left)/t.width*2-1,ea.y=-((e.clientY-t.top)/t.height*2)+1,ei.setFromCamera(ea,r);let n=ei.intersectObject(er,!1)[0];if(!n||!n.uv){F(null);return}F({ndvi:m(M,w.metricGrid.width,w.metricGrid.height,n.uv.x,1-n.uv.y),x:e.clientX-t.left,y:e.clientY-t.top})},el=()=>F(null);s.domElement.addEventListener("pointermove",eo),s.domElement.addEventListener("pointerleave",el),(async()=>{try{if(V=await p(s,w.outlinePng),K=await p(s,w.topoPng),!q)return;let i=new o.DvJ(170,10,W+8),a=new o.Wid({color:9410204,roughness:.78,metalness:.04}),l=new o.Kj0(i,a);l.position.set(0,-7.2,0),ee.add(l),B.push(()=>{i.dispose(),a.dispose()}),$=new o.Wid({map:V,color:new o.Ilk(15922679),metalness:.02,roughness:.84}),(er=new o.Kj0(G,$)).rotation.x=-Math.PI/2,ee.add(er),X=new o.jyz({uniforms:{uTopoTex:{value:K},uReveal:{value:.001}},vertexShader:"\n            varying vec2 vUv;\n            void main() {\n              vUv = uv;\n              gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n            }\n          ",fragmentShader:"\n            uniform sampler2D uTopoTex;\n            uniform float uReveal;\n            varying vec2 vUv;\n            void main() {\n              if (vUv.x > uReveal + 0.018) discard;\n              float edge = smoothstep(uReveal + 0.02, uReveal - 0.02, vUv.x);\n              vec4 topo = texture2D(uTopoTex, vUv);\n              gl_FragColor = vec4(topo.rgb, edge);\n            }\n          ",transparent:!0,depthWrite:!1});let d=new o.Kj0(G,X);d.rotation.x=-Math.PI/2,d.position.y=.16,ee.add(d),Q=new o.jyz({uniforms:{uMaxHeight:{value:O},uDensity:{value:58},uThickness:{value:.048},uOpacity:{value:.72}},vertexShader:"\n            varying float vHeight;\n            uniform float uMaxHeight;\n            void main() {\n              vHeight = max(0.0, position.z / max(uMaxHeight, 0.001));\n              gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n            }\n          ",fragmentShader:"\n            varying float vHeight;\n            uniform float uDensity;\n            uniform float uThickness;\n            uniform float uOpacity;\n            void main() {\n              float f = fract(vHeight * uDensity);\n              float d = min(f, 1.0 - f);\n              float aa = fwidth(vHeight * uDensity) * 0.9;\n              float line = 1.0 - smoothstep(uThickness, uThickness + aa, d);\n              gl_FragColor = vec4(vec3(0.16, 0.18, 0.21), line * uOpacity);\n            }\n          ",transparent:!0,depthWrite:!1});let h=new o.Kj0(G,Q);h.rotation.x=-Math.PI/2,h.position.y=.22,ee.add(h);let m=new o.Uk6(G);J=new o.nls({color:1712168,transparent:!0,opacity:.12});let v=new o.ejS(m,J);v.rotation.x=-Math.PI/2,v.position.y=.1,ee.add(v);let x=performance.now(),f=e=>{P.current!==e&&(P.current=e,_(e))},g=i=>{var a,o,l,d,h,m;if(!q)return;let p=i-x,v=.001,w=0;p<=520?f("initializing"):p<=2720?(f("revealing"),v=c((p-520)/2200,0,1)):p<=4520?(f("docking"),v=1,w=c((p-520-2200)/1800,0,1)):(f("interactive"),v=1,w=1,Z.enabled=!0),X&&(X.uniforms.uReveal.value=v);let b=1-Math.pow(1-w,3);if(r.position.set(-24+32*b,88+28*b,150+56*b),Z.target.set(0,18+-10*b,0),ee.scale.setScalar(2.3+-1.2999999999999998*b),ee.position.y=2.6+-3.8*b,ee.rotation.y=7e-5*i+(.22+-.22*b),t&&!et){let n=e.getBoundingClientRect(),i=(a=n.left,0+(a-0)*b),r=(o=n.top,0+(o-0)*b),s=(l=window.innerWidth,d=n.width,l+(d-l)*b),c=(h=window.innerHeight,m=n.height,h+(m-h)*b);t.style.left="".concat(i,"px"),t.style.top="".concat(r,"px"),t.style.width="".concat(s,"px"),t.style.height="".concat(c,"px"),t.style.borderRadius="".concat(Math.round(0+22*b),"px"),t.style.boxShadow="0 ".concat(Math.round(0+28*b),"px ").concat(Math.round(0+70*b),"px rgba(0,0,0,").concat((0+.24*b).toFixed(3),")"),u(s,c)}"interactive"!==P.current||!t||et||(et=!0,e.innerHTML="",e.appendChild(s.domElement),u(e.clientWidth||900,e.clientHeight||520),en||(en=!0,C(!1))),Z.update(),s.render(n,r),Y=requestAnimationFrame(g)};Y=requestAnimationFrame(g)}catch(e){if(!q)return;k(String((null==e?void 0:e.message)||"hero_render_failed"))}})();let ed=()=>{if(t&&!et){let e=t.getBoundingClientRect();u(e.width,e.height)}else u(e.clientWidth||900,e.clientHeight||520)};return window.addEventListener("resize",ed),()=>{q=!1,cancelAnimationFrame(Y),window.removeEventListener("resize",ed),s.domElement.removeEventListener("pointermove",eo),s.domElement.removeEventListener("pointerleave",el),Z.dispose(),G.dispose(),null==$||$.dispose(),null==X||X.dispose(),null==Q||Q.dispose(),null==J||J.dispose(),null==V||V.dispose(),null==K||K.dispose(),s.dispose(),B.forEach(e=>e()),s.domElement.parentNode===e&&e.removeChild(s.domElement),t&&s.domElement.parentNode===t&&t.removeChild(s.domElement)}},[w,y,f]),j)?(0,i.jsx)("div",{className:"flex h-[26rem] items-center justify-center rounded-2xl border border-border bg-card/70",children:(0,i.jsxs)("div",{className:"inline-flex items-center gap-2 text-sm text-muted-foreground",children:[(0,i.jsx)(s.Z,{className:"h-4 w-4 animate-spin"}),"Loading NDVI terrain sequence"]})}):E||!w?(0,i.jsx)("div",{className:"flex h-[26rem] items-center justify-center rounded-2xl border border-amber-300 bg-amber-50/70 px-4 text-center dark:border-amber-700 dark:bg-amber-950/30",children:(0,i.jsxs)("div",{className:"space-y-2",children:[(0,i.jsxs)("p",{className:"inline-flex items-center gap-2 text-sm font-medium text-amber-900 dark:text-amber-100",children:[(0,i.jsx)(u.Z,{className:"h-4 w-4"}),"Hero map currently unavailable"]}),(0,i.jsx)("p",{className:"text-xs text-amber-800 dark:text-amber-200",children:E||"Please retry in a moment."})]})}):(0,i.jsxs)("div",{className:"relative",children:[A&&f&&(0,r.createPortal)((0,i.jsx)("div",{ref:x,className:"pointer-events-none fixed inset-0 z-[80] overflow-hidden bg-[#dfe4e8]"}),f),(0,i.jsx)("div",{ref:v,className:"h-[28rem] w-full overflow-hidden rounded-2xl border border-cyan-700/30 bg-[#dfe4e8] transition-opacity duration-500 ".concat(A?"opacity-20":"opacity-100")}),!A&&(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)("div",{className:"absolute left-3 top-3 rounded-full border border-cyan-400/30 bg-[#081226]/80 px-3 py-1 text-[11px] uppercase tracking-[0.12em] text-cyan-100",children:"interactive"===I?"Interactive":I}),(0,i.jsxs)("div",{className:"absolute right-3 top-3 rounded-full border border-cyan-400/30 bg-[#081226]/80 px-3 py-1 text-[11px] text-cyan-100",children:[w.legend.metric.toUpperCase()," | ",(null==y?void 0:y.source)||w.source]})]}),S&&!A&&(0,i.jsxs)("div",{className:"pointer-events-none absolute z-20 rounded-md border border-cyan-400/50 bg-[#081226]/90 px-2 py-1 text-[11px] text-cyan-100",style:{left:Math.min(S.x+14,((null===(n=v.current)||void 0===n?void 0:n.clientWidth)||0)-120),top:Math.max(8,S.y-26)},children:["NDVI ",S.ndvi.toFixed(3)]}),(0,i.jsxs)("div",{className:"mt-3 rounded-xl border border-border bg-card/70 p-3",children:[(0,i.jsxs)("div",{className:"flex items-center justify-between text-[11px] uppercase tracking-[0.12em] text-muted-foreground",children:[(0,i.jsx)("span",{children:"NDVI Legend"}),(0,i.jsx)("span",{children:w.legend.unit})]}),(0,i.jsx)("div",{className:"mt-2 h-3 w-full overflow-hidden rounded-sm border border-black/15",children:(0,i.jsx)("div",{className:"h-full w-full",style:{background:"linear-gradient(90deg, ".concat(T.map(e=>"rgb(".concat(e.color[0],", ").concat(e.color[1],", ").concat(e.color[2],")")).join(", "),")")}})}),(0,i.jsxs)("div",{className:"mt-1 flex items-center justify-between text-xs text-muted-foreground",children:[(0,i.jsx)("span",{children:w.legend.min.toFixed(3)}),(0,i.jsx)("span",{children:w.legend.max.toFixed(3)})]})]})]})}}}]);