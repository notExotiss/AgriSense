"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[808],{7808:function(e,t,n){n.r(t),n.d(t,{default:function(){return x}});var o=n(5893),r=n(7294),i=n(4250),l=n(9477),a=n(9365);let s=(0,n(1373).Z)("mountain",[["path",{d:"m8 3 4 8 5-5 5 15H2L8 3z",key:"otkl63"}]]);var d=n(6316),u=n(6506);function c(e){if(!e||!e.includes("-"))return null;let[t,n]=e.split("-"),o=Number(t),r=Number(n);return Number.isFinite(o)&&Number.isFinite(r)?{row:o,col:r}:null}function h(e){let t=e.filter(e=>Number.isFinite(e)),n=t.length?Math.min(...t):0,o=t.length?Math.max(...t):1,r=Math.max(1e-6,o-n);return{min:n,max:o,range:r,apply:e=>(e-n)/r}}async function m(e){return await new Promise((t,n)=>{let o=new Image;o.crossOrigin="anonymous",o.onload=()=>t(o),o.onerror=()=>n(Error("metric_texture_load_failed")),o.src="data:image/png;base64,".concat(e)})}async function p(e,t,n,o,r){let l=o,a=r,s=new Float32Array(o*r),d=Number.POSITIVE_INFINITY,c=Number.NEGATIVE_INFINITY;if(t&&Array.isArray(t.values)&&t.width>0&&t.height>0&&t.values.length>=t.width*t.height){l=t.width,a=t.height,s=new Float32Array(l*a);for(let e=0;e<l*a;e++){let n=Number(t.values[e]),o=Number.isFinite(n)?n:0;s[e]=o,d=Math.min(d,o),c=Math.max(c,o)}}else if(e){let t=await m(e),n=document.createElement("canvas");n.width=o,n.height=r;let i=n.getContext("2d");if(!i)throw Error("metric_texture_context_failed");i.drawImage(t,0,0,o,r);let l=i.getImageData(0,0,o,r).data;s=new Float32Array(o*r);for(let e=0;e<o*r;e++){let t=4*e;if(l[t+3]<5){s[e]=0;continue}let n=(.2126*l[t]+.7152*l[t+1]+.0722*l[t+2])/255;s[e]=n,d=Math.min(d,n),c=Math.max(c,n)}}else throw Error("metric_texture_missing");Number.isFinite(d)&&Number.isFinite(c)||(t&&Number.isFinite(t.min)&&Number.isFinite(t.max)&&t.max>t.min?(d=t.min,c=t.max):(d=0,c=1));let h=Math.max(1e-6,c-d),p=(e,t)=>{let n=(0,u.uZ)(e,0,l-1),o=(0,u.uZ)(t,0,a-1),r=Math.floor(n),i=Math.floor(o),d=Math.min(l-1,r+1),c=Math.min(a-1,i+1),h=n-r,m=i*l+r,p=i*l+d,f=c*l+r,g=c*l+d,x=(0,u.t7)(s[m],s[p],h),w=(0,u.t7)(s[f],s[g],h);return(0,u.t7)(x,w,o-i)},f=(e,t)=>(p(e/Math.max(1,o-1)*(l-1),t/Math.max(1,r-1)*(a-1))-d)/h,g=document.createElement("canvas");g.width=o,g.height=r;let x=g.getContext("2d");if(!x)throw Error("metric_texture_output_failed");let w=x.createImageData(o,r),v=w.data;for(let e=0;e<r;e++)for(let t=0;t<o;t++){let r=4*(e*o+t),i=f(t,e),[l,a,s]=(0,u.TU)(n,i),d=l,c=a,h=s,m=18*i,p=Math.abs(m-Math.round(m));if(p<.02){let e=p<.009?.5:.28;d=Math.round((0,u.t7)(d,12,e)),c=Math.round((0,u.t7)(c,22,e)),h=Math.round((0,u.t7)(h,42,e))}v[r]=d,v[r+1]=c,v[r+2]=h,v[r+3]=255}x.putImageData(w,0,0);let b=new i.ROQ(g);return b.colorSpace=i.KI_,b.wrapS=i.uWy,b.wrapT=i.uWy,b.needsUpdate=!0,{texture:b,range:{min:d,max:c}}}function f(e,t,n,o,r){let i=(0,u.uZ)(o,0,1)*(t-1),l=(0,u.uZ)(r,0,1)*(n-1),a=Math.floor(i),s=Math.floor(l),d=Math.min(t-1,a+1),c=Math.min(n-1,s+1),h=i-a,m=(0,u.t7)(e[s*t+a],e[s*t+d],h),p=(0,u.t7)(e[c*t+a],e[c*t+d],h);return(0,u.t7)(m,p,l-s)}function g(e){return"soil"===e?"Soil Moisture":"et"===e?"Evapotranspiration":"NDVI"}function x(e){var t,n,m,x;let{open:w,bbox:v,texturePng:b,metricGrid:y,layer:M,selectedCell:N,quality:_="high"}=e,j=(0,r.useRef)(null),[I,S]=(0,r.useState)(!1),[E,A]=(0,r.useState)(null),[F,T]=(0,r.useState)(null),[k,P]=(0,r.useState)(null),[D,C]=(0,r.useState)(null),O=(0,r.useMemo)(()=>c(N),[N]),W=(0,r.useMemo)(()=>(function(e){let t=c(e);return t?"P".concat(3*t.row+t.col+1):null})(N),[N]),[H,z]=(0,r.useState)(()=>"undefined"!=typeof document&&document.documentElement.classList.contains("dark"));return((0,r.useEffect)(()=>{if("undefined"==typeof document)return;let e=document.documentElement,t=()=>z(e.classList.contains("dark"));t();let n=new MutationObserver(t);return n.observe(e,{attributes:!0,attributeFilter:["class"]}),()=>n.disconnect()},[]),(0,r.useEffect)(()=>{if(!w||!v)return;let e=new AbortController,t="high"===_?[128,96,64]:"balanced"===_?[96,64]:[64];return async function(){S(!0),A(null),T(null);try{let l="Terrain fetch failed";for(let a of t){var n,o,r,i;let t=await fetch("/api/terrain/fetch",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({bbox:v,resolution:a,layer:M,quality:_}),signal:e.signal}),s=await t.json().catch(()=>({}));if(!t.ok||!(null==s?void 0:s.success)){l=String((null==s?void 0:s.message)||(null==s?void 0:s.error)||"Terrain fetch failed (".concat(t.status,")"));continue}let d=!!(null==s?void 0:s.degraded),u=null==s?void 0:s.data,c=u&&Array.isArray(u.demGrid)&&u.demGrid.length>0&&Number(u.width)>1&&Number(u.height)>1;if(d||!c){l=String((null==s?void 0:null===(r=s.warnings)||void 0===r?void 0:r[0])||(null==s?void 0:s.reason)||"Terrain unavailable for the selected AOI.");continue}T(u),P({smoothed:!!(null===(i=null==s?void 0:null===(n=s.meshMeta)||void 0===n?void 0:n.smoothed)||void 0===i||i),resolution:Number((null==s?void 0:null===(o=s.meshMeta)||void 0===o?void 0:o.resolution)||a)}),A(null);return}T(null),A(l)}catch(t){if(e.signal.aborted)return;T(null),A(String((null==t?void 0:t.message)||"Terrain fetch failed"))}finally{e.signal.aborted||S(!1)}}(),()=>e.abort()},[w,M,null==v?void 0:v.join(","),_]),(0,r.useEffect)(()=>{if(!w||!j.current||!F||!Array.isArray(F.demGrid)||0===F.demGrid.length||F.width<2||F.height<2)return;let e=j.current,t=new i.xsS,n=e.clientWidth||1e3,o=e.clientHeight||420,r=new i.cPb(50,n/o,.1,1400);r.position.set(0,90,148);let s=new l.CP7({antialias:!0,alpha:!0});s.setSize(n,o),s.setPixelRatio(Math.min(2,window.devicePixelRatio||1)),s.outputColorSpace=i.KI_,s.toneMapping=i.LY2,s.toneMappingExposure=1.02,s.setClearColor(0,0),e.innerHTML="",e.appendChild(s.domElement);let d=new a.z(r,s.domElement);d.enableDamping=!0,d.dampingFactor=.08,d.maxPolarAngle=Math.PI/2.03,d.minDistance=30,d.maxDistance=260,d.target.set(0,6,0),t.add(new i.Mig(16777215,H?.74:.66));let c=new i.Ox3(16055295,H?1.12:1.04);c.position.set(130,142,60),t.add(c);let m=new i.Ox3(H?9483519:10664920,H?.5:.42);m.position.set(-120,84,-120),t.add(m);let g=function(e,t,n,o){let r=t*n,i=new Float32Array(r);for(let t=0;t<r;t++){let n=Number(e[t]);i[t]=Number.isFinite(n)?n:0}if(o<=0||t<3||n<3)return i;let{min:l,max:a}=h(Array.from(i)),s=Math.max(.5,(a-l)*.18),d=i;for(let e=0;e<o;e++){let e=new Float32Array(r),o=new Float32Array(r);for(let o=0;o<n;o++)for(let n=0;n<t;n++){let r=o*t+n,i=d[o*t+Math.max(0,n-1)],l=d[r],a=d[o*t+Math.min(t-1,n+1)];e[r]=.2*i+.6*l+.2*a}for(let r=0;r<n;r++)for(let l=0;l<t;l++){let a=r*t+l,d=.2*e[Math.max(0,r-1)*t+l]+.6*e[a]+.2*e[Math.min(n-1,r+1)*t+l],c=i[a];o[a]=(0,u.uZ)(d,c-s,c+s)}d=o}return d}(F.demGrid,F.width,F.height,"high"===_?4:"balanced"===_?2:1),x=h(Array.from(g)),v="high"===_?42:"balanced"===_?36:31,N=new Float32Array(g.length),I="high"===_?80:"balanced"===_?64:52;for(let e=0;e<g.length;e++){let t=Math.pow((0,u.uZ)(x.apply(g[e]),0,1),1.08),n=Math.round(t*I)/I;N[e]=(0,u.t7)(t,n,.68)*v}let S=new i._12(120,120,F.width-1,F.height-1),E=S.attributes.position;for(let e=0;e<N.length;e++)E.setZ(e,N[e]);E.needsUpdate=!0,S.computeVertexNormals();let A=new i.Wid({color:H?6254983:9674926,metalness:.03,roughness:.9}),T=new i.Kj0(S,A);T.rotation.x=-Math.PI/2,t.add(T);let k=new i.vBJ({color:16777215,transparent:!0,opacity:.96,side:i.ehD}),P=new i.Kj0(S,k);P.rotation.x=-Math.PI/2,P.position.y=.18,t.add(P);let D=new i.ejS(new i.Uk6(S),new i.nls({color:H?10072008:2768466,transparent:!0,opacity:H?.14:.1}));D.rotation.x=-Math.PI/2,t.add(D);let z=(e,t)=>f(N,F.width,F.height,e,t),K=new i.Wid({color:H?5796494:9216951,roughness:.92,metalness:.01,side:i.ehD,transparent:!0,opacity:.96}),V=[];for(let e of["north","south","west","east"]){let n="north"===e||"south"===e?F.width-1:F.height-1,o=function(e,t,n,o,r,l){let a=[],s=[],d=[];for(let i=0;i<=t;i++){let l=i/Math.max(1,t),d=l,u=l;"north"===e?(d=l,u=0):"south"===e?(d=l,u=1):(d="west"===e?0:1,u=l);let c=-o/2+d*o,h=-r/2+u*r,m=n(d,u)+.04,p=c,f=h;"north"===e&&(f-=2.6),"south"===e&&(f+=2.6),"west"===e&&(p-=2.6),"east"===e&&(p+=2.6),a.push(c,m,h),a.push(p,-1.35,f),s.push(d,u),s.push(d,u)}for(let e=0;e<t;e++){let t=2*e;d.push(t,t+1,t+2),d.push(t+1,t+3,t+2)}let u=new i.u9r;return u.setAttribute("position",new i.a$l(a,3)),u.setAttribute("uv",new i.a$l(s,2)),u.setIndex(d),u.computeVertexNormals(),u}(e,n,z,120,120,0),r=new i.Kj0(o,K);t.add(r),V.push(r)}let R=new i._12(120,120),Z=new i.Wid({color:H?3559530:10860744,roughness:.94,metalness:0,side:i.ehD,transparent:!0,opacity:.94}),G=new i.Kj0(R,Z);G.rotation.x=-Math.PI/2,G.position.y=-1.35,t.add(G);let L=new i.jyz({uniforms:{uMaxHeight:{value:v},uDensity:{value:"high"===_?60:"balanced"===_?48:36},uThickness:{value:.038},uOpacity:{value:H?.7:.62}},vertexShader:"\n        varying float vHeight;\n        uniform float uMaxHeight;\n        void main() {\n          vHeight = max(0.0, position.z / max(uMaxHeight, 0.001));\n          gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n        }\n      ",fragmentShader:"\n        varying float vHeight;\n        uniform float uDensity;\n        uniform float uThickness;\n        uniform float uOpacity;\n        void main() {\n          float f = fract(vHeight * uDensity);\n          float d = min(f, 1.0 - f);\n          float aa = fwidth(vHeight * uDensity) * 0.9;\n          float line = 1.0 - smoothstep(uThickness, uThickness + aa, d);\n          gl_FragColor = vec4(vec3(0.08, 0.11, 0.16), line * uOpacity);\n        }\n      ",transparent:!0,depthWrite:!1}),U=new i.Kj0(S,L);U.rotation.x=-Math.PI/2,U.position.y=.26,t.add(U);let B=[],J=!1,Q=null;(async()=>{if(b||y)try{let e=await p(b,y,M,F.width,F.height);if(J){e.texture.dispose();return}let t=s.capabilities.getMaxAnisotropy();(Q=e.texture).anisotropy=Math.max(2,Math.min(t,16)),k.map=Q,k.needsUpdate=!0,K.map=Q,K.needsUpdate=!0,C(e.range)}catch(e){C(null)}})();let Y=function(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,o=-60+120*e,r=-60+120*t,l=f(N,F.width,F.height,e,t)+n;return new i.Pa4(o,l,r)},$=(e,n,o,r,l)=>{var a,s,d,u,c,h,m;let p=[Y(e,o,null!==(a=null==l?void 0:l.lift)&&void 0!==a?a:.18),Y(n,o,null!==(s=null==l?void 0:l.lift)&&void 0!==s?s:.18),Y(n,r,null!==(d=null==l?void 0:l.lift)&&void 0!==d?d:.18),Y(e,r,null!==(u=null==l?void 0:l.lift)&&void 0!==u?u:.18)],f=new i.u9r().setFromPoints(p),g=new i.nls({color:null!==(c=null==l?void 0:l.color)&&void 0!==c?c:H?14083583:2046546,transparent:!0,opacity:null!==(h=null==l?void 0:l.opacity)&&void 0!==h?h:H?.76:.6,linewidth:null!==(m=null==l?void 0:l.lineWidth)&&void 0!==m?m:1,depthTest:!1,depthWrite:!1}),x=new i.blk(f,g);return t.add(x),B.push(()=>{f.dispose(),g.dispose()}),x};for(let e=0;e<3;e++)for(let t=0;t<3;t++)$(t/3,(t+1)/3,e/3,(e+1)/3,{color:H?12705279:2576498,opacity:H?.74:.62,lift:.26});if(O){let e=O.col/3,n=(O.col+1)/3,o=O.row/3,r=(O.row+1)/3,l=[{u:e,v:o},{u:n,v:o},{u:n,v:r},{u:e,v:r}],a=new i.u9r().setFromPoints([Y(e,o,.2),Y(n,o,.2),Y(n,r,.2),Y(e,r,.2)]);a.setIndex([0,1,2,0,2,3]),a.computeVertexNormals();let s=new i.vBJ({color:5101823,transparent:!0,opacity:.21,depthTest:!1,depthWrite:!1,side:i.ehD}),d=new i.Kj0(a,s);for(let u of(t.add(d),B.push(()=>{a.dispose(),s.dispose()}),$(e,n,o,r,{color:9434367,opacity:1,lift:.38}),$(e,n,o,r,{color:16773772,opacity:.86,lift:.48}),l)){let e=Y(u.u,u.v,.4),n=e.clone();n.y+=2.8;let o=new i.fHI(.09,.09,2.8,10),r=new i.Wid({color:10875900,emissive:947344,emissiveIntensity:.6,roughness:.35}),l=new i.Kj0(o,r);l.position.set(e.x,(e.y+n.y)/2,e.z),t.add(l);let a=function(e){let t=document.createElement("canvas");t.width=64,t.height=64;let n=t.getContext("2d");if(!n)return null;n.clearRect(0,0,64,64),n.fillStyle=e,n.beginPath(),n.arc(32,32,11,0,2*Math.PI),n.fill(),n.strokeStyle="rgba(255,255,255,0.96)",n.lineWidth=4,n.stroke();let o=new i.ROQ(t);o.colorSpace=i.KI_;let r=new i.xeV({map:o,transparent:!0,depthTest:!1,depthWrite:!1}),l=new i.jyi(r);return l.scale.set(1.6,1.6,1),{sprite:l,texture:o,material:r}}("#67e8f9");a&&(a.sprite.position.set(n.x,n.y,n.z),t.add(a.sprite),B.push(()=>{a.texture.dispose(),a.material.dispose()})),B.push(()=>{o.dispose(),r.dispose()})}if(W){let l=Y((e+n)/2,(o+r)/2,4.2),a=function(e){let t=document.createElement("canvas");t.width=256,t.height=80;let n=t.getContext("2d");if(!n)return null;n.clearRect(0,0,t.width,t.height),n.fillStyle="rgba(6, 11, 24, 0.82)",n.fillRect(8,12,240,56),n.strokeStyle="rgba(56, 189, 248, 0.95)",n.lineWidth=3,n.strokeRect(8,12,240,56),n.fillStyle="#e2f5ff",n.font='600 34px "IBM Plex Sans", sans-serif',n.textAlign="center",n.textBaseline="middle",n.fillText(e,t.width/2,t.height/2);let o=new i.ROQ(t);o.colorSpace=i.KI_;let r=new i.xeV({map:o,transparent:!0,depthTest:!1,depthWrite:!1}),l=new i.jyi(r);return l.scale.set(14,4.4,1),{sprite:l,texture:o,material:r}}(W);a&&(a.sprite.position.set(l.x,l.y,l.z),t.add(a.sprite),B.push(()=>{a.texture.dispose(),a.material.dispose()}))}}let q=!0,X=()=>{q&&(d.update(),s.render(t,r),requestAnimationFrame(X))};X();let ee=()=>{let t=e.clientWidth||1e3,n=e.clientHeight||420;r.aspect=t/n,r.updateProjectionMatrix(),s.setSize(t,n)};return window.addEventListener("resize",ee),()=>{J=!0,q=!1,window.removeEventListener("resize",ee),d.dispose(),S.dispose(),D.geometry.dispose(),D.material.dispose(),A.dispose(),k.dispose(),L.dispose(),V.forEach(e=>e.geometry.dispose()),K.dispose(),R.dispose(),Z.dispose(),null==Q||Q.dispose(),B.forEach(e=>e()),s.dispose(),s.domElement.parentNode===e&&e.removeChild(s.domElement)}},[w,F,b,y,N,M,_,W,H]),w)?(0,o.jsxs)("div",{className:"rounded-2xl border border-border bg-card p-3 text-foreground",children:[(0,o.jsxs)("div",{className:"mb-2 flex items-center justify-between",children:[(0,o.jsxs)("p",{className:"flex items-center gap-2 text-sm font-semibold",children:[(0,o.jsx)(s,{className:"h-4 w-4 text-sky-300"}),"3D Terrain Viewer"]}),(0,o.jsxs)("p",{className:"text-xs text-muted-foreground",children:["Metric: ",g(M)," | ",(null==F?void 0:F.source)||"loading terrain"]})]}),I&&(0,o.jsxs)("div",{className:"mb-2 inline-flex items-center gap-2 rounded-lg border border-border px-2 py-1 text-xs text-muted-foreground",children:[(0,o.jsx)(d.Z,{className:"h-3.5 w-3.5 animate-spin"}),"Loading DEM for selected AOI"]}),E&&(0,o.jsx)("div",{className:"mb-2 rounded-lg border border-rose-700/60 bg-rose-500/10 px-2 py-1 text-xs text-rose-700 dark:text-rose-300",children:E}),(0,o.jsx)("div",{ref:j,className:"h-[24rem] w-full overflow-hidden rounded-xl border border-border/70 ".concat(H?"bg-[radial-gradient(120%_100%_at_20%_0%,rgba(22,101,139,0.35)_0%,rgba(6,24,44,0.92)_52%,rgba(4,13,27,0.98)_100%)]":"bg-[radial-gradient(120%_100%_at_15%_0%,rgba(186,230,253,0.9)_0%,rgba(224,242,254,0.76)_45%,rgba(214,226,236,0.94)_100%)]")}),(0,o.jsxs)("div",{className:"mt-2 rounded-lg border border-border/80 bg-muted/35 p-2",children:[(0,o.jsxs)("p",{className:"text-[11px] uppercase tracking-[0.14em] text-muted-foreground",children:[g(M)," scale ",(null==y?void 0:y.isSimulated)?"(simulated)":"(measured)"]}),(0,o.jsx)("div",{className:"mt-1 h-3 w-full rounded",style:{backgroundImage:(0,u.G5)(M)}}),(0,o.jsxs)("div",{className:"mt-1 flex items-center justify-between text-[11px] text-muted-foreground",children:[(0,o.jsx)("span",{children:(null!==(n=null!==(t=null==D?void 0:D.min)&&void 0!==t?t:null==y?void 0:y.min)&&void 0!==n?n:0).toFixed(3)}),(0,o.jsx)("span",{children:(null==y?void 0:y.units)?y.units:"soil"===M?"m3/m3":"et"===M?"mm/day":"NDVI"}),(0,o.jsx)("span",{children:(null!==(x=null!==(m=null==D?void 0:D.max)&&void 0!==m?m:null==y?void 0:y.max)&&void 0!==x?x:1).toFixed(3)})]})]}),(0,o.jsx)("p",{className:"mt-2 text-[11px] text-muted-foreground",children:F?"High-fidelity topographic surface using ".concat(g(M)," color mapping. Selected plot point: ").concat(W||"none").concat(k?" | mesh ".concat(k.resolution,"px").concat(k.smoothed?", smoothed":""):"","."):"Terrain will appear when providers return valid DEM coverage for this AOI."})]}):null}},6506:function(e,t,n){n.d(t,{CS:function(){return o},G5:function(){return a},TU:function(){return l},t7:function(){return i},uZ:function(){return r}});let o={ndvi:[{stop:0,color:[53,74,193]},{stop:.15,color:[69,138,223]},{stop:.32,color:[71,192,220]},{stop:.48,color:[95,205,116]},{stop:.64,color:[220,211,88]},{stop:.8,color:[239,163,68]},{stop:1,color:[214,83,90]}],soil:[{stop:0,color:[65,83,191]},{stop:.2,color:[80,145,220]},{stop:.4,color:[86,196,181]},{stop:.58,color:[122,203,117]},{stop:.76,color:[231,195,86]},{stop:1,color:[191,96,60]}],et:[{stop:0,color:[55,70,189]},{stop:.2,color:[64,124,221]},{stop:.4,color:[78,196,215]},{stop:.6,color:[108,205,112]},{stop:.78,color:[239,190,82]},{stop:1,color:[209,84,72]}]};function r(e,t,n){return Math.max(t,Math.min(n,e))}function i(e,t,n){return e+(t-e)*n}function l(e,t){let n=o[e],i=r(t,0,1);for(let e=0;e<n.length-1;e++){let t=n[e],o=n[e+1];if(i<=o.stop){var l,a,s;let e=(i-t.stop)/Math.max(1e-6,o.stop-t.stop);return[Math.round((l=t.color[0])+(o.color[0]-l)*e),Math.round((a=t.color[1])+(o.color[1]-a)*e),Math.round((s=t.color[2])+(o.color[2]-s)*e)]}}return n[n.length-1].color}function a(e){return"linear-gradient(90deg, ".concat(o[e].map(e=>"rgb(".concat(e.color[0],", ").concat(e.color[1],", ").concat(e.color[2],") ").concat(Math.round(100*e.stop),"%")).join(", "),")")}}}]);