"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[808],{7808:function(e,t,n){n.r(t),n.d(t,{default:function(){return g}});var i=n(5893),r=n(7294),l=n(4250),o=n(9477),a=n(9365);let s=(0,n(1373).Z)("mountain",[["path",{d:"m8 3 4 8 5-5 5 15H2L8 3z",key:"otkl63"}]]);var d=n(6316),u=n(6506),h=n(8625);function c(e){if(!e||!e.includes("-"))return null;let[t,n]=e.split("-"),i=Number(t),r=Number(n);return Number.isFinite(i)&&Number.isFinite(r)?{row:i,col:r}:null}function m(e){let t=e.filter(e=>Number.isFinite(e)),n=t.length?Math.min(...t):0,i=t.length?Math.max(...t):1,r=Math.max(1e-6,i-n);return{min:n,max:i,range:r,apply:e=>(e-n)/r}}function p(e,t,n,i,r){let l=(0,u.uZ)(i,0,1)*(t-1),o=(0,u.uZ)(r,0,1)*(n-1),a=Math.floor(l),s=Math.floor(o),d=Math.min(t-1,a+1),h=Math.min(n-1,s+1),c=l-a,m=(0,u.t7)(e[s*t+a],e[s*t+d],c),p=(0,u.t7)(e[h*t+a],e[h*t+d],c);return(0,u.t7)(m,p,o-s)}function f(e){return"soil"===e?"Soil Moisture":"et"===e?"Evapotranspiration":"NDVI"}function g(e){var t,n,g,v;let{open:x,bbox:w,texturePng:b,metricGrid:y,layer:M,selectedCell:j,quality:N="high"}=e,S=(0,r.useRef)(null),[_,k]=(0,r.useState)(!1),[A,I]=(0,r.useState)(null),[E,P]=(0,r.useState)(null),[T,W]=(0,r.useState)(null),[C,D]=(0,r.useState)(null),F=(0,r.useMemo)(()=>c(j),[j]),H=(0,r.useMemo)(()=>(function(e){let t=c(e);return t?"P".concat(3*t.row+t.col+1):null})(j),[j]),O=(0,r.useMemo)(()=>!!(y&&Array.isArray(y.values)&&y.width>1&&y.height>1&&y.values.length>=y.width*y.height),[y]),[z,K]=(0,r.useState)(()=>"undefined"!=typeof document&&document.documentElement.classList.contains("dark"));return((0,r.useEffect)(()=>{if("undefined"==typeof document)return;let e=document.documentElement,t=()=>K(e.classList.contains("dark"));t();let n=new MutationObserver(t);return n.observe(e,{attributes:!0,attributeFilter:["class"]}),()=>n.disconnect()},[]),(0,r.useEffect)(()=>{if(!x||!w)return;let e=new AbortController,t="high"===N?[128,96,64]:"balanced"===N?[96,64]:[64];return async function(){k(!0),I(null),P(null);try{let o="Terrain fetch failed";for(let a of t){var n,i,r,l;let t=await fetch("/api/terrain/fetch",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({bbox:w,resolution:a,layer:M,quality:N}),signal:e.signal}),s=await t.json().catch(()=>({}));if(!t.ok||!(null==s?void 0:s.success)){o=String((null==s?void 0:s.message)||(null==s?void 0:s.error)||"Terrain fetch failed (".concat(t.status,")"));continue}let d=!!(null==s?void 0:s.degraded),u=null==s?void 0:s.data,h=u&&Array.isArray(u.demGrid)&&u.demGrid.length>0&&Number(u.width)>1&&Number(u.height)>1;if(d||!h){o=String((null==s?void 0:null===(r=s.warnings)||void 0===r?void 0:r[0])||(null==s?void 0:s.reason)||"Terrain unavailable for the selected AOI.");continue}P(u),W({smoothed:!!(null===(l=null==s?void 0:null===(n=s.meshMeta)||void 0===n?void 0:n.smoothed)||void 0===l||l),resolution:Number((null==s?void 0:null===(i=s.meshMeta)||void 0===i?void 0:i.resolution)||a)}),I(null);return}P(null),I(o)}catch(t){if(e.signal.aborted)return;P(null),I(String((null==t?void 0:t.message)||"Terrain fetch failed"))}finally{e.signal.aborted||k(!1)}}(),()=>e.abort()},[x,M,null==w?void 0:w.join(","),N]),(0,r.useEffect)(()=>{if(!x||!S.current||!E||!Array.isArray(E.demGrid)||0===E.demGrid.length||E.width<2||E.height<2)return;let e=S.current,t=new l.xsS,n=e.clientWidth||1e3,i=e.clientHeight||420,r=new l.cPb(50,n/i,.1,1400);r.position.set(0,90,148);let s=new o.CP7({antialias:!0,alpha:!0});s.setSize(n,i),s.setPixelRatio(Math.min(2,window.devicePixelRatio||1)),s.outputColorSpace=l.KI_,s.toneMapping=l.LY2,s.toneMappingExposure=1.02,s.setClearColor(0,0),e.innerHTML="",e.appendChild(s.domElement);let d=new a.z(r,s.domElement);d.enableDamping=!0,d.dampingFactor=.08,d.maxPolarAngle=Math.PI/2.03,d.minDistance=30,d.maxDistance=260,d.target.set(0,6,0),t.add(new l.Mig(16777215,z?.74:.66));let c=new l.Ox3(16055295,z?1.12:1.04);c.position.set(130,142,60),t.add(c);let f=new l.Ox3(z?9483519:10664920,z?.5:.42);f.position.set(-120,84,-120),t.add(f);let g=function(e,t,n,i){let r=t*n,l=new Float32Array(r);for(let t=0;t<r;t++){let n=Number(e[t]);l[t]=Number.isFinite(n)?n:0}if(i<=0||t<3||n<3)return l;let{min:o,max:a}=m(Array.from(l)),s=Math.max(.5,(a-o)*.18),d=l;for(let e=0;e<i;e++){let e=new Float32Array(r),i=new Float32Array(r);for(let i=0;i<n;i++)for(let n=0;n<t;n++){let r=i*t+n,l=d[i*t+Math.max(0,n-1)],o=d[r],a=d[i*t+Math.min(t-1,n+1)];e[r]=.2*l+.6*o+.2*a}for(let r=0;r<n;r++)for(let o=0;o<t;o++){let a=r*t+o,d=.2*e[Math.max(0,r-1)*t+o]+.6*e[a]+.2*e[Math.min(n-1,r+1)*t+o],h=l[a];i[a]=(0,u.uZ)(d,h-s,h+s)}d=i}return d}(E.demGrid,E.width,E.height,"high"===N?4:"balanced"===N?2:1),v=m(Array.from(g)),w="high"===N?42:"balanced"===N?36:31,b=new Float32Array(g.length),j="high"===N?80:"balanced"===N?64:52;for(let e=0;e<g.length;e++){let t=Math.pow((0,u.uZ)(v.apply(g[e]),0,1),1.08),n=Math.round(t*j)/j;b[e]=(0,u.t7)(t,n,.68)*w}let _=new l._12(120,120,E.width-1,E.height-1),k=_.attributes.position;for(let e=0;e<b.length;e++)k.setZ(e,b[e]);k.needsUpdate=!0,_.computeVertexNormals();let A=new l.Wid({color:z?6254983:9674926,metalness:.03,roughness:.9}),I=new l.Kj0(_,A);I.rotation.x=-Math.PI/2,t.add(I);let P=new l.vBJ({color:16777215,transparent:!0,opacity:.96,side:l.ehD}),T=new l.Kj0(_,P);T.rotation.x=-Math.PI/2,T.position.y=.18,t.add(T);let W=new l.ejS(new l.Uk6(_),new l.nls({color:z?10072008:2768466,transparent:!0,opacity:z?.14:.1}));W.rotation.x=-Math.PI/2,t.add(W);let C=(e,t)=>p(b,E.width,E.height,e,t),K=new l.Wid({color:z?5796494:9216951,roughness:.92,metalness:.01,side:l.ehD,transparent:!0,opacity:.96}),L=[];for(let e of["north","south","west","east"]){let n="north"===e||"south"===e?E.width-1:E.height-1,i=function(e,t,n,i,r,o){let a=[],s=[],d=[];for(let l=0;l<=t;l++){let o=l/Math.max(1,t),d=o,u=o;"north"===e?(d=o,u=0):"south"===e?(d=o,u=1):(d="west"===e?0:1,u=o);let h=-i/2+d*i,c=-r/2+u*r,m=n(d,u)+.04,p=h,f=c;"north"===e&&(f-=2.6),"south"===e&&(f+=2.6),"west"===e&&(p-=2.6),"east"===e&&(p+=2.6),a.push(h,m,c),a.push(p,-1.35,f),s.push(d,u),s.push(d,u)}for(let e=0;e<t;e++){let t=2*e;d.push(t,t+1,t+2),d.push(t+1,t+3,t+2)}let u=new l.u9r;return u.setAttribute("position",new l.a$l(a,3)),u.setAttribute("uv",new l.a$l(s,2)),u.setIndex(d),u.computeVertexNormals(),u}(e,n,C,120,120,0),r=new l.Kj0(i,K);t.add(r),L.push(r)}let R=new l._12(120,120),V=new l.Wid({color:z?3559530:10860744,roughness:.94,metalness:0,side:l.ehD,transparent:!0,opacity:.94}),Z=new l.Kj0(R,V);Z.rotation.x=-Math.PI/2,Z.position.y=-1.35,t.add(Z);let G=new l.jyz({uniforms:{uMaxHeight:{value:w},uDensity:{value:"high"===N?38:"balanced"===N?32:26},uThickness:{value:.034},uOpacity:{value:z?.42:.35},uLineColor:{value:new l.Ilk(z?2044745:5203839)}},vertexShader:"\n        varying float vHeight;\n        uniform float uMaxHeight;\n        void main() {\n          vHeight = max(0.0, position.z / max(uMaxHeight, 0.001));\n          gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n        }\n      ",fragmentShader:"\n        varying float vHeight;\n        uniform float uDensity;\n        uniform float uThickness;\n        uniform float uOpacity;\n        uniform vec3 uLineColor;\n        void main() {\n          float f = fract(vHeight * uDensity);\n          float d = min(f, 1.0 - f);\n          float aa = fwidth(vHeight * uDensity) * 0.9;\n          float line = 1.0 - smoothstep(uThickness, uThickness + aa, d);\n          gl_FragColor = vec4(uLineColor, line * uOpacity);\n        }\n      ",transparent:!0,depthWrite:!1}),U=new l.Kj0(_,G);U.rotation.x=-Math.PI/2,U.position.y=.26,t.add(U);let B=[],Q=!1,J=null;O||D(null),(async()=>{if(O)try{let e=await function(e,t,n,i){if(!e)throw Error("metric_grid_missing");let r=(0,h.a8)({metric:t,grid:{values:e.values,width:e.width,height:e.height,min:e.min,max:e.max},outputWidth:n,outputHeight:i,contours:!1}),o=new l.ROQ(r.canvas);return o.colorSpace=l.KI_,o.wrapS=l.uWy,o.wrapT=l.uWy,o.needsUpdate=!0,{texture:o,range:r.range}}(y,M,E.width,E.height);if(Q){e.texture.dispose();return}let t=s.capabilities.getMaxAnisotropy();(J=e.texture).anisotropy=Math.max(2,Math.min(t,16)),P.map=J,P.needsUpdate=!0,K.map=J,K.needsUpdate=!0,D(e.range)}catch(e){D(null)}})();let q=function(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,i=-60+120*e,r=-60+120*t,o=p(b,E.width,E.height,e,t)+n;return new l.Pa4(i,o,r)},$=(e,n,i,r,o)=>{var a,s,d,u,h,c,m;let p=[q(e,i,null!==(a=null==o?void 0:o.lift)&&void 0!==a?a:.18),q(n,i,null!==(s=null==o?void 0:o.lift)&&void 0!==s?s:.18),q(n,r,null!==(d=null==o?void 0:o.lift)&&void 0!==d?d:.18),q(e,r,null!==(u=null==o?void 0:o.lift)&&void 0!==u?u:.18)],f=new l.u9r().setFromPoints(p),g=new l.nls({color:null!==(h=null==o?void 0:o.color)&&void 0!==h?h:z?14083583:2046546,transparent:!0,opacity:null!==(c=null==o?void 0:o.opacity)&&void 0!==c?c:z?.76:.6,linewidth:null!==(m=null==o?void 0:o.lineWidth)&&void 0!==m?m:1,depthTest:!1,depthWrite:!1}),v=new l.blk(f,g);return t.add(v),B.push(()=>{f.dispose(),g.dispose()}),v};for(let e=0;e<3;e++)for(let t=0;t<3;t++)$(t/3,(t+1)/3,e/3,(e+1)/3,{color:z?12705279:2576498,opacity:z?.74:.62,lift:.26});if(F){let e=F.col/3,n=(F.col+1)/3,i=F.row/3,r=(F.row+1)/3,o=[{u:e,v:i},{u:n,v:i},{u:n,v:r},{u:e,v:r}],a=new l.u9r().setFromPoints([q(e,i,.2),q(n,i,.2),q(n,r,.2),q(e,r,.2)]);a.setIndex([0,1,2,0,2,3]),a.computeVertexNormals();let s=new l.vBJ({color:5101823,transparent:!0,opacity:.21,depthTest:!1,depthWrite:!1,side:l.ehD}),d=new l.Kj0(a,s);for(let u of(t.add(d),B.push(()=>{a.dispose(),s.dispose()}),$(e,n,i,r,{color:9434367,opacity:1,lift:.38}),$(e,n,i,r,{color:16773772,opacity:.86,lift:.48}),o)){let e=q(u.u,u.v,.4),n=e.clone();n.y+=2.8;let i=new l.fHI(.09,.09,2.8,10),r=new l.Wid({color:10875900,emissive:947344,emissiveIntensity:.6,roughness:.35}),o=new l.Kj0(i,r);o.position.set(e.x,(e.y+n.y)/2,e.z),t.add(o);let a=function(e){let t=document.createElement("canvas");t.width=64,t.height=64;let n=t.getContext("2d");if(!n)return null;n.clearRect(0,0,64,64),n.fillStyle=e,n.beginPath(),n.arc(32,32,11,0,2*Math.PI),n.fill(),n.strokeStyle="rgba(255,255,255,0.96)",n.lineWidth=4,n.stroke();let i=new l.ROQ(t);i.colorSpace=l.KI_;let r=new l.xeV({map:i,transparent:!0,depthTest:!1,depthWrite:!1}),o=new l.jyi(r);return o.scale.set(1.6,1.6,1),{sprite:o,texture:i,material:r}}("#67e8f9");a&&(a.sprite.position.set(n.x,n.y,n.z),t.add(a.sprite),B.push(()=>{a.texture.dispose(),a.material.dispose()})),B.push(()=>{i.dispose(),r.dispose()})}if(H){let o=q((e+n)/2,(i+r)/2,4.2),a=function(e){let t=document.createElement("canvas");t.width=256,t.height=80;let n=t.getContext("2d");if(!n)return null;n.clearRect(0,0,t.width,t.height),n.fillStyle="rgba(6, 11, 24, 0.82)",n.fillRect(8,12,240,56),n.strokeStyle="rgba(56, 189, 248, 0.95)",n.lineWidth=3,n.strokeRect(8,12,240,56),n.fillStyle="#e2f5ff",n.font='600 34px "IBM Plex Sans", sans-serif',n.textAlign="center",n.textBaseline="middle",n.fillText(e,t.width/2,t.height/2);let i=new l.ROQ(t);i.colorSpace=l.KI_;let r=new l.xeV({map:i,transparent:!0,depthTest:!1,depthWrite:!1}),o=new l.jyi(r);return o.scale.set(14,4.4,1),{sprite:o,texture:i,material:r}}(H);a&&(a.sprite.position.set(o.x,o.y,o.z),t.add(a.sprite),B.push(()=>{a.texture.dispose(),a.material.dispose()}))}}let Y=!0,X=()=>{Y&&(d.update(),s.render(t,r),requestAnimationFrame(X))};X();let ee=()=>{let t=e.clientWidth||1e3,n=e.clientHeight||420;r.aspect=t/n,r.updateProjectionMatrix(),s.setSize(t,n)};return window.addEventListener("resize",ee),()=>{Q=!0,Y=!1,window.removeEventListener("resize",ee),d.dispose(),_.dispose(),W.geometry.dispose(),W.material.dispose(),A.dispose(),P.dispose(),G.dispose(),L.forEach(e=>e.geometry.dispose()),K.dispose(),R.dispose(),V.dispose(),null==J||J.dispose(),B.forEach(e=>e()),s.dispose(),s.domElement.parentNode===e&&e.removeChild(s.domElement)}},[x,E,y,j,M,N,H,z,O]),x)?(0,i.jsxs)("div",{className:"rounded-2xl border border-border bg-card p-3 text-foreground",children:[(0,i.jsxs)("div",{className:"mb-2 flex items-center justify-between",children:[(0,i.jsxs)("p",{className:"flex items-center gap-2 text-sm font-semibold",children:[(0,i.jsx)(s,{className:"h-4 w-4 text-sky-300"}),"3D Terrain Viewer"]}),(0,i.jsxs)("p",{className:"text-xs text-muted-foreground",children:["Metric: ",f(M)," | ",(null==E?void 0:E.source)||"loading terrain"]})]}),_&&(0,i.jsxs)("div",{className:"mb-2 inline-flex items-center gap-2 rounded-lg border border-border px-2 py-1 text-xs text-muted-foreground",children:[(0,i.jsx)(d.Z,{className:"h-3.5 w-3.5 animate-spin"}),"Loading DEM for selected AOI"]}),A&&(0,i.jsx)("div",{className:"mb-2 rounded-lg border border-rose-700/60 bg-rose-500/10 px-2 py-1 text-xs text-rose-700 dark:text-rose-300",children:A}),!O&&(0,i.jsxs)("div",{className:"mb-2 rounded-lg border border-amber-700/50 bg-amber-500/10 px-2 py-1 text-xs text-amber-800 dark:text-amber-300",children:["Quantitative ",f(M)," grid is unavailable for this run, so numeric color overlay is disabled."]}),(0,i.jsx)("div",{ref:S,className:"h-[24rem] w-full overflow-hidden rounded-xl border border-border/70 ".concat(z?"bg-[radial-gradient(120%_100%_at_20%_0%,rgba(22,101,139,0.35)_0%,rgba(6,24,44,0.92)_52%,rgba(4,13,27,0.98)_100%)]":"bg-[radial-gradient(120%_100%_at_15%_0%,rgba(186,230,253,0.9)_0%,rgba(224,242,254,0.76)_45%,rgba(214,226,236,0.94)_100%)]")}),(0,i.jsxs)("div",{className:"mt-2 rounded-lg border border-border/80 bg-muted/35 p-2",children:[(0,i.jsxs)("p",{className:"text-[11px] uppercase tracking-[0.14em] text-muted-foreground",children:[f(M)," scale ",O?(null==y?void 0:y.isSimulated)?"(simulated)":"(measured)":"(unavailable)"]}),(0,i.jsx)("div",{className:"mt-1 h-3 w-full rounded",style:{backgroundImage:(0,u.G5)(M)}}),(0,i.jsxs)("div",{className:"mt-1 flex items-center justify-between text-[11px] text-muted-foreground",children:[(0,i.jsx)("span",{children:O?(null!==(n=null!==(t=null==C?void 0:C.min)&&void 0!==t?t:null==y?void 0:y.min)&&void 0!==n?n:0).toFixed(3):"N/A"}),(0,i.jsx)("span",{children:(null==y?void 0:y.units)?y.units:"soil"===M?"m3/m3":"et"===M?"mm/day":"NDVI"}),(0,i.jsx)("span",{children:O?(null!==(v=null!==(g=null==C?void 0:C.max)&&void 0!==g?g:null==y?void 0:y.max)&&void 0!==v?v:1).toFixed(3):"N/A"})]})]}),(0,i.jsx)("p",{className:"mt-2 text-[11px] text-muted-foreground",children:E?"High-fidelity topographic surface using ".concat(f(M)," color mapping from ").concat(O?"quantitative grid data":"neutral fallback shading",". Selected plot point: ").concat(H||"none").concat(T?" | mesh ".concat(T.resolution,"px").concat(T.smoothed?", smoothed":""):"","."):"Terrain will appear when providers return valid DEM coverage for this AOI."})]}):null}}}]);