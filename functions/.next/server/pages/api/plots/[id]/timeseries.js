"use strict";(()=>{var e={};e.id=50,e.ids=[50],e.modules={2509:e=>{e.exports=require("firebase-admin")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},6249:(e,r)=>{Object.defineProperty(r,"l",{enumerable:!0,get:function(){return function e(r,t){return t in r?r[t]:"then"in r&&"function"==typeof r.then?r.then(r=>e(r,t)):"function"==typeof r&&"default"===t?r:void 0}}})},2548:(e,r,t)=>{t.r(r),t.d(r,{config:()=>f,default:()=>l,routeModule:()=>E});var i={};t.r(i),t.d(i,{default:()=>c});var n=t(1802),s=t(7153),a=t(6249),o=t(535);function d(e){return String(e||"")}function u(e){return"firebase_admin_misconfigured"===d(e?.code)||"FirebaseAdminConfigError"===d(e?.name)}async function c(e,r){let{id:t}=e.query;if(!t||"string"!=typeof t)return r.status(400).json({error:"id required"});if("GET"===e.method)try{let i=(0,o._)(),n=(0,o.D)(),s=(e.headers.authorization||"").replace("Bearer ","");if(!s)return r.status(401).json({error:"auth_required"});let a=(await n.verifyIdToken(s)).uid,d=await i.collection("plots").doc(t).get();if(!d.exists)return r.status(404).json({error:"not_found"});if(d.data()?.ownerUid!==a)return r.status(403).json({error:"forbidden"});let u=(await i.collection("plots").doc(t).collection("series").orderBy("date","asc").get()).docs.map(e=>({id:e.id,...e.data()}));return r.status(200).json({items:u})}catch(e){if(console.error("timeseries GET",e?.message||e),u(e))return r.status(503).json({error:"firebase_admin_misconfigured",message:"Server Firebase Admin credentials are not configured correctly.",hint:e?.hint||"Set FIREBASE_SERVICE_ACCOUNT_JSON with a valid private key and escaped newlines."});if(d(e?.message).toLowerCase().includes("token")||d(e?.code).includes("auth"))return r.status(401).json({error:"invalid_auth"});return r.status(500).json({error:"internal"})}if("POST"===e.method)try{let i=(0,o._)(),n=(0,o.D)(),s=(e.headers.authorization||"").replace("Bearer ","");if(!s)return r.status(401).json({error:"auth_required"});let a=(await n.verifyIdToken(s)).uid,d=await i.collection("plots").doc(t).get();if(!d.exists)return r.status(404).json({error:"not_found"});if(d.data()?.ownerUid!==a)return r.status(403).json({error:"forbidden"});let{date:u,ndviStats:c}=e.body||{};if(!u||!c)return r.status(400).json({error:"date and ndviStats required"});let l=await i.collection("plots").doc(t).collection("series").add({date:u,ndviStats:c});return r.status(201).json({id:l.id})}catch(e){if(console.error("timeseries POST",e?.message||e),u(e))return r.status(503).json({error:"firebase_admin_misconfigured",message:"Server Firebase Admin credentials are not configured correctly.",hint:e?.hint||"Set FIREBASE_SERVICE_ACCOUNT_JSON with a valid private key and escaped newlines."});if(d(e?.message).toLowerCase().includes("token")||d(e?.code).includes("auth"))return r.status(401).json({error:"invalid_auth"});return r.status(500).json({error:"internal"})}return r.status(405).end()}let l=(0,a.l)(i,"default"),f=(0,a.l)(i,"config"),E=new n.PagesAPIRouteModule({definition:{kind:s.x.PAGES_API,page:"/api/plots/[id]/timeseries",pathname:"/api/plots/[id]/timeseries",bundlePath:"",filename:""},userland:i})},535:(e,r,t)=>{t.d(r,{D:()=>c,_:()=>u});var i=t(2509),n=t.n(i);class s extends Error{constructor(e,r){super(e),this.name="FirebaseAdminConfigError",this.code="firebase_admin_misconfigured",this.hint=r}}let a="idle",o=null;function d(){if("ready"!==a){if("failed"===a&&o)throw o;try{if(!n().apps.length){let e=process.env.FIREBASE_SERVICE_ACCOUNT_JSON;if(e){let r=function(e){let r;try{r=JSON.parse(e)}catch{throw new s("FIREBASE_SERVICE_ACCOUNT_JSON is not valid JSON.","Use a single-line JSON string from your Firebase service account key.")}if(!r||"object"!=typeof r)throw new s("FIREBASE_SERVICE_ACCOUNT_JSON is missing or invalid.","Set FIREBASE_SERVICE_ACCOUNT_JSON to the full service account JSON.");let t=String(r.private_key||"").replace(/\\n/g,"\n").trim();if(!(t.startsWith("-----BEGIN PRIVATE KEY-----")&&t.endsWith("-----END PRIVATE KEY-----")))throw new s("Firebase private key is not in valid PEM format.","Ensure private_key contains BEGIN/END markers and escaped newlines (\\\\n) in .env.");return{...r,private_key:t}}(e);n().initializeApp({credential:n().credential.cert(r),projectId:r.project_id||process.env.NEXT_PUBLIC_FIREBASE_PROJECT_ID})}else n().initializeApp()}a="ready",o=null}catch(e){throw a="failed",o=function(e){if(e instanceof s)return e;let r=String(e?.message||e||"Unknown Firebase Admin error"),t=r.toLowerCase();return t.includes("pem")||t.includes("private key")||t.includes("credential")?new s(r,"Rotate and re-add FIREBASE_SERVICE_ACCOUNT_JSON. Ensure private_key newline escaping is correct."):e instanceof Error?e:Error(r)}(e)}}}function u(){return d(),n().firestore()}function c(){return d(),n().auth()}},7153:(e,r)=>{var t;Object.defineProperty(r,"x",{enumerable:!0,get:function(){return t}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(t||(t={}))},1802:(e,r,t)=>{e.exports=t(145)}};var r=require("../../../../webpack-api-runtime.js");r.C(e);var t=r(r.s=2548);module.exports=t})();