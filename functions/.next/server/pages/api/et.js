"use strict";(()=>{var e={};e.id=230,e.ids=[230],e.modules={145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},1253:e=>{e.exports=require("pngjs")},1593:e=>{e.exports=import("geotiff")},6113:e=>{e.exports=require("crypto")},5229:(e,t,r)=>{r.a(e,async(e,a)=>{try{r.r(t),r.d(t,{config:()=>m,default:()=>l,routeModule:()=>d});var i=r(1802),n=r(7153),s=r(6249),o=r(4408),u=e([o]);o=(u.then?(await u)():u)[0];let l=(0,s.l)(o,"default"),m=(0,s.l)(o,"config"),d=new i.PagesAPIRouteModule({definition:{kind:n.x.PAGES_API,page:"/api/et",pathname:"/api/et",bundlePath:"",filename:""},userland:o});a()}catch(e){a(e)}})},8851:(e,t,r)=>{r.d(t,{NI:()=>u,Xb:()=>o,kw:()=>s,sA:()=>l});var a=r(6113);let i=globalThis;function n(){return i.__agrisenseMemoryCache||(i.__agrisenseMemoryCache=new Map),i.__agrisenseMemoryCache}function s(e){return(0,a.createHash)("sha1").update(e.join("|")).digest("hex")}function o(e){let t=n(),r=t.get(e);return r?Date.now()>r.expiresAt?(t.delete(e),null):r.value:null}function u(e,t,r){n().set(e,{value:t,expiresAt:Date.now()+r})}function l(e){let t=n();if(!e){let e=t.size;return t.clear(),e}let r=0,a=[];return t.forEach((t,r)=>{r.startsWith(e)&&a.push(r)}),a.forEach(e=>{t.delete(e)&&(r+=1)}),r}},4408:(e,t,r)=>{r.a(e,async(e,a)=>{try{r.r(t),r.d(t,{default:()=>g});var i=r(1253),n=r(8851),s=r(468),o=r(913),u=e([s]);function l(e,t,r){return Math.max(t,Math.min(r,e))}function m(e,t=4){let r=Math.pow(10,t);return Math.round(e*r)/r}function d(e,t,r){let a=Buffer.from(e,"base64"),i=t*r,n=new Float32Array(a.buffer,a.byteOffset,Math.min(i,Math.floor(a.byteLength/4))),s=new Float32Array(i);for(let e=0;e<i;e++){let t=Number(n[e]);s[e]=Number.isFinite(t)?t:Number.NaN}return s}function c(e,t,r){if(!e)return null;let a=Buffer.from(e,"base64"),i=t*r,n=new Uint8Array(i);for(let e=0;e<i;e++)n[e]=e<a.length&&a[e]>0?1:0;return n}async function h(e,t=15e3){let r=new AbortController,a=setTimeout(()=>r.abort(),t);try{let t=await fetch(e,{signal:r.signal});if(!t.ok)throw Error(`http_${t.status}`);return await t.json()}finally{clearTimeout(a)}}async function b(e,t){let r=new URL("https://api.open-meteo.com/v1/forecast");r.searchParams.set("latitude",String(e)),r.searchParams.set("longitude",String(t)),r.searchParams.set("timezone","auto"),r.searchParams.set("past_days","7"),r.searchParams.set("forecast_days","1"),r.searchParams.set("daily","et0_fao_evapotranspiration");let a=await h(r.toString()),i=Array.isArray(a?.daily?.et0_fao_evapotranspiration)?a.daily.et0_fao_evapotranspiration.filter(e=>Number.isFinite(Number(e))).map(Number):[];if(!i.length)throw Error("et_baseline_unavailable");return l(Number(i[i.length-1]),.05,14)}async function f(e){let t=e.geometry?JSON.stringify(e.geometry):"none",r=(0,n.kw)(["soil-et-ingest-v1",e.bbox[0],e.bbox[1],e.bbox[2],e.bbox[3],t,e.date||"auto",e.targetSize||0]),a=(0,n.Xb)(r);if(a?.result)return{...a,cacheHit:!0};let i=await (0,s.J)({bbox:e.bbox,geometry:e.geometry,date:e.date,targetSize:e.targetSize,policy:"balanced"});return(0,n.NI)(r,i,48e4),{...i,cacheHit:!1}}async function g(e,t){let r;if("POST"!==e.method)return t.status(405).end();try{r=function(e){let t=Array.isArray(e?.bbox)?e.bbox.map(Number):[];if(4!==t.length||t.some(e=>Number.isNaN(e)))throw Error("bbox_required");let r=e?.geometry&&"object"==typeof e.geometry?e.geometry:void 0,a="string"==typeof e?.date?e.date:void 0,i=Number.isFinite(Number(e?.targetSize))?Number(e.targetSize):void 0;return{bbox:t,geometry:r,date:a,targetSize:i}}(e.body||{})}catch{return t.status(400).json({error:"bbox_required",message:"Bounding box [minLon,minLat,maxLon,maxLat] is required."})}let a=(r.bbox[1]+r.bbox[3])/2,n=(r.bbox[0]+r.bbox[2])/2,s=[],u=[];try{let e=b(a,n),h=f(r),[g,p]=await Promise.all([e,h]);s.push({provider:"open-meteo-et0",ok:!0}),s.push({provider:p.result.provider,ok:!0});let y=p.result.ndvi?.metricGrid,N=p.result.ndmi?.metricGrid;if(!y?.encoded||!N?.encoded||!y.width||!y.height||!N.width||!N.height||y.width!==N.width||y.height!==N.height)return t.status(200).json({success:!0,unavailable:!0,message:"NDVI/NDMI proxy grids are unavailable for this AOI/date selection.",source:"strict-real-only",isSimulated:!1,cacheHit:p.cacheHit,warnings:u,providersTried:s,representation:"hybrid-estimate",alignment:p.result.alignment,data:null});let x=d(y.encoded,y.width,y.height),w=d(N.encoded,N.width,N.height),v=c(y.validMaskEncoded,y.width,y.height),_=c(N.validMaskEncoded,N.width,N.height),M=Number(p.result.ndvi.stats.min),S=Number(p.result.ndvi.stats.max),I=Number(p.result.ndmi.stats.min),A=Number(p.result.ndmi.stats.max),E=Math.max(1e-6,S-M),P=Math.max(1e-6,A-I),T=new Float32Array(x.length),k=new Uint8Array(x.length),F=Number.POSITIVE_INFINITY,D=Number.NEGATIVE_INFINITY,O=0,j=0;for(let e=0;e<x.length;e++){if(v&&!v[e]||_&&!_[e]){T[e]=Number.NaN,k[e]=0;continue}let t=Number(x[e]),r=Number(w[e]);if(!Number.isFinite(t)||!Number.isFinite(r)){T[e]=Number.NaN,k[e]=0;continue}let a=l((t-M)/E,0,1),i=l((r-I)/P,0,1),n=l(.18+.9*a+(i-.5)*.24,.12,1.28),s=l(g*n,.02,16);T[e]=s,k[e]=1,F=Math.min(F,s),D=Math.max(D,s),O+=s,j+=1}if(!Number.isFinite(F)||!Number.isFinite(D)||j<=0)return t.status(200).json({success:!0,unavailable:!0,message:"ET proxy grid had no valid pixels for this AOI/date selection.",source:"strict-real-only",isSimulated:!1,cacheHit:p.cacheHit,warnings:u,providersTried:s,representation:"hybrid-estimate",alignment:p.result.alignment,data:null});let H=O/j,z=Buffer.from(T.buffer,T.byteOffset,T.byteLength).toString("base64"),L=Buffer.from(k.buffer,k.byteOffset,k.byteLength).toString("base64"),q=function(e,t,r,a,n,s){let u=new i.PNG({width:r,height:a}),m=Math.max(1e-6,s-n);for(let r=0;r<e.length;r++){let a=4*r,i=Number(e[r]);if(t&&!t[r]||!Number.isFinite(i)){u.data[a]=0,u.data[a+1]=0,u.data[a+2]=0,u.data[a+3]=0;continue}let s=l((e[r]-n)/m,0,1),[d,c,h]=(0,o.TU)("et",s);u.data[a]=d,u.data[a+1]=c,u.data[a+2]=h,u.data[a+3]=255}return i.PNG.sync.write(u).toString("base64")}(T,k,y.width,y.height,F,D);return Array.isArray(p.warnings)&&p.warnings.length&&u.push(...p.warnings),t.status(200).json({success:!0,source:"Open-Meteo ET0 + Sentinel-2 NDVI/NDMI proxy",isSimulated:!1,cacheHit:p.cacheHit,unavailable:!1,warnings:u,providersTried:s,representation:"hybrid-estimate",baseline:{provider:"open-meteo",variable:"et0_fao_evapotranspiration",value:m(g),units:"mm/day",timestamp:new Date().toISOString()},proxy:{provider:p.result.provider,metric:"kc_proxy",formula:"ETc ~= ET0 * clamp(0.18 + 0.9*NDVI_norm + 0.24*(NDMI_norm-0.5), 0.12, 1.28)",sceneRef:p.result.sceneRef,dataResolutionMeters:p.result.dataResolutionMeters},alignment:p.result.alignment,data:{evapotranspiration:z,metricGrid:{encoded:z,validMaskEncoded:L,normalizationMode:"fixedPhysicalRange",width:y.width,height:y.height,min:m(F),max:m(D)},overlayPng:q,stats:{min:m(F),max:m(D),mean:m(H)},bbox:p.result.bbox,source:"Hybrid estimate (Open-Meteo ET0 baseline + NDVI/NDMI Kc proxy)",isSimulated:!1,units:"mm/day",timestamp:new Date().toISOString()}})}catch(r){let e=String(r?.message||"et_fetch_failed");return e.startsWith("http_")&&s.push({provider:"open-meteo-et0",ok:!1,reason:e}),s.some(e=>"hybrid-et-proxy"===e.provider)||s.push({provider:"hybrid-et-proxy",ok:!1,reason:e}),t.status(200).json({success:!0,unavailable:!0,message:"ET layer unavailable under strict real-only mode.",source:"strict-real-only",isSimulated:!1,cacheHit:!1,warnings:[e],providersTried:s,representation:"hybrid-estimate",data:null})}}s=(u.then?(await u)():u)[0],a()}catch(e){a(e)}})}};var t=require("../../webpack-api-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[121],()=>r(5229));module.exports=a})();