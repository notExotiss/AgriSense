"use strict";(()=>{var e={};e.id=969,e.ids=[969],e.modules={145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},1253:e=>{e.exports=require("pngjs")},1593:e=>{e.exports=import("geotiff")},6113:e=>{e.exports=require("crypto")},2004:(e,t,r)=>{r.a(e,async(e,o)=>{try{r.r(t),r.d(t,{config:()=>h,default:()=>s,routeModule:()=>m});var n=r(1802),a=r(7153),i=r(6249),l=r(9033),u=e([l]);l=(u.then?(await u)():u)[0];let s=(0,i.l)(l,"default"),h=(0,i.l)(l,"config"),m=new n.PagesAPIRouteModule({definition:{kind:a.x.PAGES_API,page:"/api/home/hero-map",pathname:"/api/home/hero-map",bundlePath:"",filename:""},userland:l});o()}catch(e){o(e)}})},9711:(e,t,r)=>{r.d(t,{z:()=>s});var o=r(1253);let n={ndvi:[{stop:0,color:[93,123,223]},{stop:.16,color:[110,177,236]},{stop:.32,color:[106,219,226]},{stop:.5,color:[129,216,156]},{stop:.68,color:[232,220,124]},{stop:.84,color:[242,176,114]},{stop:1,color:[226,126,134]}],soil:[{stop:0,color:[106,128,214]},{stop:.2,color:[122,182,232]},{stop:.4,color:[121,219,196]},{stop:.58,color:[152,214,149]},{stop:.76,color:[236,204,126]},{stop:1,color:[214,139,102]}],et:[{stop:0,color:[98,120,218]},{stop:.2,color:[109,165,232]},{stop:.4,color:[114,217,223]},{stop:.6,color:[146,214,149]},{stop:.78,color:[241,197,116]},{stop:1,color:[226,126,110]}]};function a(e,t,r){return Math.max(t,Math.min(r,e))}function i(e,t=4){let r=Math.pow(10,t);return Math.round(e*r)/r}function l(e,t,r,o,n){return e[Math.max(0,Math.min(r-1,n))*t+Math.max(0,Math.min(t-1,o))]}function u(e,t,r){let n=new o.PNG({width:e,height:t});for(let o=0;o<t;o++)for(let t=0;t<e;t++){let a=o*e+t,i=4*a,[l,u,s,h]=r(a,t,o);n.data[i]=l,n.data[i+1]=u,n.data[i+2]=s,n.data[i+3]=h}return o.PNG.sync.write(n).toString("base64")}function s(e){let t=Math.max(8,Number(e.width)),r=Math.max(8,Number(e.height)),o=function(e,t,r,o=3){let n=t*r,i=new Float32Array(n);for(let t=0;t<n;t++){let r=Number(e[t]);i[t]=Number.isFinite(r)?r:0}if(o<=0||t<3||r<3)return i;let l=Number.POSITIVE_INFINITY,u=Number.NEGATIVE_INFINITY;for(let e=0;e<i.length;e++){let t=i[e];t<l&&(l=t),t>u&&(u=t)}Number.isFinite(l)&&Number.isFinite(u)||(l=0,u=1);let s=Math.max(.02,(u-l)*.12),h=i;for(let e=0;e<o;e++){let e=new Float32Array(n),o=new Float32Array(n);for(let o=0;o<r;o++)for(let r=0;r<t;r++){let n=o*t+r,a=h[o*t+Math.max(0,r-1)],i=h[n],l=h[o*t+Math.min(t-1,r+1)];e[n]=.22*a+.56*i+.22*l}for(let n=0;n<r;n++)for(let l=0;l<t;l++){let u=n*t+l,h=.22*e[Math.max(0,n-1)*t+l]+.56*e[u]+.22*e[Math.min(r-1,n+1)*t+l],m=i[u];o[u]=a(h,m-s,m+s)}h=o}return h}(e.values,t,r,3),s=function(e,t,r){let o=Number.POSITIVE_INFINITY,n=Number.NEGATIVE_INFINITY;for(let t=0;t<e.length;t++){let r=Number(e[t]);Number.isFinite(r)&&(r<o&&(o=r),r>n&&(n=r))}return Number.isFinite(o)&&Number.isFinite(n)&&!(n-o<1e-6)?{min:o,max:n}:{min:Number.isFinite(t)?t:0,max:Number.isFinite(r)&&r>t?r:1}}(o,e.min,e.max),h=function(e,t,r){let o=Math.max(1e-6,r-t),n=new Float32Array(e.length);for(let r=0;r<e.length;r++)n[r]=a((e[r]-t)/o,0,1);return n}(o,s.min,s.max),m=u(t,r,(e,o,n)=>{let i=h[e],u=l(h,t,r,o+1,n),s=l(h,t,r,o-1,n),m=l(h,t,r,o,n-1),c=a(.84-.34*(u-s)-.32*(l(h,t,r,o,n+1)-m),.36,1.14),d=Math.abs(20*i-Math.round(20*i)),f=Math.round(a(145*c+36,0,255));if(d<.036){let e=d<.015?.56:.34;return[Math.round(f*(1-.36*e)),Math.round(f*(1-.24*e)),Math.round(f*(1-.1*e)+Math.round(102*e)),255]}return[f,f,f,255]}),c=u(t,r,(e,o,i)=>{let u=h[e],s=l(h,t,r,o+1,i),m=l(h,t,r,o-1,i),c=l(h,t,r,o,i-1),d=l(h,t,r,o,i+1),f=s-m,p=d-c,g=a(1-.18*Math.sqrt(f*f+p*p),.9,1.1),[M,b,N]=function(e,t){let r=n[e],o=a(t,0,1);for(let e=0;e<r.length-1;e++){let t=r[e],n=r[e+1];if(o<=n.stop){var i,l,u;let e=(o-t.stop)/Math.max(1e-6,n.stop-t.stop);return[Math.round((i=t.color[0])+(n.color[0]-i)*e),Math.round((l=t.color[1])+(n.color[1]-l)*e),Math.round((u=t.color[2])+(n.color[2]-u)*e)]}}return r[r.length-1].color}("ndvi",u),w=Math.round(a(M*g,0,255)),x=Math.round(a(b*g,0,255)),v=Math.round(a(N*g,0,255)),y=Math.abs(20*u-Math.round(20*u));if(y<.024){let e=y<.01?.56:.36;w=Math.round((1-e)*w+10*e),x=Math.round((1-e)*x+20*e),v=Math.round((1-e)*v+44*e)}return[w,x,v,255]}),d=n.ndvi.map(e=>({value:i(s.min+(s.max-s.min)*e.stop,4),color:e.color}));return{outlinePng:m,topoPng:c,legend:{metric:"ndvi",min:i(s.min,4),max:i(s.max,4),unit:"NDVI",stops:d}}}},8851:(e,t,r)=>{r.d(t,{NI:()=>u,Xb:()=>l,kw:()=>i});var o=r(6113);let n=globalThis;function a(){return n.__agrisenseMemoryCache||(n.__agrisenseMemoryCache=new Map),n.__agrisenseMemoryCache}function i(e){return(0,o.createHash)("sha1").update(e.join("|")).digest("hex")}function l(e){let t=a(),r=t.get(e);return r?Date.now()>r.expiresAt?(t.delete(e),null):r.value:null}function u(e,t,r){a().set(e,{value:t,expiresAt:Date.now()+r})}},9033:(e,t,r)=>{r.a(e,async(e,o)=>{try{r.r(t),r.d(t,{default:()=>s});var n=r(1253),a=r(9711),i=r(468),l=r(8851),u=e([i]);i=(u.then?(await u)():u)[0];let h=[-74.49,40.45,-74.33,40.59];async function s(e,t){if("GET"!==e.method)return t.status(405).end();let r=(0,l.kw)(["home-hero-map-v1",...h,1024]),o=(0,l.Xb)(r);if(o?.data)return t.status(200).json({...o,cacheHit:!0,warnings:[...o.warnings,"Served from memory cache."]});try{let{result:e}=await (0,i.J)({bbox:h,targetSize:1024,policy:"balanced"}),o=e?.ndvi?.metricGrid,u=o?.encoded&&o.width>0&&o.height>0?{values:function(e,t,r){let o=Buffer.from(e,"base64"),n=t*r,a=new Float32Array(o.buffer,o.byteOffset,Math.min(n,Math.floor(o.byteLength/4))),i=Array(n).fill(0);for(let e=0;e<n;e++){let t=Number(a[e]??0);i[e]=Number.isFinite(t)?t:0}return i}(o.encoded,o.width,o.height),width:o.width,height:o.height,min:o.min,max:o.max}:function(e){let t=Buffer.from(e,"base64"),r=n.PNG.sync.read(t),o=Array(r.width*r.height);for(let e=0;e<o.length;e++){let t=4*e,n=r.data[t],a=r.data[t+1],i=r.data[t+2],l=(.2126*n+.7152*a+.0722*i)/255;o[e]=2*l-1}return{values:o,width:r.width,height:r.height,min:-1,max:1}}(e.ndvi.previewPng),s=(0,a.z)(u),m=function(e){let t=new Float32Array(e.length);for(let r=0;r<e.length;r++){let o=Number(e[r]);t[r]=Number.isFinite(o)?o:0}return Buffer.from(t.buffer).toString("base64")}(u.values),c={success:!0,cacheHit:!1,data:{outlinePng:s.outlinePng,topoPng:s.topoPng,legend:s.legend,bbox:e.bbox,source:e.provider,generatedAt:new Date().toISOString(),metricGrid:{encoded:m,width:u.width,height:u.height},imagery:e.imagery},warnings:o?.encoded?[]:["Metric grid unavailable; using preview-derived NDVI approximation."]};return(0,l.NI)(r,c,18e5),t.status(200).json(c)}catch(e){return t.status(200).json({success:!1,cacheHit:!1,warnings:["Hero map unavailable for this run."],message:String(e?.message||"hero_map_generation_failed")})}}o()}catch(e){o(e)}})}};var t=require("../../../webpack-api-runtime.js");t.C(e);var r=e=>t(t.s=e),o=t.X(0,[121],()=>r(2004));module.exports=o})();