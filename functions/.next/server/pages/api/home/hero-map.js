"use strict";(()=>{var e={};e.id=969,e.ids=[969],e.modules={145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},1253:e=>{e.exports=require("pngjs")},1593:e=>{e.exports=import("geotiff")},6113:e=>{e.exports=require("crypto")},2004:(e,t,r)=>{r.a(e,async(e,n)=>{try{r.r(t),r.d(t,{config:()=>s,default:()=>h,routeModule:()=>m});var a=r(1802),i=r(7153),u=r(6249),o=r(9033),l=e([o]);o=(l.then?(await l)():l)[0];let h=(0,u.l)(o,"default"),s=(0,u.l)(o,"config"),m=new a.PagesAPIRouteModule({definition:{kind:i.x.PAGES_API,page:"/api/home/hero-map",pathname:"/api/home/hero-map",bundlePath:"",filename:""},userland:o});n()}catch(e){n(e)}})},4927:(e,t,r)=>{r.d(t,{z:()=>l});var n=r(1253),a=r(913);function i(e,t=4){let r=Math.pow(10,t);return Math.round(e*r)/r}function u(e,t,r,n,a){return e[Math.max(0,Math.min(r-1,a))*t+Math.max(0,Math.min(t-1,n))]}function o(e,t,r){let a=new n.PNG({width:e,height:t});for(let n=0;n<t;n++)for(let t=0;t<e;t++){let i=n*e+t,u=4*i,[o,l,h,s]=r(i,t,n);a.data[u]=o,a.data[u+1]=l,a.data[u+2]=h,a.data[u+3]=s}return n.PNG.sync.write(a).toString("base64")}function l(e){let t=Math.max(8,Number(e.width)),r=Math.max(8,Number(e.height)),n=function(e,t,r,n=3){let i=t*r,u=new Float32Array(i);for(let t=0;t<i;t++){let r=Number(e[t]);u[t]=Number.isFinite(r)?r:0}if(n<=0||t<3||r<3)return u;let o=Number.POSITIVE_INFINITY,l=Number.NEGATIVE_INFINITY;for(let e=0;e<u.length;e++){let t=u[e];t<o&&(o=t),t>l&&(l=t)}Number.isFinite(o)&&Number.isFinite(l)||(o=0,l=1);let h=Math.max(.02,(l-o)*.12),s=u;for(let e=0;e<n;e++){let e=new Float32Array(i),n=new Float32Array(i);for(let n=0;n<r;n++)for(let r=0;r<t;r++){let a=n*t+r,i=s[n*t+Math.max(0,r-1)],u=s[a],o=s[n*t+Math.min(t-1,r+1)];e[a]=.22*i+.56*u+.22*o}for(let i=0;i<r;i++)for(let o=0;o<t;o++){let l=i*t+o,s=.22*e[Math.max(0,i-1)*t+o]+.56*e[l]+.22*e[Math.min(r-1,i+1)*t+o],m=u[l];n[l]=(0,a.uZ)(s,m-h,m+h)}s=n}return s}(e.values,t,r,3),l=function(e,t,r){let n=Number.POSITIVE_INFINITY,a=Number.NEGATIVE_INFINITY;for(let t=0;t<e.length;t++){let r=Number(e[t]);Number.isFinite(r)&&(r<n&&(n=r),r>a&&(a=r))}return Number.isFinite(n)&&Number.isFinite(a)&&!(a-n<1e-6)?{min:n,max:a}:{min:Number.isFinite(t)?t:0,max:Number.isFinite(r)&&r>t?r:1}}(n,e.min,e.max),h=function(e,t,r){let n=Math.max(1e-6,r-t),i=new Float32Array(e.length);for(let r=0;r<e.length;r++)i[r]=(0,a.uZ)((e[r]-t)/n,0,1);return i}(n,l.min,l.max),s=o(t,r,(e,n,i)=>{let o=h[e],l=u(h,t,r,n+1,i),s=u(h,t,r,n-1,i),m=u(h,t,r,n,i-1),d=u(h,t,r,n,i+1),f=(0,a.uZ)(.84-.34*(l-s)-.32*(d-m),.36,1.14),c=Math.abs(20*o-Math.round(20*o)),g=Math.round((0,a.uZ)(145*f+36,0,255));if(c<.036){let e=c<.015?.56:.34;return[Math.round(g*(1-.36*e)),Math.round(g*(1-.24*e)),Math.round(g*(1-.1*e)+Math.round(102*e)),255]}return[g,g,g,255]}),m=o(t,r,(e,n,i)=>{let o=h[e],l=u(h,t,r,n+1,i),s=u(h,t,r,n-1,i),m=u(h,t,r,n,i-1),d=u(h,t,r,n,i+1),f=l-s,c=d-m,g=(0,a.uZ)(1-.18*Math.sqrt(f*f+c*c),.9,1.1),[b,p,M]=(0,a.TU)("ndvi",o),N=Math.round((0,a.uZ)(b*g,0,255)),w=Math.round((0,a.uZ)(p*g,0,255)),x=Math.round((0,a.uZ)(M*g,0,255)),v=Math.abs(20*o-Math.round(20*o));if(v<.024){let e=v<.01?.56:.36;N=Math.round((1-e)*N+10*e),w=Math.round((1-e)*w+20*e),x=Math.round((1-e)*x+44*e)}return[N,w,x,255]}),d=a.CS.ndvi.map(e=>({value:i(l.min+(l.max-l.min)*e.stop,4),color:e.color}));return{outlinePng:s,topoPng:m,legend:{metric:"ndvi",min:i(l.min,4),max:i(l.max,4),unit:"NDVI",stops:d}}}},8851:(e,t,r)=>{r.d(t,{NI:()=>l,Xb:()=>o,kw:()=>u,sA:()=>h});var n=r(6113);let a=globalThis;function i(){return a.__agrisenseMemoryCache||(a.__agrisenseMemoryCache=new Map),a.__agrisenseMemoryCache}function u(e){return(0,n.createHash)("sha1").update(e.join("|")).digest("hex")}function o(e){let t=i(),r=t.get(e);return r?Date.now()>r.expiresAt?(t.delete(e),null):r.value:null}function l(e,t,r){i().set(e,{value:t,expiresAt:Date.now()+r})}function h(e){let t=i();if(!e){let e=t.size;return t.clear(),e}let r=0,n=[];return t.forEach((t,r)=>{r.startsWith(e)&&n.push(r)}),n.forEach(e=>{t.delete(e)&&(r+=1)}),r}},9033:(e,t,r)=>{r.a(e,async(e,n)=>{try{r.r(t),r.d(t,{default:()=>h});var a=r(1253),i=r(4927),u=r(468),o=r(8851),l=e([u]);u=(l.then?(await l)():l)[0];let s=[-74.49,40.45,-74.33,40.59];async function h(e,t){if("GET"!==e.method)return t.status(405).end();let r=(0,o.kw)(["home-hero-map-v1",...s,1024]),n=(0,o.Xb)(r);if(n?.data)return t.status(200).json({...n,cacheHit:!0,warnings:[...n.warnings,"Served from memory cache."]});try{let{result:e}=await (0,u.J)({bbox:s,targetSize:1024,policy:"balanced"}),n=e?.ndvi?.metricGrid,l=n?.encoded&&n.width>0&&n.height>0?{values:function(e,t,r){let n=Buffer.from(e,"base64"),a=t*r,i=new Float32Array(n.buffer,n.byteOffset,Math.min(a,Math.floor(n.byteLength/4))),u=Array(a).fill(0);for(let e=0;e<a;e++){let t=Number(i[e]??0);u[e]=Number.isFinite(t)?t:0}return u}(n.encoded,n.width,n.height),width:n.width,height:n.height,min:n.min,max:n.max}:function(e){let t=Buffer.from(e,"base64"),r=a.PNG.sync.read(t),n=Array(r.width*r.height);for(let e=0;e<n.length;e++){let t=4*e,a=r.data[t],i=r.data[t+1],u=r.data[t+2],o=(.2126*a+.7152*i+.0722*u)/255;n[e]=2*o-1}return{values:n,width:r.width,height:r.height,min:-1,max:1}}(e.ndvi.previewPng),h=(0,i.z)(l),m=function(e){let t=new Float32Array(e.length);for(let r=0;r<e.length;r++){let n=Number(e[r]);t[r]=Number.isFinite(n)?n:0}return Buffer.from(t.buffer).toString("base64")}(l.values),d={success:!0,cacheHit:!1,data:{outlinePng:h.outlinePng,topoPng:h.topoPng,legend:h.legend,bbox:e.bbox,source:e.provider,generatedAt:new Date().toISOString(),metricGrid:{encoded:m,width:l.width,height:l.height},imagery:e.imagery},warnings:n?.encoded?[]:["Metric grid unavailable; using preview-derived NDVI approximation."]};return(0,o.NI)(r,d,18e5),t.status(200).json(d)}catch(e){return t.status(200).json({success:!1,cacheHit:!1,warnings:["Hero map unavailable for this run."],message:String(e?.message||"hero_map_generation_failed")})}}n()}catch(e){n(e)}})}};var t=require("../../../webpack-api-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[121],()=>r(2004));module.exports=n})();