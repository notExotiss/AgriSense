"use strict";(()=>{var e={};e.id=466,e.ids=[466],e.modules={145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},1253:e=>{e.exports=require("pngjs")},1593:e=>{e.exports=import("geotiff")},6249:(e,t)=>{Object.defineProperty(t,"l",{enumerable:!0,get:function(){return function e(t,r){return r in t?t[r]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,r)):"function"==typeof t&&"default"===r?t:void 0}}})},4203:(e,t,r)=>{r.a(e,async(e,a)=>{try{r.r(t),r.d(t,{config:()=>d,default:()=>l,routeModule:()=>h});var i=r(1802),n=r(7153),o=r(6249),s=r(4049),u=e([s]);s=(u.then?(await u)():u)[0];let l=(0,o.l)(s,"default"),d=(0,o.l)(s,"config"),h=new i.PagesAPIRouteModule({definition:{kind:n.x.PAGES_API,page:"/api/terrain/fetch",pathname:"/api/terrain/fetch",bundlePath:"",filename:""},userland:s});a()}catch(e){a(e)}})},6653:(e,t,r)=>{r.d(t,{T3:()=>s,U4:()=>o,kW:()=>n,kv:()=>u,ls:()=>l});let a=globalThis;function i(){return a.__agrisenseProviderRuntime||(a.__agrisenseProviderRuntime={}),a.__agrisenseProviderRuntime}function n(e){let t=i()[e];return!!t&&Date.now()<t.cooldownUntil}function o(e){i()[e]={failures:0,cooldownUntil:0}}function s(e,t){let r=t?.threshold??3,a=t?.cooldownMs??12e4,n=i(),o=(n[e]||{failures:0,cooldownUntil:0}).failures+1,s=o>=r;n[e]={failures:s?0:o,cooldownUntil:s?Date.now()+a:0}}async function u(e,t={},r=12e3){let a=new AbortController,i=setTimeout(()=>a.abort(),r);try{return await fetch(e,{...t,signal:a.signal})}finally{clearTimeout(i)}}async function l(e,t={},r){let a=r?.retries??1,i=r?.timeoutMs??12e3,n=new Set(r?.retryOnStatus||[408,425,429,500,502,503,504]),o=null;for(let r=0;r<=a;r++)try{let o=await u(e,t,i);if(!o.ok){if(r<a&&n.has(o.status)){await new Promise(e=>setTimeout(e,350*(r+1)));continue}let e=await o.text().catch(()=>""),t=Error(`http_${o.status}:${e.slice(0,200)}`);throw t.status=o.status,t}return await o.json()}catch(t){o=t;let e="aborterror"===String(t?.name||"").toLowerCase();if(r<a&&e){await new Promise(e=>setTimeout(e,350*(r+1)));continue}if(r<a&&String(t?.message||"").startsWith("http_5")){await new Promise(e=>setTimeout(e,350*(r+1)));continue}break}throw o instanceof Error?o:Error("fetch_failed")}},4049:(e,t,r)=>{r.a(e,async(e,a)=>{try{r.r(t),r.d(t,{default:()=>c});var i=r(1253),n=r(1593),o=r(6653),s=e([n]);function u(e,t=2){return e.map(e=>Number(e.toFixed(t)))}async function l(e){let t=await (0,o.kv)(`https://planetarycomputer.microsoft.com/api/sas/v1/sign?href=${encodeURIComponent(e)}`,{},1e4);if(!t.ok)return e;let r=await t.json().catch(()=>({}));return r?.href||r?.signedHref||e}async function d(e,t){let r=await (0,o.kv)("https://planetarycomputer.microsoft.com/api/stac/v1/search",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({collections:["cop-dem-glo-30"],bbox:e,limit:8})},14e3);if(!r.ok)throw Error(`planetary_stac_failed_${r.status}`);let a=await r.json(),i=Array.isArray(a?.features)?a.features[0]:null;if(!i)throw Error("planetary_dem_not_found");let s=function(e){let t=e?.assets||{},r=Object.values(t)[0];return t?.data?.href||t?.dem?.href||t?.elevation?.href||r?.href||null}(i);if(!s)throw Error("planetary_dem_asset_missing");let d=await l(String(s)),h=await (0,o.kv)(d,{},18e3);if(!h.ok)throw Error(`planetary_dem_fetch_failed_${h.status}`);let c=await h.arrayBuffer(),m=await (0,n.fromArrayBuffer)(c),f=await m.getImage(),p=await f.readRasters({bbox:e,width:t,height:t,resampleMethod:"bilinear",interleave:!0}),b=Array.from(p).map(e=>Number(e)).filter(e=>Number.isFinite(e));if(!b.length)throw Error("planetary_dem_empty");return u(b)}async function h(e,t){let r=function(e){let t=Math.abs(e[2]-e[0]),r=Math.abs(e[3]-e[1]),a=Math.max(t,r);return a>1.2?9:a>.45?10:a>.15?11:a>.05?12:13}(e),a=new Map,n=Array(t*t).fill(0);for(let u=0;u<t;u++){let h=u/Math.max(1,t-1),c=e[3]-(e[3]-e[1])*h;for(let h=0;h<t;h++){var s,l,d;let m=h/Math.max(1,t-1),f=e[0]+(e[2]-e[0])*m,p=function(e,t,r){let a=t*Math.PI/180,i=Math.pow(2,r);return{x:(e+180)/360*i,y:(1-Math.log(Math.tan(a)+1/Math.cos(a))/Math.PI)/2*i}}(f,c,r),b=Math.floor(p.x),w=Math.floor(p.y),y=`${r}/${b}/${w}`,g=a.get(y);if(!g){let e=`https://s3.amazonaws.com/elevation-tiles-prod/terrarium/${r}/${b}/${w}.png`,t=await (0,o.kv)(e,{},1e4);if(!t.ok)throw Error(`terrarium_tile_failed_${t.status}`);let n=Buffer.from(await t.arrayBuffer());g=i.PNG.sync.read(n),a.set(y,g)}let x=Math.max(0,Math.min(255,Math.floor((p.x-b)*256))),_=(Math.max(0,Math.min(255,Math.floor((p.y-w)*256)))*g.width+x)*4,v=(s=g.data[_],l=g.data[_+1],d=g.data[_+2],256*s+l+d/256-32768);n[u*t+h]=Number.isFinite(v)?v:0}}return u(n)}async function c(e,t){try{let r;if("POST"!==e.method)return t.status(405).end();try{r=function(e){let t=Array.isArray(e?.bbox)?e.bbox.map(Number):[];if(4!==t.length||t.some(e=>Number.isNaN(e)))throw Error("bbox_required");let r=e?.quality==="light"||e?.quality==="balanced"||e?.quality==="high"?e.quality:"high",a=[64,96,128].includes(Number(e?.resolution))?Number(e?.resolution):"high"===r?128:"balanced"===r?96:64,i=e?.layer==="soil"||e?.layer==="et"?e.layer:"ndvi";return{bbox:t,resolution:a,layer:i,quality:r}}(e.body||{})}catch(e){return t.status(400).json({error:"bbox_required",message:e?.message==="bbox_required"?"Bounding box [minLon,minLat,maxLon,maxLat] is required.":"Invalid request body."})}let a=[],i=[];try{let e=Date.now(),n=await d(r.bbox,r.resolution);return a.push({provider:"planetary-computer-dem",ok:!0,durationMs:Date.now()-e}),t.status(200).json({success:!0,meshMeta:{smoothed:!1,resolution:r.resolution},data:{demGrid:n,width:r.resolution,height:r.resolution,bbox:r.bbox,source:"planetary-computer-dem",isSimulated:!1,texturePng:null},warnings:i,providersTried:a})}catch(e){a.push({provider:"planetary-computer-dem",ok:!1,reason:String(e?.message||"planetary_failed")}),i.push("Primary DEM provider unavailable; attempting fallback terrain tiles.")}try{let e=Date.now(),n=await h(r.bbox,r.resolution);return a.push({provider:"terrarium-tiles",ok:!0,durationMs:Date.now()-e}),t.status(200).json({success:!0,meshMeta:{smoothed:!1,resolution:r.resolution},data:{demGrid:n,width:r.resolution,height:r.resolution,bbox:r.bbox,source:"terrarium-tiles",isSimulated:!1,texturePng:null},warnings:i,providersTried:a})}catch(e){return a.push({provider:"terrarium-tiles",ok:!1,reason:String(e?.message||"terrarium_failed")}),i.push("Terrain providers failed for this AOI. 3D view is unavailable in this run."),t.status(200).json({success:!0,degraded:!0,reason:"terrain_unavailable",meshMeta:{smoothed:!1,resolution:r.resolution},data:{demGrid:[],width:0,height:0,bbox:r.bbox,source:"terrain-unavailable",isSimulated:!1,texturePng:null},warnings:i,providersTried:a})}}catch(e){return t.status(200).json({success:!0,degraded:!0,reason:"terrain_unavailable",meshMeta:{smoothed:!1,resolution:0},data:{demGrid:[],width:0,height:0,bbox:[-180,-90,180,90],source:"terrain-unavailable",isSimulated:!1,texturePng:null},warnings:[String(e?.message||"Unexpected terrain failure.")],providersTried:[]})}}n=(s.then?(await s)():s)[0],a()}catch(e){a(e)}})},7153:(e,t)=>{var r;Object.defineProperty(t,"x",{enumerable:!0,get:function(){return r}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(r||(r={}))},1802:(e,t,r)=>{e.exports=r(145)}};var t=require("../../../webpack-api-runtime.js");t.C(e);var r=t(t.s=4203);module.exports=r})();