"use strict";(()=>{var e={};e.id=466,e.ids=[466],e.modules={145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},1253:e=>{e.exports=require("pngjs")},1593:e=>{e.exports=import("geotiff")},6249:(e,t)=>{Object.defineProperty(t,"l",{enumerable:!0,get:function(){return function e(t,r){return r in t?t[r]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,r)):"function"==typeof t&&"default"===r?t:void 0}}})},4203:(e,t,r)=>{r.a(e,async(e,o)=>{try{r.r(t),r.d(t,{config:()=>h,default:()=>u,routeModule:()=>c});var a=r(1802),i=r(7153),n=r(6249),s=r(4049),l=e([s]);s=(l.then?(await l)():l)[0];let u=(0,n.l)(s,"default"),h=(0,n.l)(s,"config"),c=new a.PagesAPIRouteModule({definition:{kind:i.x.PAGES_API,page:"/api/terrain/fetch",pathname:"/api/terrain/fetch",bundlePath:"",filename:""},userland:s});o()}catch(e){o(e)}})},6653:(e,t,r)=>{r.d(t,{T3:()=>s,U4:()=>n,kW:()=>i,kv:()=>l,ls:()=>u});let o=globalThis;function a(){return o.__agrisenseProviderRuntime||(o.__agrisenseProviderRuntime={}),o.__agrisenseProviderRuntime}function i(e){let t=a()[e];return!!t&&Date.now()<t.cooldownUntil}function n(e){a()[e]={failures:0,cooldownUntil:0}}function s(e,t){let r=t?.threshold??3,o=t?.cooldownMs??12e4,i=a(),n=(i[e]||{failures:0,cooldownUntil:0}).failures+1,s=n>=r;i[e]={failures:s?0:n,cooldownUntil:s?Date.now()+o:0}}async function l(e,t={},r=12e3){let o=new AbortController,a=setTimeout(()=>o.abort(),r);try{return await fetch(e,{...t,signal:o.signal})}finally{clearTimeout(a)}}async function u(e,t={},r){let o=r?.retries??1,a=r?.timeoutMs??12e3,i=new Set(r?.retryOnStatus||[408,425,429,500,502,503,504]),n=null;for(let r=0;r<=o;r++)try{let n=await l(e,t,a);if(!n.ok){if(r<o&&i.has(n.status)){await new Promise(e=>setTimeout(e,350*(r+1)));continue}let e=await n.text().catch(()=>""),t=Error(`http_${n.status}:${e.slice(0,200)}`);throw t.status=n.status,t}return await n.json()}catch(t){n=t;let e="aborterror"===String(t?.name||"").toLowerCase();if(r<o&&e){await new Promise(e=>setTimeout(e,350*(r+1)));continue}if(r<o&&String(t?.message||"").startsWith("http_5")){await new Promise(e=>setTimeout(e,350*(r+1)));continue}break}throw n instanceof Error?n:Error("fetch_failed")}},6347:(e,t,r)=>{function o(e){let t=Number(e);return Number.isFinite(t)?t:null}function a(e){if(!e||"object"!=typeof e||"Polygon"!==e.type||!Array.isArray(e.coordinates)||!e.coordinates.length)return null;let t=e.coordinates[0];if(!Array.isArray(t)||t.length<4)return null;let r=[];for(let e of t){if(!Array.isArray(e)||e.length<2)continue;let t=o(e[0]),a=o(e[1]);null!=t&&null!=a&&r.push([t,a])}if(r.length<4)return null;let a=r[0],i=r[r.length-1];return((a[0]!==i[0]||a[1]!==i[1])&&r.push([a[0],a[1]]),r.length<4)?null:{type:"Polygon",coordinates:[r]}}function i(e,t){if(!e.length)return[];let r=e.slice();if(r.length>1){let e=r[0],t=r[r.length-1];e[0]===t[0]&&e[1]===t[1]&&(r=r.slice(0,-1))}return!r.length||(r=function(e,t){let r=[];for(let o=0;o<e.length;o++){let a=e[o],i=e[(o+e.length-1)%e.length],n=a[1]<=t,s=i[1]<=t;if(n){if(!s){let e=(t-i[1])/Math.max(1e-12,a[1]-i[1]);r.push([i[0]+e*(a[0]-i[0]),t])}r.push(a)}else if(s){let e=(t-i[1])/Math.max(1e-12,a[1]-i[1]);r.push([i[0]+e*(a[0]-i[0]),t])}}return r}(r=function(e,t){let r=[];for(let o=0;o<e.length;o++){let a=e[o],i=e[(o+e.length-1)%e.length],n=a[1]>=t,s=i[1]>=t;if(n){if(!s){let e=(t-i[1])/Math.max(1e-12,a[1]-i[1]);r.push([i[0]+e*(a[0]-i[0]),t])}r.push(a)}else if(s){let e=(t-i[1])/Math.max(1e-12,a[1]-i[1]);r.push([i[0]+e*(a[0]-i[0]),t])}}return r}(r=function(e,t){let r=[];for(let o=0;o<e.length;o++){let a=e[o],i=e[(o+e.length-1)%e.length],n=a[0]<=t,s=i[0]<=t;if(n){if(!s){let e=(t-i[0])/Math.max(1e-12,a[0]-i[0]);r.push([t,i[1]+e*(a[1]-i[1])])}r.push(a)}else if(s){let e=(t-i[0])/Math.max(1e-12,a[0]-i[0]);r.push([t,i[1]+e*(a[1]-i[1])])}}return r}(r=function(e,t){let r=[];for(let o=0;o<e.length;o++){let a=e[o],i=e[(o+e.length-1)%e.length],n=a[0]>=t,s=i[0]>=t;if(n){if(!s){let e=(t-i[0])/Math.max(1e-12,a[0]-i[0]);r.push([t,i[1]+e*(a[1]-i[1])])}r.push(a)}else if(s){let e=(t-i[0])/Math.max(1e-12,a[0]-i[0]);r.push([t,i[1]+e*(a[1]-i[1])])}}return r}(r,t.minLon),t.maxLon),t.minLat),t.maxLat)).length<3?[]:function(e){if(!e.length)return e;let t=e[0],r=e[e.length-1];return t[0]!==r[0]||t[1]!==r[1]?[...e,[t[0],t[1]]]:e}(r)}function n(e,t,r,o){let a=Math.max(1,t*r);if(!o?.coordinates?.[0]?.length)return{mask:null,applied:!1,coveredPixelRatio:1};let i=o.coordinates[0],n=new Uint8Array(a),s=0;for(let o=0;o<r;o++)for(let a=0;a<t;a++){let l=o*t+a;(function(e,t){let[r,o]=e,a=!1;for(let e=0,i=t.length-1;e<t.length;i=e++){let n=t[e][0],s=t[e][1],l=t[i][0],u=t[i][1];s>o!=u>o&&r<(l-n)*(o-s)/Math.max(1e-12,u-s)+n&&(a=!a)}return a})(function(e,t,r,o,a){let i=(e[2]-e[0])/Math.max(1,t),n=(e[3]-e[1])/Math.max(1,r);return[e[0]+(o+.5)*i,e[3]-(a+.5)*n]}(e,t,r,a,o),i)&&(n[l]=1,s+=1)}return{mask:n,applied:!0,coveredPixelRatio:s/a}}function s(e,t,r){return{bbox:e,crs:"EPSG:4326",width:t,height:r,pixelSizeLon:Math.abs(e[2]-e[0])/Math.max(1,t),pixelSizeLat:Math.abs(e[3]-e[1])/Math.max(1,r),pixelSizeMetersApprox:function(e,t,r){let o=Math.abs(e[2]-e[0])/Math.max(1,t),a=Math.abs(e[3]-e[1])/Math.max(1,r),i=(e[1]+e[3])/2*(Math.PI/180),n=6378137*Math.PI/180;return Math.max(.1,(n*Math.cos(i)*o+a*n)/2)}(e,t,r)}}r.d(t,{LD:()=>s,eE:()=>n,hu:()=>i,le:()=>a})},4475:(e,t,r)=>{r.d(t,{q:()=>s});var o=r(913);function a(e,t){if(!e.length)return 0;if(1===e.length)return e[0];let r=(e.length-1)*(0,o.uZ)(t,0,1),a=Math.floor(r),i=Math.ceil(r);return a===i?e[a]:e[a]+(e[i]-e[a])*(r-a)}function i(e,t,r){return Number.isFinite(e)&&e>=t&&e<=r}function n(e,t=3){let r=Math.pow(10,t);return Math.round(e*r)/r}function s(e){let t=Number.isFinite(e.plausibleMinMeters)?Number(e.plausibleMinMeters):-650,r=Number.isFinite(e.plausibleMaxMeters)?Number(e.plausibleMaxMeters):9500,s=Math.max(1,e.width*e.height),l=e.demGrid.slice(0,s);for(;l.length<s;)l.push(Number.NaN);let u=l.filter(e=>i(Number(e),t,r));if(!u.length)throw Error("dem_no_valid_pixels");u.sort((e,t)=>e-t);let h=a(u,.002),c=a(u,.998),d=a(u,.5),m=a(u,.05),p=a(u,.95),f=!1,g=0;for(let e=0;e<s;e++){let a=Number(l[e]);if(!i(a,t,r)){l[e]=Number.NaN,g+=1;continue}let n=(0,o.uZ)(a,h,c);Math.abs(n-a)>1e-9&&(f=!0),l[e]=n}let v=g;for(let t=0;t<6;t++){let t=!1;for(let r=0;r<e.height;r++)for(let o=0;o<e.width;o++){let a=r*e.width+o;if(Number.isFinite(l[a]))continue;let i=0,n=0;for(let[t,a]of[[o-1,r],[o+1,r],[o,r-1],[o,r+1],[o-1,r-1],[o+1,r-1],[o-1,r+1],[o+1,r+1]]){if(t<0||a<0||t>=e.width||a>=e.height)continue;let r=Number(l[a*e.width+t]);Number.isFinite(r)&&(i+=r,n+=1)}n>0&&(l[a]=i/n,t=!0,g-=1)}if(!t)break}for(let e=0;e<s;e++)Number.isFinite(l[e])||(l[e]=d,g-=1);let w=l.slice().sort((e,t)=>e-t),M=w[0],b=w[w.length-1],y=a(w,.05),_=a(w,.95);return{demGrid:l.map(e=>n(e,2)),validRatio:n((s-v)/s,4),voidFillRatio:n(v/s,4),clampApplied:f,zStats:{zMin:n(M,2),zMax:n(b,2),zP05:n(Number.isFinite(y)?y:m,2),zP95:n(Number.isFinite(_)?_:p,2)}}}},8514:(e,t,r)=>{r.a(e,async(e,o)=>{try{r.d(t,{f:()=>S});var a=r(1253),i=r(1593),n=r(6653),s=e([i]);function l(e,t,r){return Math.max(t,Math.min(r,e))}function u(e,t,r){let o=Math.abs(e[2]-e[0])/Math.max(1,t),a=Math.abs(e[3]-e[1])/Math.max(1,r),i=(e[1]+e[3])/2*(Math.PI/180);return(o*Math.max(1,111320*Math.cos(i))+111320*a)/2}function h(e,t=2){let r=Math.pow(10,t);return Math.round(e*r)/r}function c(e,t,r,o,a){if(t===o&&r===a)return e.slice();let i=Array(o*a).fill(Number.NaN);for(let n=0;n<a;n++){let s=n/Math.max(1,a-1)*(r-1);for(let a=0;a<o;a++){let u=a/Math.max(1,o-1)*(t-1);i[n*o+a]=function(e,t,r,o,a){let i=l(o,0,t-1),n=l(a,0,r-1),s=Math.floor(i),u=Math.floor(n),h=Math.min(t-1,s+1),c=Math.min(r-1,u+1),d=i-s,m=n-u,p=[{value:e[u*t+s],w:(1-d)*(1-m)},{value:e[u*t+h],w:d*(1-m)},{value:e[c*t+s],w:(1-d)*m},{value:e[c*t+h],w:d*m}],f=0,g=0;for(let e of p){var v;v=e.value,Number.isFinite(v)&&v>-650&&v<9500&&(f+=e.value*e.w,g+=e.w)}return g<=1e-9?Number.NaN:f/g}(e,t,r,u,s)}}return i}async function d(e,t,r){let o=e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength),a=await (0,i.fromArrayBuffer)(o),n=await a.getImage(),s=Number(n.getWidth()),l=Number(n.getHeight()),u=n.getGDALNoData(),d=Number.isFinite(Number(u))?Number(u):null,m=await n.readRasters({interleave:!0}),p=Array(s*l);for(let e=0;e<p.length;e++){let t=Number(m[e]),r=null!=d&&1e-6>Math.abs(t-d);p[e]=!Number.isFinite(t)||r?Number.NaN:t}let f=t&&t>1?t:s,g=r&&r>1?r:l;return{values:c(p,s,l,f,g).map(e=>Number.isFinite(e)?h(e,2):Number.NaN),width:f,height:g}}function m(e,t,r){return e.ok?r?Error(`${t}_failed_${r}`):Error(`${t}_failed`):Error(`${t}_failed_${e.status}`)}async function p(e){let t=await (0,n.kv)(`https://planetarycomputer.microsoft.com/api/sas/v1/sign?href=${encodeURIComponent(e)}`,{},1e4);if(!t.ok)return e;let r=await t.json().catch(()=>({}));return r?.href||r?.signedHref||e}async function f(e,t,r,o){let a=new URL("https://portal.opentopography.org/API/usgsdem");a.searchParams.set("datasetName",o),a.searchParams.set("south",String(e[1])),a.searchParams.set("north",String(e[3])),a.searchParams.set("west",String(e[0])),a.searchParams.set("east",String(e[2])),a.searchParams.set("outputFormat","GTiff"),a.searchParams.set("API_Key",r);let i=await (0,n.kv)(a.toString(),{},3e4);if(!i.ok)throw m(i,`opentopography_${o.toLowerCase()}`);if(String(i.headers.get("content-type")||"").toLowerCase().includes("json")){let e=await i.json().catch(()=>({})),t=e?.error||e?.message||`opentopography_${o.toLowerCase()}_json_error`;throw Error(String(t))}let s=Buffer.from(await i.arrayBuffer()),l=await d(s,t,t);return{demGrid:l.values,width:l.width,height:l.height,bbox:e,demSource:"opentopography",demDataset:o,modelType:"DTM",verticalDatum:"USGS10m"===o||"USGS30m"===o?"NAVD88 (source-native)":"source-native",sourceResolutionMeters:"USGS10m"===o?10:30,effectiveResolutionMeters:u(e,l.width,l.height),warnings:[]}}async function g(e,t,r){let o=new URL("https://portal.opentopography.org/API/globaldem");o.searchParams.set("demtype","COP30"),o.searchParams.set("south",String(e[1])),o.searchParams.set("north",String(e[3])),o.searchParams.set("west",String(e[0])),o.searchParams.set("east",String(e[2])),o.searchParams.set("outputFormat","GTiff"),o.searchParams.set("API_Key",r);let a=await (0,n.kv)(o.toString(),{},3e4);if(!a.ok)throw m(a,"opentopography_cop30");if(String(a.headers.get("content-type")||"").toLowerCase().includes("json")){let e=await a.json().catch(()=>({}));throw Error(String(e?.error||e?.message||"opentopography_cop30_json_error"))}let i=Buffer.from(await a.arrayBuffer()),s=await d(i,t,t);return{demGrid:s.values,width:s.width,height:s.height,bbox:e,demSource:"opentopography",demDataset:"COP30",modelType:"DTM",verticalDatum:"EGM2008 (source-native)",sourceResolutionMeters:30,effectiveResolutionMeters:u(e,s.width,s.height),warnings:[]}}async function v(e,t,r){let o=function(e,t){let r=function(e){let t=Math.abs(e[2]-e[0]),r=Math.abs(e[3]-e[1]),o=(e[1]+e[3])/2*(Math.PI/180);return Math.max(t*Math.max(1,111320*Math.cos(o)),111320*r)}(e);return l(Math.min(t,r<=5e3?96:r<=15e3?80:64),48,96)}(e,t),a=o*o,i=Array(a);for(let t=0;t<o;t++){let r=t/Math.max(1,o-1),a=e[3]-(e[3]-e[1])*r;for(let r=0;r<o;r++){let n=r/Math.max(1,o-1),s=e[0]+(e[2]-e[0])*n;i[t*o+r]={lat:a,lon:s}}}let s=Array(a).fill(Number.NaN),d=0,p=0;for(let e=0;e<i.length;e+=128){let t=i.slice(e,e+128),o=new URL("https://maps.googleapis.com/maps/api/elevation/json");o.searchParams.set("locations",t.map(e=>`${e.lat.toFixed(6)},${e.lon.toFixed(6)}`).join("|")),o.searchParams.set("key",r);let a=await (0,n.kv)(o.toString(),{},18e3);if(!a.ok)throw m(a,"google_elevation");let l=await a.json().catch(()=>({})),u=String(l?.status||"").toUpperCase();if("OK"!==u){let e="OVER_QUERY_LIMIT"===u?"google_elevation_over_query_limit":"REQUEST_DENIED"===u?"google_elevation_request_denied":"INVALID_REQUEST"===u?"google_elevation_invalid_request":`google_elevation_status_${u||"UNKNOWN"}`;throw Error(e)}let c=Array.isArray(l?.results)?l.results:[];for(let r=0;r<t.length;r++){let t=c[r],o=Number(t?.elevation);s[e+r]=Number.isFinite(o)?h(o,2):Number.NaN;let a=Number(t?.resolution);Number.isFinite(a)&&a>0&&(d+=a,p+=1)}}if(!s.some(e=>Number.isFinite(e)))throw Error("google_elevation_no_data");let f=c(s,o,o,t,t).map(e=>Number.isFinite(e)?h(e,2):Number.NaN),g=p>0?d/p:u(e,o,o);return{demGrid:f,width:t,height:t,bbox:e,demSource:"google-elevation",demDataset:`elevation-api-${o}x${o}`,modelType:"DTM",verticalDatum:"EGM96 (source-native)",sourceResolutionMeters:g,effectiveResolutionMeters:u(e,t,t),warnings:["Google Elevation API samples a raster source with variable native resolution by location."]}}async function w(e,t){let r=new URL("https://elevation.nationalmap.gov/arcgis/rest/services/3DEPElevation/ImageServer/exportImage");r.searchParams.set("bbox",e.join(",")),r.searchParams.set("bboxSR","4326"),r.searchParams.set("imageSR","4326"),r.searchParams.set("size",`${t},${t}`),r.searchParams.set("format","tiff"),r.searchParams.set("pixelType","F32"),r.searchParams.set("interpolation","RSP_BilinearInterpolation"),r.searchParams.set("f","image");let o=await (0,n.kv)(r.toString(),{},18e3);if(!o.ok)throw m(o,"usgs_3dep_direct");let a=Buffer.from(await o.arrayBuffer()),i=await d(a,t,t);return{demGrid:i.values,width:i.width,height:i.height,bbox:e,demSource:"usgs-3dep",demDataset:"3DEP-ImageServer",modelType:"DTM",verticalDatum:"NAVD88 (source-native)",sourceResolutionMeters:10,effectiveResolutionMeters:u(e,i.width,i.height),warnings:[]}}async function M(e,t){let r=await (0,n.kv)("https://planetarycomputer.microsoft.com/api/stac/v1/search",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({collections:["cop-dem-glo-30"],bbox:e,limit:6})},14e3);if(!r.ok)throw m(r,"planetary_copdem_stac");let o=await r.json(),a=Array.isArray(o?.features)?o.features[0]:null;if(!a)throw Error("planetary_copdem_not_found");let i=function(e){let t=e?.assets||{},r=Object.values(t)[0];return t?.data?.href||t?.dem?.href||t?.elevation?.href||r?.href||null}(a);if(!i)throw Error("planetary_copdem_asset_missing");let s=await p(String(i)),l=await (0,n.kv)(s,{},18e3);if(!l.ok)throw m(l,"planetary_copdem_fetch");let h=Buffer.from(await l.arrayBuffer()),c=await d(h,t,t);return{demGrid:c.values,width:c.width,height:c.height,bbox:e,demSource:"planetary-computer",demDataset:"cop-dem-glo-30",modelType:"DTM",verticalDatum:"EGM2008 (source-native)",sourceResolutionMeters:30,effectiveResolutionMeters:u(e,c.width,c.height),warnings:[]}}async function b(){let e=process.env.SENTINEL_HUB_CLIENT_ID,t=process.env.SENTINEL_HUB_CLIENT_SECRET;if(!e||!t)return null;let r=await (0,n.kv)("https://services.sentinel-hub.com/oauth/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({grant_type:"client_credentials",client_id:e,client_secret:t})},12e3);if(!r.ok)return null;let o=await r.json().catch(()=>({}));return"string"==typeof o?.access_token?o.access_token:null}async function y(){let e=process.env.SENTINEL_HUB_CLIENT_ID,t=process.env.SENTINEL_HUB_CLIENT_SECRET;if(!e||!t)return null;let r=await (0,n.kv)("https://identity.dataspace.copernicus.eu/auth/realms/CDSE/protocol/openid-connect/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({grant_type:"client_credentials",client_id:e,client_secret:t})},12e3);if(!r.ok)return null;let o=await r.json().catch(()=>({}));return"string"==typeof o?.access_token?o.access_token:null}async function _(e,t){let r=await b(),o="https://services.sentinel-hub.com/api/v1/process";if(r||(r=await y(),o="https://sh.dataspace.copernicus.eu/api/v1/process"),!r)throw Error("sentinel_dem_credentials_missing");let a=`//VERSION=3
function setup() {
  return {
    input: [{ bands: ["DEM"] }],
    output: { bands: 1, sampleType: "FLOAT32" }
  };
}
function evaluatePixel(sample) {
  return [sample.DEM];
}`,i=await (0,n.kv)(o,{method:"POST",headers:{Authorization:`Bearer ${r}`,"Content-Type":"application/json"},body:JSON.stringify({input:{bounds:{bbox:e,properties:{crs:"http://www.opengis.net/def/crs/OGC/1.3/CRS84"}},data:[{type:"dem",dataFilter:{demInstance:"COPERNICUS_30"}}]},output:{responses:[{identifier:"default",format:{type:"image/tiff"}}],width:t,height:t},evalscript:a})},22e3);if(!i.ok)throw m(i,"sentinel_hub_copdem");let s=Buffer.from(await i.arrayBuffer()),l=await d(s,t,t);return{demGrid:l.values,width:l.width,height:l.height,bbox:e,demSource:"sentinel-hub",demDataset:"copernicus-dem-30",modelType:"DTM",verticalDatum:"EGM2008 (source-native)",sourceResolutionMeters:30,effectiveResolutionMeters:u(e,l.width,l.height),warnings:[]}}async function P(e,t){let r=function(e){let t=Math.abs(e[2]-e[0]),r=Math.abs(e[3]-e[1]),o=Math.max(t,r);return o>1.2?9:o>.45?10:o>.15?11:o>.05?12:o>.015?13:o>.005?14:15}(e),o=new Map,i=Array(t*t).fill(Number.NaN);for(let u=0;u<t;u++){let d=u/Math.max(1,t-1),p=e[3]-(e[3]-e[1])*d;for(let d=0;d<t;d++){var s,l,c;let f=d/Math.max(1,t-1),g=e[0]+(e[2]-e[0])*f,v=function(e,t,r){let o=t*Math.PI/180,a=Math.pow(2,r);return{x:(e+180)/360*a,y:(1-Math.log(Math.tan(o)+1/Math.cos(o))/Math.PI)/2*a}}(g,p,r),w=Math.floor(v.x),M=Math.floor(v.y),b=`${r}/${w}/${M}`,y=o.get(b);if(!y){let e=`https://s3.amazonaws.com/elevation-tiles-prod/terrarium/${r}/${w}/${M}.png`,t=await (0,n.kv)(e,{},1e4);if(!t.ok)throw m(t,"terrarium_tiles");let i=Buffer.from(await t.arrayBuffer());y=a.PNG.sync.read(i),o.set(b,y)}let _=Math.max(0,Math.min(255,Math.floor((v.x-w)*256))),P=(Math.max(0,Math.min(255,Math.floor((v.y-M)*256)))*y.width+_)*4,x=(s=y.data[P],l=y.data[P+1],c=y.data[P+2],256*s+l+c/256-32768);i[u*t+d]=Number.isFinite(x)?h(x,2):Number.NaN}}let d=(e[1]+e[3])/2*(Math.PI/180),p=156543.03392*Math.cos(d)/Math.pow(2,r);return{demGrid:i,width:t,height:t,bbox:e,demSource:"terrarium",demDataset:`terrarium-z${r}`,modelType:"DSM",verticalDatum:"approx (source-native)",sourceResolutionMeters:p,effectiveResolutionMeters:u(e,t,t),warnings:["Terrarium fallback in use. Resolution may be coarse for plot-level terrain decisions."]}}async function x(e,t,r){if((0,n.kW)(e))throw t.push({provider:e,ok:!1,reason:"cooldown"}),Error(`${e}_cooldown`);let o=Date.now();try{let a=await r();return t.push({provider:e,ok:!0,durationMs:Date.now()-o}),(0,n.U4)(e),a}catch(r){throw t.push({provider:e,ok:!1,reason:String(r?.message||`${e}_failed`),durationMs:Date.now()-o}),(0,n.T3)(e,{threshold:2,cooldownMs:9e4}),r}}async function S(e){let t=[],r=(e.openTopoApiKey||"").trim(),o=(e.googleMapsApiKey||"").trim(),a=function(e){let t=(e[0]+e[2])/2,r=(e[1]+e[3])/2;return t>=-172&&t<=-60&&r>=16&&r<=72}(e.bbox);if(r&&a){try{return{result:await x("opentopography-usgs10m",t,()=>f(e.bbox,e.resolution,r,"USGS10m")),providersTried:t}}catch{}try{return{result:await x("opentopography-usgs30m",t,()=>f(e.bbox,e.resolution,r,"USGS30m")),providersTried:t}}catch{}}else r||t.push({provider:"opentopography-usgs10m",ok:!1,reason:"missing_OPENTOPO_API_KEY"});if(a)try{return{result:await x("usgs-3dep-direct",t,()=>w(e.bbox,e.resolution)),providersTried:t}}catch{}if(r)try{return{result:await x("opentopography-cop30",t,()=>g(e.bbox,e.resolution,r)),providersTried:t}}catch{}else t.push({provider:"opentopography-cop30",ok:!1,reason:"missing_OPENTOPO_API_KEY"});if(o)try{return{result:await x("google-elevation",t,()=>v(e.bbox,e.resolution,o)),providersTried:t}}catch{}else t.push({provider:"google-elevation",ok:!1,reason:"missing_GOOGLE_MAPS_API_KEY"});try{return{result:await x("sentinel-hub-copdem",t,()=>_(e.bbox,e.resolution)),providersTried:t}}catch{}try{return{result:await x("planetary-copdem",t,()=>M(e.bbox,e.resolution)),providersTried:t}}catch{}try{return{result:await x("terrarium-tiles",t,()=>P(e.bbox,e.resolution)),providersTried:t}}catch(r){let e=Error(String(r?.message||"all_terrain_providers_failed"));throw e.providersTried=t,e}}i=(s.then?(await s)():s)[0],o()}catch(e){o(e)}})},913:(e,t,r)=>{r.d(t,{CS:()=>o,TU:()=>i,uZ:()=>a});let o={ndvi:[{stop:0,color:[93,123,223]},{stop:.16,color:[110,177,236]},{stop:.32,color:[106,219,226]},{stop:.5,color:[129,216,156]},{stop:.68,color:[232,220,124]},{stop:.84,color:[242,176,114]},{stop:1,color:[226,126,134]}],soil:[{stop:0,color:[106,128,214]},{stop:.2,color:[122,182,232]},{stop:.4,color:[121,219,196]},{stop:.58,color:[152,214,149]},{stop:.76,color:[236,204,126]},{stop:1,color:[214,139,102]}],et:[{stop:0,color:[98,120,218]},{stop:.2,color:[109,165,232]},{stop:.4,color:[114,217,223]},{stop:.6,color:[146,214,149]},{stop:.78,color:[241,197,116]},{stop:1,color:[226,126,110]}]};function a(e,t,r){return Math.max(t,Math.min(r,e))}function i(e,t){let r=o[e],i=a(t,0,1);for(let e=0;e<r.length-1;e++){let t=r[e],o=r[e+1];if(i<=o.stop){var n,s,l;let e=(i-t.stop)/Math.max(1e-6,o.stop-t.stop);return[Math.round((n=t.color[0])+(o.color[0]-n)*e),Math.round((s=t.color[1])+(o.color[1]-s)*e),Math.round((l=t.color[2])+(o.color[2]-l)*e)]}}return r[r.length-1].color}},4049:(e,t,r)=>{r.a(e,async(e,o)=>{try{r.r(t),r.d(t,{default:()=>u});var a=r(6347),i=r(8514),n=r(4475),s=e([i]);function l(e,t=3){let r=Math.pow(10,t);return Math.round(e*r)/r}async function u(e,t){let r;if("POST"!==e.method)return t.status(405).end();try{r=function(e){let t=Array.isArray(e?.bbox)?e.bbox.map(Number):[];if(4!==t.length||t.some(e=>Number.isNaN(e))||!(t[2]>t[0])||!(t[3]>t[1]))throw Error("bbox_required");let r=e?.quality==="light"||e?.quality==="balanced"||e?.quality==="high"?e.quality:"balanced",o=Number(e?.resolution),i=Number.isFinite(o)?Math.max(64,Math.min(320,Math.round(o))):"high"===r?224:"balanced"===r?176:128,n=e?.verticalScaleMode==="reliefAssist"?"reliefAssist":"true",s=e?.geometry?(0,a.le)(e.geometry):null;if(e?.geometry&&!s)throw Error("invalid_geometry");return{bbox:t,geometry:s,resolution:i,quality:r,verticalScaleMode:n}}(e.body||{})}catch(e){return t.status(400).json({error:e?.message==="invalid_geometry"?"invalid_geometry":"bbox_required",message:e?.message==="invalid_geometry"?"AOI geometry must be a valid GeoJSON Polygon.":"Bounding box [minLon,minLat,maxLon,maxLat] is required."})}try{let e=process.env.OPENTOPO_API_KEY||process.env.OPEN_TOPOGRAPHY_API_KEY||"",o=process.env.GOOGLE_MAPS_API_KEY||process.env.GOOGLE_CLOUD_MAPS_API_KEY||"",s=await (0,i.f)({bbox:r.bbox,resolution:r.resolution,openTopoApiKey:e,googleMapsApiKey:o}),u=function(e){var t;let r;let o=(0,n.q)({demGrid:e.provider.demGrid,width:e.provider.width,height:e.provider.height}),i=l(function(e,t,r){let o=Math.abs(e[2]-e[0])/Math.max(1,t),a=Math.abs(e[3]-e[1])/Math.max(1,r),i=(e[1]+e[3])/2*(Math.PI/180);return(o*Math.max(1,111320*Math.cos(i))+111320*a)/2}(e.provider.bbox,e.provider.width,e.provider.height),2),s=l(e.provider.effectiveResolutionMeters||i,2),u=(t=e.provider.bbox,r=s<=12?"high":s<=35?"medium":"low",250>function(e){let t=Math.abs(e[2]-e[0]),r=Math.abs(e[3]-e[1]),o=(e[1]+e[3])/2*(Math.PI/180);return Math.max(t*Math.max(1,111320*Math.cos(o)),111320*r)}(t)&&s>10&&(r="high"===r?"medium":"low"),r),h=function(e,t,r,o){let i=(0,a.eE)(e,t,r,o);return l(i.coveredPixelRatio,4)}(e.provider.bbox,e.provider.width,e.provider.height,e.parsed.geometry),c=[...e.provider.warnings];return o.voidFillRatio>.08&&c.push(`DEM had missing pixels; filled ${(100*o.voidFillRatio).toFixed(1)}% voids for continuity.`),"low"===u&&c.push(`Terrain resolution is coarse for small-plot certainty (~${s.toFixed(1)}m/pixel).`),{success:!0,source:e.provider.demSource,demSource:e.provider.demSource,demDataset:e.provider.demDataset,modelType:e.provider.modelType,verticalDatum:e.provider.verticalDatum,sourceResolutionMeters:l(e.provider.sourceResolutionMeters,2),effectiveResolutionMeters:s,precisionClass:u,voidFillRatio:o.voidFillRatio,zStats:o.zStats,providerResolutionMeters:l(e.provider.sourceResolutionMeters,2),pixelSizeMeters:i,coverage:h,meshMeta:{smoothed:!1,resolution:e.parsed.resolution},warnings:c,providersTried:e.providersTried,data:{demGrid:o.demGrid,width:e.provider.width,height:e.provider.height,bbox:e.provider.bbox,source:e.provider.demSource,isSimulated:!1,texturePng:null,providerResolutionMeters:l(e.provider.sourceResolutionMeters,2),pixelSizeMeters:i,coverage:h,demSource:e.provider.demSource,demDataset:e.provider.demDataset,modelType:e.provider.modelType,verticalDatum:e.provider.verticalDatum,sourceResolutionMeters:l(e.provider.sourceResolutionMeters,2),effectiveResolutionMeters:s,precisionClass:u,voidFillRatio:o.voidFillRatio,zStats:o.zStats}}}({parsed:r,provider:s.result,providersTried:s.providersTried});return t.status(200).json(u)}catch(o){let e=Array.isArray(o?.providersTried)?o.providersTried:[];return t.status(200).json({success:!0,degraded:!0,reason:"terrain_unavailable",source:"terrain-unavailable",demSource:"terrain-unavailable",demDataset:"none",modelType:"DTM",verticalDatum:"n/a",sourceResolutionMeters:0,effectiveResolutionMeters:0,precisionClass:"low",voidFillRatio:0,zStats:{zMin:0,zMax:0,zP05:0,zP95:0},providerResolutionMeters:0,pixelSizeMeters:0,coverage:0,meshMeta:{smoothed:!1,resolution:r.resolution},warnings:[String(o?.message||"All terrain providers failed for this AOI.")],providersTried:e,data:{demGrid:[],width:0,height:0,bbox:r.bbox,source:"terrain-unavailable",isSimulated:!1,texturePng:null,providerResolutionMeters:0,pixelSizeMeters:0,coverage:0,demSource:"terrain-unavailable",demDataset:"none",modelType:"DTM",verticalDatum:"n/a",sourceResolutionMeters:0,effectiveResolutionMeters:0,precisionClass:"low",voidFillRatio:0,zStats:{zMin:0,zMax:0,zP05:0,zP95:0}}})}}i=(s.then?(await s)():s)[0],o()}catch(e){o(e)}})},7153:(e,t)=>{var r;Object.defineProperty(t,"x",{enumerable:!0,get:function(){return r}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(r||(r={}))},1802:(e,t,r)=>{e.exports=r(145)}};var t=require("../../../webpack-api-runtime.js");t.C(e);var r=t(t.s=4203);module.exports=r})();