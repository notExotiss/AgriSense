"use strict";(()=>{var e={};e.id=228,e.ids=[228],e.modules={145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},1253:e=>{e.exports=require("pngjs")},1593:e=>{e.exports=import("geotiff")},6113:e=>{e.exports=require("crypto")},1911:(e,t,r)=>{r.a(e,async(e,i)=>{try{r.r(t),r.d(t,{config:()=>m,default:()=>u,routeModule:()=>c});var a=r(1802),s=r(7153),n=r(6249),o=r(2297),l=e([o]);o=(l.then?(await l)():l)[0];let u=(0,n.l)(o,"default"),m=(0,n.l)(o,"config"),c=new a.PagesAPIRouteModule({definition:{kind:s.x.PAGES_API,page:"/api/soil",pathname:"/api/soil",bundlePath:"",filename:""},userland:o});i()}catch(e){i(e)}})},8851:(e,t,r)=>{r.d(t,{NI:()=>l,Xb:()=>o,kw:()=>n,sA:()=>u});var i=r(6113);let a=globalThis;function s(){return a.__agrisenseMemoryCache||(a.__agrisenseMemoryCache=new Map),a.__agrisenseMemoryCache}function n(e){return(0,i.createHash)("sha1").update(e.join("|")).digest("hex")}function o(e){let t=s(),r=t.get(e);return r?Date.now()>r.expiresAt?(t.delete(e),null):r.value:null}function l(e,t,r){s().set(e,{value:t,expiresAt:Date.now()+r})}function u(e){let t=s();if(!e){let e=t.size;return t.clear(),e}let r=0,i=[];return t.forEach((t,r)=>{r.startsWith(e)&&i.push(r)}),i.forEach(e=>{t.delete(e)&&(r+=1)}),r}},2297:(e,t,r)=>{r.a(e,async(e,i)=>{try{r.r(t),r.d(t,{default:()=>h});var a=r(1253),s=r(8851),n=r(468),o=r(913),l=e([n]);function u(e,t,r){return Math.max(t,Math.min(r,e))}function m(e,t=4){let r=Math.pow(10,t);return Math.round(e*r)/r}async function c(e,t=15e3){let r=new AbortController,i=setTimeout(()=>r.abort(),t);try{let t=await fetch(e,{signal:r.signal});if(!t.ok)throw Error(`http_${t.status}`);return await t.json()}finally{clearTimeout(i)}}async function d(e,t){let r=new URL("https://api.open-meteo.com/v1/forecast");r.searchParams.set("latitude",String(e)),r.searchParams.set("longitude",String(t)),r.searchParams.set("timezone","auto"),r.searchParams.set("past_days","1"),r.searchParams.set("forecast_days","1"),r.searchParams.set("hourly","soil_moisture_0_to_1cm,soil_moisture_1_to_3cm,soil_moisture_3_to_9cm");let i=await c(r.toString()),a=i?.hourly||{},s=Array.isArray(a?.soil_moisture_0_to_1cm)?a.soil_moisture_0_to_1cm:[],n=Array.isArray(a?.soil_moisture_1_to_3cm)?a.soil_moisture_1_to_3cm:[],o=Array.isArray(a?.soil_moisture_3_to_9cm)?a.soil_moisture_3_to_9cm:[],l=Math.max(0,Math.min(s.length-1,n.length-1,o.length-1)),m=Number(s[l]),d=Number(n[l]),b=Number(o[l]),h=(Number.isFinite(m)?.5*m:0)+(Number.isFinite(d)?.3*d:0)+(Number.isFinite(b)?.2*b:0),f=(Number.isFinite(m)?.5:0)+(Number.isFinite(d)?.3:0)+(Number.isFinite(b)?.2:0);if(!Number.isFinite(h)||f<=0)throw Error("soil_baseline_unavailable");return u(h/f,.02,.7)}async function b(e){let t=e.geometry?JSON.stringify(e.geometry):"none",r=(0,s.kw)(["soil-et-ingest-v1",e.bbox[0],e.bbox[1],e.bbox[2],e.bbox[3],t,e.date||"auto",e.targetSize||0]),i=(0,s.Xb)(r);if(i?.result)return{...i,cacheHit:!0};let a=await (0,n.J)({bbox:e.bbox,geometry:e.geometry,date:e.date,targetSize:e.targetSize,policy:"balanced"});return(0,s.NI)(r,a,48e4),{...a,cacheHit:!1}}async function h(e,t){let r;if("POST"!==e.method)return t.status(405).end();try{r=function(e){let t=Array.isArray(e?.bbox)?e.bbox.map(Number):[];if(4!==t.length||t.some(e=>Number.isNaN(e)))throw Error("bbox_required");let r=e?.geometry&&"object"==typeof e.geometry?e.geometry:void 0,i="string"==typeof e?.date?e.date:void 0,a=Number.isFinite(Number(e?.targetSize))?Number(e.targetSize):void 0;return{bbox:t,geometry:r,date:i,targetSize:a}}(e.body||{})}catch{return t.status(400).json({error:"bbox_required",message:"Bounding box [minLon,minLat,maxLon,maxLat] is required."})}let i=(r.bbox[1]+r.bbox[3])/2,s=(r.bbox[0]+r.bbox[2])/2,n=[],l=[];try{let e=d(i,s),c=b(r),[h,f]=await Promise.all([e,c]);n.push({provider:"open-meteo-soil",ok:!0}),n.push({provider:f.result.provider,ok:!0});let g=f.result.ndmi?.metricGrid;if(!g?.encoded||!g.width||!g.height)return t.status(200).json({success:!0,unavailable:!0,message:"NDMI proxy grid is unavailable for this AOI/date selection.",source:"strict-real-only",isSimulated:!1,cacheHit:f.cacheHit,warnings:l,providersTried:n,representation:"hybrid-estimate",alignment:f.result.alignment,data:null});let y=function(e,t,r){let i=Buffer.from(e,"base64"),a=t*r,s=new Float32Array(i.buffer,i.byteOffset,Math.min(a,Math.floor(i.byteLength/4))),n=new Float32Array(a);for(let e=0;e<a;e++){let t=Number(s[e]);n[e]=Number.isFinite(t)?t:Number.NaN}return n}(g.encoded,g.width,g.height),p=function(e,t,r){if(!e)return null;let i=Buffer.from(e,"base64"),a=t*r,s=new Uint8Array(a);for(let e=0;e<a;e++)s[e]=e<i.length&&i[e]>0?1:0;return s}(g.validMaskEncoded,g.width,g.height),_=Number(f.result.ndmi?.stats?.mean??0),N=new Float32Array(y.length),x=new Uint8Array(y.length),w=Number.POSITIVE_INFINITY,v=Number.NEGATIVE_INFINITY,M=0,S=0;for(let e=0;e<y.length;e++){let t=Number(y[e]);if(p&&!p[e]||!Number.isFinite(t)){N[e]=Number.NaN,x[e]=0;continue}let r=h+(t-_)*.22,i=u(r,.02,.7);N[e]=i,x[e]=1,w=Math.min(w,i),v=Math.max(v,i),M+=i,S+=1}if(!Number.isFinite(w)||!Number.isFinite(v)||S<=0)return t.status(200).json({success:!0,unavailable:!0,message:"Soil proxy grid had no valid pixels for this AOI/date selection.",source:"strict-real-only",isSimulated:!1,cacheHit:f.cacheHit,warnings:l,providersTried:n,representation:"hybrid-estimate",alignment:f.result.alignment,data:null});let A=M/S,I=Buffer.from(N.buffer,N.byteOffset,N.byteLength).toString("base64"),F=Buffer.from(x.buffer,x.byteOffset,x.byteLength).toString("base64"),P=function(e,t,r,i,s,n){let l=new a.PNG({width:r,height:i}),m=Math.max(1e-6,n-s);for(let r=0;r<e.length;r++){let i=4*r,a=Number(e[r]);if(t&&!t[r]||!Number.isFinite(a)){l.data[i]=0,l.data[i+1]=0,l.data[i+2]=0,l.data[i+3]=0;continue}let n=u((e[r]-s)/m,0,1),[c,d,b]=(0,o.TU)("soil",n);l.data[i]=c,l.data[i+1]=d,l.data[i+2]=b,l.data[i+3]=255}return a.PNG.sync.write(l).toString("base64")}(N,x,g.width,g.height,w,v);return Array.isArray(f.warnings)&&f.warnings.length&&l.push(...f.warnings),t.status(200).json({success:!0,source:"Open-Meteo + Sentinel-2 NDMI proxy",isSimulated:!1,cacheHit:f.cacheHit,unavailable:!1,warnings:l,providersTried:n,representation:"hybrid-estimate",baseline:{provider:"open-meteo",variable:"soil_moisture_0_to_9cm_weighted",value:m(h),units:"m3/m3",timestamp:new Date().toISOString()},proxy:{provider:f.result.provider,metric:"ndmi",formula:"(B8A - B11) / (B8A + B11)",sceneRef:f.result.sceneRef,dataResolutionMeters:f.result.dataResolutionMeters},alignment:f.result.alignment,data:{soilMoisture:I,metricGrid:{encoded:I,validMaskEncoded:F,normalizationMode:"fixedPhysicalRange",width:g.width,height:g.height,min:m(w),max:m(v)},overlayPng:P,stats:{min:m(w),max:m(v),mean:m(A)},bbox:f.result.bbox,source:"Hybrid estimate (Open-Meteo baseline + NDMI proxy)",isSimulated:!1,units:"m3/m3",timestamp:new Date().toISOString()}})}catch(r){let e=String(r?.message||"soil_fetch_failed");return e.startsWith("http_")&&n.push({provider:"open-meteo-soil",ok:!1,reason:e}),n.some(e=>"hybrid-soil-proxy"===e.provider)||n.push({provider:"hybrid-soil-proxy",ok:!1,reason:e}),t.status(200).json({success:!0,unavailable:!0,message:"Soil layer unavailable under strict real-only mode.",source:"strict-real-only",isSimulated:!1,cacheHit:!1,warnings:[e],providersTried:n,representation:"hybrid-estimate",data:null})}}n=(l.then?(await l)():l)[0],i()}catch(e){i(e)}})}};var t=require("../../webpack-api-runtime.js");t.C(e);var r=e=>t(t.s=e),i=t.X(0,[121],()=>r(1911));module.exports=i})();