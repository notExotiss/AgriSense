"use strict";(()=>{var e={};e.id=228,e.ids=[228],e.modules={145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},6249:(e,t)=>{Object.defineProperty(t,"l",{enumerable:!0,get:function(){return function e(t,r){return r in t?t[r]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,r)):"function"==typeof t&&"default"===r?t:void 0}}})},1574:(e,t,r)=>{r.r(t),r.d(t,{config:()=>c,default:()=>d,routeModule:()=>_});var s={};r.r(s),r.d(s,{default:()=>m});var a=r(1802),i=r(7153),o=r(6249);async function n(e,t=15e3){let r=new AbortController,s=setTimeout(()=>r.abort(),t);try{let t=await fetch(e,{signal:r.signal});if(!t.ok)throw Error(`http_${t.status}`);return await t.json()}finally{clearTimeout(s)}}function u(e,t,r){let s;let a=(s=Math.abs(Math.round((t[0]+t[1]+t[2]+t[3])*1e5)||12345),()=>(s=(1664525*s+1013904223)%4294967296)/4294967296),i=Array(65536),o=Number.POSITIVE_INFINITY,n=Number.NEGATIVE_INFINITY,u=0;for(let t=0;t<256;t++)for(let s=0;s<256;s++){let l=256*t+s,m=Math.max(.04,Math.min(.65,e+Math.sin(s/256*Math.PI)*Math.cos(t/256*Math.PI)*.03+(a()-.5)*("soil"===r?.04:.08)));i[l]=Number(m.toFixed(4)),o=Math.min(o,m),n=Math.max(n,m),u+=m}let l={type:"soil_moisture",width:256,height:256,data:i,stats:{min:Number(o.toFixed(4)),max:Number(n.toFixed(4)),mean:Number((u/i.length).toFixed(4))}};return{encoded:Buffer.from(JSON.stringify(l)).toString("base64"),stats:l.stats}}async function l(e,t){let r=new URL("https://api.open-meteo.com/v1/forecast");r.searchParams.set("latitude",String(e)),r.searchParams.set("longitude",String(t)),r.searchParams.set("timezone","auto"),r.searchParams.set("past_days","1"),r.searchParams.set("forecast_days","1"),r.searchParams.set("hourly","soil_moisture_0_to_1cm,soil_moisture_1_to_3cm,soil_moisture_3_to_9cm");let s=await n(r.toString()),a=s?.hourly||{},i=a?.soil_moisture_0_to_1cm||[],o=a?.soil_moisture_1_to_3cm||[],u=a?.soil_moisture_3_to_9cm||[],l=Math.max(0,i.length-1);if(![i[l],o[l],u[l]].filter(e=>"number"==typeof e).length)throw Error("no_soil_values");return Math.max(.05,Math.min(.6,(.5*Number(i[l]??0)+.3*Number(o[l]??0)+.2*Number(u[l]??0))/(Number(null!=i[l]?.5:0)+Number(null!=o[l]?.3:0)+Number(null!=u[l]?.2:0)||1)))}async function m(e,t){if("POST"!==e.method)return t.status(405).end();try{let{bbox:r}=e.body||{};if(!Array.isArray(r)||4!==r.length)return t.status(400).json({error:"bbox_required",message:"Bounding box [minx,miny,maxx,maxy] is required"});let s=r.map(Number),a=(s[1]+s[3])/2,i=(s[0]+s[2])/2;try{let e=await l(a,i),r=u(e,s,"soil");return t.status(200).json({success:!0,source:"Open-Meteo",isSimulated:!1,cacheHit:!1,warnings:[],providersTried:[{provider:"open-meteo-soil",ok:!0}],data:{soilMoisture:r.encoded,stats:r.stats,bbox:s,source:"Open-Meteo soil moisture (AOI-derived grid)",isSimulated:!1,units:"m3/m3",timestamp:new Date().toISOString()}})}catch(r){let e=u(.28,s,"fallback");return t.status(200).json({success:!0,source:"Simulated fallback (Open-Meteo unavailable)",isSimulated:!0,cacheHit:!1,warnings:[r?.message||"soil_provider_failed"],providersTried:[{provider:"open-meteo-soil",ok:!1,reason:r?.message||"soil_provider_failed"}],data:{soilMoisture:e.encoded,stats:e.stats,bbox:s,source:"Simulated",isSimulated:!0,units:"m3/m3",timestamp:new Date().toISOString()}})}}catch(e){return t.status(500).json({error:"soil_fetch_failed",message:String(e?.message||e)})}}let d=(0,o.l)(s,"default"),c=(0,o.l)(s,"config"),_=new a.PagesAPIRouteModule({definition:{kind:i.x.PAGES_API,page:"/api/soil",pathname:"/api/soil",bundlePath:"",filename:""},userland:s})},7153:(e,t)=>{var r;Object.defineProperty(t,"x",{enumerable:!0,get:function(){return r}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(r||(r={}))},1802:(e,t,r)=>{e.exports=r(145)}};var t=require("../../webpack-api-runtime.js");t.C(e);var r=t(t.s=1574);module.exports=r})();