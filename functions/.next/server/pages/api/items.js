"use strict";(()=>{var e={};e.id=180,e.ids=[180],e.modules={2509:e=>{e.exports=require("firebase-admin")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},6249:(e,r)=>{Object.defineProperty(r,"l",{enumerable:!0,get:function(){return function e(r,t){return t in r?r[t]:"then"in r&&"function"==typeof r.then?r.then(r=>e(r,t)):"function"==typeof r&&"default"===t?r:void 0}}})},3170:(e,r,t)=>{t.r(r),t.d(r,{config:()=>_,default:()=>h,routeModule:()=>A});var n={};t.r(n),t.d(n,{default:()=>b});var i=t(1802),o=t(7153),a=t(6249),s=t(535);function l(e){return"number"==typeof e&&Number.isFinite(e)}function u(e){if(!Array.isArray(e)||e.length<2)return null;let r=Number(e[0]),t=Number(e[1]);return l(r)&&l(t)?[r,t]:null}function d(e){return Array.isArray(e)?e.map(u).filter(e=>Array.isArray(e)&&2===e.length):[]}function c(e){if(e.length<4)return!1;let r=e[0],t=e[e.length-1];return r[0]===t[0]&&r[1]===t[1]}function f(e){let r=Number.POSITIVE_INFINITY,t=Number.POSITIVE_INFINITY,n=Number.NEGATIVE_INFINITY,i=Number.NEGATIVE_INFINITY;for(let[o,a]of e)r=Math.min(r,o),t=Math.min(t,a),n=Math.max(n,o),i=Math.max(i,a);return[r,t,n,i]}function m(e){if(!e)return null;if("string"==typeof e)try{let r=JSON.parse(e);if(r?.type==="Polygon"&&Array.isArray(r?.coordinates))return r;return null}catch{return null}return"object"==typeof e&&e?.type==="Polygon"&&Array.isArray(e?.coordinates)?e:null}function g(e){return String(e||"")}function y(e){return"firebase_admin_misconfigured"===g(e?.code)||"FirebaseAdminConfigError"===g(e?.name)}function p(e){if(void 0!==e){if(null===e)return null;if("number"==typeof e)return Number.isFinite(e)?e:null;if("string"==typeof e||"boolean"==typeof e)return e;if(e instanceof Date)return e.toISOString();if(Array.isArray(e))return e.map(e=>p(e)).filter(e=>void 0!==e);if("object"==typeof e){let r={};for(let[t,n]of Object.entries(e)){let e=p(n);void 0!==e&&(r[t]=e)}return r}}}async function b(e,r){if("POST"===e.method)try{let t=(0,s._)(),n=(0,s.D)(),i=(e.headers.authorization||"").replace("Bearer ","");if(i||"string"!=typeof e.body?.idToken||(i=e.body.idToken),!i)return r.status(401).json({error:"auth_required"});let o=(await n.verifyIdToken(i)).uid,{name:a,description:u,geojson:m,ndviStats:g,previewPng:y,locationName:b,inferenceSnapshot:h,sourceQuality:_,grid3x3:A}=e.body||{},E=new Date().toISOString(),v=String(a||b||"").trim();if(!v)return r.status(400).json({error:"validation_failed",message:"Plot name is required."});let S=m?function(e){let r=null;if("string"==typeof e)try{r=JSON.parse(e)}catch{throw Error("invalid_geometry")}else e&&"object"==typeof e&&(r=e);if(!r||"Polygon"!==r.type||!Array.isArray(r.coordinates)||!r.coordinates.length)throw Error("invalid_geometry");let t=d(r.coordinates[0]);if(!c(t))throw Error("invalid_geometry");let n=f(t),i=function(e){let r=e.slice(0,-1),t=Math.max(1,r.length),n=r.reduce((e,r)=>(e.lon+=r[0],e.lat+=r[1],e),{lon:0,lat:0});return[n.lon/t,n.lat/t]}(t);if(n.some(e=>!l(e))||i.some(e=>!l(e)))throw Error("invalid_geometry");return{geojsonText:JSON.stringify({type:"Polygon",coordinates:[t]}),bbox:n,centroid:i,ringsFlat:function(e){let r=[];for(let[t,n]of e)if(r.push(Number(t.toFixed(7)),Number(n.toFixed(7))),r.length>=1024)break;return r}(t)}}(m):null,N="string"==typeof y?y:null,I=!!(N&&N.length>7e5),w=function(e){if(!e||"object"!=typeof e)return null;let r=Array.isArray(e.recommendations)?e.recommendations.slice(0,3):[];return p({engine:e.engine||null,objective:e.objective||null,confidence:e.confidence??null,dataQuality:e.dataQuality||null,forecast:e.forecast||null,anomaly:e.anomaly||null,summary:e.summary||null,recommendations:r,warnings:Array.isArray(e.warnings)?e.warnings.slice(0,12):[],timestamp:new Date().toISOString()})}(h),P=Array.isArray(A)?A.slice(0,9).map((e,r)=>{let t=Number(e?.row),n=Number(e?.col),i=`${Number.isFinite(t)?t:Math.floor(r/3)}-${Number.isFinite(n)?n:r%3}`,o=Number(e?.mean),a=Number(e?.min),s=Number(e?.max),l=Number(e?.validPixelRatio),u=String(e?.stressLevel||"").toLowerCase();return{cellId:String(e?.cellId||i),row:Number.isFinite(t)?t:Math.floor(r/3),col:Number.isFinite(n)?n:r%3,mean:Number.isFinite(o)?o:0,min:Number.isFinite(a)?a:0,max:Number.isFinite(s)?s:0,validPixelRatio:Number.isFinite(l)?l:0,stressLevel:"high"===u||"moderate"===u||"low"===u?u:"unknown"}}):[],T=p({ingestProvider:_?.ingestProvider||null,fallbackUsed:!!_?.fallbackUsed,warnings:Array.isArray(_?.warnings)?_.warnings.slice(0,20):[],providersTried:Array.isArray(_?.providersTried)?_.providersTried.slice(0,20).map(e=>({provider:e?.provider||"unknown",ok:!!e?.ok,reason:e?.reason?String(e.reason).slice(0,240):null})):[]}),j={name:v,locationName:String(b||a||"").slice(0,180)||null,description:String(u||"").slice(0,5e3),geojsonText:S?.geojsonText||null,geojson:null,bbox:S?.bbox||null,centroid:S?.centroid||null,ringsFlat:S?.ringsFlat||null,grid3x3:P,ndviStats:p(g||null),previewPng:I?null:N,inferenceSnapshot:w,sourceQuality:T,previewDropped:I,ownerUid:o,createdAt:E},O=p(j);if(function(e){try{return Buffer.byteLength(JSON.stringify(e),"utf8")}catch{return Number.POSITIVE_INFINITY}}(O)>9e5)return r.status(413).json({error:"plot_payload_too_large",message:"Plot payload is too large to store. Reduce optional data and retry."});let F=await t.collection("plots").add(O);return r.status(201).json({id:F.id,previewDropped:I})}catch(e){if(console.error("items POST error:",e?.message||e,e?.stack),y(e))return r.status(503).json({error:"firebase_admin_misconfigured",message:"Server Firebase Admin credentials are not configured correctly.",hint:e?.hint||"Set FIREBASE_SERVICE_ACCOUNT_JSON with a valid private key and escaped newlines."});if(String(e?.message||"").toLowerCase().includes("token")||String(e?.code||"").includes("auth"))return r.status(401).json({error:"invalid_auth",message:"Invalid or expired authentication token."});if(g(e?.message).toLowerCase().includes("invalid_geometry"))return r.status(400).json({error:"invalid_geometry",message:"Geometry must be a valid closed polygon with finite coordinates."});if(function(e){let r=g(e?.message).toLowerCase();return r.includes("maximum document size")||r.includes("too large")||r.includes("exceeds the limit")||r.includes("request entity too large")}(e))return r.status(413).json({error:"plot_payload_too_large",message:"Plot payload exceeded storage limits."});if(function(e){let r=g(e?.message).toLowerCase();return r.includes('cannot use "undefined" as a firestore value')||r.includes("contains undefined")||r.includes("invalid firestore value")}(e))return r.status(400).json({error:"invalid_payload",message:"Plot payload includes unsupported values."});return r.status(500).json({error:"save_failed",message:e?.message||"Unknown error"})}if("GET"===e.method)try{let t=(0,s._)(),n=(0,s.D)(),i=(e.headers.authorization||"").replace("Bearer ","");if(!i)return r.status(401).json({error:"auth_required"});let o=(await n.verifyIdToken(i)).uid,a=(await t.collection("plots").where("ownerUid","==",o).limit(200).get()).docs.map(e=>{let r=e.data(),t=m(r?.geojson)||m(r?.geojsonText),n=Array.isArray(r?.bbox)&&4===r.bbox.length?r.bbox:function(e){let r=m(e),t=d(r?.coordinates?.[0]||[]);return c(t)?f(t):null}(t);return{id:e.id,...r,geojson:t||null,bbox:n||null}}).sort((e,r)=>{let t="string"==typeof e?.createdAt?e.createdAt:"";return("string"==typeof r?.createdAt?r.createdAt:"").localeCompare(t)}).slice(0,100);return r.status(200).json({items:a})}catch(e){if(console.error("items GET",e?.message||e),y(e))return r.status(503).json({error:"firebase_admin_misconfigured",message:"Server Firebase Admin credentials are not configured correctly.",hint:e?.hint||"Set FIREBASE_SERVICE_ACCOUNT_JSON with a valid private key and escaped newlines."});if(String(e?.message||"").toLowerCase().includes("token")||String(e?.code||"").includes("auth"))return r.status(401).json({error:"invalid_auth"});return r.status(500).json({error:"items_fetch_failed",message:e?.message||"Unknown error"})}return r.status(405).end()}let h=(0,a.l)(n,"default"),_=(0,a.l)(n,"config"),A=new i.PagesAPIRouteModule({definition:{kind:o.x.PAGES_API,page:"/api/items",pathname:"/api/items",bundlePath:"",filename:""},userland:n})},535:(e,r,t)=>{t.d(r,{D:()=>d,_:()=>u});var n=t(2509),i=t.n(n);class o extends Error{constructor(e,r){super(e),this.name="FirebaseAdminConfigError",this.code="firebase_admin_misconfigured",this.hint=r}}let a="idle",s=null;function l(){if("ready"!==a){if("failed"===a&&s)throw s;try{if(!i().apps.length){let e=process.env.FIREBASE_SERVICE_ACCOUNT_JSON;if(e){let r=function(e){let r;try{r=JSON.parse(e)}catch{throw new o("FIREBASE_SERVICE_ACCOUNT_JSON is not valid JSON.","Use a single-line JSON string from your Firebase service account key.")}if(!r||"object"!=typeof r)throw new o("FIREBASE_SERVICE_ACCOUNT_JSON is missing or invalid.","Set FIREBASE_SERVICE_ACCOUNT_JSON to the full service account JSON.");let t=String(r.private_key||"").replace(/\\n/g,"\n").trim();if(!(t.startsWith("-----BEGIN PRIVATE KEY-----")&&t.endsWith("-----END PRIVATE KEY-----")))throw new o("Firebase private key is not in valid PEM format.","Ensure private_key contains BEGIN/END markers and escaped newlines (\\\\n) in .env.");return{...r,private_key:t}}(e);i().initializeApp({credential:i().credential.cert(r),projectId:r.project_id||process.env.NEXT_PUBLIC_FIREBASE_PROJECT_ID})}else i().initializeApp()}a="ready",s=null}catch(e){throw a="failed",s=function(e){if(e instanceof o)return e;let r=String(e?.message||e||"Unknown Firebase Admin error"),t=r.toLowerCase();return t.includes("pem")||t.includes("private key")||t.includes("credential")?new o(r,"Rotate and re-add FIREBASE_SERVICE_ACCOUNT_JSON. Ensure private_key newline escaping is correct."):e instanceof Error?e:Error(r)}(e)}}}function u(){return l(),i().firestore()}function d(){return l(),i().auth()}},7153:(e,r)=>{var t;Object.defineProperty(r,"x",{enumerable:!0,get:function(){return t}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(t||(t={}))},1802:(e,r,t)=>{e.exports=t(145)}};var r=require("../../webpack-api-runtime.js");r.C(e);var t=r(r.s=3170);module.exports=t})();