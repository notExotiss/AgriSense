"use strict";(()=>{var e={};e.id=351,e.ids=[351],e.modules={2509:e=>{e.exports=require("firebase-admin")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},1253:e=>{e.exports=require("pngjs")},6113:e=>{e.exports=require("crypto")},9529:(e,t,i)=>{i.r(t),i.d(t,{config:()=>g,default:()=>v,routeModule:()=>f});var a={};i.r(a),i.d(a,{config:()=>o,default:()=>y});var s=i(1802),n=i(7153),r=i(6249),l=i(9685);let o={api:{bodyParser:{sizeLimit:"4mb"}}};function d(e,t=0){let i=Number(e);return Number.isFinite(i)?i:t}function u(e){return e&&"object"==typeof e?{min:d(e.min),max:d(e.max),mean:d(e.mean)}:null}function m(e){let t=e?.current||e?.weather||e||{};return{temperature:d(t.temperature??t.temperature_2m),humidity:d(t.humidity??t.relative_humidity_2m),precipitation:d(t.precipitation),windSpeed:d(t.windSpeed??t.wind_speed_10m),source:"string"==typeof e?.source?e.source:void 0,isSimulated:!!e?.isSimulated}}function c(e){let t=e?.summary||e?.data?.summary||{},i=(Array.isArray(e?.timeSeries)?e.timeSeries:Array.isArray(e?.data?.timeSeries)?e.data.timeSeries:[]).slice(-12).map(e=>({date:"string"==typeof e?.date?e.date:"",ndvi:d(e?.ndvi),cloudCover:"number"==typeof e?.cloudCover?e.cloudCover:null}));return{summary:{trend:"string"==typeof t?.trend?t.trend:"stable",averageNDVI:d(t?.averageNDVI),totalPoints:d(t?.totalPoints)},points:i,source:"string"==typeof e?.source?e.source:void 0,isSimulated:!!e?.isSimulated}}function p(e){let t=e&&e>0?` Retry in about ${Math.max(1,Math.round(e/1e3))}s.`:"";return`Gemini is temporarily unavailable for this request.${t}`}async function y(e,t){if("POST"!==e.method)return t.status(405).end();try{let i=function(e){var t,i;let a=e&&"object"==typeof e?e:{},s=String(a?.prompt||a?.question||"").slice(0,4e3).trim(),n="string"==typeof a?.mode?a.mode:void 0,r=Array.isArray(a?.history)?a.history.slice(-8).map(e=>({role:String(e?.role||"user").slice(0,12),text:String(e?.text||"").slice(0,480)})):[],l=a?.context||{},o=u(a?.ndviData?.stats||a?.ndviData||l?.ndviStats),p=u(a?.soilData?.stats||a?.soilData||l?.soilStats),y=u(a?.etData?.stats||a?.etData||l?.etStats);return{prompt:s,analysisType:"string"==typeof a?.analysisType?a.analysisType:void 0,objective:a?.objective||"balanced",mode:n,ndviData:o?{stats:o}:void 0,soilData:p?{stats:p,isSimulated:!!(a?.soilData?.isSimulated||l?.soil?.isSimulated)}:void 0,etData:y?{stats:y,isSimulated:!!(a?.etData?.isSimulated||l?.et?.isSimulated)}:void 0,weatherData:m(a?.weatherData||l?.weather),timeSeriesData:c(a?.timeSeriesData||l?.timeSeries),context:{ndviStats:o,soilStats:p,etStats:y,grid3x3:Array.isArray(t=l?.grid3x3||a?.grid3x3)?t.slice(0,9).map((e,t)=>({cellId:String(e?.cellId||`${Math.floor(t/3)}-${t%3}`),row:Number.isFinite(Number(e?.row))?Number(e.row):Math.floor(t/3),col:Number.isFinite(Number(e?.col))?Number(e.col):t%3,mean:d(e?.mean),min:d(e?.min),max:d(e?.max),validPixelRatio:d(e?.validPixelRatio),stressLevel:"string"==typeof e?.stressLevel?e.stressLevel:"unknown"})):[],selectedCell:"string"==typeof l?.selectedCell?l.selectedCell:void 0,weather:m(a?.weatherData||l?.weather),timeSeries:c(a?.timeSeriesData||l?.timeSeries),warnings:Array.isArray(l?.warnings)?l.warnings.slice(0,12).map(e=>String(e).slice(0,200)):[]},providersTried:Array.isArray(i=a?.providersTried||l?.providersTried)?i.slice(0,12).map(e=>({provider:String(e?.provider||"unknown"),ok:!!e?.ok,reason:e?.reason?String(e.reason).slice(0,120):void 0})):[],history:r}}(e.body),{inference:a,chat:s,llmUnavailable:n}=await (0,l.d7)({prompt:i.prompt||"Provide a field operations summary.",analysisType:i.analysisType,objective:i.objective,mode:i.mode,ndviData:i.ndviData,weatherData:i.weatherData,soilData:i.soilData,etData:i.etData,timeSeriesData:i.timeSeriesData,context:i.context,providersTried:i.providersTried,selectedCell:i.context?.selectedCell,history:i.history});if(!s){let e=Number(n?.retryAfterMs||0)||void 0,s=p(e),r=Array.isArray(n?.attemptedModels)?n?.attemptedModels:[],l=Number(n?.retries||0);return t.status(200).json({success:!0,unavailable:!0,retryAfterMs:e,assistantBackend:"unavailable",warnings:[n?.lastFailure||n?.message||"gemini_unavailable"],answer:s,sections:{rationale:"The LLM provider did not return a usable response for this request.",actions:["Retry the same question in a moment.","If this persists, verify GEMINI_API_KEY and model availability."]},renderModel:"qa",usedHistory:!1,suggestion:s,output:s,model:a.engine,engine:a.engine,confidence:a.confidence,objective:a.objective,dataQuality:a.dataQuality,isSimulatedInputs:a.isSimulatedInputs,inference:a,intent:"general",intentConfidence:0,mode:i.mode||"status",evidence:[],tasks:[],selectedCell:i.context?.selectedCell||null,scenarioUsed:!1,llmAttemptedModels:r,llmFinalModel:null,llmRetries:l,llmDegraded:!0,confidenceBreakdown:{model:a.confidence,dataQuality:a.dataQuality.score},timestamp:new Date().toISOString()})}return t.status(200).json({success:!0,unavailable:!1,answer:s.answer,sections:s.sections,renderModel:s.renderModel,usedHistory:s.usedHistory,suggestion:s.text,output:s.text,assistantBackend:s.backend||"llm-gemini",model:a.engine,engine:a.engine,confidence:a.confidence,objective:a.objective,dataQuality:a.dataQuality,isSimulatedInputs:a.isSimulatedInputs,inference:a,intent:s.intent,intentConfidence:s.intentConfidence,mode:s.mode,evidence:s.evidence,tasks:s.tasks,selectedCell:i.context?.selectedCell||null,scenarioUsed:!1,llmAttemptedModels:s.llmAttemptedModels||[],llmFinalModel:s.llmFinalModel||null,llmRetries:Number(s.llmRetries||0),llmDegraded:!!s.llmDegraded,confidenceBreakdown:{model:a.confidence,dataQuality:a.dataQuality.score},timestamp:new Date().toISOString()})}catch(a){let i=String(a?.message||"");if(i.toLowerCase().includes("body exceeded"))return t.status(413).json({error:"request_too_large",message:"Request body exceeded limit. Send compact context only."});return t.status(200).json({success:!0,unavailable:!0,retryAfterMs:8e3,warnings:[i||"gemini_unavailable"],answer:p(8e3),sections:{rationale:"The assistant backend did not produce a valid response.",actions:["Retry in a few seconds.","If the issue persists, verify Gemini API configuration and quota."]},renderModel:"qa",usedHistory:!1,suggestion:p(8e3),output:p(8e3),assistantBackend:"unavailable",model:"agrisense-ml-engine",engine:"agrisense-ml-engine",confidence:0,objective:e.body?.objective||"balanced",dataQuality:{completeness:0,providerQuality:0,score:0,isSimulatedInputs:!0,warnings:["Assistant unavailable"]},isSimulatedInputs:!0,inference:null,intent:"general",intentConfidence:0,mode:e.body?.mode||"status",evidence:[],tasks:[],selectedCell:e.body?.selectedCell||e.body?.context?.selectedCell||null,scenarioUsed:!1,llmAttemptedModels:[],llmFinalModel:null,llmRetries:0,llmDegraded:!0,confidenceBreakdown:{model:0,dataQuality:0},timestamp:new Date().toISOString()})}}let v=(0,r.l)(a,"default"),g=(0,r.l)(a,"config"),f=new s.PagesAPIRouteModule({definition:{kind:n.x.PAGES_API,page:"/api/gemini",pathname:"/api/gemini",bundlePath:"",filename:""},userland:a})}};var t=require("../../webpack-api-runtime.js");t.C(e);var i=e=>t(t.s=e),a=t.X(0,[490],()=>i(9529));module.exports=a})();