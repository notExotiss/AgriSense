"use strict";(()=>{var e={};e.id=351,e.ids=[351],e.modules={2509:e=>{e.exports=require("firebase-admin")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},1253:e=>{e.exports=require("pngjs")},6113:e=>{e.exports=require("crypto")},9529:(e,t,i)=>{i.r(t),i.d(t,{config:()=>v,default:()=>y,routeModule:()=>g});var a={};i.r(a),i.d(a,{config:()=>l,default:()=>p});var s=i(1802),r=i(7153),n=i(6249),o=i(4917);let l={api:{bodyParser:{sizeLimit:"4mb"}}};function d(e,t=0){let i=Number(e);return Number.isFinite(i)?i:t}function m(e){return e&&"object"==typeof e?{min:d(e.min),max:d(e.max),mean:d(e.mean)}:null}function c(e){let t=e?.current||e?.weather||e||{};return{temperature:d(t.temperature??t.temperature_2m),humidity:d(t.humidity??t.relative_humidity_2m),precipitation:d(t.precipitation),windSpeed:d(t.windSpeed??t.wind_speed_10m),source:"string"==typeof e?.source?e.source:void 0,isSimulated:!!e?.isSimulated}}function u(e){let t=e?.summary||e?.data?.summary||{},i=(Array.isArray(e?.timeSeries)?e.timeSeries:Array.isArray(e?.data?.timeSeries)?e.data.timeSeries:[]).slice(-12).map(e=>({date:"string"==typeof e?.date?e.date:"",ndvi:d(e?.ndvi),cloudCover:"number"==typeof e?.cloudCover?e.cloudCover:null}));return{summary:{trend:"string"==typeof t?.trend?t.trend:"stable",averageNDVI:d(t?.averageNDVI),totalPoints:d(t?.totalPoints)},points:i,source:"string"==typeof e?.source?e.source:void 0,isSimulated:!!e?.isSimulated}}async function p(e,t){if("POST"!==e.method)return t.status(405).end();try{let i=function(e){var t,i;let a=e&&"object"==typeof e?e:{},s=String(a?.prompt||a?.question||"").slice(0,4e3).trim(),r="string"==typeof a?.mode?a.mode:void 0,n=Array.isArray(a?.history)?a.history.slice(-8).map(e=>({role:String(e?.role||"user").slice(0,12),text:String(e?.text||"").slice(0,480)})):[],o=a?.context||{},l=m(a?.ndviData?.stats||a?.ndviData||o?.ndviStats),p=m(a?.soilData?.stats||a?.soilData||o?.soilStats),y=m(a?.etData?.stats||a?.etData||o?.etStats);return{prompt:s,analysisType:"string"==typeof a?.analysisType?a.analysisType:void 0,objective:a?.objective||"balanced",mode:r,ndviData:l?{stats:l}:void 0,soilData:p?{stats:p,isSimulated:!!(a?.soilData?.isSimulated||o?.soil?.isSimulated)}:void 0,etData:y?{stats:y,isSimulated:!!(a?.etData?.isSimulated||o?.et?.isSimulated)}:void 0,weatherData:c(a?.weatherData||o?.weather),timeSeriesData:u(a?.timeSeriesData||o?.timeSeries),context:{ndviStats:l,soilStats:p,etStats:y,grid3x3:Array.isArray(t=o?.grid3x3||a?.grid3x3)?t.slice(0,9).map((e,t)=>({cellId:String(e?.cellId||`${Math.floor(t/3)}-${t%3}`),row:Number.isFinite(Number(e?.row))?Number(e.row):Math.floor(t/3),col:Number.isFinite(Number(e?.col))?Number(e.col):t%3,mean:d(e?.mean),min:d(e?.min),max:d(e?.max),validPixelRatio:d(e?.validPixelRatio),stressLevel:"string"==typeof e?.stressLevel?e.stressLevel:"unknown"})):[],selectedCell:"string"==typeof o?.selectedCell?o.selectedCell:void 0,weather:c(a?.weatherData||o?.weather),timeSeries:u(a?.timeSeriesData||o?.timeSeries),warnings:Array.isArray(o?.warnings)?o.warnings.slice(0,12).map(e=>String(e).slice(0,200)):[]},providersTried:Array.isArray(i=a?.providersTried||o?.providersTried)?i.slice(0,12).map(e=>({provider:String(e?.provider||"unknown"),ok:!!e?.ok,reason:e?.reason?String(e.reason).slice(0,120):void 0})):[],history:n}}(e.body),{inference:a,chat:s}=await (0,o.d7)({prompt:i.prompt||"Provide a field operations summary.",analysisType:i.analysisType,objective:i.objective,mode:i.mode,ndviData:i.ndviData,weatherData:i.weatherData,soilData:i.soilData,etData:i.etData,timeSeriesData:i.timeSeriesData,context:i.context,providersTried:i.providersTried,selectedCell:i.context?.selectedCell,history:i.history});return t.status(200).json({success:!0,answer:s.answer,sections:s.sections,renderModel:s.renderModel,usedHistory:s.usedHistory,suggestion:s.text,output:s.text,assistantBackend:s.backend||"deterministic",model:a.engine,engine:a.engine,confidence:a.confidence,objective:a.objective,dataQuality:a.dataQuality,isSimulatedInputs:a.isSimulatedInputs,inference:a,intent:s.intent,intentConfidence:s.intentConfidence,mode:s.mode,evidence:s.evidence,tasks:s.tasks,selectedCell:i.context?.selectedCell||null,scenarioUsed:!1,llmAttemptedModels:s.llmAttemptedModels||[],llmFinalModel:s.llmFinalModel||null,llmRetries:Number(s.llmRetries||0),llmDegraded:!!s.llmDegraded,confidenceBreakdown:{model:a.confidence,dataQuality:a.dataQuality.score},timestamp:new Date().toISOString()})}catch(n){let i=String(n?.message||"");if(i.toLowerCase().includes("body exceeded"))return t.status(413).json({error:"request_too_large",message:"Request body exceeded limit. Send compact context only."});let a=d(e.body?.ndviData?.stats?.mean??e.body?.context?.ndviStats?.mean,.4),s=a<.3?"high":a<.45?"moderate":"low",r=`AI Assistant is running in degraded mode (${i||"inference unavailable"}).
Current NDVI mean indicates ${s} vegetation stress risk.
Recommended next steps:
1. Re-run analysis for the same AOI and compare the selected 3x3 cell.
2. Prioritize irrigation uniformity checks in stressed cells.
3. Re-check within 24-48 hours after intervention.`;return t.status(200).json({success:!0,degraded:!0,warnings:[i||"ML inference unavailable; fallback response returned."],answer:r,sections:{rationale:`Current NDVI mean indicates ${s} vegetation stress risk.`,actions:["Re-run analysis for the same AOI and compare selected plot points.","Prioritize irrigation uniformity checks in stressed cells.","Re-check within 24-48 hours after intervention."]},renderModel:"qa",usedHistory:!1,suggestion:r,output:r,assistantBackend:"deterministic",model:"agrisense-ml-fallback",engine:"agrisense-ml-fallback",confidence:.42,objective:e.body?.objective||"balanced",dataQuality:{completeness:.5,providerQuality:.5,score:.42,isSimulatedInputs:!0,warnings:["Fallback assistant response"]},isSimulatedInputs:!0,inference:null,intent:"general",intentConfidence:.3,mode:e.body?.mode||"status",evidence:[],tasks:[],selectedCell:e.body?.selectedCell||e.body?.context?.selectedCell||null,scenarioUsed:!1,llmAttemptedModels:[],llmFinalModel:null,llmRetries:0,llmDegraded:!0,confidenceBreakdown:{model:.42,dataQuality:.42},timestamp:new Date().toISOString()})}}let y=(0,n.l)(a,"default"),v=(0,n.l)(a,"config"),g=new s.PagesAPIRouteModule({definition:{kind:r.x.PAGES_API,page:"/api/gemini",pathname:"/api/gemini",bundlePath:"",filename:""},userland:a})}};var t=require("../../webpack-api-runtime.js");t.C(e);var i=e=>t(t.s=e),a=t.X(0,[281],()=>i(9529));module.exports=a})();