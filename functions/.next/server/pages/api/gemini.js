"use strict";(()=>{var e={};e.id=351,e.ids=[351],e.modules={2509:e=>{e.exports=require("firebase-admin")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},1253:e=>{e.exports=require("pngjs")},6113:e=>{e.exports=require("crypto")},9529:(e,t,i)=>{i.r(t),i.d(t,{config:()=>g,default:()=>v,routeModule:()=>f});var a={};i.r(a),i.d(a,{config:()=>l,default:()=>y});var n=i(1802),r=i(7153),s=i(6249),o=i(9685);let l={api:{bodyParser:{sizeLimit:"4mb"}}};function d(e,t=0){let i=Number(e);return Number.isFinite(i)?i:t}function u(e){return e&&"object"==typeof e?{min:d(e.min),max:d(e.max),mean:d(e.mean)}:null}function m(e){let t=e?.current||e?.weather||e||{};return{temperature:d(t.temperature??t.temperature_2m),humidity:d(t.humidity??t.relative_humidity_2m),precipitation:d(t.precipitation),windSpeed:d(t.windSpeed??t.wind_speed_10m),source:"string"==typeof e?.source?e.source:void 0,isSimulated:!!e?.isSimulated}}function c(e){let t=e?.summary||e?.data?.summary||{},i=(Array.isArray(e?.timeSeries)?e.timeSeries:Array.isArray(e?.data?.timeSeries)?e.data.timeSeries:[]).slice(-12).map(e=>({date:"string"==typeof e?.date?e.date:"",ndvi:d(e?.ndvi),cloudCover:"number"==typeof e?.cloudCover?e.cloudCover:null}));return{summary:{trend:"string"==typeof t?.trend?t.trend:"stable",averageNDVI:d(t?.averageNDVI),totalPoints:d(t?.totalPoints)},points:i,source:"string"==typeof e?.source?e.source:void 0,isSimulated:!!e?.isSimulated}}function p(e,t){let i=t&&t>0?Math.max(1,Math.round(t/1e3)):null,a=i?` Retry in about ${i}s.`:"",n=String(e||"").toLowerCase();return n.includes("gemini_key_leaked")?{answer:`Gemini is blocked because the configured API key was reported as leaked.${a}`,rationale:"Google rejected the key at the provider layer before the model could run.",actions:["Create a new Gemini API key in Google AI Studio.","Set only GEMINI_API_KEY on the server and remove NEXT_PUBLIC_GEMINI_API_KEY from client env.","Restart the Next.js server after updating the key."]}:n.includes("gemini_key_invalid")||n.includes("permission_denied")?{answer:`Gemini rejected the API credentials for this request.${a}`,rationale:"The provider returned an authorization failure.",actions:["Verify GEMINI_API_KEY is valid and active.","Confirm the key has access to Gemini generateContent.","Restart the server after any env changes."]}:n.includes("gemini_http_404")?{answer:`Gemini model configuration is invalid for the current API version.${a}`,rationale:"The configured model name could not be resolved by the provider.",actions:["Set GEMINI_MODEL to a currently available model from the Gemini ListModels endpoint.","Optionally set GEMINI_FALLBACK_MODELS to additional supported models.","Restart the server after changing environment variables."]}:{answer:`Gemini is temporarily unavailable for this request.${a}`,rationale:"The LLM provider did not return a usable response for this request.",actions:["Retry the same question in a moment.","If this persists, verify GEMINI_API_KEY and model availability."]}}async function y(e,t){if("POST"!==e.method)return t.status(405).end();try{let i=function(e){var t,i;let a=e&&"object"==typeof e?e:{},n=String(a?.prompt||a?.question||"").slice(0,4e3).trim(),r="string"==typeof a?.mode?a.mode:void 0,s=Array.isArray(a?.history)?a.history.slice(-8).map(e=>({role:String(e?.role||"user").slice(0,12),text:String(e?.text||"").slice(0,480)})):[],o=a?.context||{},l=u(a?.ndviData?.stats||a?.ndviData||o?.ndviStats),p=u(a?.soilData?.stats||a?.soilData||o?.soilStats),y=u(a?.etData?.stats||a?.etData||o?.etStats);return{prompt:n,analysisType:"string"==typeof a?.analysisType?a.analysisType:void 0,objective:a?.objective||"balanced",mode:r,ndviData:l?{stats:l}:void 0,soilData:p?{stats:p,isSimulated:!!(a?.soilData?.isSimulated||o?.soil?.isSimulated)}:void 0,etData:y?{stats:y,isSimulated:!!(a?.etData?.isSimulated||o?.et?.isSimulated)}:void 0,weatherData:m(a?.weatherData||o?.weather),timeSeriesData:c(a?.timeSeriesData||o?.timeSeries),context:{ndviStats:l,soilStats:p,etStats:y,grid3x3:Array.isArray(t=o?.grid3x3||a?.grid3x3)?t.slice(0,9).map((e,t)=>({cellId:String(e?.cellId||`${Math.floor(t/3)}-${t%3}`),row:Number.isFinite(Number(e?.row))?Number(e.row):Math.floor(t/3),col:Number.isFinite(Number(e?.col))?Number(e.col):t%3,mean:d(e?.mean),min:d(e?.min),max:d(e?.max),validPixelRatio:d(e?.validPixelRatio),stressLevel:"string"==typeof e?.stressLevel?e.stressLevel:"unknown"})):[],selectedCell:"string"==typeof o?.selectedCell?o.selectedCell:void 0,weather:m(a?.weatherData||o?.weather),timeSeries:c(a?.timeSeriesData||o?.timeSeries),warnings:Array.isArray(o?.warnings)?o.warnings.slice(0,12).map(e=>String(e).slice(0,200)):[]},providersTried:Array.isArray(i=a?.providersTried||o?.providersTried)?i.slice(0,12).map(e=>({provider:String(e?.provider||"unknown"),ok:!!e?.ok,reason:e?.reason?String(e.reason).slice(0,120):void 0})):[],history:s}}(e.body),{inference:a,chat:n,llmUnavailable:r}=await (0,o.d7)({prompt:i.prompt||"Provide a field operations summary.",analysisType:i.analysisType,objective:i.objective,mode:i.mode,ndviData:i.ndviData,weatherData:i.weatherData,soilData:i.soilData,etData:i.etData,timeSeriesData:i.timeSeriesData,context:i.context,providersTried:i.providersTried,selectedCell:i.context?.selectedCell,history:i.history});if(!n){let e=Number(r?.retryAfterMs||0)||void 0,n=p(r?.lastFailure||r?.message,e),s=Array.isArray(r?.attemptedModels)?r?.attemptedModels:[],o=Number(r?.retries||0);return t.status(200).json({success:!0,unavailable:!0,retryAfterMs:e,assistantBackend:"unavailable",warnings:[r?.lastFailure||r?.message||"gemini_unavailable"],answer:n.answer,sections:{rationale:n.rationale,actions:n.actions},renderModel:"qa",usedHistory:!1,suggestion:n.answer,output:n.answer,model:a.engine,engine:a.engine,confidence:a.confidence,objective:a.objective,dataQuality:a.dataQuality,isSimulatedInputs:a.isSimulatedInputs,inference:a,intent:"general",intentConfidence:0,mode:i.mode||"status",evidence:[],tasks:[],selectedCell:i.context?.selectedCell||null,scenarioUsed:!1,llmAttemptedModels:s,llmFinalModel:null,llmRetries:o,llmDegraded:!0,confidenceBreakdown:{model:a.confidence,dataQuality:a.dataQuality.score},timestamp:new Date().toISOString()})}return t.status(200).json({success:!0,unavailable:!1,answer:n.answer,sections:n.sections,renderModel:n.renderModel,usedHistory:n.usedHistory,suggestion:n.text,output:n.text,assistantBackend:n.backend||"llm-gemini",model:a.engine,engine:a.engine,confidence:a.confidence,objective:a.objective,dataQuality:a.dataQuality,isSimulatedInputs:a.isSimulatedInputs,inference:a,intent:n.intent,intentConfidence:n.intentConfidence,mode:n.mode,evidence:n.evidence,tasks:n.tasks,selectedCell:i.context?.selectedCell||null,scenarioUsed:!1,llmAttemptedModels:n.llmAttemptedModels||[],llmFinalModel:n.llmFinalModel||null,llmRetries:Number(n.llmRetries||0),llmDegraded:!!n.llmDegraded,confidenceBreakdown:{model:a.confidence,dataQuality:a.dataQuality.score},timestamp:new Date().toISOString()})}catch(n){let i=String(n?.message||""),a=p(i,8e3);if(i.toLowerCase().includes("body exceeded"))return t.status(413).json({error:"request_too_large",message:"Request body exceeded limit. Send compact context only."});return t.status(200).json({success:!0,unavailable:!0,retryAfterMs:8e3,warnings:[i||"gemini_unavailable"],answer:a.answer,sections:{rationale:a.rationale,actions:a.actions},renderModel:"qa",usedHistory:!1,suggestion:a.answer,output:a.answer,assistantBackend:"unavailable",model:"agrisense-ml-engine",engine:"agrisense-ml-engine",confidence:0,objective:e.body?.objective||"balanced",dataQuality:{completeness:0,providerQuality:0,score:0,isSimulatedInputs:!0,warnings:["Assistant unavailable"]},isSimulatedInputs:!0,inference:null,intent:"general",intentConfidence:0,mode:e.body?.mode||"status",evidence:[],tasks:[],selectedCell:e.body?.selectedCell||e.body?.context?.selectedCell||null,scenarioUsed:!1,llmAttemptedModels:[],llmFinalModel:null,llmRetries:0,llmDegraded:!0,confidenceBreakdown:{model:0,dataQuality:0},timestamp:new Date().toISOString()})}}let v=(0,s.l)(a,"default"),g=(0,s.l)(a,"config"),f=new n.PagesAPIRouteModule({definition:{kind:r.x.PAGES_API,page:"/api/gemini",pathname:"/api/gemini",bundlePath:"",filename:""},userland:a})}};var t=require("../../webpack-api-runtime.js");t.C(e);var i=e=>t(t.s=e),a=t.X(0,[490],()=>i(9529));module.exports=a})();