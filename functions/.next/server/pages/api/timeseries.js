"use strict";(()=>{var e={};e.id=61,e.ids=[61],e.modules={2509:e=>{e.exports=require("firebase-admin")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},1253:e=>{e.exports=require("pngjs")},6113:e=>{e.exports=require("crypto")},6249:(e,t)=>{Object.defineProperty(t,"l",{enumerable:!0,get:function(){return function e(t,r){return r in t?t[r]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,r)):"function"==typeof t&&"default"===r?t:void 0}}})},3869:(e,t,r)=>{r.r(t),r.d(t,{config:()=>A,default:()=>v,routeModule:()=>S});var a={};r.r(a),r.d(a,{default:()=>y});var n=r(1802),i=r(7153),o=r(6249),s=r(1253),l=r(535);function u(e,t){let r=process.env[e];return null==r?t:"1"===r||"true"===r.toLowerCase()||"yes"===r.toLowerCase()}let c={ML_ENGINE_V1:u("FEATURE_ML_ENGINE_V1",!0),REAL_TIMESERIES:u("FEATURE_REAL_TIMESERIES",!0),NEW_UI:u("FEATURE_NEW_UI",!0),PLOT_GEOMETRY_V2:u("FEATURE_PLOT_GEOMETRY_V2",!0),GRID_3X3:u("FEATURE_GRID_3X3",!0),TERRAIN_3D:u("FEATURE_TERRAIN_3D",!0),AI_SIMULATOR:u("FEATURE_AI_SIMULATOR",!0),DASHBOARD_UNIFIED:u("FEATURE_DASHBOARD_UNIFIED",!0)};var d=r(6653),f=r(8851);let h="planetary-computer-timeseries";function m(e,t,r){return Math.max(t,Math.min(r,e))}function p(e){return e.toISOString().slice(0,10)}function E(e,t,r,a=96){let n=new URL("https://planetarycomputer.microsoft.com/api/data/v1/item/preview.png");return n.searchParams.set("collection","sentinel-2-l2a"),n.searchParams.set("item",e),n.searchParams.set("assets",t),n.searchParams.set("asset_bidx",`${t}|1`),n.searchParams.set("nodata","0"),n.searchParams.set("format","png"),n.searchParams.set("rescale","0,3000"),n.searchParams.set("bbox",r.join(",")),n.searchParams.set("width",String(a)),n.searchParams.set("height",String(a)),n.toString()}async function _(e,t){let[r,a]=await Promise.all([(0,d.kv)(E(e.id,"B04",t),{},12e3),(0,d.kv)(E(e.id,"B08",t),{},12e3)]);if(!r.ok||!a.ok)throw Error(`band_fetch_failed_${r.status}_${a.status}`);let n=s.PNG.sync.read(Buffer.from(await r.arrayBuffer())),i=s.PNG.sync.read(Buffer.from(await a.arrayBuffer()));if(n.width!==i.width||n.height!==i.height)throw Error("band_dimension_mismatch");let o=n.width*n.height,l=0,u=0;for(let e=0;e<o;e++){let t=4*e,r=n.data[t],a=i.data[t],o=a+r;if(o<=0)continue;let s=m((a-r)/o,-1,1);Number.isFinite(s)&&(l+=1,u+=s)}if(!l)throw Error("no_valid_pixels");return{mean:Number((u/l).toFixed(4)),validRatio:Number((l/o).toFixed(4))}}async function g(e){try{let t=(0,l._)(),r=await t.collection("timeseries_cache").doc(e).get();if(!r.exists)return null;let a=r.data()||{},n=new Date(String(a.createdAt||0)).getTime();if(!n||Date.now()-n>864e5)return null;return a.payload}catch{return null}}async function w(e,t){try{let r=(0,l._)();await r.collection("timeseries_cache").doc(e).set({createdAt:new Date().toISOString(),payload:t})}catch{}}async function b(e,t){if((0,d.kW)(h))throw t.push({provider:h,ok:!1,reason:"cooldown"}),Error("provider_cooldown");let r=Date.now();try{let a=await (0,d.kv)("https://planetarycomputer.microsoft.com/api/stac/v1/search",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({bbox:e.bbox,datetime:`${e.startDate}/${e.endDate}`,collections:["sentinel-2-l2a"],limit:96,sortby:[{field:"properties.datetime",direction:"desc"}]})},14e3);if(!a.ok)throw Error(`stac_search_failed_${a.status}`);let n=await a.json(),i=function(e,t){let r=new Map;for(let a of e){let e=String(a?.id||""),n=String(a?.properties?.datetime||"").slice(0,10);if(!e||!n||!a?.assets?.B04?.href||!a?.assets?.B08?.href)continue;let i="number"==typeof a?.properties?.["eo:cloud_cover"]?Number(a.properties["eo:cloud_cover"]):null,o=function(e,t){let r=new Date(e);if("daily"===t)return p(r);if("weekly"===t){let e=r.getUTCDay()||7;return r.setUTCDate(r.getUTCDate()-e+1),p(r)}return`${r.getUTCFullYear()}-${String(r.getUTCMonth()+1).padStart(2,"0")}`}(n,t),s=r.get(o);if(!s){r.set(o,{id:e,date:n,cloudCover:i});continue}let l=s.cloudCover??100,u=i??100;(u<l||u===l&&n>s.date)&&r.set(o,{id:e,date:n,cloudCover:i})}return Array.from(r.values()).sort((e,t)=>e.date.localeCompare(t.date)).slice(-24)}(Array.isArray(n?.features)?n.features:[],e.interval);if(!i.length)throw Error("no_imagery");let o=[];for(let t of i)try{let r=await _(t,e.bbox);o.push({date:t.date,ndvi:r.mean,cloudCover:t.cloudCover,confidence:Number(m(r.validRatio*(1-(t.cloudCover??20)/120),.45,.98).toFixed(3)),source:"planetary-computer",isSimulated:!1})}catch{}if(o.length<3)throw Error("insufficient_points");return o.sort((e,t)=>e.date.localeCompare(t.date)),(0,d.U4)(h),t.push({provider:h,ok:!0,durationMs:Date.now()-r}),o}catch(e){throw(0,d.T3)(h),t.push({provider:h,ok:!1,reason:String(e?.message||"provider_failed"),durationMs:Date.now()-r}),e}}async function y(e,t){if("POST"!==e.method)return t.status(405).end();try{let r=function(e){let t=Array.isArray(e?.bbox)?e.bbox.map(Number):[];if(4!==t.length||t.some(e=>Number.isNaN(e)))throw Error("bbox_required");let r=e?.endDate?new Date(e.endDate):new Date,a=new Date(e?.startDate?e.startDate:r.getTime()-31536e6),n=["daily","weekly","monthly"].includes(e?.interval)?e.interval:"weekly";return{bbox:t,startDate:p(a),endDate:p(r),interval:n}}(e.body||{}),a=[],n=[],i=(0,f.kw)(["timeseries",r.bbox.join(","),r.startDate,r.endDate,r.interval]),o=(0,f.Xb)(i);if(o)return t.status(200).json({...o,cacheHit:!0,warnings:[...o.warnings||[],"Returned from memory cache."]});let s=await g(i);if(s)return(0,f.NI)(i,s,864e5),t.status(200).json({...s,cacheHit:!0,warnings:[...s.warnings||[],"Returned from Firestore cache."]});let l=[],u=!1;if(c.REAL_TIMESERIES)try{l=await b(r,a)}catch(e){n.push(`Real provider failed: ${String(e?.message||"unknown_error")}`)}else n.push("FEATURE_REAL_TIMESERIES disabled; using simulated series.");l.length||(l=function(e){let t=function(e){let t=0;for(let r=0;r<e.length;r++)t=(t<<5)-t+e.charCodeAt(r);return()=>(t^=t<<13,t^=t>>17,Math.abs((t^=t<<5)%1e6)/1e6)}(`${e.bbox.join(",")}:${e.startDate}:${e.endDate}:${e.interval}`),r=[],a=new Date(e.startDate),n=new Date(e.endDate);for(;a<=n&&r.length<24;){let n=.16*Math.sin(a.getUTCMonth()/12*Math.PI*2),i=m(.46+n+(t()-.5)*.07,-.1,.9);r.push({date:p(a),ndvi:Number(i.toFixed(4)),cloudCover:Number((32*t()).toFixed(2)),confidence:Number((.55+.2*t()).toFixed(3)),source:"simulated-fallback",isSimulated:!0}),"daily"===e.interval?a.setUTCDate(a.getUTCDate()+1):"weekly"===e.interval?a.setUTCDate(a.getUTCDate()+7):a.setUTCMonth(a.getUTCMonth()+1)}return r}(r),u=!0,n.push("Simulated fallback used because real providers were unavailable."));let d={success:!0,data:{timeSeries:l,bbox:r.bbox,interval:r.interval,startDate:r.startDate,endDate:r.endDate,summary:function(e){let t=e.reduce((e,t)=>e+t.ndvi,0)/Math.max(e.length,1);return{totalPoints:e.length,averageNDVI:Number(t.toFixed(4)),trend:function(e){if(e.length<3)return"stable";let t=e.slice(0,Math.floor(e.length/2)),r=e.slice(Math.floor(e.length/2)),a=t.reduce((e,t)=>e+t.ndvi,0)/Math.max(t.length,1),n=r.reduce((e,t)=>e+t.ndvi,0)/Math.max(r.length,1)-a;return n>.04?"improving":n<-.04?"declining":"stable"}(e),seasonality:function(e){if(e.length<8)return{detected:!1,amplitude:0,peakMonth:null,lowMonth:null};let t={};for(let r of e){let e=new Date(r.date).getUTCMonth();t[e]||(t[e]=[]),t[e].push(r.ndvi)}let r=Array(12).fill(0);for(let e=0;e<12;e++){let a=t[e]||[];r[e]=a.length?a.reduce((e,t)=>e+t,0)/a.length:0}let a=Math.max(...r),n=Math.min(...r);return{detected:a-n>.06,amplitude:Number((a-n).toFixed(4)),peakMonth:r.indexOf(a),lowMonth:r.indexOf(n)}}(e)}}(l)},source:u?"simulated-fallback":"planetary-computer",isSimulated:u,cacheHit:!1,warnings:n,providersTried:a};return(0,f.NI)(i,d,864e5),await w(i,d),t.status(200).json(d)}catch(e){if("bbox_required"===String(e?.message||""))return t.status(400).json({error:"bbox_required",message:"Bounding box [minx,miny,maxx,maxy] is required."});return t.status(500).json({error:"timeseries_failed",message:String(e?.message||"Unexpected timeseries error")})}}let v=(0,o.l)(a,"default"),A=(0,o.l)(a,"config"),S=new n.PagesAPIRouteModule({definition:{kind:i.x.PAGES_API,page:"/api/timeseries",pathname:"/api/timeseries",bundlePath:"",filename:""},userland:a})},535:(e,t,r)=>{r.d(t,{D:()=>c,_:()=>u});var a=r(2509),n=r.n(a);class i extends Error{constructor(e,t){super(e),this.name="FirebaseAdminConfigError",this.code="firebase_admin_misconfigured",this.hint=t}}let o="idle",s=null;function l(){if("ready"!==o){if("failed"===o&&s)throw s;try{if(!n().apps.length){let e=process.env.FIREBASE_SERVICE_ACCOUNT_JSON;if(e){let t=function(e){let t;try{t=JSON.parse(e)}catch{throw new i("FIREBASE_SERVICE_ACCOUNT_JSON is not valid JSON.","Use a single-line JSON string from your Firebase service account key.")}if(!t||"object"!=typeof t)throw new i("FIREBASE_SERVICE_ACCOUNT_JSON is missing or invalid.","Set FIREBASE_SERVICE_ACCOUNT_JSON to the full service account JSON.");let r=String(t.private_key||"").replace(/\\n/g,"\n").trim();if(!(r.startsWith("-----BEGIN PRIVATE KEY-----")&&r.endsWith("-----END PRIVATE KEY-----")))throw new i("Firebase private key is not in valid PEM format.","Ensure private_key contains BEGIN/END markers and escaped newlines (\\\\n) in .env.");return{...t,private_key:r}}(e);n().initializeApp({credential:n().credential.cert(t),projectId:t.project_id||"brightbite-81e92"})}else n().initializeApp()}o="ready",s=null}catch(e){throw o="failed",s=function(e){if(e instanceof i)return e;let t=String(e?.message||e||"Unknown Firebase Admin error"),r=t.toLowerCase();return r.includes("pem")||r.includes("private key")||r.includes("credential")?new i(t,"Rotate and re-add FIREBASE_SERVICE_ACCOUNT_JSON. Ensure private_key newline escaping is correct."):e instanceof Error?e:Error(t)}(e)}}}function u(){return l(),n().firestore()}function c(){return l(),n().auth()}},8851:(e,t,r)=>{r.d(t,{NI:()=>l,Xb:()=>s,kw:()=>o});var a=r(6113);let n=globalThis;function i(){return n.__agrisenseMemoryCache||(n.__agrisenseMemoryCache=new Map),n.__agrisenseMemoryCache}function o(e){return(0,a.createHash)("sha1").update(e.join("|")).digest("hex")}function s(e){let t=i(),r=t.get(e);return r?Date.now()>r.expiresAt?(t.delete(e),null):r.value:null}function l(e,t,r){i().set(e,{value:t,expiresAt:Date.now()+r})}},6653:(e,t,r)=>{r.d(t,{T3:()=>s,U4:()=>o,kW:()=>i,kv:()=>l,ls:()=>u});let a=globalThis;function n(){return a.__agrisenseProviderRuntime||(a.__agrisenseProviderRuntime={}),a.__agrisenseProviderRuntime}function i(e){let t=n()[e];return!!t&&Date.now()<t.cooldownUntil}function o(e){n()[e]={failures:0,cooldownUntil:0}}function s(e,t){let r=t?.threshold??3,a=t?.cooldownMs??12e4,i=n(),o=(i[e]||{failures:0,cooldownUntil:0}).failures+1,s=o>=r;i[e]={failures:s?0:o,cooldownUntil:s?Date.now()+a:0}}async function l(e,t={},r=12e3){let a=new AbortController,n=setTimeout(()=>a.abort(),r);try{return await fetch(e,{...t,signal:a.signal})}finally{clearTimeout(n)}}async function u(e,t={},r){let a=r?.retries??1,n=r?.timeoutMs??12e3,i=new Set(r?.retryOnStatus||[408,425,429,500,502,503,504]),o=null;for(let r=0;r<=a;r++)try{let o=await l(e,t,n);if(!o.ok){if(r<a&&i.has(o.status)){await new Promise(e=>setTimeout(e,350*(r+1)));continue}let e=await o.text().catch(()=>""),t=Error(`http_${o.status}:${e.slice(0,200)}`);throw t.status=o.status,t}return await o.json()}catch(t){o=t;let e="aborterror"===String(t?.name||"").toLowerCase();if(r<a&&e){await new Promise(e=>setTimeout(e,350*(r+1)));continue}if(r<a&&String(t?.message||"").startsWith("http_5")){await new Promise(e=>setTimeout(e,350*(r+1)));continue}break}throw o instanceof Error?o:Error("fetch_failed")}},7153:(e,t)=>{var r;Object.defineProperty(t,"x",{enumerable:!0,get:function(){return r}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(r||(r={}))},1802:(e,t,r)=>{e.exports=r(145)}};var t=require("../../webpack-api-runtime.js");t.C(e);var r=t(t.s=3869);module.exports=r})();