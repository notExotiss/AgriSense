"use strict";(()=>{var e={};e.id=143,e.ids=[143],e.modules={145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},6113:e=>{e.exports=require("crypto")},6249:(e,t)=>{Object.defineProperty(t,"l",{enumerable:!0,get:function(){return function e(t,r){return r in t?t[r]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,r)):"function"==typeof t&&"default"===r?t:void 0}}})},8846:(e,t,r)=>{r.r(t),r.d(t,{config:()=>p,default:()=>g,routeModule:()=>h});var o={};r.r(o),r.d(o,{default:()=>m});var n=r(1802),i=r(7153),s=r(6249),a=r(6653),u=r(8851);function l(e,t,r=.06){let o=Number((e-r).toFixed(6));return[o,Number((e+r).toFixed(6)),Number((t-r).toFixed(6)),Number((t+r).toFixed(6))]}async function c(e){let t=new URL("https://geocoding-api.open-meteo.com/v1/search");t.searchParams.set("name",e),t.searchParams.set("count","8"),t.searchParams.set("language","en"),t.searchParams.set("format","json");let r=await (0,a.ls)(t.toString(),{},{retries:1,timeoutMs:9e3}),o=(Array.isArray(r?.results)?r.results:[]).filter(e=>"number"==typeof e?.latitude&&"number"==typeof e?.longitude).map(e=>{let t=Number(e.latitude),r=Number(e.longitude),o=[e.admin1,e.country].filter(Boolean).join(", ");return{display_name:[e.name,o].filter(Boolean).join(", "),lat:t,lon:r,bbox:l(t,r),source:"open-meteo"}});if(!o.length)throw Error("no_results");return o}async function d(e){let t=new URL("https://photon.komoot.io/api/");t.searchParams.set("q",e),t.searchParams.set("limit","8");let r=await (0,a.ls)(t.toString(),{},{retries:1,timeoutMs:9e3}),o=(Array.isArray(r?.features)?r.features:[]).filter(e=>Array.isArray(e?.geometry?.coordinates)).map(e=>{let t=Number(e.geometry.coordinates[0]),r=Number(e.geometry.coordinates[1]),o=e.properties||{},n=[o.city||o.county||o.state,o.country].filter(Boolean).join(", ");return{display_name:[o.name||o.street||o.state||"Unknown",n].filter(Boolean).join(", "),lat:r,lon:t,bbox:l(r,t),source:"photon"}});if(!o.length)throw Error("no_results");return o}async function f(e,t,r){if((0,a.kW)(e))return r.push({provider:e,ok:!1,reason:"cooldown"}),null;let o=Date.now();try{let n=await t();return(0,a.U4)(e),r.push({provider:e,ok:!0,durationMs:Date.now()-o}),n}catch(t){return(0,a.T3)(e),r.push({provider:e,ok:!1,reason:function(e){let t=String(e?.message||e||"").toLowerCase();return t.includes("http_403")?"geocode_provider_403":t.includes("abort")||t.includes("timeout")?"geocode_timeout":t.includes("no_results")?"geocode_no_results":"geocode_all_failed"}(t),status:Number(t?.status)||void 0,durationMs:Date.now()-o}),null}}async function m(e,t){if("GET"!==e.method)return t.status(405).end();let r=String(e.query.q||"").trim();if(!r)return t.status(400).json({error:"validation_failed",message:'Query parameter "q" is required.'});let{clean:o,primary:n}=function(e){let t=e.replace(/\s+/g," ").trim(),r=t.split(",")[0]?.trim()||t;return{clean:t,primary:r||t}}(r),i=[],s=[],a=`geocode:${o.toLowerCase()}`,l=(0,u.Xb)(a);if(l)return t.status(200).json({...l,warnings:[...l.warnings||[],"Served from cache."]});let m=[n,o].filter((e,t,r)=>!!e&&r.indexOf(e)===t);for(let e=0;e<m.length;e++){let r=m[e];1===e&&s.push("Primary normalized query returned no results; retried with full query.");let l=await f("open-meteo",()=>c(r),i);if(l?.length){let e={success:!0,query:o,normalizedQuery:n,places:l,warnings:s,providersTried:i};return(0,u.NI)(a,e,216e5),t.status(200).json(e)}let g=await f("photon",()=>d(r),i);if(g?.length){let e={success:!0,query:o,normalizedQuery:n,places:g,warnings:[...s,"Fallback geocoder used."],providersTried:i};return(0,u.NI)(a,e,216e5),t.status(200).json(e)}}if(l?.places?.length)return t.status(200).json({...l,warnings:[...l.warnings||[],"Providers unavailable; returned recent cached result."],providersTried:i});let g=i.find(e=>!e.ok&&"geocode_provider_403"===e.reason)?"geocode_provider_403":i.every(e=>"geocode_timeout"===e.reason)?"geocode_timeout":i.some(e=>"geocode_no_results"===e.reason)?"geocode_no_results":"geocode_all_failed";return t.status(502).json({error:g,message:"geocode_no_results"===g?`No locations found for "${o}".`:`All geocoding providers failed for "${o}".`,reason:g,providersTried:i})}let g=(0,s.l)(o,"default"),p=(0,s.l)(o,"config"),h=new n.PagesAPIRouteModule({definition:{kind:i.x.PAGES_API,page:"/api/geocode",pathname:"/api/geocode",bundlePath:"",filename:""},userland:o})},8851:(e,t,r)=>{r.d(t,{NI:()=>u,Xb:()=>a,kw:()=>s,sA:()=>l});var o=r(6113);let n=globalThis;function i(){return n.__agrisenseMemoryCache||(n.__agrisenseMemoryCache=new Map),n.__agrisenseMemoryCache}function s(e){return(0,o.createHash)("sha1").update(e.join("|")).digest("hex")}function a(e){let t=i(),r=t.get(e);return r?Date.now()>r.expiresAt?(t.delete(e),null):r.value:null}function u(e,t,r){i().set(e,{value:t,expiresAt:Date.now()+r})}function l(e){let t=i();if(!e){let e=t.size;return t.clear(),e}let r=0,o=[];return t.forEach((t,r)=>{r.startsWith(e)&&o.push(r)}),o.forEach(e=>{t.delete(e)&&(r+=1)}),r}},6653:(e,t,r)=>{r.d(t,{T3:()=>a,U4:()=>s,kW:()=>i,kv:()=>u,ls:()=>l});let o=globalThis;function n(){return o.__agrisenseProviderRuntime||(o.__agrisenseProviderRuntime={}),o.__agrisenseProviderRuntime}function i(e){let t=n()[e];return!!t&&Date.now()<t.cooldownUntil}function s(e){n()[e]={failures:0,cooldownUntil:0}}function a(e,t){let r=t?.threshold??3,o=t?.cooldownMs??12e4,i=n(),s=(i[e]||{failures:0,cooldownUntil:0}).failures+1,a=s>=r;i[e]={failures:a?0:s,cooldownUntil:a?Date.now()+o:0}}async function u(e,t={},r=12e3){let o=new AbortController,n=setTimeout(()=>o.abort(),r);try{return await fetch(e,{...t,signal:o.signal})}finally{clearTimeout(n)}}async function l(e,t={},r){let o=r?.retries??1,n=r?.timeoutMs??12e3,i=new Set(r?.retryOnStatus||[408,425,429,500,502,503,504]),s=null;for(let r=0;r<=o;r++)try{let s=await u(e,t,n);if(!s.ok){if(r<o&&i.has(s.status)){await new Promise(e=>setTimeout(e,350*(r+1)));continue}let e=await s.text().catch(()=>""),t=Error(`http_${s.status}:${e.slice(0,200)}`);throw t.status=s.status,t}return await s.json()}catch(t){s=t;let e="aborterror"===String(t?.name||"").toLowerCase();if(r<o&&e){await new Promise(e=>setTimeout(e,350*(r+1)));continue}if(r<o&&String(t?.message||"").startsWith("http_5")){await new Promise(e=>setTimeout(e,350*(r+1)));continue}break}throw s instanceof Error?s:Error("fetch_failed")}},7153:(e,t)=>{var r;Object.defineProperty(t,"x",{enumerable:!0,get:function(){return r}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(r||(r={}))},1802:(e,t,r)=>{e.exports=r(145)}};var t=require("../../webpack-api-runtime.js");t.C(e);var r=t(t.s=8846);module.exports=r})();