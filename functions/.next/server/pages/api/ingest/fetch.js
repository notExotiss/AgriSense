"use strict";(()=>{var e={};e.id=511,e.ids=[511],e.modules={145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},1253:e=>{e.exports=require("pngjs")},1593:e=>{e.exports=import("geotiff")},5758:(e,t,a)=>{a.a(e,async(e,r)=>{try{a.r(t),a.d(t,{config:()=>d,default:()=>c,routeModule:()=>u});var i=a(1802),s=a(7153),n=a(6249),o=a(5723),l=e([o]);o=(l.then?(await l)():l)[0];let c=(0,n.l)(o,"default"),d=(0,n.l)(o,"config"),u=new i.PagesAPIRouteModule({definition:{kind:s.x.PAGES_API,page:"/api/ingest/fetch",pathname:"/api/ingest/fetch",bundlePath:"",filename:""},userland:o});r()}catch(e){r(e)}})},5723:(e,t,a)=>{a.a(e,async(e,r)=>{try{a.r(t),a.d(t,{default:()=>l});var i=a(468),s=e([i]);async function n(e){try{let t=await fetch(`https://planetarycomputer.microsoft.com/api/sas/v1/sign?href=${encodeURIComponent(e)}`);if(!t.ok)return e;let a=await t.json();return a?.href||a?.signedHref||e}catch{return e}}async function o(e){let{bbox:t,date:a}=e.body||{},r=await fetch("https://planetarycomputer.microsoft.com/api/stac/v1/search",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({bbox:t,datetime:a,collections:["sentinel-2-l2a"],limit:1,sortby:[{field:"eo:cloud_cover",direction:"asc"}]})});if(!r.ok)throw Error(`legacy_stac_failed_${r.status}`);let i=await r.json(),s=i.features?.[0];if(!s)throw Error("legacy_no_scene");let o=await n(s.assets?.B04?.href),l=await n(s.assets?.B08?.href);return{success:!0,data:{provider:"planetary-computer-preview",fallbackUsed:!1,imagery:{id:s.id,date:s.properties?.datetime||null,cloudCover:s.properties?.["eo:cloud_cover"]??null,platform:s.properties?.platform??null},bbox:t,ndvi:{previewPng:null,width:null,height:null,stats:{min:0,max:0,mean:0,p10:0,p90:0},validPixelRatio:0,grid3x3:[]},assets:{b04:o,b08:l}},warnings:["Legacy ingest mode enabled: run manual client-side NDVI processing."]}}async function l(e,t){if("POST"!==e.method)return t.status(405).end();try{if("false"===process.env.USE_NEW_INGEST_PIPELINE){let a=await o(e);return t.status(200).json(a)}let{bbox:a,date:r,targetSize:s,policy:n}=e.body||{},{result:l,warnings:c}=await (0,i.J)({bbox:a,date:r,targetSize:s,policy:n});return t.status(200).json({success:!0,data:l,warnings:c})}catch(r){let e=(0,i.i)(r),a="bbox_required"===e.error?400:"all_providers_failed"===e.error?502:500;return t.status(a).json(e)}}i=(s.then?(await s)():s)[0],r()}catch(e){r(e)}})}};var t=require("../../../webpack-api-runtime.js");t.C(e);var a=e=>t(t.s=e),r=t.X(0,[121],()=>a(5758));module.exports=r})();