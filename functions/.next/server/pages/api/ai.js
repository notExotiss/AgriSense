"use strict";(()=>{var e={};e.id=41,e.ids=[41],e.modules={2509:e=>{e.exports=require("firebase-admin")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},1253:e=>{e.exports=require("pngjs")},6113:e=>{e.exports=require("crypto")},1091:(e,t,a)=>{a.r(t),a.d(t,{config:()=>c,default:()=>o,routeModule:()=>u});var n={};a.r(n),a.d(n,{default:()=>d});var i=a(1802),r=a(7153),s=a(6249),l=a(4917);async function d(e,t){if("POST"!==e.method)return t.status(405).end();try{let a=e.body||{},n=String(a?.prompt||"").trim(),i=await (0,l.d7)({prompt:n||"Provide a farm health summary.",ndviData:a?.ndviData,weatherData:a?.weatherData,soilData:a?.soilData,etData:a?.etData,timeSeriesData:a?.timeSeriesData,context:a?.context,objective:a?.objective||"balanced",mode:a?.mode,selectedCell:a?.selectedCell||a?.context?.selectedCell||null,providersTried:a?.providersTried,history:Array.isArray(a?.history)?a.history.slice(-8).map(e=>({role:e?.role==="assistant"?"assistant":"user",text:String(e?.text||"").slice(0,400)})):[]});if(!i.chat){let e=Number(i.llmUnavailable?.retryAfterMs||0)||8e3,n=`Gemini is temporarily unavailable for this request. Retry in about ${Math.max(1,Math.round(e/1e3))}s.`;return t.status(200).json({answer:n,sections:{rationale:"The assistant backend did not return a usable model response.",actions:["Retry shortly.","Check Gemini model availability if this persists."]},output:n,assistantBackend:"unavailable",unavailable:!0,retryAfterMs:e,llmAttemptedModels:i.llmUnavailable?.attemptedModels||[],llmFinalModel:null,llmRetries:Number(i.llmUnavailable?.retries||0),llmDegraded:!0,engine:i.inference.engine,confidence:i.inference.confidence,dataQuality:i.inference.dataQuality,inference:i.inference,mode:a?.mode||"status",evidence:[],tasks:[],selectedCell:a?.selectedCell||a?.context?.selectedCell||null,scenarioUsed:!1,confidenceBreakdown:{model:i.inference.confidence,dataQuality:i.inference.dataQuality?.score}})}return t.status(200).json({answer:i.chat.answer,sections:i.chat.sections,output:i.chat.text,assistantBackend:i.chat.backend||"llm-gemini",engine:i.inference.engine,confidence:i.inference.confidence,dataQuality:i.inference.dataQuality,inference:i.inference,mode:i.chat.mode,evidence:i.chat.evidence,tasks:i.chat.tasks,selectedCell:a?.selectedCell||a?.context?.selectedCell||null,scenarioUsed:!1,confidenceBreakdown:{model:i.inference.confidence,dataQuality:i.inference.dataQuality?.score}})}catch(n){let e=String(n?.message||"Unexpected inference error"),a="Gemini is temporarily unavailable for this request. Please retry shortly.";return t.status(200).json({answer:a,output:a,assistantBackend:"unavailable",unavailable:!0,retryAfterMs:8e3,engine:"agrisense-ml-engine",confidence:0,dataQuality:{completeness:0,providerQuality:0,score:0,isSimulatedInputs:!0,warnings:[e]},degraded:!0,warnings:[e]})}}let o=(0,s.l)(n,"default"),c=(0,s.l)(n,"config"),u=new i.PagesAPIRouteModule({definition:{kind:r.x.PAGES_API,page:"/api/ai",pathname:"/api/ai",bundlePath:"",filename:""},userland:n})}};var t=require("../../webpack-api-runtime.js");t.C(e);var a=e=>t(t.s=e),n=t.X(0,[281],()=>a(1091));module.exports=n})();