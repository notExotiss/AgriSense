"use strict";exports.id=281,exports.ids=[281],exports.modules={6249:(e,t)=>{Object.defineProperty(t,"l",{enumerable:!0,get:function(){return function e(t,n){return n in t?t[n]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,n)):"function"==typeof t&&"default"===n?t:void 0}}})},535:(e,t,n)=>{n.d(t,{D:()=>d,_:()=>c});var i=n(2509),r=n.n(i);class a extends Error{constructor(e,t){super(e),this.name="FirebaseAdminConfigError",this.code="firebase_admin_misconfigured",this.hint=t}}let s="idle",o=null;function l(){if("ready"!==s){if("failed"===s&&o)throw o;try{if(!r().apps.length){let e=process.env.FIREBASE_SERVICE_ACCOUNT_JSON;if(e){let t=function(e){let t;try{t=JSON.parse(e)}catch{throw new a("FIREBASE_SERVICE_ACCOUNT_JSON is not valid JSON.","Use a single-line JSON string from your Firebase service account key.")}if(!t||"object"!=typeof t)throw new a("FIREBASE_SERVICE_ACCOUNT_JSON is missing or invalid.","Set FIREBASE_SERVICE_ACCOUNT_JSON to the full service account JSON.");let n=String(t.private_key||"").replace(/\\n/g,"\n").trim();if(!(n.startsWith("-----BEGIN PRIVATE KEY-----")&&n.endsWith("-----END PRIVATE KEY-----")))throw new a("Firebase private key is not in valid PEM format.","Ensure private_key contains BEGIN/END markers and escaped newlines (\\\\n) in .env.");return{...t,private_key:n}}(e);r().initializeApp({credential:r().credential.cert(t),projectId:t.project_id||process.env.NEXT_PUBLIC_FIREBASE_PROJECT_ID})}else r().initializeApp()}s="ready",o=null}catch(e){throw s="failed",o=function(e){if(e instanceof a)return e;let t=String(e?.message||e||"Unknown Firebase Admin error"),n=t.toLowerCase();return n.includes("pem")||n.includes("private key")||n.includes("credential")?new a(t,"Rotate and re-add FIREBASE_SERVICE_ACCOUNT_JSON. Ensure private_key newline escaping is correct."):e instanceof Error?e:Error(t)}(e)}}}function c(){return l(),r().firestore()}function d(){return l(),r().auth()}},4917:(e,t,n)=>{n.d(t,{d7:()=>B,Cb:()=>W,ge:()=>J});var i=n(6113);function r(e){if(!e.length)return 0;let t=[...e].sort((e,t)=>e-t),n=Math.floor(t.length/2);return t.length%2?t[n]:(t[n-1]+t[n])/2}let a={irrigation:["irrigation","water","moisture","drip","schedule","soil","stress","evapotranspiration","et"],stress:["stress","ndvi","decline","canopy","health","yellow","wilt","anomaly","hotspot"],fertility:["fertility","nutrient","nitrogen","phosphorus","potassium","soil test","deficiency"],"disease-risk":["disease","fungal","blight","humidity","outbreak","pest","leaf spot"],forecast:["forecast","next week","next month","trend","predict","projection","outlook"],actions:["what should i do","next step","plan","action","recommendation","task list"],"what-if":["what if","simulate","scenario","tradeoff","water budget","yield target"],general:["overview","summary","status","field"]};function s(e,t){let n=function(e){let t={};for(let n of e)t[n]=(t[n]||0)+1;let n=e.length||1;return Object.keys(t).forEach(e=>{t[e]=t[e]/n}),t}(e),i={};return Object.keys(n).forEach(e=>{i[e]=n[e]*(t[e]||0)}),i}function o(e){let t=e.toLowerCase().replace(/[^a-z0-9\s-]/g," ").split(/\s+/).filter(Boolean);if(!t.length)return{intent:"general",confidence:.3};let n=Object.values(a).map(e=>e);n.push(t);let i=function(e){let t={};for(let n of e)new Set(n).forEach(e=>{t[e]=(t[e]||0)+1});let n=e.length,i={};return Object.keys(t).forEach(e=>{i[e]=Math.log((n+1)/((t[e]||0)+1))+1}),i}(n),r=s(t,i),o="general",l=0;return Object.keys(a).forEach(t=>{let n=function(e,t){let n=new Set([...Object.keys(e),...Object.keys(t)]),i=0,r=0,a=0;n.forEach(n=>{let s=e[n]||0,o=t[n]||0;i+=s*o,r+=s*s,a+=o*o});let s=Math.sqrt(r)*Math.sqrt(a);return s?i/s:0}(r,s(a[t],i)),c=e.toLowerCase();"what-if"===t&&(c.includes("what if")||c.includes("simulate")||c.includes("scenario"))&&(n+=.22),"actions"===t&&(c.includes("what should i do")||c.includes("next actions"))&&(n+=.2),"irrigation"===t&&(c.includes("water")||c.includes("irrigation"))&&(n+=.12),n>l&&(l=n,o=t)}),{intent:o,confidence:Number(Math.max(.2,Math.min(.99,l)).toFixed(3))}}function l(e){return`${Math.round(100*e)}%`}function c(e){return[`NDVI mean ${e.featureVector.ndviMean}`,`7-day delta ${e.featureVector.ndviDelta7}`,`30-day delta ${e.featureVector.ndviDelta30}`,`Risk 7d ${l(e.forecast.risk7d)}`,`Anomaly ${l(e.anomaly.score)}`,`Confidence ${l(e.confidence)}`]}function d(e){let t=e.match(/\bp\s*([1-9])\b/i);if(t){let e=Number(t[1])-1;return`${Math.floor(e/3)}-${e%3}`}let n=e.match(/\b([0-2])\s*[-,:]\s*([0-2])\b/);return n?`${n[1]}-${n[2]}`:null}function u(e){return e.dataQuality.completeness<.65?"Data coverage is partial, so recommendations are intentionally conservative.":"Data coverage is strong enough for tactical field decisions."}function m(e){let t=e.recommendations[0];return(t?.actions||[]).slice(0,3)}function h(e){let t=[e.answer];return e.sections?.rationale&&t.push(`Why: ${e.sections.rationale}`),e.sections?.actions?.length&&t.push(`Actions:
${e.sections.actions.map((e,t)=>`${t+1}. ${e}`).join("\n")}`),e.sections?.forecast&&t.push(`Forecast: ${e.sections.forecast}`),t.push(`Data note: ${e.dataNote}`),t.push(`Evidence:
- ${e.evidence.join("\n- ")}`),t.join("\n\n")}function f(e,t,n){return Math.max(t,Math.min(n,e))}function p(e,t=4){let n=Math.pow(10,t);return Math.round(e*n)/n}function g(e){return e.length?e.reduce((e,t)=>e+t,0)/e.length:0}function y(e){if(e.length<2)return 0;let t=e.length,n=(t-1)/2,i=g(e),r=0,a=0;for(let s=0;s<t;s++)r+=(s-n)*(e[s]-i),a+=Math.pow(s-n,2);return a?r/a:0}function v(e){return e.length?e.reduce((e,t)=>e+t,0)/e.length:0}function w(e,t){return e.length?v(e.slice(Math.max(0,e.length-t))):0}function x(e,t,n){return Math.max(t,Math.min(n,e))}function M(e,t=4){let n=Math.pow(10,t);return Math.round(e*n)/n}function S(e,t){let n=x((.2-t.soilMoistureMean)*2.4,0,1),i=x((t.temperature-30)/12,0,1),r=x((t.etMean-5.5)/5,0,1),a=x((.42-e)*1.8,0,1);return x(.45*a+.25*n+.2*i+.1*r,0,1)}var b=n(1253);function A(e,t,n){return Math.max(t,Math.min(n,e))}let k=["https://generativelanguage.googleapis.com/v1beta/models","https://generativelanguage.googleapis.com/v1/models"],I=["gemini-2.0-flash","gemini-2.0-flash-lite","gemini-1.5-flash","gemini-1.5-pro"];class N extends Error{constructor(e,t){super(e),this.name="GeminiUnavailableError",this.attemptedModels=t.attemptedModels,this.retries=t.retries,this.retryAfterMs=t.retryAfterMs,this.lastFailure=t.lastFailure}}function $(e){return"irrigation-plan"===e||"stress-debug"===e||"forecast"===e||"next-actions"===e||"what-if-explainer"===e||"status"===e?e:"status"}function _(e){let t=e.trim();if(!t)return null;try{return JSON.parse(t)}catch{let e=t.match(/```(?:json)?\s*([\s\S]*?)```/i);if(!e?.[1])return null;try{return JSON.parse(e[1].trim())}catch{return null}}}async function D(e,t,n){let i=new AbortController,r=setTimeout(()=>i.abort(),n);try{return await fetch(e,{...t,signal:i.signal})}finally{clearTimeout(r)}}async function E(e,t,n){let i=null;for(let r of k){let a=`${r}/${encodeURIComponent(t)}:generateContent?key=${encodeURIComponent(e)}`,s=await D(a,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)},25e3);if(404===s.status){i=s;continue}return s}return i}async function C(e){let t=[];for(let n of k)try{let i=`${n}?key=${encodeURIComponent(e)}`,r=await D(i,{method:"GET"},8e3);if(!r.ok)continue;let a=await r.json().catch(()=>null);for(let e of Array.isArray(a?.models)?a.models:[]){if(!(Array.isArray(e?.supportedGenerationMethods)?e.supportedGenerationMethods:[]).some(e=>"generatecontent"===String(e).toLowerCase()))continue;let n=String(e?.name||"").replace(/^models\//i,"").trim();n&&t.push(n)}}catch{}return Array.from(new Set(t))}async function P(e){var t,n,i,r;let a;let s=process.env.GEMINI_API_KEY||process.env.AGRISENSE_GEMINI_API_KEY||process.env.GOOGLE_API_KEY||process.env.NEXT_PUBLIC_GEMINI_API_KEY;if(!s)throw new N("gemini_api_key_missing",{attemptedModels:[],retries:0,lastFailure:"gemini_key_missing"});let l=o(e.prompt||""),c=Array.isArray(t=e.history)?t.slice(-10).map(e=>({role:"assistant"===e.role?"model":"user",text:String(e.text||"").slice(0,600)})).filter(e=>!!e.text):[],d=$(e.mode),u=function(e){let t=e.inference,n=Array.isArray(e.context?.grid3x3)?e.context.grid3x3.slice(0,9):[],i=e.selectedCell||e.context?.selectedCell||null,r=i?n.find(e=>String(e?.cellId||"")===String(i)):null;return{objective:e.objective||t.objective||"balanced",mode:$(e.mode),selectedCell:i,selectedCellData:r||null,inference:{summary:t.summary,confidence:t.confidence,dataQuality:t.dataQuality,forecast:t.forecast,anomaly:t.anomaly,featureVector:t.featureVector,recommendations:(t.recommendations||[]).slice(0,4).map(e=>({title:e.title,priority:e.priority,reason:e.reason,actions:(e.actions||[]).slice(0,4),expectedImpact:e.expectedImpact,confidence:e.confidence,timeWindow:e.timeWindow})),tasks:(t.tasks||[]).slice(0,5)},observed:{ndviStats:e.context?.ndviStats||null,soilStats:e.context?.soilStats||null,etStats:e.context?.etStats||null,weather:e.context?.weather||null,timeSeriesSummary:e.context?.timeSeries?.summary||null,grid3x3:n},providerDiagnostics:{providersTried:Array.isArray(e.context?.providersTried)?e.context.providersTried.slice(0,12):[],warnings:[...Array.isArray(e.context?.warnings)?e.context.warnings.slice(0,12):[],...Array.isArray(t?.warnings)?t.warnings.slice(0,12):[]]}}}(e),m=[],h=0,f=null,p="gemini_failed",g=[{role:"user",parts:[{text:`System rules:
You are AgriSense AI Assistant for farm operations. Answer the user question first in plain language, then provide rationale, actions, and forecast when relevant. Use only provided context and metrics. Never invent unavailable values. If the question references missing context, say exactly what is missing and ask one concise clarifying question. Do not return markdown code fences or raw JSON objects in the answer. Return strict JSON only with keys: answer, rationale, actions, forecast, mode. actions must be an array of 0-5 concise action strings. mode must be one of: status, irrigation-plan, stress-debug, forecast, next-actions, what-if-explainer.`}]},...c.map(e=>({role:e.role,parts:[{text:e.text}]}))];g.push({role:"user",parts:[{text:JSON.stringify({question:String(e.prompt||"").slice(0,4e3),context:u,outputContract:{answer:"string",rationale:"string",actions:["string"],forecast:"string",mode:"status|irrigation-plan|stress-debug|forecast|next-actions|what-if-explainer"}})}]});let y={contents:g,generationConfig:{temperature:.25,topP:.9,maxOutputTokens:720}},v=function(){let e=e=>String(e||"").trim().replace(/^models\//i,"").replace(/:generateContent$/i,""),t=[e(process.env.GEMINI_MODEL||process.env.AGRISENSE_LLM_MODEL||"gemini-2.5-flash"),...String(process.env.GEMINI_FALLBACK_MODELS||"").split(",").map(t=>e(t)).filter(Boolean),...I.map(t=>e(t))],n=[];for(let e of t)n.includes(e)||n.push(e);return n}(),w=await C(s),x=new Set(w),M=x.size>0?v.filter(e=>x.has(e)):v;for(let t of Array.from(new Set([...M,...w,...v]))){m.includes(t)||m.push(t);for(let o=0;o<=2;o++){let u;try{u=await E(s,t,y)}catch(e){if(p=String(e?.message||"gemini_network_error"),o<2){h+=1,await new Promise(e=>setTimeout(e,350*(o+1)));continue}break}if(!u.ok){let e=function(e){let t={message:e.slice(0,260),status:"UNKNOWN"};try{let n=JSON.parse(e),i=n?.error;return{message:String(i?.message||t.message),status:String(i?.status||t.status)}}catch{return t}}(await u.text().catch(()=>"")),t=e.message.toLowerCase(),i=t.includes("reported as leaked")||t.includes("api key")&&t.includes("leaked"),r=t.includes("api key not valid")||t.includes("invalid api key"),s=t.includes("permission denied")||t.includes("not authorized");p=i?"gemini_key_leaked":r?"gemini_key_invalid":s?`gemini_permission_denied:${e.status}`:`gemini_http_${u.status}:${e.status}:${e.message.slice(0,180)}`;let l=u.headers.get("retry-after");if(l){let e=Number(l);Number.isFinite(e)&&e>0&&(a=Math.max(a||0,Math.round(1e3*e)))}if((429===(n=u.status)||500===n||502===n||503===n||504===n)&&o<2){h+=1,await new Promise(e=>setTimeout(e,420*(o+1)));continue}break}let g=await u.json().catch(()=>null),v=String(g?.promptFeedback?.blockReason||"").trim();if(v){p=`gemini_prompt_blocked:${v}`;break}let w=function(e){let t=Array.isArray(e?.candidates)?e.candidates:[],n=[];for(let e of t)for(let t of Array.isArray(e?.content?.parts)?e.content.parts:[])"string"==typeof t?.text&&t.text.trim()&&n.push(t.text.trim());return n.join("\n").trim()}(g);if(!w){if(p="gemini_empty_response",o<2){h+=1,await new Promise(e=>setTimeout(e,280*(o+1)));continue}break}let x=_(w),M=function(e){let t=String(e||"").trim();if(!t)return"";let n=t.match(/```(?:json)?\s*([\s\S]*?)```/i);if(n?.[1]&&(t=n[1].trim()),t.startsWith("{")&&t.endsWith("}")||t.startsWith("[")&&t.endsWith("]")){let e=_(t);if(e&&"object"==typeof e){let n=e.answer||e.response||e.text,i="object"==typeof e.data?e.data?.answer||e.data?.text:"",r=String(n||i||"").trim();r&&(t=r)}}if(!t||t.startsWith("{")||t.startsWith("[")){let e=t.match(/"answer"\s*:\s*"([\s\S]*?)"/i);e?.[1]&&(t=(function(e){try{return JSON.parse(`"${e.replace(/\\/g,"\\\\").replace(/"/g,'\\"')}"`)}catch{return e}})(e[1]).replace(/\\n/g,"\n").trim())}return t.replace(/^["'`{[]+/,"").replace(/["'`\]}]+$/,"").replace(/\s+/g," ").trim()}(x?.answer||w);if(!M){if(p="gemini_missing_answer",o<2){h+=1,await new Promise(e=>setTimeout(e,280*(o+1)));continue}break}f=t;let S=String(x?.rationale||"").trim()||void 0,b=String(x?.forecast||"").trim()||void 0,A=Array.isArray(i=x?.actions)?i.map(e=>String(e||"").trim()).filter(Boolean).slice(0,5):[],k=$(x?.mode||d),I=(r=e.inference,[`NDVI mean ${r.featureVector.ndviMean}`,`7-day delta ${r.featureVector.ndviDelta7}`,`30-day delta ${r.featureVector.ndviDelta30}`,`Risk 7d ${Math.round(100*r.forecast.risk7d)}%`,`Anomaly ${Math.round(100*r.anomaly.score)}%`,`Confidence ${Math.round(100*r.confidence)}%`]).slice(0,6);return{backend:"llm-gemini",mode:k,renderModel:"what-if-explainer"===k?"what-if":"status"===k?"status":"qa",intent:l.intent,intentConfidence:l.confidence,usedHistory:c.length>0,answer:M,sections:{rationale:S,actions:A,forecast:b},evidence:I,tasks:e.inference.tasks.slice(0,5),text:function(e,t,n,i,r){let a=[e];return t&&a.push(`Why: ${t}`),n?.length&&a.push(`Actions:
${n.map((e,t)=>`${t+1}. ${e}`).join("\n")}`),i&&a.push(`Forecast: ${i}`),r?.length&&a.push(`Evidence:
- ${r.join("\n- ")}`),a.join("\n\n")}(M,S,A,b,I),llmAttemptedModels:m,llmFinalModel:f,llmRetries:h,llmDegraded:h>0||m.length>1}}}throw new N("gemini_all_models_failed",{attemptedModels:m,retries:h,retryAfterMs:a,lastFailure:p})}var O=n(535);let F="agrisense-ml-v1";async function V(){try{let e=(0,O._)();await e.collection("ml_models").doc(F).set({version:F,updatedAt:new Date().toISOString(),objectiveDefault:"balanced"},{merge:!0})}catch{}}async function j(e){try{let t=(0,O._)();await t.collection("ml_feedback").doc(e.eventId).set({plotId:e.plotId||null,feedback:e.feedback||"neutral",createdAt:new Date().toISOString(),engine:e.result.engine,objective:e.result.objective,confidence:e.result.confidence,dataQuality:e.result.dataQuality,anomaly:e.result.anomaly})}catch{}}function T(e,t,n){return Math.max(t,Math.min(n,e))}function R(e){return e>.72?"high":e>.45?"medium":"low"}function L(e,t){let n="yield"===t?{ndvi:1,water:.58,heat:.52,volatility:.42,momentum:.35}:"water"===t?{ndvi:.72,water:1.08,heat:.44,volatility:.36,momentum:.32}:{ndvi:.88,water:.88,heat:.5,volatility:.4,momentum:.34},i=T((.44-e.ndviMean)*3.2,0,1),r=T(.9*e.moistureDeficitIndex+(.22-e.soilMoistureMean)*2.6,0,1),a=T(.8*e.weatherStressIndex+(e.temperature-30)/12,0,1),s=T((e.ndviVolatility-.1)*5,0,1),o=T(-(2.2*e.ndviDelta7)+-(1.6*e.trendAcceleration),0,1);return T(1/(1+Math.exp(-(i*n.ndvi+r*n.water+a*n.heat+s*n.volatility+o*n.momentum-1.26))),0,1)}function G(e,t,n){return Math.max(t,Math.min(n,e))}function U(e,t=4){let n=Math.pow(10,t);return Math.round(e*n)/n}async function W(e){var t;let n="yield"===(t=e.objective)||"water"===t||"balanced"===t?t:"balanced",a=function(e){let t=e?.ndviData?.stats||e?.context?.ndviStats||{},n=function(e){let t=Array.isArray(e?.context?.timeSeries?.timeSeries)?e.context.timeSeries.timeSeries:Array.isArray(e?.context?.timeSeries?.points)?e.context.timeSeries.points:null;return((Array.isArray(e?.timeSeriesData?.timeSeries)?e.timeSeriesData.timeSeries:Array.isArray(e?.timeSeriesData?.points)?e.timeSeriesData.points:null)||t||[]).map(e=>Number(e?.ndvi)).filter(e=>Number.isFinite(e))}(e),i=String(e?.selectedCell||e?.context?.selectedCell||""),r=(Array.isArray(e?.context?.grid3x3)?e.context.grid3x3:[]).find(e=>String(e?.cellId)===i),a=Number(t?.mean??n[n.length-1]??.45),s=Number.isFinite(Number(r?.mean))?.7*a+.3*Number(r.mean):a,o=Number(t?.min??Math.max(-.2,s-.2)),l=Number(t?.max??Math.min(.95,s+.2)),c=function(e){if(e.length<2)return 0;let t=g(e);return Math.sqrt(e.reduce((e,n)=>e+Math.pow(n-t,2),0)/e.length)}(n),d=y(n.length?n:[s,s]),u=n.length>=7?w(n,3)-v(n.slice(Math.max(0,n.length-10),Math.max(0,n.length-7))):0,m=n.length>=30?w(n,6)-v(n.slice(Math.max(0,n.length-36),Math.max(0,n.length-30))):1.8*u,h=n.length>=8?y(n.slice(-4))-y(n.slice(Math.max(0,n.length-8),Math.max(0,n.length-4))):0,x=n.length>=4?p(g(n.slice(-3))-g(n.slice(-6,-3).length?n.slice(-6,-3):n.slice(-3))):0,M=e?.weatherData?.current||e?.weatherData?.weather||e?.context?.weather?.current||{},S=Number(M?.temperature??M?.temperature_2m??24),b=Number(M?.humidity??M?.relative_humidity_2m??55),A=Number(M?.precipitation??e?.weatherData?.current?.precipitation??1.2),k=e?.soilData?.stats||e?.context?.soilStats||{},I=e?.etData?.stats||e?.context?.etStats||{},N=Number(k?.mean??.24),$=Number(I?.mean??3.4),_=f((.28-N)*3.2+($-4.1)*.08,0,1),D=f((S-30)*.05+(b>84?.2:0)+.015*A,0,1),E=f(Number(e?.context?.dataLatencyHours||0)/96,0,1);return{ndviMin:p(o),ndviMax:p(l),ndviMean:p(s),ndviSpread:p(Math.max(0,l-o)),ndviDelta7:p(u),ndviDelta30:p(m),ndviTrendSlope:p(d),trendAcceleration:p(h),ndviVolatility:p(c),soilMoistureMean:p(N),moistureDeficitIndex:p(_),etMean:p($),weatherStressIndex:p(D),temperature:p(S),precipitation:p(A),humidity:p(b),seasonalIndex:p(.5+.5*Math.sin(new Date().getUTCMonth()/12*Math.PI*2-Math.PI/2)),shortTermMomentum:p(x),dataLatencyPenalty:p(E)}}(e),s=function(e){let t=[!!(e?.ndviData?.stats||e?.context?.ndviStats),!!(e?.timeSeriesData?.timeSeries||e?.timeSeriesData?.points||e?.context?.timeSeries),!!(e?.weatherData||e?.context?.weather),!!(e?.soilData||e?.context?.soilStats),!!(e?.etData||e?.context?.etStats)],n=t.filter(Boolean).length/t.length,i=Array.isArray(e?.providersTried)?e.providersTried:[],r=i.filter(e=>e.ok).length,a=i.length?r/i.length:.75,s=[];n<.7&&s.push("Limited input coverage; recommendations are conservative."),a<.6&&s.push("One or more upstream providers reported degraded reliability.");let o=[e?.weatherData?.isSimulated,e?.soilData?.isSimulated,e?.etData?.isSimulated,e?.timeSeriesData?.isSimulated,e?.context?.weather?.isSimulated,e?.context?.timeSeries?.isSimulated].filter(Boolean).length>0;o&&s.push("Some inputs are simulated due to provider outages.");let l=f(.65*n+.35*a-(o?.12:0),0,1);return{completeness:p(n),providerQuality:p(a),score:p(l),isSimulatedInputs:o,warnings:s}}(e),o=function(e,t){let n=function(e,t){let n=e?.timeSeriesData?.timeSeries||e?.context?.timeSeries?.timeSeries||e?.context?.timeSeries||[],i=Array.isArray(n)?n.map(e=>Number(e?.ndvi)).filter(e=>Number.isFinite(e)):[];return i.length?i:[t,t,t,t]}(e,t.ndviMean),i=n.length>=24?12:n.length>=14?7:4,r=function(e,t,n){let i=Math.max(2,Math.min(n,Math.floor(e.length/2))),r=e[0],a=e.length>1?e[1]-e[0]:0,s=Array(i).fill(0);for(let t=0;t<i&&t<e.length;t++)s[t]=e[t]-r;for(let t=0;t<e.length;t++){let n=e[t],o=s[t%i],l=r;a=.25*((r=.45*(n-o)+.55*(r+a))-l)+.75*a,s[t%i]=.2*(n-r)+.8*o}let o=[];for(let t=1;t<=30;t++){let n=s[(e.length+t-1)%i];o.push(r+a*t+n)}return o}(n,0,i),a=r.slice(0,7),s=x(a.reduce((e,t)=>e+t,0)/Math.max(a.length,1),-.3,.95),o=x(r.reduce((e,t)=>e+t,0)/Math.max(r.length,1),-.3,.95);return{ndvi7d:M(s),ndvi30d:M(o),risk7d:M(S(s,t)),risk30d:M(S(o,t)),trend:function(e){if(e.length<3)return"stable";let t=e.slice(0,Math.floor(e.length/2)),n=e.slice(Math.floor(e.length/2)),i=t.reduce((e,t)=>e+t,0)/t.length,r=n.reduce((e,t)=>e+t,0)/n.length-i;return r>.04?"improving":r<-.04?"declining":"stable"}(n)}}(e,a),l=function(e,t){let n=function(e,t){let n=e?.timeSeriesData?.timeSeries||e?.context?.timeSeries?.timeSeries||e?.context?.timeSeries||[],i=Array.isArray(n)?n.map(e=>Number(e?.ndvi)).filter(e=>Number.isFinite(e)):[];return i.length?i:[t,t]}(e,t.ndviMean),i=r(n),a=r(n.map(e=>Math.abs(e-i)))||1e-6,s=(n[n.length-1]-i)/a*.6745,o=Math.max(0,-(2.8*function(e,t=.3){if(!e.length)return 0;let n=e[0];for(let i=1;i<e.length;i++)n=t*e[i]+(1-t)*n;return n}(n.slice(1).map((e,t)=>e-n[t])))),l=2.4*Math.max(0,t.ndviVolatility-.09),c=t.humidity>84?.12:0,d=Math.max(0,Math.min(1,.35*Math.abs(s)+.35*o+l+c)),u=[];return Math.abs(s)>1.6&&u.push("Current NDVI deviates strongly from recent median."),o>.2&&u.push("Short-term NDVI momentum is negative."),l>.14&&u.push("NDVI variance is elevated versus typical baseline."),c>0&&u.push("High humidity can elevate disease pressure."),u.length||u.push("No major anomaly signal detected."),{score:Number(d.toFixed(4)),level:d>.66?"high":d>.38?"moderate":"low",signals:u}}(e,a),c={k:3,clusters:function(e,t){let n=e?.ndviData?.previewPng||e?.context?.ndvi?.previewPng||e?.context?.ndviPreviewPng||"",i=[];if(n)try{i=function(e,t){let n=Buffer.from(e,"base64"),i=b.PNG.sync.read(n),r=Math.max(1,Math.floor(i.width/24)),a=Math.max(1,Math.floor(i.height/24)),s=[];for(let e=0;e<i.height;e+=a)for(let n=0;n<i.width;n+=r){let r=(e*i.width+n)*4,a=i.data[r],o=i.data[r+1],l=(.2126*a+.7152*o+.0722*i.data[r+2])/255;s.push([A(l,0,1),n/Math.max(1,i.width-1),e/Math.max(1,i.height-1),A(t.soilMoistureMean,0,1),A(t.etMean/10,0,1)])}return s}(n,t)}catch{i=[]}return i.length||(i=function(e){let t=function(e){let t=0;for(let n=0;n<e.length;n++)t=(t<<5)-t+e.charCodeAt(n);return()=>(t^=t<<13,t^=t>>17,Math.abs((t^=t<<5)%1e6)/1e6)}(`${e.ndviMean}:${e.ndviSpread}:${e.soilMoistureMean}:${e.etMean}`),n=[];for(let i=0;i<180;i++){let i=t(),r=t(),a=A(e.ndviMean+(t()-.5)*e.ndviSpread,-.1,.95),s=A(e.soilMoistureMean+(t()-.5)*.1,0,1),o=A(e.etMean/10+(t()-.5)*.15,0,1);n.push([a,i,r,s,o])}return n}(t)),function(e,t=3,n=14){if(!e.length)return[];let i=Math.min(t,e.length),r=e.slice(0,i).map(e=>[...e]),a=Array(e.length).fill(0);for(let t=0;t<n;t++){for(let t=0;t<e.length;t++){let n=0,i=Number.POSITIVE_INFINITY;for(let a=0;a<r.length;a++){let s=function(e,t){let n=0;for(let i=0;i<e.length;i++){let r=(e[i]||0)-(t[i]||0);n+=r*r}return Math.sqrt(n)}(e[t],r[a]);s<i&&(i=s,n=a)}a[t]=n}for(let t=0;t<r.length;t++){let n=e.filter((e,n)=>a[n]===t);if(!n.length)continue;let i=r[t].length,s=Array(i).fill(0);for(let e of n)for(let t=0;t<i;t++)s[t]+=e[t];for(let e=0;e<i;e++)s[e]/=n.length;r[t]=s}}return r.map((e,t)=>({id:t,count:a.filter(e=>e===t).length,centroid:e.map(e=>Number(e.toFixed(4)))}))}(i,3,12)}(e,a)},d=function(e,t,n){let i=[],r=L(e,t);return(e.soilMoistureMean<.2||r>.7)&&i.push({id:"irrigation-tighten",title:"Tighten irrigation scheduling",priority:R(Math.max(r,n)),reason:"Soil moisture trend indicates high water stress probability for the next cycle.",actions:["Apply shorter, higher-frequency irrigation events for the next 72 hours.","Inspect emitter uniformity in low-vigor zones.","Re-check NDVI and soil moisture after two irrigation cycles."],expectedImpact:Number((8+12*r).toFixed(1)),confidence:Number((.62+(1-n)*.2).toFixed(3)),timeWindow:"24-72h",evidence:[`Moisture deficit index ${e.moistureDeficitIndex.toFixed(2)}`,`Objective risk ${Math.round(100*r)}%`]}),(e.ndviSpread>.38||e.ndviVolatility>.12)&&i.push({id:"zone-scouting",title:"Run targeted zone scouting",priority:R(e.ndviSpread),reason:"Canopy variability is elevated, which suggests non-uniform stress drivers.",actions:["Scout low-vigor and transition zones first.","Record pest pressure and irrigation delivery observations.","Sample soil nutrients in two representative low-NDVI patches."],expectedImpact:Number((5+15*e.ndviSpread).toFixed(1)),confidence:Number((.58+(1-e.ndviVolatility)*.22).toFixed(3)),timeWindow:"48h",evidence:[`NDVI spread ${e.ndviSpread.toFixed(2)}`,`NDVI volatility ${e.ndviVolatility.toFixed(2)}`]}),e.humidity>82&&e.temperature>24&&i.push({id:"disease-watch",title:"Increase disease surveillance",priority:R(.63),reason:"Warm and humid conditions can increase disease pressure during canopy stress.",actions:["Inspect for foliar disease symptoms in dense canopy sections.","Prioritize morning scouting to detect early infection signs.","Track humidity trend over the next 3 days before intervention."],expectedImpact:Number((4.5+9*e.weatherStressIndex).toFixed(1)),confidence:Number((.56+(1-n)*.18).toFixed(3)),timeWindow:"48-96h",evidence:[`Humidity ${e.humidity.toFixed(0)}%`,`Weather stress index ${e.weatherStressIndex.toFixed(2)}`]}),i.length||i.push({id:"maintain-baseline",title:"Maintain baseline operations",priority:"low",reason:"Current indicators show stable conditions with manageable risk.",actions:["Continue standard irrigation schedule.","Re-run analysis in 5-7 days for drift detection.","Log field notes to improve future recommendation tuning."],expectedImpact:2.8,confidence:.69,timeWindow:"5-7d",evidence:["Risk profile within baseline thresholds."]}),i.slice(0,4)}(a,n,l.score),u=L(a,n),m=1-Math.min(1,Math.abs(o.risk7d-l.score)),h={engine:F,objective:n,confidence:Number(Math.max(.2,Math.min(.99,.6*s.score+.25*m+(1-u)*.15)).toFixed(4)),dataQuality:s,isSimulatedInputs:s.isSimulatedInputs,featureVector:a,forecast:o,anomaly:l,zones:c,recommendations:d,tasks:d.map((e,t)=>({id:`task-${t+1}-${e.id}`,title:e.title,impact:e.expectedImpact,confidence:e.confidence,timeWindow:e.timeWindow,owner:e.id.includes("irrigation")?"irrigation":e.id.includes("zone")?"scouting":"operations"})),providersTried:Array.isArray(e.providersTried)?e.providersTried:[],warnings:[...s.warnings]},k={...h,summary:function(e){let t=Math.round(100*e.forecast.risk7d),n="improving"===e.forecast.trend?"improving":"declining"===e.forecast.trend?"declining":"stable",i="high"===e.anomaly.level?`NDVI volatility is elevated and anomaly risk is ${Math.round(100*e.anomaly.score)}%.`:`Field trend is ${n} with ${t}% 7-day risk.`;return{whatChanged:i,why:e.anomaly.signals[0]||"Signals across NDVI, weather, and moisture are within expected range.",nextActions:e.recommendations[0]?.title||"Continue baseline monitoring.",recheckIn:"high"===e.anomaly.level?"24-48 hours":"5-7 days"}}(h)};return V(),j({eventId:(0,i.randomUUID)(),result:k}),k}async function B(e){let t=await W(e),n=String(e.prompt||""),i=null,r=null;try{i=await P({prompt:n,mode:e.mode,objective:e.objective,selectedCell:e.selectedCell||e?.context?.selectedCell||null,inference:t,history:e.history,context:e.context})}catch(e){i=null,r=e instanceof N?{message:e.message,attemptedModels:e.attemptedModels,retries:e.retries,retryAfterMs:e.retryAfterMs,lastFailure:e.lastFailure}:{message:String(e?.message||"gemini_unavailable"),attemptedModels:[],retries:0}}return i||(i={...function(e){let t=String(e.prompt||"").trim(),n=o(t),i=e.inference,r=function(e,t){let n=e.toLowerCase();return n.includes("what if")||n.includes("simulate")||n.includes("scenario")?"what-if":n.includes("forecast")||n.includes("next week")||n.includes("next month")||n.includes("outlook")?"forecast":n.includes("anomaly")||n.includes("stress")||n.includes("hotspot")?"stress":n.includes("why")||n.includes("reason")||n.includes("cause")?"why":n.includes("compare")||n.includes("difference")||n.includes("changed")||n.includes("versus")?"compare":n.includes("what should i do")||n.includes("next action")||n.includes("plan")||n.includes("should i")?"action":(t?"what-if-explainer"===t?"what-if":"stress-debug"===t?"stress":"next-actions"===t||"irrigation-plan"===t?"action":"forecast"===t?"forecast":"status":null)||"status"}(t,e.mode),{cellId:a,usedHistory:s}=function(e,t,n){let i=d(e);if(i)return{cellId:i,usedHistory:!1};if(t)return{cellId:t,usedHistory:!1};for(let e of Array.isArray(n)?[...n].reverse():[]){let t=d(e.text||"");if(t)return{cellId:t,usedHistory:!0}}return{cellId:null,usedHistory:!1}}(t,e.selectedCell,e.history);if(function(e){let t=e.toLowerCase();return(t.includes("that cell")||t.includes("this cell")||t.includes("same cell")||t.includes("that zone")||t.includes("this zone")||t.includes("that one")||t.includes("this one"))&&!d(e)}(t)&&!a){let e="I can answer that precisely once you pick a plot point (P1-P9) or mention a specific cell like 1-2.",t=c(i).slice(0,4),r=u(i);return{mode:"status",renderModel:"qa",intent:n.intent,intentConfidence:n.confidence,usedHistory:s,answer:e,sections:{actions:["Select a plot point on the 3x3 grid.","Ask again with that point in scope."]},evidence:t,tasks:i.tasks.slice(0,3),text:h({answer:e,sections:{actions:["Select a plot point on the 3x3 grid.","Ask again with that point in scope."]},evidence:t,dataNote:r})}}let f=function(e,t,n,i){let r=function(e){if(!e||!e.includes("-"))return null;let[t,n]=e.split("-"),i=Number(t),r=Number(n);return Number.isFinite(i)&&Number.isFinite(r)?`P${3*i+r+1}`:null}(n),a=l(t.forecast.risk7d),s=l(t.forecast.risk30d),o=l(t.anomaly.score);if("what-if"===e)return{answer:`Use a small scenario first: irrigation +10% with target risk <= 35%. Then compare NDVI30 and water-use deltas before scaling across the full field${r?`, starting with ${r}`:""}.`,sections:{rationale:`Current baseline risk is ${a} over 7 days with ${t.forecast.trend} trend, so moderate adjustments are safer than large jumps.`,actions:["Run a +10% irrigation scenario.","Compare baseline vs scenario NDVI30 and risk7.","If risk drops without excess water cost, expand to adjacent plot points."],forecast:`Baseline: risk7 ${a}, risk30 ${s}, trend ${t.forecast.trend}.`},renderModel:"what-if",mode:"what-if-explainer"};if("forecast"===e)return{answer:`The near-term outlook is ${t.forecast.trend}. Expected NDVI is ${t.forecast.ndvi7d} in 7 days and ${t.forecast.ndvi30d} in 30 days, with risk at ${a} / ${s}.`,sections:{rationale:`Anomaly signal is ${o}, which indicates ${t.anomaly.level} instability right now.`,actions:m(t),forecast:`Trend: ${t.forecast.trend}; NDVI7: ${t.forecast.ndvi7d}; NDVI30: ${t.forecast.ndvi30d}.`},renderModel:"qa",mode:"forecast"};if("stress"===e||"why"===e){let e=r?` for ${r}`:"";return{answer:`The main stress driver${e} is ${t.anomaly.signals[0]||"a combined NDVI/moisture anomaly"} with anomaly score ${o}.`,sections:{rationale:t.summary.why,actions:m(t),forecast:`Risk over 7 days is ${a}. Re-check window: ${t.summary.recheckIn}.`},renderModel:"qa",mode:"stress-debug"}}if("compare"===e)return{answer:`Compared with the recent baseline, field risk is ${a} over 7 days and the trend is ${t.forecast.trend}. NDVI deltas are ${t.featureVector.ndviDelta7} (7d) and ${t.featureVector.ndviDelta30} (30d).`,sections:{rationale:t.summary.whatChanged,actions:m(t),forecast:`Anomaly: ${o}; confidence: ${l(t.confidence)}.`},renderModel:"qa",mode:"status"};if("action"===e){let e=r?` prioritizing ${r}`:"";return{answer:`Start with targeted scouting and irrigation checks${e}, then re-run analysis after the next intervention cycle.`,sections:{rationale:t.summary.why,actions:m(t),forecast:`Current risk: ${a}; confidence: ${l(t.confidence)}.`},renderModel:"qa",mode:"next-actions"}}return{answer:`Current status: trend is ${t.forecast.trend} with ${a} 7-day risk${r?` at focus ${r}`:""}.`,sections:{rationale:t.summary.whatChanged,actions:m(t),forecast:`Anomaly ${o}; NDVI7 ${t.forecast.ndvi7d}; NDVI30 ${t.forecast.ndvi30d}.`},renderModel:"status",mode:"status"}}(r,i,a,0),p=c(i).slice(0,5),g=u(i);return{mode:f.mode,renderModel:f.renderModel,intent:n.intent,intentConfidence:n.confidence,usedHistory:s,answer:f.answer,sections:f.sections,evidence:p,tasks:i.tasks.slice(0,4),text:h({answer:f.answer,sections:f.sections,evidence:p,dataNote:g})}}({prompt:n,mode:e.mode,selectedCell:e.selectedCell||e?.context?.selectedCell||null,inference:t,history:e.history}),backend:"unavailable",llmAttemptedModels:r?.attemptedModels||[],llmFinalModel:null,llmRetries:Number(r?.retries||0),llmDegraded:!0,unavailable:!0,retryAfterMs:r?.retryAfterMs}),{inference:t,chat:i,llmUnavailable:r}}function J(e,t){return function(e,t){let n=G(Number(t?.irrigationDelta||0),-.35,.6),i=G(Number(t?.waterBudget||.5),0,1),r=G(Number(t?.fertilizerDelta||0),-.2,.3),a=G(Number(t?.targetRisk||.35),.05,.95),s=G(.45*e.moistureDeficitIndex+.25*e.weatherStressIndex+.8*Math.max(0,.42-e.ndviMean),0,1),o=.52*n+.14*i,l=.1*n+.06*r-.02*e.dataLatencyPenalty,c=G(e.ndviMean+e.ndviDelta30+l,-.2,.95),d=G(s-.55*o+.05*Math.max(0,a-.55),.02,.98),u=U(100*n,1),m=U((c-(e.ndviMean+e.ndviDelta30))*65,1),h=d<s?"Scenario reduces near-term risk; use as next irrigation schedule candidate.":"Scenario increases near-term risk; tighten water plan or reduce stress drivers.",f=G(.55+(1-e.dataLatencyPenalty)*.2+(1-.2*Math.abs(n)),.35,.92);return{baselineRisk7d:U(s),scenarioRisk7d:U(d),baselineNdvi30d:U(e.ndviMean+e.ndviDelta30),scenarioNdvi30d:U(c),waterUseDeltaPct:u,yieldProxyDeltaPct:m,recommendation:h,confidence:U(f)}}(e,t)}},7153:(e,t)=>{var n;Object.defineProperty(t,"x",{enumerable:!0,get:function(){return n}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(n||(n={}))},1802:(e,t,n)=>{e.exports=n(145)}};