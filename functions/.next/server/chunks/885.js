"use strict";exports.id=885,exports.ids=[885],exports.modules={2090:(e,t,r)=>{r.d(t,{Z:()=>a});let a=(0,r(1373).Z)("mountain",[["path",{d:"m8 3 4 8 5-5 5 15H2L8 3z",key:"otkl63"}]])},8885:(e,t,r)=>{r.a(e,async(e,a)=>{try{r.r(t),r.d(t,{default:()=>w});var o=r(997),i=r(6689),n=r(2949),l=r(8724),s=r(2090),d=r(6316),u=r(8098),h=e([n,l]);function c(e){if(!e||!e.includes("-"))return null;let[t,r]=e.split("-"),a=Number(t),o=Number(r);return Number.isFinite(a)&&Number.isFinite(o)?{row:a,col:o}:null}function m(e){let t=e.filter(e=>Number.isFinite(e)),r=t.length?Math.min(...t):0,a=t.length?Math.max(...t):1,o=Math.max(1e-6,a-r);return{min:r,max:a,range:o,apply:e=>(e-r)/o}}async function p(e){return await new Promise((t,r)=>{let a=new Image;a.crossOrigin="anonymous",a.onload=()=>t(a),a.onerror=()=>r(Error("metric_texture_load_failed")),a.src=`data:image/png;base64,${e}`})}async function f(e,t,r,a,o){let i=a,l=o,s=new Float32Array(a*o),d=Number.POSITIVE_INFINITY,h=Number.NEGATIVE_INFINITY;if(t&&Array.isArray(t.values)&&t.width>0&&t.height>0&&t.values.length>=t.width*t.height){i=t.width,l=t.height,s=new Float32Array(i*l);for(let e=0;e<i*l;e++){let r=Number(t.values[e]),a=Number.isFinite(r)?r:0;s[e]=a,d=Math.min(d,a),h=Math.max(h,a)}}else if(e){let t=await p(e),r=document.createElement("canvas");r.width=a,r.height=o;let i=r.getContext("2d");if(!i)throw Error("metric_texture_context_failed");i.drawImage(t,0,0,a,o);let n=i.getImageData(0,0,a,o).data;s=new Float32Array(a*o);for(let e=0;e<a*o;e++){let t=4*e;if(n[t+3]<5){s[e]=0;continue}let r=(.2126*n[t]+.7152*n[t+1]+.0722*n[t+2])/255;s[e]=r,d=Math.min(d,r),h=Math.max(h,r)}}else throw Error("metric_texture_missing");Number.isFinite(d)&&Number.isFinite(h)||(t&&Number.isFinite(t.min)&&Number.isFinite(t.max)&&t.max>t.min?(d=t.min,h=t.max):(d=0,h=1));let c=Math.max(1e-6,h-d),m=(e,t)=>{let r=(0,u.uZ)(e,0,i-1),a=(0,u.uZ)(t,0,l-1),o=Math.floor(r),n=Math.floor(a),d=Math.min(i-1,o+1),h=Math.min(l-1,n+1),c=r-o,m=n*i+o,p=n*i+d,f=h*i+o,g=h*i+d,x=(0,u.t7)(s[m],s[p],c),w=(0,u.t7)(s[f],s[g],c);return(0,u.t7)(x,w,a-n)},f=(e,t)=>{let r=e/Math.max(1,a-1)*(i-1),n=t/Math.max(1,o-1)*(l-1);return(m(r,n)-d)/c},g=document.createElement("canvas");g.width=a,g.height=o;let x=g.getContext("2d");if(!x)throw Error("metric_texture_output_failed");let w=x.createImageData(a,o),M=w.data;for(let e=0;e<o;e++)for(let t=0;t<a;t++){let o=e*a+t,i=4*o,n=f(t,e),[l,s,d]=(0,u.TU)(r,n),h=l,c=s,m=d,p=18*n,g=Math.abs(p-Math.round(p));if(g<.02){let e=g<.009?.5:.28;h=Math.round((0,u.t7)(h,12,e)),c=Math.round((0,u.t7)(c,22,e)),m=Math.round((0,u.t7)(m,42,e))}M[i]=h,M[i+1]=c,M[i+2]=m,M[i+3]=255}x.putImageData(w,0,0);let b=new n.CanvasTexture(g);return b.colorSpace=n.SRGBColorSpace,b.wrapS=n.ClampToEdgeWrapping,b.wrapT=n.ClampToEdgeWrapping,b.needsUpdate=!0,{texture:b,range:{min:d,max:h}}}function g(e,t,r,a,o){let i=(0,u.uZ)(a,0,1)*(t-1),n=(0,u.uZ)(o,0,1)*(r-1),l=Math.floor(i),s=Math.floor(n),d=Math.min(t-1,l+1),h=Math.min(r-1,s+1),c=i-l,m=(0,u.t7)(e[s*t+l],e[s*t+d],c),p=(0,u.t7)(e[h*t+l],e[h*t+d],c);return(0,u.t7)(m,p,n-s)}function x(e){return"soil"===e?"Soil Moisture":"et"===e?"Evapotranspiration":"NDVI"}function w({open:e,bbox:t,texturePng:r,metricGrid:a,layer:h,selectedCell:p,quality:w="high"}){let M=(0,i.useRef)(null),[b,y]=(0,i.useState)(!1),[v,S]=(0,i.useState)(null),[N,E]=(0,i.useState)(null),[I,T]=(0,i.useState)(null),[A,F]=(0,i.useState)(null),_=(0,i.useMemo)(()=>c(p),[p]),C=(0,i.useMemo)(()=>(function(e){let t=c(e);return t?`P${3*t.row+t.col+1}`:null})(p),[p]),[j,P]=(0,i.useState)(()=>"undefined"!=typeof document&&document.documentElement.classList.contains("dark"));return((0,i.useEffect)(()=>{if("undefined"==typeof document)return;let e=document.documentElement,t=()=>P(e.classList.contains("dark"));t();let r=new MutationObserver(t);return r.observe(e,{attributes:!0,attributeFilter:["class"]}),()=>r.disconnect()},[]),(0,i.useEffect)(()=>{if(!e||!t)return;let r=new AbortController,a="high"===w?[128,96,64]:"balanced"===w?[96,64]:[64];return async function(){y(!0),S(null),E(null);try{let e="Terrain fetch failed";for(let o of a){let a=await fetch("/api/terrain/fetch",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({bbox:t,resolution:o,layer:h,quality:w}),signal:r.signal}),i=await a.json().catch(()=>({}));if(!a.ok||!i?.success){e=String(i?.message||i?.error||`Terrain fetch failed (${a.status})`);continue}let n=!!i?.degraded,l=i?.data,s=l&&Array.isArray(l.demGrid)&&l.demGrid.length>0&&Number(l.width)>1&&Number(l.height)>1;if(n||!s){e=String(i?.warnings?.[0]||i?.reason||"Terrain unavailable for the selected AOI.");continue}E(l),T({smoothed:!!(i?.meshMeta?.smoothed??!0),resolution:Number(i?.meshMeta?.resolution||o)}),S(null);return}E(null),S(e)}catch(e){if(r.signal.aborted)return;E(null),S(String(e?.message||"Terrain fetch failed"))}finally{r.signal.aborted||y(!1)}}(),()=>r.abort()},[e,h,t?.join(","),w]),(0,i.useEffect)(()=>{if(!e||!M.current||!N||!Array.isArray(N.demGrid)||0===N.demGrid.length||N.width<2||N.height<2)return;let t=M.current,o=new n.Scene,i=t.clientWidth||1e3,s=t.clientHeight||420,d=new n.PerspectiveCamera(50,i/s,.1,1400);d.position.set(0,90,148);let c=new n.WebGLRenderer({antialias:!0,alpha:!0});c.setSize(i,s),c.setPixelRatio(Math.min(2,window.devicePixelRatio||1)),c.outputColorSpace=n.SRGBColorSpace,c.toneMapping=n.ACESFilmicToneMapping,c.toneMappingExposure=1.02,c.setClearColor(0,0),t.innerHTML="",t.appendChild(c.domElement);let p=new l.OrbitControls(d,c.domElement);p.enableDamping=!0,p.dampingFactor=.08,p.maxPolarAngle=Math.PI/2.03,p.minDistance=30,p.maxDistance=260,p.target.set(0,6,0),o.add(new n.AmbientLight(16777215,j?.74:.66));let x=new n.DirectionalLight(16055295,j?1.12:1.04);x.position.set(130,142,60),o.add(x);let b=new n.DirectionalLight(j?9483519:10664920,j?.5:.42);b.position.set(-120,84,-120),o.add(b);let y=function(e,t,r,a){let o=t*r,i=new Float32Array(o);for(let t=0;t<o;t++){let r=Number(e[t]);i[t]=Number.isFinite(r)?r:0}if(a<=0||t<3||r<3)return i;let{min:n,max:l}=m(Array.from(i)),s=Math.max(.5,(l-n)*.18),d=i;for(let e=0;e<a;e++){let e=new Float32Array(o),a=new Float32Array(o);for(let a=0;a<r;a++)for(let r=0;r<t;r++){let o=a*t+r,i=d[a*t+Math.max(0,r-1)],n=d[o],l=d[a*t+Math.min(t-1,r+1)];e[o]=.2*i+.6*n+.2*l}for(let o=0;o<r;o++)for(let n=0;n<t;n++){let l=o*t+n,d=e[Math.max(0,o-1)*t+n],h=e[l],c=e[Math.min(r-1,o+1)*t+n],m=.2*d+.6*h+.2*c,p=i[l];a[l]=(0,u.uZ)(m,p-s,p+s)}d=a}return d}(N.demGrid,N.width,N.height,"high"===w?4:"balanced"===w?2:1),v=m(Array.from(y)),S="high"===w?42:"balanced"===w?36:31,E=new Float32Array(y.length),I="high"===w?80:"balanced"===w?64:52;for(let e=0;e<y.length;e++){let t=(0,u.uZ)(v.apply(y[e]),0,1),r=Math.pow(t,1.08),a=Math.round(r*I)/I;E[e]=(0,u.t7)(r,a,.68)*S}let T=new n.PlaneGeometry(120,120,N.width-1,N.height-1),A=T.attributes.position;for(let e=0;e<E.length;e++)A.setZ(e,E[e]);A.needsUpdate=!0,T.computeVertexNormals();let P=new n.MeshStandardMaterial({color:j?6254983:9674926,metalness:.03,roughness:.9}),D=new n.Mesh(T,P);D.rotation.x=-Math.PI/2,o.add(D);let G=new n.MeshBasicMaterial({color:16777215,transparent:!0,opacity:.96,side:n.DoubleSide}),k=new n.Mesh(T,G);k.rotation.x=-Math.PI/2,k.position.y=.18,o.add(k);let L=new n.LineSegments(new n.WireframeGeometry(T),new n.LineBasicMaterial({color:j?10072008:2768466,transparent:!0,opacity:j?.14:.1}));L.rotation.x=-Math.PI/2,o.add(L);let B=(e,t)=>g(E,N.width,N.height,e,t),W=new n.MeshStandardMaterial({color:j?5796494:9216951,roughness:.92,metalness:.01,side:n.DoubleSide,transparent:!0,opacity:.96}),$=[];for(let e of["north","south","west","east"]){let t="north"===e||"south"===e?N.width-1:N.height-1,r=function(e,t,r,a,o,i){let l=[],s=[],d=[];for(let i=0;i<=t;i++){let n=i/Math.max(1,t),d=n,u=n;"north"===e?(d=n,u=0):"south"===e?(d=n,u=1):(d="west"===e?0:1,u=n);let h=-a/2+d*a,c=-o/2+u*o,m=r(d,u)+.04,p=h,f=c;"north"===e&&(f-=2.6),"south"===e&&(f+=2.6),"west"===e&&(p-=2.6),"east"===e&&(p+=2.6),l.push(h,m,c),l.push(p,-1.35,f),s.push(d,u),s.push(d,u)}for(let e=0;e<t;e++){let t=2*e;d.push(t,t+1,t+2),d.push(t+1,t+3,t+2)}let u=new n.BufferGeometry;return u.setAttribute("position",new n.Float32BufferAttribute(l,3)),u.setAttribute("uv",new n.Float32BufferAttribute(s,2)),u.setIndex(d),u.computeVertexNormals(),u}(e,t,B,120,120,0),a=new n.Mesh(r,W);o.add(a),$.push(a)}let H=new n.PlaneGeometry(120,120),O=new n.MeshStandardMaterial({color:j?3559530:10860744,roughness:.94,metalness:0,side:n.DoubleSide,transparent:!0,opacity:.94}),R=new n.Mesh(H,O);R.rotation.x=-Math.PI/2,R.position.y=-1.35,o.add(R);let Z=new n.ShaderMaterial({uniforms:{uMaxHeight:{value:S},uDensity:{value:"high"===w?60:"balanced"===w?48:36},uThickness:{value:.038},uOpacity:{value:j?.7:.62}},vertexShader:`
        varying float vHeight;
        uniform float uMaxHeight;
        void main() {
          vHeight = max(0.0, position.z / max(uMaxHeight, 0.001));
          gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
        }
      `,fragmentShader:`
        varying float vHeight;
        uniform float uDensity;
        uniform float uThickness;
        uniform float uOpacity;
        void main() {
          float f = fract(vHeight * uDensity);
          float d = min(f, 1.0 - f);
          float aa = fwidth(vHeight * uDensity) * 0.9;
          float line = 1.0 - smoothstep(uThickness, uThickness + aa, d);
          gl_FragColor = vec4(vec3(0.08, 0.11, 0.16), line * uOpacity);
        }
      `,transparent:!0,depthWrite:!1}),V=new n.Mesh(T,Z);V.rotation.x=-Math.PI/2,V.position.y=.26,o.add(V);let z=[],U=!1,Y=null;(async()=>{if(r||a)try{let e=await f(r,a,h,N.width,N.height);if(U){e.texture.dispose();return}let t=c.capabilities.getMaxAnisotropy();(Y=e.texture).anisotropy=Math.max(2,Math.min(t,16)),G.map=Y,G.needsUpdate=!0,W.map=Y,W.needsUpdate=!0,F(e.range)}catch{F(null)}})();let q=(e,t,r=0)=>{let a=-60+120*e,o=-60+120*t,i=g(E,N.width,N.height,e,t)+r;return new n.Vector3(a,i,o)},J=(e,t,r,a,i)=>{let l=[q(e,r,i?.lift??.18),q(t,r,i?.lift??.18),q(t,a,i?.lift??.18),q(e,a,i?.lift??.18)],s=new n.BufferGeometry().setFromPoints(l),d=new n.LineBasicMaterial({color:i?.color??(j?14083583:2046546),transparent:!0,opacity:i?.opacity??(j?.76:.6),linewidth:i?.lineWidth??1,depthTest:!1,depthWrite:!1}),u=new n.LineLoop(s,d);return o.add(u),z.push(()=>{s.dispose(),d.dispose()}),u};for(let e=0;e<3;e++)for(let t=0;t<3;t++)J(t/3,(t+1)/3,e/3,(e+1)/3,{color:j?12705279:2576498,opacity:j?.74:.62,lift:.26});if(_){let e=_.col/3,t=(_.col+1)/3,r=_.row/3,a=(_.row+1)/3,i=[{u:e,v:r},{u:t,v:r},{u:t,v:a},{u:e,v:a}],l=new n.BufferGeometry().setFromPoints([q(e,r,.2),q(t,r,.2),q(t,a,.2),q(e,a,.2)]);l.setIndex([0,1,2,0,2,3]),l.computeVertexNormals();let s=new n.MeshBasicMaterial({color:5101823,transparent:!0,opacity:.21,depthTest:!1,depthWrite:!1,side:n.DoubleSide}),d=new n.Mesh(l,s);for(let u of(o.add(d),z.push(()=>{l.dispose(),s.dispose()}),J(e,t,r,a,{color:9434367,opacity:1,lift:.38}),J(e,t,r,a,{color:16773772,opacity:.86,lift:.48}),i)){let e=q(u.u,u.v,.4),t=e.clone();t.y+=2.8;let r=new n.CylinderGeometry(.09,.09,2.8,10),a=new n.MeshStandardMaterial({color:10875900,emissive:947344,emissiveIntensity:.6,roughness:.35}),i=new n.Mesh(r,a);i.position.set(e.x,(e.y+t.y)/2,e.z),o.add(i);let l=function(e){let t=document.createElement("canvas");t.width=64,t.height=64;let r=t.getContext("2d");if(!r)return null;r.clearRect(0,0,64,64),r.fillStyle=e,r.beginPath(),r.arc(32,32,11,0,2*Math.PI),r.fill(),r.strokeStyle="rgba(255,255,255,0.96)",r.lineWidth=4,r.stroke();let a=new n.CanvasTexture(t);a.colorSpace=n.SRGBColorSpace;let o=new n.SpriteMaterial({map:a,transparent:!0,depthTest:!1,depthWrite:!1}),i=new n.Sprite(o);return i.scale.set(1.6,1.6,1),{sprite:i,texture:a,material:o}}("#67e8f9");l&&(l.sprite.position.set(t.x,t.y,t.z),o.add(l.sprite),z.push(()=>{l.texture.dispose(),l.material.dispose()})),z.push(()=>{r.dispose(),a.dispose()})}if(C){let i=(e+t)/2,l=(r+a)/2,s=q(i,l,4.2),d=function(e){let t=document.createElement("canvas");t.width=256,t.height=80;let r=t.getContext("2d");if(!r)return null;r.clearRect(0,0,t.width,t.height),r.fillStyle="rgba(6, 11, 24, 0.82)",r.fillRect(8,12,240,56),r.strokeStyle="rgba(56, 189, 248, 0.95)",r.lineWidth=3,r.strokeRect(8,12,240,56),r.fillStyle="#e2f5ff",r.font='600 34px "IBM Plex Sans", sans-serif',r.textAlign="center",r.textBaseline="middle",r.fillText(e,t.width/2,t.height/2);let a=new n.CanvasTexture(t);a.colorSpace=n.SRGBColorSpace;let o=new n.SpriteMaterial({map:a,transparent:!0,depthTest:!1,depthWrite:!1}),i=new n.Sprite(o);return i.scale.set(14,4.4,1),{sprite:i,texture:a,material:o}}(C);d&&(d.sprite.position.set(s.x,s.y,s.z),o.add(d.sprite),z.push(()=>{d.texture.dispose(),d.material.dispose()}))}}let K=!0,Q=()=>{K&&(p.update(),c.render(o,d),requestAnimationFrame(Q))};Q();let X=()=>{let e=t.clientWidth||1e3,r=t.clientHeight||420;d.aspect=e/r,d.updateProjectionMatrix(),c.setSize(e,r)};return window.addEventListener("resize",X),()=>{U=!0,K=!1,window.removeEventListener("resize",X),p.dispose(),T.dispose(),L.geometry.dispose(),L.material.dispose(),P.dispose(),G.dispose(),Z.dispose(),$.forEach(e=>e.geometry.dispose()),W.dispose(),H.dispose(),O.dispose(),Y?.dispose(),z.forEach(e=>e()),c.dispose(),c.domElement.parentNode===t&&t.removeChild(c.domElement)}},[e,N,r,a,p,h,w,C,j]),e)?(0,o.jsxs)("div",{className:"rounded-2xl border border-border bg-card p-3 text-foreground",children:[(0,o.jsxs)("div",{className:"mb-2 flex items-center justify-between",children:[(0,o.jsxs)("p",{className:"flex items-center gap-2 text-sm font-semibold",children:[o.jsx(s.Z,{className:"h-4 w-4 text-sky-300"}),"3D Terrain Viewer"]}),(0,o.jsxs)("p",{className:"text-xs text-muted-foreground",children:["Metric: ",x(h)," | ",N?.source||"loading terrain"]})]}),b&&(0,o.jsxs)("div",{className:"mb-2 inline-flex items-center gap-2 rounded-lg border border-border px-2 py-1 text-xs text-muted-foreground",children:[o.jsx(d.Z,{className:"h-3.5 w-3.5 animate-spin"}),"Loading DEM for selected AOI"]}),v&&o.jsx("div",{className:"mb-2 rounded-lg border border-rose-700/60 bg-rose-500/10 px-2 py-1 text-xs text-rose-700 dark:text-rose-300",children:v}),o.jsx("div",{ref:M,className:`h-[24rem] w-full overflow-hidden rounded-xl border border-border/70 ${j?"bg-[radial-gradient(120%_100%_at_20%_0%,rgba(22,101,139,0.35)_0%,rgba(6,24,44,0.92)_52%,rgba(4,13,27,0.98)_100%)]":"bg-[radial-gradient(120%_100%_at_15%_0%,rgba(186,230,253,0.9)_0%,rgba(224,242,254,0.76)_45%,rgba(214,226,236,0.94)_100%)]"}`}),(0,o.jsxs)("div",{className:"mt-2 rounded-lg border border-border/80 bg-muted/35 p-2",children:[(0,o.jsxs)("p",{className:"text-[11px] uppercase tracking-[0.14em] text-muted-foreground",children:[x(h)," scale ",a?.isSimulated?"(simulated)":"(measured)"]}),o.jsx("div",{className:"mt-1 h-3 w-full rounded",style:{backgroundImage:(0,u.G5)(h)}}),(0,o.jsxs)("div",{className:"mt-1 flex items-center justify-between text-[11px] text-muted-foreground",children:[o.jsx("span",{children:(A?.min??a?.min??0).toFixed(3)}),o.jsx("span",{children:a?.units?a.units:"soil"===h?"m3/m3":"et"===h?"mm/day":"NDVI"}),o.jsx("span",{children:(A?.max??a?.max??1).toFixed(3)})]})]}),o.jsx("p",{className:"mt-2 text-[11px] text-muted-foreground",children:N?`High-fidelity topographic surface using ${x(h)} color mapping. Selected plot point: ${C||"none"}${I?` | mesh ${I.resolution}px${I.smoothed?", smoothed":""}`:""}.`:"Terrain will appear when providers return valid DEM coverage for this AOI."})]}):null}[n,l]=h.then?(await h)():h,a()}catch(e){a(e)}})},8098:(e,t,r)=>{r.d(t,{CS:()=>a,G5:()=>l,TU:()=>n,t7:()=>i,uZ:()=>o});let a={ndvi:[{stop:0,color:[53,74,193]},{stop:.15,color:[69,138,223]},{stop:.32,color:[71,192,220]},{stop:.48,color:[95,205,116]},{stop:.64,color:[220,211,88]},{stop:.8,color:[239,163,68]},{stop:1,color:[214,83,90]}],soil:[{stop:0,color:[65,83,191]},{stop:.2,color:[80,145,220]},{stop:.4,color:[86,196,181]},{stop:.58,color:[122,203,117]},{stop:.76,color:[231,195,86]},{stop:1,color:[191,96,60]}],et:[{stop:0,color:[55,70,189]},{stop:.2,color:[64,124,221]},{stop:.4,color:[78,196,215]},{stop:.6,color:[108,205,112]},{stop:.78,color:[239,190,82]},{stop:1,color:[209,84,72]}]};function o(e,t,r){return Math.max(t,Math.min(r,e))}function i(e,t,r){return e+(t-e)*r}function n(e,t){let r=a[e],i=o(t,0,1);for(let e=0;e<r.length-1;e++){let t=r[e],a=r[e+1];if(i<=a.stop){var n,l,s;let e=(i-t.stop)/Math.max(1e-6,a.stop-t.stop);return[Math.round((n=t.color[0])+(a.color[0]-n)*e),Math.round((l=t.color[1])+(a.color[1]-l)*e),Math.round((s=t.color[2])+(a.color[2]-s)*e)]}}return r[r.length-1].color}function l(e){return`linear-gradient(90deg, ${a[e].map(e=>`rgb(${e.color[0]}, ${e.color[1]}, ${e.color[2]}) ${Math.round(100*e.stop)}%`).join(", ")})`}}};