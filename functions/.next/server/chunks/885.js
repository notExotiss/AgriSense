"use strict";exports.id=885,exports.ids=[885],exports.modules={2090:(e,t,r)=>{r.d(t,{Z:()=>i});let i=(0,r(1373).Z)("mountain",[["path",{d:"m8 3 4 8 5-5 5 15H2L8 3z",key:"otkl63"}]])},8885:(e,t,r)=>{r.a(e,async(e,i)=>{try{r.r(t),r.d(t,{default:()=>x});var a=r(997),n=r(6689),o=r(2949),l=r(8724),s=r(2090),d=r(6316),c=r(8098),u=e([o,l]);function h(e){if(!e||!e.includes("-"))return null;let[t,r]=e.split("-"),i=Number(t),a=Number(r);return Number.isFinite(i)&&Number.isFinite(a)?{row:i,col:a}:null}function m(e){let t=e.filter(e=>Number.isFinite(e)),r=t.length?Math.min(...t):0,i=t.length?Math.max(...t):1,a=Math.max(1e-6,i-r);return{min:r,max:i,range:a,apply:e=>(e-r)/a}}async function p(e){return await new Promise((t,r)=>{let i=new Image;i.crossOrigin="anonymous",i.onload=()=>t(i),i.onerror=()=>r(Error("metric_texture_load_failed")),i.src=`data:image/png;base64,${e}`})}async function f(e,t,r,i,a){let n=i,l=a,s=new Float32Array(i*a),d=Number.POSITIVE_INFINITY,u=Number.NEGATIVE_INFINITY;if(t&&Array.isArray(t.values)&&t.width>0&&t.height>0&&t.values.length>=t.width*t.height){n=t.width,l=t.height,s=new Float32Array(n*l);for(let e=0;e<n*l;e++){let r=Number(t.values[e]),i=Number.isFinite(r)?r:0;s[e]=i,d=Math.min(d,i),u=Math.max(u,i)}}else if(e){let t=await p(e),r=document.createElement("canvas");r.width=i,r.height=a;let n=r.getContext("2d");if(!n)throw Error("metric_texture_context_failed");n.drawImage(t,0,0,i,a);let o=n.getImageData(0,0,i,a).data;s=new Float32Array(i*a);for(let e=0;e<i*a;e++){let t=4*e;if(o[t+3]<5){s[e]=0;continue}let r=(.2126*o[t]+.7152*o[t+1]+.0722*o[t+2])/255;s[e]=r,d=Math.min(d,r),u=Math.max(u,r)}}else throw Error("metric_texture_missing");Number.isFinite(d)&&Number.isFinite(u)||(t&&Number.isFinite(t.min)&&Number.isFinite(t.max)&&t.max>t.min?(d=t.min,u=t.max):(d=0,u=1));let h=Math.max(1e-6,u-d),m=(e,t)=>{let r=(0,c.uZ)(e,0,n-1),i=(0,c.uZ)(t,0,l-1),a=Math.floor(r),o=Math.floor(i),d=Math.min(n-1,a+1),u=Math.min(l-1,o+1),h=r-a,m=o*n+a,p=o*n+d,f=u*n+a,g=u*n+d,x=(0,c.t7)(s[m],s[p],h),w=(0,c.t7)(s[f],s[g],h);return(0,c.t7)(x,w,i-o)},f=(e,t)=>{let r=e/Math.max(1,i-1)*(n-1),o=t/Math.max(1,a-1)*(l-1);return(m(r,o)-d)/h},g=document.createElement("canvas");g.width=i,g.height=a;let x=g.getContext("2d");if(!x)throw Error("metric_texture_output_failed");let w=x.createImageData(i,a),M=w.data;for(let e=0;e<a;e++)for(let t=0;t<i;t++){let a=e*i+t,n=4*a,o=f(t,e),[l,s,d]=(0,c.TU)(r,o),u=l,h=s,m=d,p=18*o,g=Math.abs(p-Math.round(p));if(g<.02){let e=g<.009?.5:.28;u=Math.round((0,c.t7)(u,12,e)),h=Math.round((0,c.t7)(h,22,e)),m=Math.round((0,c.t7)(m,42,e))}M[n]=u,M[n+1]=h,M[n+2]=m,M[n+3]=255}x.putImageData(w,0,0);let y=new o.CanvasTexture(g);return y.colorSpace=o.SRGBColorSpace,y.wrapS=o.ClampToEdgeWrapping,y.wrapT=o.ClampToEdgeWrapping,y.needsUpdate=!0,{texture:y,range:{min:d,max:u}}}function g(e){return"soil"===e?"Soil Moisture":"et"===e?"Evapotranspiration":"NDVI"}function x({open:e,bbox:t,texturePng:r,metricGrid:i,layer:u,selectedCell:p,quality:x="high"}){let w=(0,n.useRef)(null),[M,y]=(0,n.useState)(!1),[b,v]=(0,n.useState)(null),[S,N]=(0,n.useState)(null),[T,I]=(0,n.useState)(null),[E,A]=(0,n.useState)(null),F=(0,n.useMemo)(()=>h(p),[p]),j=(0,n.useMemo)(()=>(function(e){let t=h(e);return t?`P${3*t.row+t.col+1}`:null})(p),[p]);return((0,n.useEffect)(()=>{if(!e||!t)return;let r=new AbortController,i="high"===x?[128,96,64]:"balanced"===x?[96,64]:[64];return async function(){y(!0),v(null),N(null);try{let e="Terrain fetch failed";for(let a of i){let i=await fetch("/api/terrain/fetch",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({bbox:t,resolution:a,layer:u,quality:x}),signal:r.signal}),n=await i.json().catch(()=>({}));if(!i.ok||!n?.success){e=String(n?.message||n?.error||`Terrain fetch failed (${i.status})`);continue}let o=!!n?.degraded,l=n?.data,s=l&&Array.isArray(l.demGrid)&&l.demGrid.length>0&&Number(l.width)>1&&Number(l.height)>1;if(o||!s){e=String(n?.warnings?.[0]||n?.reason||"Terrain unavailable for the selected AOI.");continue}N(l),I({smoothed:!!(n?.meshMeta?.smoothed??!0),resolution:Number(n?.meshMeta?.resolution||a)}),v(null);return}N(null),v(e)}catch(e){if(r.signal.aborted)return;N(null),v(String(e?.message||"Terrain fetch failed"))}finally{r.signal.aborted||y(!1)}}(),()=>r.abort()},[e,u,t?.join(","),x]),(0,n.useEffect)(()=>{if(!e||!w.current||!S||!Array.isArray(S.demGrid)||0===S.demGrid.length||S.width<2||S.height<2)return;let t=w.current,a=new o.Scene;a.background=new o.Color(593690);let n=t.clientWidth||1e3,s=t.clientHeight||420,d=new o.PerspectiveCamera(50,n/s,.1,1400);d.position.set(0,90,148);let h=new o.WebGLRenderer({antialias:!0,alpha:!1});h.setSize(n,s),h.setPixelRatio(Math.min(2,window.devicePixelRatio||1)),h.outputColorSpace=o.SRGBColorSpace,h.toneMapping=o.ACESFilmicToneMapping,h.toneMappingExposure=1.02,t.innerHTML="",t.appendChild(h.domElement);let p=new l.OrbitControls(d,h.domElement);p.enableDamping=!0,p.dampingFactor=.08,p.maxPolarAngle=Math.PI/2.03,p.minDistance=30,p.maxDistance=260,p.target.set(0,6,0),a.add(new o.AmbientLight(16777215,.58));let g=new o.DirectionalLight(16055295,1.02);g.position.set(130,140,60),a.add(g);let M=new o.DirectionalLight(9090815,.42);M.position.set(-120,80,-120),a.add(M);let y=function(e,t,r,i){let a=t*r,n=new Float32Array(a);for(let t=0;t<a;t++){let r=Number(e[t]);n[t]=Number.isFinite(r)?r:0}if(i<=0||t<3||r<3)return n;let{min:o,max:l}=m(Array.from(n)),s=Math.max(.5,(l-o)*.18),d=n;for(let e=0;e<i;e++){let e=new Float32Array(a),i=new Float32Array(a);for(let i=0;i<r;i++)for(let r=0;r<t;r++){let a=i*t+r,n=d[i*t+Math.max(0,r-1)],o=d[a],l=d[i*t+Math.min(t-1,r+1)];e[a]=.2*n+.6*o+.2*l}for(let a=0;a<r;a++)for(let o=0;o<t;o++){let l=a*t+o,d=e[Math.max(0,a-1)*t+o],u=e[l],h=e[Math.min(r-1,a+1)*t+o],m=.2*d+.6*u+.2*h,p=n[l];i[l]=(0,c.uZ)(m,p-s,p+s)}d=i}return d}(S.demGrid,S.width,S.height,"high"===x?4:"balanced"===x?2:1),b=m(Array.from(y)),v="high"===x?42:"balanced"===x?36:31,N=new Float32Array(y.length),T="high"===x?80:"balanced"===x?64:52;for(let e=0;e<y.length;e++){let t=(0,c.uZ)(b.apply(y[e]),0,1),r=Math.pow(t,1.08),i=Math.round(r*T)/T;N[e]=(0,c.t7)(r,i,.68)*v}let I=new o.PlaneGeometry(120,120,S.width-1,S.height-1),E=I.attributes.position;for(let e=0;e<N.length;e++)E.setZ(e,N[e]);E.needsUpdate=!0,I.computeVertexNormals();let C=new o.BoxGeometry(126,9.5,126),z=new o.MeshStandardMaterial({color:7041664,roughness:.78,metalness:.03}),P=new o.Mesh(C,z);P.position.set(0,-6.5,0),a.add(P);let G=new o.MeshStandardMaterial({color:8228769,metalness:.04,roughness:.86}),D=new o.Mesh(I,G);D.rotation.x=-Math.PI/2,a.add(D);let k=new o.LineSegments(new o.WireframeGeometry(I),new o.LineBasicMaterial({color:988970,transparent:!0,opacity:.075}));k.rotation.x=-Math.PI/2,a.add(k);let _=new o.ShaderMaterial({uniforms:{uMaxHeight:{value:v},uDensity:{value:"high"===x?60:"balanced"===x?48:36},uThickness:{value:.04},uOpacity:{value:.66}},vertexShader:`
        varying float vHeight;
        uniform float uMaxHeight;
        void main() {
          vHeight = max(0.0, position.z / max(uMaxHeight, 0.001));
          gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
        }
      `,fragmentShader:`
        varying float vHeight;
        uniform float uDensity;
        uniform float uThickness;
        uniform float uOpacity;
        void main() {
          float f = fract(vHeight * uDensity);
          float d = min(f, 1.0 - f);
          float aa = fwidth(vHeight * uDensity) * 0.9;
          float line = 1.0 - smoothstep(uThickness, uThickness + aa, d);
          gl_FragColor = vec4(vec3(0.06, 0.09, 0.13), line * uOpacity);
        }
      `,transparent:!0,depthWrite:!1}),L=new o.Mesh(I,_);L.rotation.x=-Math.PI/2,L.position.y=.26,a.add(L);let W=[],H=!1,$=null;(async()=>{if(r||i)try{let e=await f(r,i,u,S.width,S.height);if(H){e.texture.dispose();return}let t=h.capabilities.getMaxAnisotropy();($=e.texture).anisotropy=Math.max(2,Math.min(t,16)),G.map=$,G.needsUpdate=!0,A(e.range)}catch{A(null)}})();let B=(e,t,r=0)=>{let i=-60+120*e,a=-60+120*t,n=function(e,t,r,i,a){let n=(0,c.uZ)(i,0,1)*(t-1),o=(0,c.uZ)(a,0,1)*(r-1),l=Math.floor(n),s=Math.floor(o),d=Math.min(t-1,l+1),u=Math.min(r-1,s+1),h=n-l,m=(0,c.t7)(e[s*t+l],e[s*t+d],h),p=(0,c.t7)(e[u*t+l],e[u*t+d],h);return(0,c.t7)(m,p,o-s)}(N,S.width,S.height,e,t)+r;return new o.Vector3(i,n,a)},R=(e,t,r,i,n)=>{let l=[B(e,r,n?.lift??.18),B(t,r,n?.lift??.18),B(t,i,n?.lift??.18),B(e,i,n?.lift??.18)],s=new o.BufferGeometry().setFromPoints(l),d=new o.LineBasicMaterial({color:n?.color??14870768,transparent:!0,opacity:n?.opacity??.42,linewidth:n?.lineWidth??1,depthTest:!1,depthWrite:!1}),c=new o.LineLoop(s,d);return a.add(c),W.push(()=>{s.dispose(),d.dispose()}),c};for(let e=0;e<3;e++)for(let t=0;t<3;t++)R(t/3,(t+1)/3,e/3,(e+1)/3,{color:9684477,opacity:.5,lift:.2});if(F){let e=F.col/3,t=(F.col+1)/3,r=F.row/3,i=(F.row+1)/3,n=[{u:e,v:r},{u:t,v:r},{u:t,v:i},{u:e,v:i}],l=new o.BufferGeometry().setFromPoints([B(e,r,.2),B(t,r,.2),B(t,i,.2),B(e,i,.2)]);l.setIndex([0,1,2,0,2,3]),l.computeVertexNormals();let s=new o.MeshBasicMaterial({color:2282478,transparent:!0,opacity:.16,depthTest:!1,depthWrite:!1,side:o.DoubleSide}),d=new o.Mesh(l,s);for(let c of(a.add(d),W.push(()=>{l.dispose(),s.dispose()}),R(e,t,r,i,{color:6809849,opacity:1,lift:.32}),R(e,t,r,i,{color:16707722,opacity:.72,lift:.42}),n)){let e=B(c.u,c.v,.4),t=e.clone();t.y+=2.8;let r=new o.CylinderGeometry(.09,.09,2.8,10),i=new o.MeshStandardMaterial({color:10875900,emissive:947344,emissiveIntensity:.6,roughness:.35}),n=new o.Mesh(r,i);n.position.set(e.x,(e.y+t.y)/2,e.z),a.add(n);let l=function(e){let t=document.createElement("canvas");t.width=64,t.height=64;let r=t.getContext("2d");if(!r)return null;r.clearRect(0,0,64,64),r.fillStyle=e,r.beginPath(),r.arc(32,32,11,0,2*Math.PI),r.fill(),r.strokeStyle="rgba(255,255,255,0.96)",r.lineWidth=4,r.stroke();let i=new o.CanvasTexture(t);i.colorSpace=o.SRGBColorSpace;let a=new o.SpriteMaterial({map:i,transparent:!0,depthTest:!1,depthWrite:!1}),n=new o.Sprite(a);return n.scale.set(1.6,1.6,1),{sprite:n,texture:i,material:a}}("#67e8f9");l&&(l.sprite.position.set(t.x,t.y,t.z),a.add(l.sprite),W.push(()=>{l.texture.dispose(),l.material.dispose()})),W.push(()=>{r.dispose(),i.dispose()})}if(j){let n=(e+t)/2,l=(r+i)/2,s=B(n,l,4.2),d=function(e){let t=document.createElement("canvas");t.width=256,t.height=80;let r=t.getContext("2d");if(!r)return null;r.clearRect(0,0,t.width,t.height),r.fillStyle="rgba(6, 11, 24, 0.82)",r.fillRect(8,12,240,56),r.strokeStyle="rgba(56, 189, 248, 0.95)",r.lineWidth=3,r.strokeRect(8,12,240,56),r.fillStyle="#e2f5ff",r.font='600 34px "IBM Plex Sans", sans-serif',r.textAlign="center",r.textBaseline="middle",r.fillText(e,t.width/2,t.height/2);let i=new o.CanvasTexture(t);i.colorSpace=o.SRGBColorSpace;let a=new o.SpriteMaterial({map:i,transparent:!0,depthTest:!1,depthWrite:!1}),n=new o.Sprite(a);return n.scale.set(14,4.4,1),{sprite:n,texture:i,material:a}}(j);d&&(d.sprite.position.set(s.x,s.y,s.z),a.add(d.sprite),W.push(()=>{d.texture.dispose(),d.material.dispose()}))}}let Z=!0,O=()=>{Z&&(p.update(),h.render(a,d),requestAnimationFrame(O))};O();let V=()=>{let e=t.clientWidth||1e3,r=t.clientHeight||420;d.aspect=e/r,d.updateProjectionMatrix(),h.setSize(e,r)};return window.addEventListener("resize",V),()=>{H=!0,Z=!1,window.removeEventListener("resize",V),p.dispose(),I.dispose(),k.geometry.dispose(),k.material.dispose(),G.map?.dispose(),G.dispose(),_.dispose(),C.dispose(),z.dispose(),$?.dispose(),W.forEach(e=>e()),h.dispose(),h.domElement.parentNode===t&&t.removeChild(h.domElement)}},[e,S,r,i,p,u,x,j]),e)?(0,a.jsxs)("div",{className:"rounded-2xl border border-zinc-200 bg-zinc-950/95 p-3 text-zinc-100",children:[(0,a.jsxs)("div",{className:"mb-2 flex items-center justify-between",children:[(0,a.jsxs)("p",{className:"flex items-center gap-2 text-sm font-semibold",children:[a.jsx(s.Z,{className:"h-4 w-4 text-sky-300"}),"3D Terrain Viewer"]}),(0,a.jsxs)("p",{className:"text-xs text-zinc-300",children:["Metric: ",g(u)," | ",S?.source||"loading terrain"]})]}),M&&(0,a.jsxs)("div",{className:"mb-2 inline-flex items-center gap-2 rounded-lg border border-zinc-700 px-2 py-1 text-xs text-zinc-300",children:[a.jsx(d.Z,{className:"h-3.5 w-3.5 animate-spin"}),"Loading DEM for selected AOI"]}),b&&a.jsx("div",{className:"mb-2 rounded-lg border border-rose-800 bg-rose-950/60 px-2 py-1 text-xs text-rose-200",children:b}),a.jsx("div",{ref:w,className:"h-[24rem] w-full overflow-hidden rounded-xl border border-zinc-700/70"}),(0,a.jsxs)("div",{className:"mt-2 rounded-lg border border-zinc-700/70 bg-zinc-900/70 p-2",children:[(0,a.jsxs)("p",{className:"text-[11px] uppercase tracking-[0.14em] text-zinc-400",children:[g(u)," scale ",i?.isSimulated?"(simulated)":"(measured)"]}),a.jsx("div",{className:"mt-1 h-3 w-full rounded",style:{backgroundImage:(0,c.G5)(u)}}),(0,a.jsxs)("div",{className:"mt-1 flex items-center justify-between text-[11px] text-zinc-300",children:[a.jsx("span",{children:(E?.min??i?.min??0).toFixed(3)}),a.jsx("span",{children:i?.units?i.units:"soil"===u?"m3/m3":"et"===u?"mm/day":"NDVI"}),a.jsx("span",{children:(E?.max??i?.max??1).toFixed(3)})]})]}),a.jsx("p",{className:"mt-2 text-[11px] text-zinc-400",children:S?`High-fidelity topographic surface using ${g(u)} color mapping. Selected plot point: ${j||"none"}${T?` | mesh ${T.resolution}px${T.smoothed?", smoothed":""}`:""}.`:"Terrain will appear when providers return valid DEM coverage for this AOI."})]}):null}[o,l]=u.then?(await u)():u,i()}catch(e){i(e)}})},8098:(e,t,r)=>{r.d(t,{G5:()=>l,TU:()=>o,t7:()=>n,uZ:()=>a});let i={ndvi:[{stop:0,color:[53,74,193]},{stop:.15,color:[69,138,223]},{stop:.32,color:[71,192,220]},{stop:.48,color:[95,205,116]},{stop:.64,color:[220,211,88]},{stop:.8,color:[239,163,68]},{stop:1,color:[214,83,90]}],soil:[{stop:0,color:[65,83,191]},{stop:.2,color:[80,145,220]},{stop:.4,color:[86,196,181]},{stop:.58,color:[122,203,117]},{stop:.76,color:[231,195,86]},{stop:1,color:[191,96,60]}],et:[{stop:0,color:[55,70,189]},{stop:.2,color:[64,124,221]},{stop:.4,color:[78,196,215]},{stop:.6,color:[108,205,112]},{stop:.78,color:[239,190,82]},{stop:1,color:[209,84,72]}]};function a(e,t,r){return Math.max(t,Math.min(r,e))}function n(e,t,r){return e+(t-e)*r}function o(e,t){let r=i[e],n=a(t,0,1);for(let e=0;e<r.length-1;e++){let t=r[e],i=r[e+1];if(n<=i.stop){var o,l,s;let e=(n-t.stop)/Math.max(1e-6,i.stop-t.stop);return[Math.round((o=t.color[0])+(i.color[0]-o)*e),Math.round((l=t.color[1])+(i.color[1]-l)*e),Math.round((s=t.color[2])+(i.color[2]-s)*e)]}}return r[r.length-1].color}function l(e){return`linear-gradient(90deg, ${i[e].map(e=>`rgb(${e.color[0]}, ${e.color[1]}, ${e.color[2]}) ${Math.round(100*e.stop)}%`).join(", ")})`}}};