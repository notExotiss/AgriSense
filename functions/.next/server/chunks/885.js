"use strict";exports.id=885,exports.ids=[885],exports.modules={2090:(e,t,i)=>{i.d(t,{Z:()=>r});let r=(0,i(1373).Z)("mountain",[["path",{d:"m8 3 4 8 5-5 5 15H2L8 3z",key:"otkl63"}]])},8885:(e,t,i)=>{i.a(e,async(e,r)=>{try{i.r(t),i.d(t,{default:()=>M});var a=i(997),n=i(6689),o=i(2949),l=i(8724),s=i(2090),d=i(6316),u=i(8098),h=i(8625),m=i(1854),c=i(8070),p=e([o,l,c]);function f(e){if(!e||!e.includes("-"))return null;let[t,i]=e.split("-"),r=Number(t),a=Number(i);return Number.isFinite(r)&&Number.isFinite(a)?{row:r,col:a}:null}function g(e,t,i,r,a){let n=(0,u.uZ)(r,0,1)*(t-1),o=(0,u.uZ)(a,0,1)*(i-1),l=Math.floor(n),s=Math.floor(o),d=Math.min(t-1,l+1),h=Math.min(i-1,s+1),m=n-l,c=(0,u.t7)(e[s*t+l],e[s*t+d],m),p=(0,u.t7)(e[h*t+l],e[h*t+d],m);return(0,u.t7)(c,p,o-s)}function x(e){return"soil"===e?"Soil Moisture":"et"===e?"Evapotranspiration":"NDVI"}function M({open:e,bbox:t,geometry:i,alignmentBbox:r,cellFootprints:p,texturePng:M,metricGrid:w,layer:b,selectedCell:v}){let y=(0,n.useRef)(null),[S,N]=(0,n.useState)(!1),[T,A]=(0,n.useState)(null),[C,D]=(0,n.useState)(null),[F,E]=(0,n.useState)(null),[R,j]=(0,n.useState)(null),$=(0,n.useMemo)(()=>f(v),[v]),k=(0,n.useMemo)(()=>(function(e){let t=f(e);return t?`P${3*t.row+t.col+1}`:null})(v),[v]),P=(0,n.useMemo)(()=>!!(w&&Array.isArray(w.values)&&w.width>1&&w.height>1&&w.values.length>=w.width*w.height),[w]),[_,I]=(0,n.useState)(()=>"undefined"!=typeof document&&document.documentElement.classList.contains("dark"));return((0,n.useEffect)(()=>{if("undefined"==typeof document)return;let e=document.documentElement,t=()=>I(e.classList.contains("dark"));t();let i=new MutationObserver(t);return i.observe(e,{attributes:!0,attributeFilter:["class"]}),()=>i.disconnect()},[]),(0,n.useEffect)(()=>{if(!e||!t)return;let r=new AbortController,a=[224,192,160,128];return async function(){N(!0),A(null),D(null);try{let e="Terrain fetch failed";for(let n of a){let a=await fetch("/api/terrain/fetch",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({bbox:t,geometry:i||null,resolution:n,layer:b}),signal:r.signal}),o=await a.json().catch(()=>({}));if(!a.ok||!o?.success){e=String(o?.message||o?.error||`Terrain fetch failed (${a.status})`);continue}let l=!!o?.degraded,s=o?.data,d=s&&Array.isArray(s.demGrid)&&s.demGrid.length>0&&Number(s.width)>1&&Number(s.height)>1;if(l||!d){e=String(o?.warnings?.[0]||o?.reason||"Terrain unavailable for the selected AOI.");continue}D({...s,demSource:s?.demSource||o?.demSource||s?.source||o?.source,demDataset:s?.demDataset||o?.demDataset,modelType:s?.modelType||o?.modelType,verticalDatum:s?.verticalDatum||o?.verticalDatum,sourceResolutionMeters:s?.sourceResolutionMeters??o?.sourceResolutionMeters??s?.providerResolutionMeters,effectiveResolutionMeters:s?.effectiveResolutionMeters??o?.effectiveResolutionMeters??s?.pixelSizeMeters,precisionClass:s?.precisionClass||o?.precisionClass,voidFillRatio:s?.voidFillRatio??o?.voidFillRatio,zStats:s?.zStats||o?.zStats}),E({smoothed:!!(o?.meshMeta?.smoothed??!0),resolution:Number(o?.meshMeta?.resolution||n)}),A(null);return}D(null),A(e)}catch(e){if(r.signal.aborted)return;D(null),A(String(e?.message||"Terrain fetch failed"))}finally{r.signal.aborted||N(!1)}}(),()=>r.abort()},[e,b,t?.join(","),JSON.stringify(i||null)]),(0,n.useEffect)(()=>{if(!e||!y.current||!C||!Array.isArray(C.demGrid)||0===C.demGrid.length||C.width<2||C.height<2)return;let t=y.current,i=new o.Scene,a=t.clientWidth||1e3,n=t.clientHeight||420,s=new o.PerspectiveCamera(48,a/n,.1,1400);s.position.set(0,84,136);let d=new o.WebGLRenderer({antialias:!0,alpha:!0});d.setSize(a,n),d.setPixelRatio(Math.min(2,window.devicePixelRatio||1)),d.outputColorSpace=o.SRGBColorSpace,d.toneMapping=o.ACESFilmicToneMapping,d.toneMappingExposure=1.02,d.setClearColor(0,0),t.innerHTML="",t.appendChild(d.domElement);let f=new l.OrbitControls(s,d.domElement);f.enableDamping=!0,f.dampingFactor=.08,f.maxPolarAngle=Math.PI/2.45,f.minDistance=24,f.maxDistance=520,f.minPolarAngle=.22,f.target.set(0,0,0),i.add(new o.AmbientLight(16777215,_?.74:.66));let x=new o.DirectionalLight(16055295,_?1.12:1.04);x.position.set(130,142,60),i.add(x);let M=new o.DirectionalLight(_?9483519:10664920,_?.5:.42);M.position.set(-120,84,-120),i.add(M);let v=function(e,t,i,r){let a=t*i,n=new Float32Array(a);for(let t=0;t<a;t++){let i=Number(e[t]);n[t]=Number.isFinite(i)?i:0}if(r<=0||t<3||i<3)return n;let{min:o,max:l}=function(e){let t=e.filter(e=>Number.isFinite(e)),i=t.length?Math.min(...t):0,r=t.length?Math.max(...t):1,a=Math.max(1e-6,r-i);return{min:i,max:r,range:a,apply:e=>(e-i)/a}}(Array.from(n)),s=Math.max(.5,(l-o)*.18),d=n;for(let e=0;e<r;e++){let e=new Float32Array(a),r=new Float32Array(a);for(let r=0;r<i;r++)for(let i=0;i<t;i++){let a=r*t+i,n=d[r*t+Math.max(0,i-1)],o=d[a],l=d[r*t+Math.min(t-1,i+1)];e[a]=.2*n+.6*o+.2*l}for(let a=0;a<i;a++)for(let o=0;o<t;o++){let l=a*t+o,d=e[Math.max(0,a-1)*t+o],h=e[l],m=e[Math.min(i-1,a+1)*t+o],c=.2*d+.6*h+.2*m,p=n[l];r[l]=(0,u.uZ)(c,p-s,p+s)}d=r}return d}(C.demGrid,C.width,C.height,0),S=(0,m.i)({demGrid:Array.from(v),width:C.width,height:C.height,bbox:C.bbox}),N=S.planeWidth,T=S.planeHeight,A=S.scaledHeight,D=S.elevationScale,F=S.elevationScale,E=Math.max(N,T),R=Math.min(N,T),I=(0,u.uZ)(.3*D,2.4,34),Z=(0,u.uZ)(.92*E,56,300),G=(0,u.uZ)(Math.max(.46*E,I+2.4*D),38,170);s.position.set(0,G,Z),f.target.set(0,I,0),f.minDistance=(0,u.uZ)(.5*R,24,160),f.maxDistance=(0,u.uZ)(3.2*E,150,620),f.update();let H=new o.PlaneGeometry(N,T,C.width-1,C.height-1),L=H.attributes.position;for(let e=0;e<A.length;e++)L.setZ(e,A[e]);L.needsUpdate=!0,H.computeVertexNormals();let W=new o.MeshStandardMaterial({color:_?6254983:9674926,metalness:.03,roughness:.9}),z=new o.Mesh(H,W);z.rotation.x=-Math.PI/2,i.add(z);let B=new o.MeshBasicMaterial({color:16777215,transparent:!0,opacity:.96,side:o.DoubleSide}),O=new o.Mesh(H,B);O.rotation.x=-Math.PI/2,O.position.y=.18,i.add(O);let q=new o.LineSegments(new o.WireframeGeometry(H),new o.LineBasicMaterial({color:_?10072008:2768466,transparent:!0,opacity:_?.14:.1}));q.rotation.x=-Math.PI/2,i.add(q);let U=S.reliefMeters/Math.max(1e-6,S.metersPerUnit)*.08,V=-(0,u.uZ)(U,.28,1.2),J=(e,t)=>g(A,C.width,C.height,e,t),Q=new o.MeshStandardMaterial({color:_?5796494:9216951,roughness:.92,metalness:.01,side:o.DoubleSide,transparent:!1,opacity:1}),K=[];for(let e of["north","south","west","east"]){let t="north"===e||"south"===e?C.width-1:C.height-1,r=function(e,t,i,r,a,n){let l=[],s=[],d=[];for(let o=0;o<=t;o++){let d=o/Math.max(1,t),u=d,h=d;"north"===e?(u=d,h=0):"south"===e?(u=d,h=1):(u="west"===e?0:1,h=d);let m=-r/2+u*r,c=-a/2+h*a,p=i(u,h)+.04,f=m,g=c;"north"===e&&(g-=2.6),"south"===e&&(g+=2.6),"west"===e&&(f-=2.6),"east"===e&&(f+=2.6),l.push(m,p,c),l.push(f,n,g),s.push(u,h),s.push(u,h)}for(let e=0;e<t;e++){let t=2*e;d.push(t,t+1,t+2),d.push(t+1,t+3,t+2)}let u=new o.BufferGeometry;return u.setAttribute("position",new o.Float32BufferAttribute(l,3)),u.setAttribute("uv",new o.Float32BufferAttribute(s,2)),u.setIndex(d),u.computeVertexNormals(),u}(e,t,J,N,T,V),a=new o.Mesh(r,Q);i.add(a),K.push(a)}let X=new o.PlaneGeometry(N,T),Y=new o.MeshStandardMaterial({color:_?4679814:10335946,roughness:.94,metalness:0,side:o.DoubleSide,transparent:!1,opacity:1}),ee=new o.Mesh(X,Y);ee.rotation.x=-Math.PI/2,ee.position.y=V,i.add(ee);let et=(0,c.E)({maxHeight:D,reliefUnits:F,isDarkTheme:_,quality:"balanced"}),ei=new o.Mesh(H,et);ei.rotation.x=-Math.PI/2,ei.position.y=.26,i.add(ei);let er=[],ea=!1,en=null,eo=null;P||j(null),(async()=>{if(P)try{let e=await function(e,t,i,r){if(!e)throw Error("metric_grid_missing");let a=(0,h.a8)({metric:t,grid:{values:e.values,validMask:e.validMask,width:e.width,height:e.height,min:e.min,max:e.max},outputWidth:i,outputHeight:r,contours:!1}),n=new o.CanvasTexture(a.canvas);n.colorSpace=o.SRGBColorSpace,n.wrapS=o.ClampToEdgeWrapping,n.wrapT=o.ClampToEdgeWrapping,n.needsUpdate=!0;let l=document.createElement("canvas");l.width=a.canvas.width,l.height=a.canvas.height;let s=l.getContext("2d");if(!s)throw Error("opaque_metric_canvas_failed");s.drawImage(a.canvas,0,0);let d=s.getImageData(0,0,l.width,l.height),m=d.data,c=(0,u.TU)(t,.5);for(let e=0;e<l.height;e++){let t=c[0],i=c[1],r=c[2];for(let a=0;a<l.width;a++){let n=(e*l.width+a)*4;if(m[n+3]>0){t=m[n],i=m[n+1],r=m[n+2],m[n+3]=255;continue}m[n]=t,m[n+1]=i,m[n+2]=r,m[n+3]=255}}s.putImageData(d,0,0);let p=new o.CanvasTexture(l);return p.colorSpace=o.SRGBColorSpace,p.wrapS=o.ClampToEdgeWrapping,p.wrapT=o.ClampToEdgeWrapping,p.needsUpdate=!0,{texture:n,opaqueTexture:p,range:a.range}}(w,b,C.width,C.height);if(ea){e.texture.dispose();return}let t=d.capabilities.getMaxAnisotropy();en=e.texture,eo=e.opaqueTexture,en.anisotropy=Math.max(2,Math.min(t,16)),eo.anisotropy=Math.max(2,Math.min(t,16)),B.map=en,B.needsUpdate=!0,Q.map=eo,Q.needsUpdate=!0,Y.map=eo,Y.needsUpdate=!0,j(e.range)}catch{j(null)}})();let el=(e,t,i=0)=>{let r=-N/2+e*N,a=-T/2+t*T,n=g(A,C.width,C.height,e,t)+i;return new o.Vector3(r,n,a)},es=(e,t)=>{if(!Array.isArray(e)||e.length<3)return null;let r=e.map(e=>el(e.u,e.v,t?.lift??.18)),a=new o.BufferGeometry().setFromPoints(r),n=new o.LineBasicMaterial({color:t?.color??(_?14083583:2046546),transparent:!0,opacity:t?.opacity??(_?.76:.6),linewidth:t?.lineWidth??1,depthTest:!1,depthWrite:!1}),l=new o.LineLoop(a,n);return i.add(l),er.push(()=>{a.dispose(),n.dispose()}),l},ed=r||C.bbox,eu=new Map;if(Array.isArray(p)&&p.length)for(let e of p){let t=function(e,t){let i=e?.polygon?.coordinates?.[0];if(!Array.isArray(i)||i.length<4)return[];let r=[];for(let e of i){let i=Number(e?.[0]),a=Number(e?.[1]);Number.isFinite(i)&&Number.isFinite(a)&&r.push(function(e,t,i){let r=(0,u.uZ)((t-e[0])/Math.max(1e-9,e[2]-e[0]),0,1),a=(0,u.uZ)((e[3]-i)/Math.max(1e-9,e[3]-e[1]),0,1);return{u:r,v:a}}(t,i,a))}return r.length>=4?r:[]}(e,ed);t.length>=4&&eu.set(e.cellId,t)}let eh=(e,t)=>[{u:t/3,v:e/3},{u:(t+1)/3,v:e/3},{u:(t+1)/3,v:(e+1)/3},{u:t/3,v:(e+1)/3}],em=new Map,ec=eu.size>0;for(let e=0;e<3;e++)for(let t=0;t<3;t++){let i=`${e}-${t}`,r=eu.get(i);if(ec){r&&r.length>=3&&em.set(i,r);continue}em.set(i,r||eh(e,t))}for(let e of Array.from(em.values()))es(e,{color:_?12705279:2576498,opacity:_?.74:.62,lift:.26});if($){let e=`${$.row}-${$.col}`,t=em.get(e);if(!t||t.length<3);else{for(let e of(es(t,{color:9434367,opacity:1,lift:.38}),es(t,{color:16773772,opacity:.86,lift:.48}),t.length>8?t.filter((e,i)=>i%Math.ceil(t.length/8)==0):t)){let t=el(e.u,e.v,.4),r=t.clone();r.y+=2.8;let a=new o.CylinderGeometry(.09,.09,2.8,10),n=new o.MeshStandardMaterial({color:10875900,emissive:947344,emissiveIntensity:.6,roughness:.35}),l=new o.Mesh(a,n);l.position.set(t.x,(t.y+r.y)/2,t.z),i.add(l);let s=function(e){let t=document.createElement("canvas");t.width=64,t.height=64;let i=t.getContext("2d");if(!i)return null;i.clearRect(0,0,64,64),i.fillStyle=e,i.beginPath(),i.arc(32,32,11,0,2*Math.PI),i.fill(),i.strokeStyle="rgba(255,255,255,0.96)",i.lineWidth=4,i.stroke();let r=new o.CanvasTexture(t);r.colorSpace=o.SRGBColorSpace;let a=new o.SpriteMaterial({map:r,transparent:!0,depthTest:!1,depthWrite:!1}),n=new o.Sprite(a);return n.scale.set(1.6,1.6,1),{sprite:n,texture:r,material:a}}("#67e8f9");s&&(s.sprite.position.set(r.x,r.y,r.z),i.add(s.sprite),er.push(()=>{s.texture.dispose(),s.material.dispose()})),er.push(()=>{a.dispose(),n.dispose()})}if(k){let e=t.reduce((e,t)=>e+t.u,0)/Math.max(1,t.length),r=t.reduce((e,t)=>e+t.v,0)/Math.max(1,t.length),a=el(e,r,4.2),n=function(e){let t=document.createElement("canvas");t.width=256,t.height=80;let i=t.getContext("2d");if(!i)return null;i.clearRect(0,0,t.width,t.height),i.fillStyle="rgba(6, 11, 24, 0.82)",i.fillRect(8,12,240,56),i.strokeStyle="rgba(56, 189, 248, 0.95)",i.lineWidth=3,i.strokeRect(8,12,240,56),i.fillStyle="#e2f5ff",i.font='600 34px "IBM Plex Sans", sans-serif',i.textAlign="center",i.textBaseline="middle",i.fillText(e,t.width/2,t.height/2);let r=new o.CanvasTexture(t);r.colorSpace=o.SRGBColorSpace;let a=new o.SpriteMaterial({map:r,transparent:!0,depthTest:!1,depthWrite:!1}),n=new o.Sprite(a);return n.scale.set(14,4.4,1),{sprite:n,texture:r,material:a}}(k);n&&(n.sprite.position.set(a.x,a.y,a.z),i.add(n.sprite),er.push(()=>{n.texture.dispose(),n.material.dispose()}))}}}let ep=!0,ef=()=>{ep&&(f.update(),d.render(i,s),requestAnimationFrame(ef))};ef();let eg=()=>{let e=t.clientWidth||1e3,i=t.clientHeight||420;s.aspect=e/i,s.updateProjectionMatrix(),d.setSize(e,i)};return window.addEventListener("resize",eg),()=>{ea=!0,ep=!1,window.removeEventListener("resize",eg),f.dispose(),H.dispose(),q.geometry.dispose(),q.material.dispose(),W.dispose(),B.dispose(),et.dispose(),K.forEach(e=>e.geometry.dispose()),Q.dispose(),X.dispose(),Y.dispose(),en?.dispose(),eo?.dispose(),er.forEach(e=>e()),d.dispose(),d.domElement.parentNode===t&&t.removeChild(d.domElement)}},[e,C,w,v,b,k,_,P,r?.join(","),JSON.stringify(p||[])]),e)?(0,a.jsxs)("div",{className:"rounded-2xl border border-border bg-card p-3 text-foreground",children:[(0,a.jsxs)("div",{className:"mb-2 flex items-center justify-between",children:[(0,a.jsxs)("p",{className:"flex items-center gap-2 text-sm font-semibold",children:[a.jsx(s.Z,{className:"h-4 w-4 text-sky-300"}),"3D Terrain Viewer"]}),(0,a.jsxs)("div",{className:"text-right text-xs text-muted-foreground",children:[(0,a.jsxs)("p",{children:["Metric: ",x(b)," | ",C?.demSource||C?.source||"loading terrain"]}),(0,a.jsxs)("p",{children:[C?.modelType||"n/a"," | ",C?.demDataset||"n/a",C?.effectiveResolutionMeters?` | ~${C.effectiveResolutionMeters.toFixed(1)}m/pixel`:""]})]})]}),C?.precisionClass==="low"&&a.jsx("div",{className:"mb-2 rounded-lg border border-amber-700/60 bg-amber-500/10 px-2 py-1 text-xs text-amber-800 dark:text-amber-300",children:"Precision warning: DEM resolution is coarse for strict plot-level relief certainty in this AOI."}),S&&(0,a.jsxs)("div",{className:"mb-2 inline-flex items-center gap-2 rounded-lg border border-border px-2 py-1 text-xs text-muted-foreground",children:[a.jsx(d.Z,{className:"h-3.5 w-3.5 animate-spin"}),"Loading DEM for selected AOI"]}),T&&a.jsx("div",{className:"mb-2 rounded-lg border border-rose-700/60 bg-rose-500/10 px-2 py-1 text-xs text-rose-700 dark:text-rose-300",children:T}),!P&&(0,a.jsxs)("div",{className:"mb-2 rounded-lg border border-amber-700/50 bg-amber-500/10 px-2 py-1 text-xs text-amber-800 dark:text-amber-300",children:["Quantitative ",x(b)," grid is unavailable for this run, so numeric color overlay is disabled."]}),a.jsx("div",{ref:y,className:`h-[24rem] w-full overflow-hidden rounded-xl border border-border/70 ${_?"bg-[radial-gradient(120%_100%_at_20%_0%,rgba(22,101,139,0.35)_0%,rgba(6,24,44,0.92)_52%,rgba(4,13,27,0.98)_100%)]":"bg-[radial-gradient(120%_100%_at_15%_0%,rgba(186,230,253,0.9)_0%,rgba(224,242,254,0.76)_45%,rgba(214,226,236,0.94)_100%)]"}`}),(0,a.jsxs)("div",{className:"mt-2 rounded-lg border border-border/80 bg-muted/35 p-2",children:[(0,a.jsxs)("p",{className:"text-[11px] uppercase tracking-[0.14em] text-muted-foreground",children:[x(b)," scale ",P?w?.isSimulated?"(simulated)":"(measured)":"(unavailable)"]}),a.jsx("div",{className:"mt-1 h-3 w-full rounded",style:{backgroundImage:(0,u.G5)(b)}}),(0,a.jsxs)("div",{className:"mt-1 flex items-center justify-between text-[11px] text-muted-foreground",children:[a.jsx("span",{children:P?(R?.min??w?.min??0).toFixed(3):"N/A"}),a.jsx("span",{children:w?.units?w.units:"soil"===b?"m3/m3":"et"===b?"mm/day":"NDVI"}),a.jsx("span",{children:P?(R?.max??w?.max??1).toFixed(3):"N/A"})]})]}),a.jsx("p",{className:"mt-2 text-[11px] text-muted-foreground",children:C?`Topographic surface uses ${C.modelType||"DTM"} elevation from ${C.demSource||C.source}${C.demDataset?` (${C.demDataset})`:""} with ${x(b)} color mapping from ${P?"quantitative grid data":"neutral fallback shading"}. Selected plot point: ${k||"none"}${F?` | mesh ${F.resolution}px${F.smoothed?", smoothed":""}`:""}${C.sourceResolutionMeters?` | source ~${C.sourceResolutionMeters.toFixed(1)}m`:""}${C.effectiveResolutionMeters?` | effective ~${C.effectiveResolutionMeters.toFixed(1)}m`:""}${C.verticalDatum?` | datum ${C.verticalDatum}`:""}${"number"==typeof C.coverage?` | AOI cover ${(100*C.coverage).toFixed(1)}%`:""}${"number"==typeof C.voidFillRatio?` | void fill ${(100*C.voidFillRatio).toFixed(1)}%`:""}.`:"Terrain will appear when providers return valid DEM coverage for this AOI."})]}):null}[o,l,c]=p.then?(await p)():p,r()}catch(e){r(e)}})},1854:(e,t,i)=>{i.d(t,{i:()=>n});var r=i(8098);function a(e,t){if(!e.length)return 0;if(1===e.length)return e[0];let i=(e.length-1)*(0,r.uZ)(t,0,1),a=Math.floor(i),n=Math.ceil(i);return a===n?e[a]:(0,r.t7)(e[a],e[n],i-a)}function n(e){let t=e.demGrid.filter(e=>Number.isFinite(e)).sort((e,t)=>e-t);if(!t.length)throw Error("dem_no_finite_values");let i=a(t,.005),n=a(t,.995),o=Math.min(i,n),l=Math.max(i,n),s=Math.max(.25,l-o),{planeWidth:d,planeHeight:u,span:h}=function(e,t=120){let i=function(e){let t=Math.abs(e[2]-e[0]),i=Math.abs(e[3]-e[1]);return{xMeters:Math.max(1,t*Math.max(1,111320*Math.cos((e[1]+e[3])/2*(Math.PI/180)))),yMeters:Math.max(1,111320*i)}}(e),a=i.xMeters/Math.max(1,i.yMeters);return a>=1?{planeWidth:t,planeHeight:(0,r.uZ)(t/a,.42*t,t),span:i}:{planeWidth:(0,r.uZ)(t*a,.42*t,t),planeHeight:t,span:i}}(e.bbox,120),m=Math.max(1e-6,Math.max(h.xMeters/d,h.yMeters/u)),c=Math.min(d,u),p=Math.max(.05,s/m),f=1.12;if(p>=.18*c)f=1;else if(p>=.12*c)f=1.08;else{let e=(0,r.uZ)(.22*c,14,36);f=(0,r.uZ)(e/p,1.15,s>=1200?14:s>=400?12:s>=120?10:8)}p<.35?f=Math.max(f,6.5):p<.7&&(f=Math.max(f,4.2));let g=new Float32Array(e.width*e.height),x=0;for(let t=0;t<g.length;t++){let i=Number(e.demGrid[t]),a=Number.isFinite(i)?i:o,n=((0,r.uZ)(a,o,l)-o)/m*f;g[t]=n,n>x&&(x=n)}return{planeWidth:d,planeHeight:u,scaledHeight:g,elevationScale:Math.max(1.25,x),reliefMeters:s,exaggeration:f,clippedMin:o,clippedMax:l,metersPerUnit:m}}},8070:(e,t,i)=>{i.a(e,async(e,r)=>{try{i.d(t,{E:()=>l});var a=i(2949),n=i(8098),o=e([a]);function l(e){let t="high"===e.quality?.032:"balanced"===e.quality?.03:.028,i="high"===e.quality?18:"balanced"===e.quality?16:14;return new a.ShaderMaterial({uniforms:{uMaxHeight:{value:e.maxHeight},uDensity:{value:(0,n.uZ)(i+1.2*e.reliefUnits,12,34)},uThickness:{value:t},uOpacity:{value:e.isDarkTheme?.32:.27},uLineColor:{value:new a.Color(e.isDarkTheme?2044745:5203839)}},vertexShader:`
      varying float vHeight;
      uniform float uMaxHeight;
      void main() {
        vHeight = max(0.0, position.z / max(uMaxHeight, 0.001));
        gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
      }
    `,fragmentShader:`
      varying float vHeight;
      uniform float uDensity;
      uniform float uThickness;
      uniform float uOpacity;
      uniform vec3 uLineColor;
      void main() {
        float f = fract(vHeight * uDensity);
        float d = min(f, 1.0 - f);
        float aa = fwidth(vHeight * uDensity) * 0.9;
        float line = 1.0 - smoothstep(uThickness, uThickness + aa, d);
        gl_FragColor = vec4(uLineColor, line * uOpacity);
      }
    `,transparent:!0,depthWrite:!1})}a=(o.then?(await o)():o)[0],r()}catch(e){r(e)}})}};