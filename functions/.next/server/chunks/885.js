"use strict";exports.id=885,exports.ids=[885],exports.modules={2090:(e,t,r)=>{r.d(t,{Z:()=>i});let i=(0,r(1373).Z)("mountain",[["path",{d:"m8 3 4 8 5-5 5 15H2L8 3z",key:"otkl63"}]])},8885:(e,t,r)=>{r.a(e,async(e,i)=>{try{r.r(t),r.d(t,{default:()=>x});var a=r(997),n=r(6689),o=r(2949),s=r(8724),l=r(2090),d=r(6316),u=r(8098),h=r(8625),c=e([o,s]);function p(e){if(!e||!e.includes("-"))return null;let[t,r]=e.split("-"),i=Number(t),a=Number(r);return Number.isFinite(i)&&Number.isFinite(a)?{row:i,col:a}:null}function m(e){let t=e.filter(e=>Number.isFinite(e)),r=t.length?Math.min(...t):0,i=t.length?Math.max(...t):1,a=Math.max(1e-6,i-r);return{min:r,max:i,range:a,apply:e=>(e-r)/a}}function f(e,t,r,i,a){let n=(0,u.uZ)(i,0,1)*(t-1),o=(0,u.uZ)(a,0,1)*(r-1),s=Math.floor(n),l=Math.floor(o),d=Math.min(t-1,s+1),h=Math.min(r-1,l+1),c=n-s,p=(0,u.t7)(e[l*t+s],e[l*t+d],c),m=(0,u.t7)(e[h*t+s],e[h*t+d],c);return(0,u.t7)(p,m,o-l)}function g(e){return"soil"===e?"Soil Moisture":"et"===e?"Evapotranspiration":"NDVI"}function x({open:e,bbox:t,texturePng:r,metricGrid:i,layer:c,selectedCell:x,quality:w="high"}){let b=(0,n.useRef)(null),[y,M]=(0,n.useState)(!1),[v,S]=(0,n.useState)(null),[N,A]=(0,n.useState)(null),[C,j]=(0,n.useState)(null),[T,E]=(0,n.useState)(null),P=(0,n.useMemo)(()=>p(x),[x]),k=(0,n.useMemo)(()=>(function(e){let t=p(e);return t?`P${3*t.row+t.col+1}`:null})(x),[x]),F=(0,n.useMemo)(()=>!!(i&&Array.isArray(i.values)&&i.width>1&&i.height>1&&i.values.length>=i.width*i.height),[i]),[L,D]=(0,n.useState)(()=>"undefined"!=typeof document&&document.documentElement.classList.contains("dark"));return((0,n.useEffect)(()=>{if("undefined"==typeof document)return;let e=document.documentElement,t=()=>D(e.classList.contains("dark"));t();let r=new MutationObserver(t);return r.observe(e,{attributes:!0,attributeFilter:["class"]}),()=>r.disconnect()},[]),(0,n.useEffect)(()=>{if(!e||!t)return;let r=new AbortController,i="high"===w?[128,96,64]:"balanced"===w?[96,64]:[64];return async function(){M(!0),S(null),A(null);try{let e="Terrain fetch failed";for(let a of i){let i=await fetch("/api/terrain/fetch",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({bbox:t,resolution:a,layer:c,quality:w}),signal:r.signal}),n=await i.json().catch(()=>({}));if(!i.ok||!n?.success){e=String(n?.message||n?.error||`Terrain fetch failed (${i.status})`);continue}let o=!!n?.degraded,s=n?.data,l=s&&Array.isArray(s.demGrid)&&s.demGrid.length>0&&Number(s.width)>1&&Number(s.height)>1;if(o||!l){e=String(n?.warnings?.[0]||n?.reason||"Terrain unavailable for the selected AOI.");continue}A(s),j({smoothed:!!(n?.meshMeta?.smoothed??!0),resolution:Number(n?.meshMeta?.resolution||a)}),S(null);return}A(null),S(e)}catch(e){if(r.signal.aborted)return;A(null),S(String(e?.message||"Terrain fetch failed"))}finally{r.signal.aborted||M(!1)}}(),()=>r.abort()},[e,c,t?.join(","),w]),(0,n.useEffect)(()=>{if(!e||!b.current||!N||!Array.isArray(N.demGrid)||0===N.demGrid.length||N.width<2||N.height<2)return;let t=b.current,r=new o.Scene,a=t.clientWidth||1e3,n=t.clientHeight||420,l=new o.PerspectiveCamera(50,a/n,.1,1400);l.position.set(0,90,148);let d=new o.WebGLRenderer({antialias:!0,alpha:!0});d.setSize(a,n),d.setPixelRatio(Math.min(2,window.devicePixelRatio||1)),d.outputColorSpace=o.SRGBColorSpace,d.toneMapping=o.ACESFilmicToneMapping,d.toneMappingExposure=1.02,d.setClearColor(0,0),t.innerHTML="",t.appendChild(d.domElement);let p=new s.OrbitControls(l,d.domElement);p.enableDamping=!0,p.dampingFactor=.08,p.maxPolarAngle=Math.PI/2.03,p.minDistance=30,p.maxDistance=260,p.target.set(0,6,0),r.add(new o.AmbientLight(16777215,L?.74:.66));let g=new o.DirectionalLight(16055295,L?1.12:1.04);g.position.set(130,142,60),r.add(g);let x=new o.DirectionalLight(L?9483519:10664920,L?.5:.42);x.position.set(-120,84,-120),r.add(x);let y=function(e,t,r,i){let a=t*r,n=new Float32Array(a);for(let t=0;t<a;t++){let r=Number(e[t]);n[t]=Number.isFinite(r)?r:0}if(i<=0||t<3||r<3)return n;let{min:o,max:s}=m(Array.from(n)),l=Math.max(.5,(s-o)*.18),d=n;for(let e=0;e<i;e++){let e=new Float32Array(a),i=new Float32Array(a);for(let i=0;i<r;i++)for(let r=0;r<t;r++){let a=i*t+r,n=d[i*t+Math.max(0,r-1)],o=d[a],s=d[i*t+Math.min(t-1,r+1)];e[a]=.2*n+.6*o+.2*s}for(let a=0;a<r;a++)for(let o=0;o<t;o++){let s=a*t+o,d=e[Math.max(0,a-1)*t+o],h=e[s],c=e[Math.min(r-1,a+1)*t+o],p=.2*d+.6*h+.2*c,m=n[s];i[s]=(0,u.uZ)(p,m-l,m+l)}d=i}return d}(N.demGrid,N.width,N.height,"high"===w?4:"balanced"===w?2:1),M=m(Array.from(y)),v="high"===w?42:"balanced"===w?36:31,S=new Float32Array(y.length),A="high"===w?80:"balanced"===w?64:52;for(let e=0;e<y.length;e++){let t=(0,u.uZ)(M.apply(y[e]),0,1),r=Math.pow(t,1.08),i=Math.round(r*A)/A;S[e]=(0,u.t7)(r,i,.68)*v}let C=new o.PlaneGeometry(120,120,N.width-1,N.height-1),j=C.attributes.position;for(let e=0;e<S.length;e++)j.setZ(e,S[e]);j.needsUpdate=!0,C.computeVertexNormals();let T=new o.MeshStandardMaterial({color:L?6254983:9674926,metalness:.03,roughness:.9}),D=new o.Mesh(C,T);D.rotation.x=-Math.PI/2,r.add(D);let G=new o.MeshBasicMaterial({color:16777215,transparent:!0,opacity:.96,side:o.DoubleSide}),_=new o.Mesh(C,G);_.rotation.x=-Math.PI/2,_.position.y=.18,r.add(_);let I=new o.LineSegments(new o.WireframeGeometry(C),new o.LineBasicMaterial({color:L?10072008:2768466,transparent:!0,opacity:L?.14:.1}));I.rotation.x=-Math.PI/2,r.add(I);let B=(e,t)=>f(S,N.width,N.height,e,t),W=new o.MeshStandardMaterial({color:L?5796494:9216951,roughness:.92,metalness:.01,side:o.DoubleSide,transparent:!0,opacity:.96}),H=[];for(let e of["north","south","west","east"]){let t="north"===e||"south"===e?N.width-1:N.height-1,i=function(e,t,r,i,a,n){let s=[],l=[],d=[];for(let n=0;n<=t;n++){let o=n/Math.max(1,t),d=o,u=o;"north"===e?(d=o,u=0):"south"===e?(d=o,u=1):(d="west"===e?0:1,u=o);let h=-i/2+d*i,c=-a/2+u*a,p=r(d,u)+.04,m=h,f=c;"north"===e&&(f-=2.6),"south"===e&&(f+=2.6),"west"===e&&(m-=2.6),"east"===e&&(m+=2.6),s.push(h,p,c),s.push(m,-1.35,f),l.push(d,u),l.push(d,u)}for(let e=0;e<t;e++){let t=2*e;d.push(t,t+1,t+2),d.push(t+1,t+3,t+2)}let u=new o.BufferGeometry;return u.setAttribute("position",new o.Float32BufferAttribute(s,3)),u.setAttribute("uv",new o.Float32BufferAttribute(l,2)),u.setIndex(d),u.computeVertexNormals(),u}(e,t,B,120,120,0),a=new o.Mesh(i,W);r.add(a),H.push(a)}let R=new o.PlaneGeometry(120,120),O=new o.MeshStandardMaterial({color:L?3559530:10860744,roughness:.94,metalness:0,side:o.DoubleSide,transparent:!0,opacity:.94}),z=new o.Mesh(R,O);z.rotation.x=-Math.PI/2,z.position.y=-1.35,r.add(z);let Z=new o.ShaderMaterial({uniforms:{uMaxHeight:{value:v},uDensity:{value:"high"===w?38:"balanced"===w?32:26},uThickness:{value:.034},uOpacity:{value:L?.42:.35},uLineColor:{value:new o.Color(L?2044745:5203839)}},vertexShader:`
        varying float vHeight;
        uniform float uMaxHeight;
        void main() {
          vHeight = max(0.0, position.z / max(uMaxHeight, 0.001));
          gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
        }
      `,fragmentShader:`
        varying float vHeight;
        uniform float uDensity;
        uniform float uThickness;
        uniform float uOpacity;
        uniform vec3 uLineColor;
        void main() {
          float f = fract(vHeight * uDensity);
          float d = min(f, 1.0 - f);
          float aa = fwidth(vHeight * uDensity) * 0.9;
          float line = 1.0 - smoothstep(uThickness, uThickness + aa, d);
          gl_FragColor = vec4(uLineColor, line * uOpacity);
        }
      `,transparent:!0,depthWrite:!1}),$=new o.Mesh(C,Z);$.rotation.x=-Math.PI/2,$.position.y=.26,r.add($);let V=[],U=!1,q=null;F||E(null),(async()=>{if(F)try{let e=await function(e,t,r,i){if(!e)throw Error("metric_grid_missing");let a=(0,h.a8)({metric:t,grid:{values:e.values,width:e.width,height:e.height,min:e.min,max:e.max},outputWidth:r,outputHeight:i,contours:!1}),n=new o.CanvasTexture(a.canvas);return n.colorSpace=o.SRGBColorSpace,n.wrapS=o.ClampToEdgeWrapping,n.wrapT=o.ClampToEdgeWrapping,n.needsUpdate=!0,{texture:n,range:a.range}}(i,c,N.width,N.height);if(U){e.texture.dispose();return}let t=d.capabilities.getMaxAnisotropy();(q=e.texture).anisotropy=Math.max(2,Math.min(t,16)),G.map=q,G.needsUpdate=!0,W.map=q,W.needsUpdate=!0,E(e.range)}catch{E(null)}})();let J=(e,t,r=0)=>{let i=-60+120*e,a=-60+120*t,n=f(S,N.width,N.height,e,t)+r;return new o.Vector3(i,n,a)},Q=(e,t,i,a,n)=>{let s=[J(e,i,n?.lift??.18),J(t,i,n?.lift??.18),J(t,a,n?.lift??.18),J(e,a,n?.lift??.18)],l=new o.BufferGeometry().setFromPoints(s),d=new o.LineBasicMaterial({color:n?.color??(L?14083583:2046546),transparent:!0,opacity:n?.opacity??(L?.76:.6),linewidth:n?.lineWidth??1,depthTest:!1,depthWrite:!1}),u=new o.LineLoop(l,d);return r.add(u),V.push(()=>{l.dispose(),d.dispose()}),u};for(let e=0;e<3;e++)for(let t=0;t<3;t++)Q(t/3,(t+1)/3,e/3,(e+1)/3,{color:L?12705279:2576498,opacity:L?.74:.62,lift:.26});if(P){let e=P.col/3,t=(P.col+1)/3,i=P.row/3,a=(P.row+1)/3,n=[{u:e,v:i},{u:t,v:i},{u:t,v:a},{u:e,v:a}],s=new o.BufferGeometry().setFromPoints([J(e,i,.2),J(t,i,.2),J(t,a,.2),J(e,a,.2)]);s.setIndex([0,1,2,0,2,3]),s.computeVertexNormals();let l=new o.MeshBasicMaterial({color:5101823,transparent:!0,opacity:.21,depthTest:!1,depthWrite:!1,side:o.DoubleSide}),d=new o.Mesh(s,l);for(let u of(r.add(d),V.push(()=>{s.dispose(),l.dispose()}),Q(e,t,i,a,{color:9434367,opacity:1,lift:.38}),Q(e,t,i,a,{color:16773772,opacity:.86,lift:.48}),n)){let e=J(u.u,u.v,.4),t=e.clone();t.y+=2.8;let i=new o.CylinderGeometry(.09,.09,2.8,10),a=new o.MeshStandardMaterial({color:10875900,emissive:947344,emissiveIntensity:.6,roughness:.35}),n=new o.Mesh(i,a);n.position.set(e.x,(e.y+t.y)/2,e.z),r.add(n);let s=function(e){let t=document.createElement("canvas");t.width=64,t.height=64;let r=t.getContext("2d");if(!r)return null;r.clearRect(0,0,64,64),r.fillStyle=e,r.beginPath(),r.arc(32,32,11,0,2*Math.PI),r.fill(),r.strokeStyle="rgba(255,255,255,0.96)",r.lineWidth=4,r.stroke();let i=new o.CanvasTexture(t);i.colorSpace=o.SRGBColorSpace;let a=new o.SpriteMaterial({map:i,transparent:!0,depthTest:!1,depthWrite:!1}),n=new o.Sprite(a);return n.scale.set(1.6,1.6,1),{sprite:n,texture:i,material:a}}("#67e8f9");s&&(s.sprite.position.set(t.x,t.y,t.z),r.add(s.sprite),V.push(()=>{s.texture.dispose(),s.material.dispose()})),V.push(()=>{i.dispose(),a.dispose()})}if(k){let n=(e+t)/2,s=(i+a)/2,l=J(n,s,4.2),d=function(e){let t=document.createElement("canvas");t.width=256,t.height=80;let r=t.getContext("2d");if(!r)return null;r.clearRect(0,0,t.width,t.height),r.fillStyle="rgba(6, 11, 24, 0.82)",r.fillRect(8,12,240,56),r.strokeStyle="rgba(56, 189, 248, 0.95)",r.lineWidth=3,r.strokeRect(8,12,240,56),r.fillStyle="#e2f5ff",r.font='600 34px "IBM Plex Sans", sans-serif',r.textAlign="center",r.textBaseline="middle",r.fillText(e,t.width/2,t.height/2);let i=new o.CanvasTexture(t);i.colorSpace=o.SRGBColorSpace;let a=new o.SpriteMaterial({map:i,transparent:!0,depthTest:!1,depthWrite:!1}),n=new o.Sprite(a);return n.scale.set(14,4.4,1),{sprite:n,texture:i,material:a}}(k);d&&(d.sprite.position.set(l.x,l.y,l.z),r.add(d.sprite),V.push(()=>{d.texture.dispose(),d.material.dispose()}))}}let K=!0,X=()=>{K&&(p.update(),d.render(r,l),requestAnimationFrame(X))};X();let Y=()=>{let e=t.clientWidth||1e3,r=t.clientHeight||420;l.aspect=e/r,l.updateProjectionMatrix(),d.setSize(e,r)};return window.addEventListener("resize",Y),()=>{U=!0,K=!1,window.removeEventListener("resize",Y),p.dispose(),C.dispose(),I.geometry.dispose(),I.material.dispose(),T.dispose(),G.dispose(),Z.dispose(),H.forEach(e=>e.geometry.dispose()),W.dispose(),R.dispose(),O.dispose(),q?.dispose(),V.forEach(e=>e()),d.dispose(),d.domElement.parentNode===t&&t.removeChild(d.domElement)}},[e,N,i,x,c,w,k,L,F]),e)?(0,a.jsxs)("div",{className:"rounded-2xl border border-border bg-card p-3 text-foreground",children:[(0,a.jsxs)("div",{className:"mb-2 flex items-center justify-between",children:[(0,a.jsxs)("p",{className:"flex items-center gap-2 text-sm font-semibold",children:[a.jsx(l.Z,{className:"h-4 w-4 text-sky-300"}),"3D Terrain Viewer"]}),(0,a.jsxs)("p",{className:"text-xs text-muted-foreground",children:["Metric: ",g(c)," | ",N?.source||"loading terrain"]})]}),y&&(0,a.jsxs)("div",{className:"mb-2 inline-flex items-center gap-2 rounded-lg border border-border px-2 py-1 text-xs text-muted-foreground",children:[a.jsx(d.Z,{className:"h-3.5 w-3.5 animate-spin"}),"Loading DEM for selected AOI"]}),v&&a.jsx("div",{className:"mb-2 rounded-lg border border-rose-700/60 bg-rose-500/10 px-2 py-1 text-xs text-rose-700 dark:text-rose-300",children:v}),!F&&(0,a.jsxs)("div",{className:"mb-2 rounded-lg border border-amber-700/50 bg-amber-500/10 px-2 py-1 text-xs text-amber-800 dark:text-amber-300",children:["Quantitative ",g(c)," grid is unavailable for this run, so numeric color overlay is disabled."]}),a.jsx("div",{ref:b,className:`h-[24rem] w-full overflow-hidden rounded-xl border border-border/70 ${L?"bg-[radial-gradient(120%_100%_at_20%_0%,rgba(22,101,139,0.35)_0%,rgba(6,24,44,0.92)_52%,rgba(4,13,27,0.98)_100%)]":"bg-[radial-gradient(120%_100%_at_15%_0%,rgba(186,230,253,0.9)_0%,rgba(224,242,254,0.76)_45%,rgba(214,226,236,0.94)_100%)]"}`}),(0,a.jsxs)("div",{className:"mt-2 rounded-lg border border-border/80 bg-muted/35 p-2",children:[(0,a.jsxs)("p",{className:"text-[11px] uppercase tracking-[0.14em] text-muted-foreground",children:[g(c)," scale ",F?i?.isSimulated?"(simulated)":"(measured)":"(unavailable)"]}),a.jsx("div",{className:"mt-1 h-3 w-full rounded",style:{backgroundImage:(0,u.G5)(c)}}),(0,a.jsxs)("div",{className:"mt-1 flex items-center justify-between text-[11px] text-muted-foreground",children:[a.jsx("span",{children:F?(T?.min??i?.min??0).toFixed(3):"N/A"}),a.jsx("span",{children:i?.units?i.units:"soil"===c?"m3/m3":"et"===c?"mm/day":"NDVI"}),a.jsx("span",{children:F?(T?.max??i?.max??1).toFixed(3):"N/A"})]})]}),a.jsx("p",{className:"mt-2 text-[11px] text-muted-foreground",children:N?`High-fidelity topographic surface using ${g(c)} color mapping from ${F?"quantitative grid data":"neutral fallback shading"}. Selected plot point: ${k||"none"}${C?` | mesh ${C.resolution}px${C.smoothed?", smoothed":""}`:""}.`:"Terrain will appear when providers return valid DEM coverage for this AOI."})]}):null}[o,s]=c.then?(await c)():c,i()}catch(e){i(e)}})}};