"use strict";exports.id=121,exports.ids=[121],exports.modules={6249:(e,t)=>{Object.defineProperty(t,"l",{enumerable:!0,get:function(){return function e(t,r){return r in t?t[r]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,r)):"function"==typeof t&&"default"===r?t:void 0}}})},468:(e,t,r)=>{r.a(e,async(e,i)=>{try{r.d(t,{J:()=>y,i:()=>N});var a=r(1253),n=r(1593),o=e([n]);n=(o.then?(await o)():o)[0];let S=`//VERSION=3
function setup(){
  return {
    input: [{ bands:["B04","B08"], units: "REFLECTANCE" }],
    output: { bands: 1, sampleType: "FLOAT32" }
  }
}
function evaluatePixel(s){
  let ndvi = (s.B08 - s.B04) / (s.B08 + s.B04)
  if (!isFinite(ndvi)) ndvi = 0
  return [ndvi]
}`,x=`//VERSION=3
function setup(){
  return { input:[{ bands:["B04","B08"], units: "REFLECTANCE" }], output: { bands: 3 } }
}
function evaluatePixel(s){
  let v = (s.B08 - s.B04) / (s.B08 + s.B04)
  if (!isFinite(v)) v = 0
  let r,g,b
  if (v < 0){ r=128; g=0; b=38 }
  else if (v < 0.2){ r=255; g=255; b=178 }
  else if (v < 0.4){ r=127; g=201; b=127 }
  else { r=27; g=120; b=55 }
  return [r/255, g/255, b/255]
}`;class E extends Error{constructor(e,t){super(e),this.name="IngestPipelineError",this.failures=t}}async function s(e,t={},r=25e3){let i=new AbortController,a=setTimeout(()=>i.abort(),r);try{return await fetch(e,{...t,signal:i.signal})}finally{clearTimeout(a)}}function l(e,t,r){return Math.max(t,Math.min(r,e))}function u(e,t=6){let r=Math.pow(10,t);return Math.round(e*r)/r}function d(e){if(e&&e.includes("/")){let[t,r]=e.split("/"),i=new Date(t),a=new Date(r);if(!Number.isNaN(i.getTime())&&!Number.isNaN(a.getTime()))return{fromDate:i,toDate:a,datetime:`${t}/${r}`}}let t=new Date,r=new Date(t.getTime()-3888e6);return{fromDate:r,toDate:t,datetime:`${r.toISOString().slice(0,10)}/${t.toISOString().slice(0,10)}`}}function c(e){let t=new URL("https://planetarycomputer.microsoft.com/api/data/v1/item/preview.png");return t.searchParams.set("collection","sentinel-2-l2a"),t.searchParams.set("item",e.itemId),t.searchParams.set("assets",e.band),t.searchParams.set("asset_bidx",`${e.band}|1`),t.searchParams.set("nodata","0"),t.searchParams.set("format","png"),t.searchParams.set("rescale","0,3000"),t.searchParams.set("bbox",e.bbox.join(",")),t.searchParams.set("width",String(e.width)),t.searchParams.set("height",String(e.height)),t.toString()}function h(e,t){if(!e.length)return 0;if(1===e.length)return e[0];let r=(e.length-1)*t,i=Math.floor(r),a=Math.ceil(r);if(i===a)return e[i];let n=r-i;return e[i]*(1-n)+e[a]*n}function f(e,t,r,i){let a=[];for(let n=0;n<3;n++)for(let o=0;o<3;o++){let s=Math.floor(o/3*t),l=Math.floor((o+1)/3*t),d=Math.floor(n/3*r),c=Math.floor((n+1)/3*r),h=Number.POSITIVE_INFINITY,f=Number.NEGATIVE_INFINITY,m=0,p=0,g=0,b=Math.max(1,(l-s)*(c-d));for(let r=d;r<c;r++)for(let a=s;a<l;a++){let n=r*t+a,o=Number(e[n]);Number.isFinite(o)&&(p+=1,h=Math.min(h,o),f=Math.max(f,o),m+=o,i?.[n]&&(g+=1))}let w=p?m/p:0,_=i?g/b:p/b;a.push({cellId:`${n}-${o}`,row:n,col:o,mean:u(w,4),min:u(p?h:0,4),max:u(p?f:0,4),validPixelRatio:u(_,4),stressLevel:_<.1?"unknown":w<.28?"high":w<.42?"moderate":"low"})}return a}function m(e,t,r,i=128){let a=Math.max(1,Math.min(i,t)),n=Math.max(1,Math.min(i,r)),o=new Float32Array(a*n),s=Number.POSITIVE_INFINITY,l=Number.NEGATIVE_INFINITY;for(let i=0;i<n;i++){let u=Math.floor(i/n*r),d=Math.min(r,Math.ceil((i+1)/n*r));for(let r=0;r<a;r++){let n=Math.floor(r/a*t),c=Math.min(t,Math.ceil((r+1)/a*t)),h=0,f=0;for(let r=u;r<d;r++)for(let i=n;i<c;i++){let a=e[r*t+i];Number.isFinite(a)&&(h+=a,f+=1)}let m=f?h/f:0;o[i*a+r]=m,s=Math.min(s,m),l=Math.max(l,m)}}return Number.isFinite(s)&&Number.isFinite(l)||(s=0,l=0),{values:o,width:a,height:n,min:s,max:l}}function p(e){return Buffer.from(e.buffer,e.byteOffset,e.byteLength).toString("base64")}async function g(e){let t=d(e.date),r=await s("https://planetarycomputer.microsoft.com/api/stac/v1/search",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({bbox:e.bbox,datetime:e.date,collections:["sentinel-2-l2a"],limit:16,sortby:[{field:"properties.datetime",direction:"desc"}]})});if(!r.ok)throw Error(`stac_search_failed_${r.status}`);let i=await r.json(),n=function(e,t,r){let i=new Date;return[...e].filter(e=>e?.id&&e?.assets?.B04?.href&&e?.assets?.B08?.href).map(e=>({item:e,score:function(e,t,r,i,a){let n=e?.properties?.datetime?new Date(e.properties.datetime):null,o="number"==typeof e?.properties?.["eo:cloud_cover"]?e.properties["eo:cloud_cover"]:100,s=n?(r.getTime()-n.getTime())/864e5:365,u=l(1-s/90,0,1),d=l(1-o/100,0,1);return"lowest-cloud"===t?.8*d+.2*u:"most-recent"===t?.85*u+.15*d:.6*u+.4*d+(n&&n>=i&&n<=a?.1:0)}(e,t,i,r.fromDate,r.toDate)})).sort((e,t)=>t.score-e.score)[0]?.item}(i.features||[],e.policy,t);if(!n)throw Error("no_imagery_found");let o=c({itemId:n.id,bbox:e.bbox,band:"B04",width:e.targetSize,height:e.targetSize}),g=c({itemId:n.id,bbox:e.bbox,band:"B08",width:e.targetSize,height:e.targetSize}),[b,w]=await Promise.all([s(o,{},25e3),s(g,{},25e3)]);if(!b.ok||!w.ok)throw Error(`band_fetch_failed_${b.status}_${w.status}`);let[_,v]=await Promise.all([b.arrayBuffer().then(e=>Buffer.from(e)),w.arrayBuffer().then(e=>Buffer.from(e))]),y=function(e,t){let r=a.PNG.sync.read(e),i=a.PNG.sync.read(t);if(r.width!==i.width||r.height!==i.height)throw Error("band_dimension_mismatch");let n=r.width,o=r.height,s=n*o,d=new Float32Array(s),c=new Uint8Array(s),f=Number.POSITIVE_INFINITY,m=Number.NEGATIVE_INFINITY,p=0,g=0,b=[];for(let e=0;e<s;e++){let t=4*e,a=r.data[t],n=i.data[t],o=n+a,s=0;o>0&&(s=l((n-a)/o,-1,1),c[e]=1,g+=1,b.push(s),f=Math.min(f,s),m=Math.max(m,s),p+=s),d[e]=s}b.sort((e,t)=>e-t);let w=g?p/g:0,_=g?h(b,.1):0,v=g?h(b,.9):0;return{ndviValues:d,width:n,height:o,stats:{min:u(g?f:0),max:u(g?m:0),mean:u(w),p10:u(_),p90:u(v)},validPixelRatio:u(g/Math.max(1,s),4),validMask:c}}(_,v),N=function(e,t,r){let i=new a.PNG({width:t,height:r});for(let t=0;t<e.length;t++){let[r,a,n]=function(e){let t=l(e,-1,1);return t<-.1?[42,69,135]:t<0?[121,164,207]:t<.2?[231,204,126]:t<.4?[170,196,106]:t<.6?[90,161,83]:t<.8?[46,120,64]:[22,86,53]}(e[t]),o=4*t;i.data[o]=r,i.data[o+1]=a,i.data[o+2]=n,i.data[o+3]=255}return a.PNG.sync.write(i).toString("base64")}(y.ndviValues,y.width,y.height),S=f(y.ndviValues,y.width,y.height,y.validMask),x=m(y.ndviValues,y.width,y.height,128);return{provider:"planetary-computer-preview",fallbackUsed:!1,imagery:{id:String(n.id),date:n?.properties?.datetime||null,cloudCover:"number"==typeof n?.properties?.["eo:cloud_cover"]?n.properties["eo:cloud_cover"]:null,platform:n?.properties?.platform||null},bbox:e.bbox,ndvi:{previewPng:N,width:y.width,height:y.height,metricGrid:{encoded:p(x.values),width:x.width,height:x.height,min:u(x.min,4),max:u(x.max,4)},stats:y.stats,validPixelRatio:y.validPixelRatio,grid3x3:S}}}async function b(){let e=process.env.SENTINEL_HUB_CLIENT_ID,t=process.env.SENTINEL_HUB_CLIENT_SECRET;if(!e||!t)return null;let r=await s("https://services.sentinel-hub.com/oauth/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({grant_type:"client_credentials",client_id:e,client_secret:t})});return r.ok?(await r.json()).access_token:null}async function w(){let e=process.env.SENTINEL_HUB_CLIENT_ID,t=process.env.SENTINEL_HUB_CLIENT_SECRET;if(!e||!t)return null;let r=await s("https://identity.dataspace.copernicus.eu/auth/realms/CDSE/protocol/openid-connect/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({grant_type:"client_credentials",client_id:e,client_secret:t})});return r.ok?(await r.json()).access_token:null}async function _(e){let t=await b(),r="https://services.sentinel-hub.com/api/v1/process",i="sentinel-hub-classic";if(t||(t=await w(),r="https://sh.dataspace.copernicus.eu/api/v1/process",i="sentinel-hub-cdse"),!t)throw Error("sentinel_credentials_missing_or_invalid");let[a,o]=e.date.split("/"),d=`${a}T00:00:00Z`,c=`${o}T23:59:59Z`,g={bounds:{bbox:e.bbox,properties:{crs:"http://www.opengis.net/def/crs/OGC/1.3/CRS84"}},data:[{type:"S2L2A",dataFilter:{timeRange:{from:d,to:c},mosaickingOrder:"leastCC"}}]},_=await s(r,{method:"POST",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},body:JSON.stringify({input:g,evalscript:S,output:{responses:[{identifier:"default",format:{type:"image/tiff"}}],width:e.targetSize,height:e.targetSize}})});if(!_.ok)throw Error(`sentinel_tiff_process_failed_${_.status}`);let v=await _.arrayBuffer(),y=await (0,n.fromArrayBuffer)(v),N=await y.getImage(),E=await N.readRasters({interleave:!0}),P=new Float32Array(E.length),I=new Uint8Array(E.length),T=[];for(let e=0;e<E.length;e++){let t=Number(E[e]);if(!Number.isFinite(t)){P[e]=0;continue}let r=l(t,-1,1);P[e]=r,I[e]=1,T.push(r)}T.sort((e,t)=>e-t);let B=T.length?T[0]:0,A=T.length?T[T.length-1]:0,M=T.length?T.reduce((e,t)=>e+t,0)/T.length:0,C=T.length?h(T,.1):0,O=T.length?h(T,.9):0,L=await s(r,{method:"POST",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},body:JSON.stringify({input:g,evalscript:x,output:{responses:[{identifier:"default",format:{type:"image/png"}}],width:e.targetSize,height:e.targetSize}})});if(!L.ok)throw Error(`sentinel_png_process_failed_${L.status}`);let F=Buffer.from(await L.arrayBuffer()),R=f(P,e.targetSize,e.targetSize,I),k=m(P,e.targetSize,e.targetSize,128);return{provider:"sentinel-hub-cdse",fallbackUsed:!0,imagery:{id:`${i}:${a}-${o}`,date:null,cloudCover:null,platform:"Sentinel-2"},bbox:e.bbox,ndvi:{previewPng:F.toString("base64"),width:e.targetSize,height:e.targetSize,metricGrid:{encoded:p(k.values),width:k.width,height:k.height,min:u(k.min,4),max:u(k.max,4)},stats:{min:u(B),max:u(A),mean:u(M),p10:u(C),p90:u(O)},validPixelRatio:u(T.length/Math.max(1,P.length),4),grid3x3:R}}}function v(e,t){let r=t instanceof Error?t.message:"unknown_error";return{provider:e,code:r,message:r}}async function y(e){let t=function(e){let t=(e.bbox||[]).map(Number);if(!Array.isArray(t)||4!==t.length||t.some(e=>Number.isNaN(e)))throw Error("bbox_required");let r=e.targetSize&&[256,512,1024].includes(e.targetSize)?e.targetSize:512,i=e.policy||"balanced",{datetime:a}=d(e.date);return{bbox:t,date:a,policy:i,targetSize:r}}(e),r=[],i=[];try{let e=await g(t);return e.ndvi.validPixelRatio<.5&&i.push("Low valid pixel ratio detected. Consider adjusting date range or bbox."),{result:e,warnings:i}}catch(e){r.push(v("planetary-computer-preview",e)),i.push("Primary free satellite provider failed; attempting fallback provider.")}try{return{result:await _(t),warnings:i}}catch(e){throw r.push(v("sentinel-hub-cdse",e)),new E("all_providers_failed",r)}}function N(e){return e instanceof E?{error:"all_providers_failed",message:"No satellite providers were able to process this request.",providers:e.failures}:e instanceof Error&&"bbox_required"===e.message?{error:"bbox_required",message:"Bounding box [minLon,minLat,maxLon,maxLat] is required.",providers:[]}:{error:"ingest_failed",message:e instanceof Error?e.message:"Unknown ingest error",providers:[]}}i()}catch(e){i(e)}})},7153:(e,t)=>{var r;Object.defineProperty(t,"x",{enumerable:!0,get:function(){return r}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(r||(r={}))},1802:(e,t,r)=>{e.exports=r(145)}};