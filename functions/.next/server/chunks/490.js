"use strict";exports.id=490,exports.ids=[490],exports.modules={6249:(e,t)=>{Object.defineProperty(t,"l",{enumerable:!0,get:function(){return function e(t,i){return i in t?t[i]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,i)):"function"==typeof t&&"default"===i?t:void 0}}})},535:(e,t,i)=>{i.d(t,{D:()=>d,_:()=>c});var n=i(2509),r=i.n(n);class a extends Error{constructor(e,t){super(e),this.name="FirebaseAdminConfigError",this.code="firebase_admin_misconfigured",this.hint=t}}let s="idle",o=null;function l(){if("ready"!==s){if("failed"===s&&o)throw o;try{if(!r().apps.length){let e=process.env.FIREBASE_SERVICE_ACCOUNT_JSON;if(e){let t=function(e){let t;try{t=JSON.parse(e)}catch{throw new a("FIREBASE_SERVICE_ACCOUNT_JSON is not valid JSON.","Use a single-line JSON string from your Firebase service account key.")}if(!t||"object"!=typeof t)throw new a("FIREBASE_SERVICE_ACCOUNT_JSON is missing or invalid.","Set FIREBASE_SERVICE_ACCOUNT_JSON to the full service account JSON.");let i=String(t.private_key||"").replace(/\\n/g,"\n").trim();if(!(i.startsWith("-----BEGIN PRIVATE KEY-----")&&i.endsWith("-----END PRIVATE KEY-----")))throw new a("Firebase private key is not in valid PEM format.","Ensure private_key contains BEGIN/END markers and escaped newlines (\\\\n) in .env.");return{...t,private_key:i}}(e);r().initializeApp({credential:r().credential.cert(t),projectId:t.project_id||"brightbite-81e92"})}else r().initializeApp()}s="ready",o=null}catch(e){throw s="failed",o=function(e){if(e instanceof a)return e;let t=String(e?.message||e||"Unknown Firebase Admin error"),i=t.toLowerCase();return i.includes("pem")||i.includes("private key")||i.includes("credential")?new a(t,"Rotate and re-add FIREBASE_SERVICE_ACCOUNT_JSON. Ensure private_key newline escaping is correct."):e instanceof Error?e:Error(t)}(e)}}}function c(){return l(),r().firestore()}function d(){return l(),r().auth()}},9685:(e,t,i)=>{i.d(t,{d7:()=>j,Cb:()=>F,ge:()=>T});var n=i(6113);function r(e){if(!e.length)return 0;let t=[...e].sort((e,t)=>e-t),i=Math.floor(t.length/2);return t.length%2?t[i]:(t[i-1]+t[i])/2}function a(e,t,i){return Math.max(t,Math.min(i,e))}function s(e,t=4){let i=Math.pow(10,t);return Math.round(e*i)/i}function o(e){return e.length?e.reduce((e,t)=>e+t,0)/e.length:0}function l(e){if(e.length<2)return 0;let t=e.length,i=(t-1)/2,n=o(e),r=0,a=0;for(let s=0;s<t;s++)r+=(s-i)*(e[s]-n),a+=Math.pow(s-i,2);return a?r/a:0}function c(e){return e.length?e.reduce((e,t)=>e+t,0)/e.length:0}function d(e,t){return e.length?c(e.slice(Math.max(0,e.length-t))):0}function u(e,t,i){return Math.max(t,Math.min(i,e))}function m(e,t=4){let i=Math.pow(10,t);return Math.round(e*i)/i}function h(e,t){let i=u((.2-t.soilMoistureMean)*2.4,0,1),n=u((t.temperature-30)/12,0,1),r=u((t.etMean-5.5)/5,0,1),a=u((.42-e)*1.8,0,1);return u(.45*a+.25*i+.2*n+.1*r,0,1)}var f=i(1253);function g(e,t,i){return Math.max(t,Math.min(i,e))}let p={irrigation:["irrigation","water","moisture","drip","schedule","soil","stress","evapotranspiration","et"],stress:["stress","ndvi","decline","canopy","health","yellow","wilt","anomaly","hotspot"],fertility:["fertility","nutrient","nitrogen","phosphorus","potassium","soil test","deficiency"],"disease-risk":["disease","fungal","blight","humidity","outbreak","pest","leaf spot"],forecast:["forecast","next week","next month","trend","predict","projection","outlook"],actions:["what should i do","next step","plan","action","recommendation","task list"],"what-if":["what if","simulate","scenario","tradeoff","water budget","yield target"],general:["overview","summary","status","field"]};function y(e,t){let i=function(e){let t={};for(let i of e)t[i]=(t[i]||0)+1;let i=e.length||1;return Object.keys(t).forEach(e=>{t[e]=t[e]/i}),t}(e),n={};return Object.keys(i).forEach(e=>{n[e]=i[e]*(t[e]||0)}),n}let v=["gemini-1.5-flash","gemini-1.5-flash-8b"];class x extends Error{constructor(e,t){super(e),this.name="GeminiUnavailableError",this.attemptedModels=t.attemptedModels,this.retries=t.retries,this.retryAfterMs=t.retryAfterMs,this.lastFailure=t.lastFailure}}function w(e){return"irrigation-plan"===e||"stress-debug"===e||"forecast"===e||"next-actions"===e||"what-if-explainer"===e||"status"===e?e:"status"}function S(e){let t=e.trim();if(!t)return null;try{return JSON.parse(t)}catch{let e=t.match(/```(?:json)?\s*([\s\S]*?)```/i);if(!e?.[1])return null;try{return JSON.parse(e[1].trim())}catch{return null}}}async function M(e,t,i){let n=new AbortController,r=setTimeout(()=>n.abort(),i);try{return await fetch(e,{...t,signal:n.signal})}finally{clearTimeout(r)}}async function b(e,t,i){let n=`https://generativelanguage.googleapis.com/v1beta/models/${encodeURIComponent(t)}:generateContent?key=${encodeURIComponent(e)}`;return await M(n,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)},25e3)}async function A(e){var t,i,n,r;let a;let s=process.env.GEMINI_API_KEY||"AIzaSyC2C7TGobGDzS0oBrN6JGxQH5O7gDY9Pwk";if(!s)return null;let o=function(e){let t=e.toLowerCase().replace(/[^a-z0-9\s-]/g," ").split(/\s+/).filter(Boolean);if(!t.length)return{intent:"general",confidence:.3};let i=Object.values(p).map(e=>e);i.push(t);let n=function(e){let t={};for(let i of e)new Set(i).forEach(e=>{t[e]=(t[e]||0)+1});let i=e.length,n={};return Object.keys(t).forEach(e=>{n[e]=Math.log((i+1)/((t[e]||0)+1))+1}),n}(i),r=y(t,n),a="general",s=0;return Object.keys(p).forEach(t=>{let i=function(e,t){let i=new Set([...Object.keys(e),...Object.keys(t)]),n=0,r=0,a=0;i.forEach(i=>{let s=e[i]||0,o=t[i]||0;n+=s*o,r+=s*s,a+=o*o});let s=Math.sqrt(r)*Math.sqrt(a);return s?n/s:0}(r,y(p[t],n)),o=e.toLowerCase();"what-if"===t&&(o.includes("what if")||o.includes("simulate")||o.includes("scenario"))&&(i+=.22),"actions"===t&&(o.includes("what should i do")||o.includes("next actions"))&&(i+=.2),"irrigation"===t&&(o.includes("water")||o.includes("irrigation"))&&(i+=.12),i>s&&(s=i,a=t)}),{intent:a,confidence:Number(Math.max(.2,Math.min(.99,s)).toFixed(3))}}(e.prompt||""),l=Array.isArray(t=e.history)?t.slice(-10).map(e=>({role:"assistant"===e.role?"model":"user",text:String(e.text||"").slice(0,600)})).filter(e=>!!e.text):[],c=w(e.mode),d=function(e){let t=e.inference,i=Array.isArray(e.context?.grid3x3)?e.context.grid3x3.slice(0,9):[],n=e.selectedCell||e.context?.selectedCell||null,r=n?i.find(e=>String(e?.cellId||"")===String(n)):null;return{objective:e.objective||t.objective||"balanced",mode:w(e.mode),selectedCell:n,selectedCellData:r||null,inference:{summary:t.summary,confidence:t.confidence,dataQuality:t.dataQuality,forecast:t.forecast,anomaly:t.anomaly,featureVector:t.featureVector,recommendations:(t.recommendations||[]).slice(0,4).map(e=>({title:e.title,priority:e.priority,reason:e.reason,actions:(e.actions||[]).slice(0,4),expectedImpact:e.expectedImpact,confidence:e.confidence,timeWindow:e.timeWindow})),tasks:(t.tasks||[]).slice(0,5)},observed:{ndviStats:e.context?.ndviStats||null,soilStats:e.context?.soilStats||null,etStats:e.context?.etStats||null,weather:e.context?.weather||null,timeSeriesSummary:e.context?.timeSeries?.summary||null,grid3x3:i},providerDiagnostics:{providersTried:Array.isArray(e.context?.providersTried)?e.context.providersTried.slice(0,12):[],warnings:[...Array.isArray(e.context?.warnings)?e.context.warnings.slice(0,12):[],...Array.isArray(t?.warnings)?t.warnings.slice(0,12):[]]}}}(e),u=[],m=0,h=null,f="gemini_failed",g=l.map(e=>({role:e.role,parts:[{text:e.text}]}));g.push({role:"user",parts:[{text:JSON.stringify({question:String(e.prompt||"").slice(0,4e3),context:d,outputContract:{answer:"string",rationale:"string",actions:["string"],forecast:"string",mode:"status|irrigation-plan|stress-debug|forecast|next-actions|what-if-explainer"}})}]});let M={systemInstruction:{parts:[{text:"You are AgriSense AI Assistant for farm operations. Answer the user question first in plain language, then provide rationale, actions, and forecast when relevant. Use only provided context and metrics. Never invent unavailable values. If the question references missing context, say exactly what is missing and ask one concise clarifying question. Do not return markdown code fences or raw JSON objects in the answer. Return strict JSON only with keys: answer, rationale, actions, forecast, mode. actions must be an array of 0-5 concise action strings. mode must be one of: status, irrigation-plan, stress-debug, forecast, next-actions, what-if-explainer."}]},contents:g,generationConfig:{temperature:.25,topP:.9,maxOutputTokens:720,responseMimeType:"application/json"}};for(let t of function(){let e=[process.env.GEMINI_MODEL||process.env.AGRISENSE_LLM_MODEL||"gemini-1.5-flash",...String(process.env.GEMINI_FALLBACK_MODELS||"").split(",").map(e=>e.trim()).filter(Boolean),...v],t=[];for(let i of e)t.includes(i)||t.push(i);return t}()){u.includes(t)||u.push(t);for(let d=0;d<=2;d++){let g;try{g=await b(s,t,M)}catch(e){if(f=String(e?.message||"gemini_network_error"),d<2){m+=1,await new Promise(e=>setTimeout(e,350*(d+1)));continue}break}if(!g.ok){let e=await g.text().catch(()=>"");f=`gemini_http_${g.status}:${e.slice(0,220)}`;let t=g.headers.get("retry-after");if(t){let e=Number(t);Number.isFinite(e)&&e>0&&(a=Math.max(a||0,Math.round(1e3*e)))}if((429===(i=g.status)||500===i||502===i||503===i||504===i)&&d<2){m+=1,await new Promise(e=>setTimeout(e,420*(d+1)));continue}break}let p=function(e){let t=(Array.isArray(e?.candidates)?e.candidates:[])[0],i=(Array.isArray(t?.content?.parts)?t.content.parts:[]).find(e=>"string"==typeof e?.text);return String(i?.text||"").trim()}(await g.json().catch(()=>null));if(!p){if(f="gemini_empty_response",d<2){m+=1,await new Promise(e=>setTimeout(e,280*(d+1)));continue}break}let y=S(p),v=function(e){let t=String(e||"").trim();if(!t)return"";let i=t.match(/```(?:json)?\s*([\s\S]*?)```/i);if(i?.[1]&&(t=i[1].trim()),t.startsWith("{")&&t.endsWith("}")||t.startsWith("[")&&t.endsWith("]")){let e=S(t);if(e&&"object"==typeof e){let i=e.answer||e.response||e.text,n="object"==typeof e.data?e.data?.answer||e.data?.text:"",r=String(i||n||"").trim();r&&(t=r)}}if(!t||t.startsWith("{")||t.startsWith("[")){let e=t.match(/"answer"\s*:\s*"([\s\S]*?)"/i);e?.[1]&&(t=(function(e){try{return JSON.parse(`"${e.replace(/\\/g,"\\\\").replace(/"/g,'\\"')}"`)}catch{return e}})(e[1]).replace(/\\n/g,"\n").trim())}return t.replace(/^["'`{[]+/,"").replace(/["'`\]}]+$/,"").replace(/\s+/g," ").trim()}(y?.answer||p);if(!v){if(f="gemini_missing_answer",d<2){m+=1,await new Promise(e=>setTimeout(e,280*(d+1)));continue}break}h=t;let x=String(y?.rationale||"").trim()||void 0,A=String(y?.forecast||"").trim()||void 0,N=Array.isArray(n=y?.actions)?n.map(e=>String(e||"").trim()).filter(Boolean).slice(0,5):[],I=w(y?.mode||c),D=(r=e.inference,[`NDVI mean ${r.featureVector.ndviMean}`,`7-day delta ${r.featureVector.ndviDelta7}`,`30-day delta ${r.featureVector.ndviDelta30}`,`Risk 7d ${Math.round(100*r.forecast.risk7d)}%`,`Anomaly ${Math.round(100*r.anomaly.score)}%`,`Confidence ${Math.round(100*r.confidence)}%`]).slice(0,6);return{backend:"llm-gemini",mode:I,renderModel:"what-if-explainer"===I?"what-if":"status"===I?"status":"qa",intent:o.intent,intentConfidence:o.confidence,usedHistory:l.length>0,answer:v,sections:{rationale:x,actions:N,forecast:A},evidence:D,tasks:e.inference.tasks.slice(0,5),text:function(e,t,i,n,r){let a=[e];return t&&a.push(`Why: ${t}`),i?.length&&a.push(`Actions:
${i.map((e,t)=>`${t+1}. ${e}`).join("\n")}`),n&&a.push(`Forecast: ${n}`),r?.length&&a.push(`Evidence:
- ${r.join("\n- ")}`),a.join("\n\n")}(v,x,N,A,D),llmAttemptedModels:u,llmFinalModel:h,llmRetries:m,llmDegraded:m>0||u.length>1}}}throw new x("gemini_all_models_failed",{attemptedModels:u,retries:m,retryAfterMs:a,lastFailure:f})}var N=i(535);let I="agrisense-ml-v1";async function D(){try{let e=(0,N._)();await e.collection("ml_models").doc(I).set({version:I,updatedAt:new Date().toISOString(),objectiveDefault:"balanced"},{merge:!0})}catch{}}async function k(e){try{let t=(0,N._)();await t.collection("ml_feedback").doc(e.eventId).set({plotId:e.plotId||null,feedback:e.feedback||"neutral",createdAt:new Date().toISOString(),engine:e.result.engine,objective:e.result.objective,confidence:e.result.confidence,dataQuality:e.result.dataQuality,anomaly:e.result.anomaly})}catch{}}function E(e,t,i){return Math.max(t,Math.min(i,e))}function _(e){return e>.72?"high":e>.45?"medium":"low"}function C(e,t){let i="yield"===t?{ndvi:1,water:.58,heat:.52,volatility:.42,momentum:.35}:"water"===t?{ndvi:.72,water:1.08,heat:.44,volatility:.36,momentum:.32}:{ndvi:.88,water:.88,heat:.5,volatility:.4,momentum:.34},n=E((.44-e.ndviMean)*3.2,0,1),r=E(.9*e.moistureDeficitIndex+(.22-e.soilMoistureMean)*2.6,0,1),a=E(.8*e.weatherStressIndex+(e.temperature-30)/12,0,1),s=E((e.ndviVolatility-.1)*5,0,1),o=E(-(2.2*e.ndviDelta7)+-(1.6*e.trendAcceleration),0,1);return E(1/(1+Math.exp(-(n*i.ndvi+r*i.water+a*i.heat+s*i.volatility+o*i.momentum-1.26))),0,1)}function O(e,t,i){return Math.max(t,Math.min(i,e))}function P(e,t=4){let i=Math.pow(10,t);return Math.round(e*i)/i}async function F(e){var t;let i="yield"===(t=e.objective)||"water"===t||"balanced"===t?t:"balanced",p=function(e){let t=e?.ndviData?.stats||e?.context?.ndviStats||{},i=function(e){let t=Array.isArray(e?.context?.timeSeries?.timeSeries)?e.context.timeSeries.timeSeries:Array.isArray(e?.context?.timeSeries?.points)?e.context.timeSeries.points:null;return((Array.isArray(e?.timeSeriesData?.timeSeries)?e.timeSeriesData.timeSeries:Array.isArray(e?.timeSeriesData?.points)?e.timeSeriesData.points:null)||t||[]).map(e=>Number(e?.ndvi)).filter(e=>Number.isFinite(e))}(e),n=String(e?.selectedCell||e?.context?.selectedCell||""),r=(Array.isArray(e?.context?.grid3x3)?e.context.grid3x3:[]).find(e=>String(e?.cellId)===n),u=Number(t?.mean??i[i.length-1]??.45),m=Number.isFinite(Number(r?.mean))?.7*u+.3*Number(r.mean):u,h=Number(t?.min??Math.max(-.2,m-.2)),f=Number(t?.max??Math.min(.95,m+.2)),g=function(e){if(e.length<2)return 0;let t=o(e);return Math.sqrt(e.reduce((e,i)=>e+Math.pow(i-t,2),0)/e.length)}(i),p=l(i.length?i:[m,m]),y=i.length>=7?d(i,3)-c(i.slice(Math.max(0,i.length-10),Math.max(0,i.length-7))):0,v=i.length>=30?d(i,6)-c(i.slice(Math.max(0,i.length-36),Math.max(0,i.length-30))):1.8*y,x=i.length>=8?l(i.slice(-4))-l(i.slice(Math.max(0,i.length-8),Math.max(0,i.length-4))):0,w=i.length>=4?s(o(i.slice(-3))-o(i.slice(-6,-3).length?i.slice(-6,-3):i.slice(-3))):0,S=e?.weatherData?.current||e?.weatherData?.weather||e?.context?.weather?.current||{},M=Number(S?.temperature??S?.temperature_2m??24),b=Number(S?.humidity??S?.relative_humidity_2m??55),A=Number(S?.precipitation??e?.weatherData?.current?.precipitation??1.2),N=e?.soilData?.stats||e?.context?.soilStats||{},I=e?.etData?.stats||e?.context?.etStats||{},D=Number(N?.mean??.24),k=Number(I?.mean??3.4),E=a((.28-D)*3.2+(k-4.1)*.08,0,1),_=a((M-30)*.05+(b>84?.2:0)+.015*A,0,1),C=a(Number(e?.context?.dataLatencyHours||0)/96,0,1);return{ndviMin:s(h),ndviMax:s(f),ndviMean:s(m),ndviSpread:s(Math.max(0,f-h)),ndviDelta7:s(y),ndviDelta30:s(v),ndviTrendSlope:s(p),trendAcceleration:s(x),ndviVolatility:s(g),soilMoistureMean:s(D),moistureDeficitIndex:s(E),etMean:s(k),weatherStressIndex:s(_),temperature:s(M),precipitation:s(A),humidity:s(b),seasonalIndex:s(.5+.5*Math.sin(new Date().getUTCMonth()/12*Math.PI*2-Math.PI/2)),shortTermMomentum:s(w),dataLatencyPenalty:s(C)}}(e),y=function(e){let t=[!!(e?.ndviData?.stats||e?.context?.ndviStats),!!(e?.timeSeriesData?.timeSeries||e?.timeSeriesData?.points||e?.context?.timeSeries),!!(e?.weatherData||e?.context?.weather),!!(e?.soilData||e?.context?.soilStats),!!(e?.etData||e?.context?.etStats)],i=t.filter(Boolean).length/t.length,n=Array.isArray(e?.providersTried)?e.providersTried:[],r=n.filter(e=>e.ok).length,o=n.length?r/n.length:.75,l=[];i<.7&&l.push("Limited input coverage; recommendations are conservative."),o<.6&&l.push("One or more upstream providers reported degraded reliability.");let c=[e?.weatherData?.isSimulated,e?.soilData?.isSimulated,e?.etData?.isSimulated,e?.timeSeriesData?.isSimulated,e?.context?.weather?.isSimulated,e?.context?.timeSeries?.isSimulated].filter(Boolean).length>0;c&&l.push("Some inputs are simulated due to provider outages.");let d=a(.65*i+.35*o-(c?.12:0),0,1);return{completeness:s(i),providerQuality:s(o),score:s(d),isSimulatedInputs:c,warnings:l}}(e),v=function(e,t){let i=function(e,t){let i=e?.timeSeriesData?.timeSeries||e?.context?.timeSeries?.timeSeries||e?.context?.timeSeries||[],n=Array.isArray(i)?i.map(e=>Number(e?.ndvi)).filter(e=>Number.isFinite(e)):[];return n.length?n:[t,t,t,t]}(e,t.ndviMean),n=i.length>=24?12:i.length>=14?7:4,r=function(e,t,i){let n=Math.max(2,Math.min(i,Math.floor(e.length/2))),r=e[0],a=e.length>1?e[1]-e[0]:0,s=Array(n).fill(0);for(let t=0;t<n&&t<e.length;t++)s[t]=e[t]-r;for(let t=0;t<e.length;t++){let i=e[t],o=s[t%n],l=r;a=.25*((r=.45*(i-o)+.55*(r+a))-l)+.75*a,s[t%n]=.2*(i-r)+.8*o}let o=[];for(let t=1;t<=30;t++){let i=s[(e.length+t-1)%n];o.push(r+a*t+i)}return o}(i,0,n),a=r.slice(0,7),s=u(a.reduce((e,t)=>e+t,0)/Math.max(a.length,1),-.3,.95),o=u(r.reduce((e,t)=>e+t,0)/Math.max(r.length,1),-.3,.95);return{ndvi7d:m(s),ndvi30d:m(o),risk7d:m(h(s,t)),risk30d:m(h(o,t)),trend:function(e){if(e.length<3)return"stable";let t=e.slice(0,Math.floor(e.length/2)),i=e.slice(Math.floor(e.length/2)),n=t.reduce((e,t)=>e+t,0)/t.length,r=i.reduce((e,t)=>e+t,0)/i.length-n;return r>.04?"improving":r<-.04?"declining":"stable"}(i)}}(e,p),x=function(e,t){let i=function(e,t){let i=e?.timeSeriesData?.timeSeries||e?.context?.timeSeries?.timeSeries||e?.context?.timeSeries||[],n=Array.isArray(i)?i.map(e=>Number(e?.ndvi)).filter(e=>Number.isFinite(e)):[];return n.length?n:[t,t]}(e,t.ndviMean),n=r(i),a=r(i.map(e=>Math.abs(e-n)))||1e-6,s=(i[i.length-1]-n)/a*.6745,o=Math.max(0,-(2.8*function(e,t=.3){if(!e.length)return 0;let i=e[0];for(let n=1;n<e.length;n++)i=t*e[n]+(1-t)*i;return i}(i.slice(1).map((e,t)=>e-i[t])))),l=2.4*Math.max(0,t.ndviVolatility-.09),c=t.humidity>84?.12:0,d=Math.max(0,Math.min(1,.35*Math.abs(s)+.35*o+l+c)),u=[];return Math.abs(s)>1.6&&u.push("Current NDVI deviates strongly from recent median."),o>.2&&u.push("Short-term NDVI momentum is negative."),l>.14&&u.push("NDVI variance is elevated versus typical baseline."),c>0&&u.push("High humidity can elevate disease pressure."),u.length||u.push("No major anomaly signal detected."),{score:Number(d.toFixed(4)),level:d>.66?"high":d>.38?"moderate":"low",signals:u}}(e,p),w={k:3,clusters:function(e,t){let i=e?.ndviData?.previewPng||e?.context?.ndvi?.previewPng||e?.context?.ndviPreviewPng||"",n=[];if(i)try{n=function(e,t){let i=Buffer.from(e,"base64"),n=f.PNG.sync.read(i),r=Math.max(1,Math.floor(n.width/24)),a=Math.max(1,Math.floor(n.height/24)),s=[];for(let e=0;e<n.height;e+=a)for(let i=0;i<n.width;i+=r){let r=(e*n.width+i)*4,a=n.data[r],o=n.data[r+1],l=(.2126*a+.7152*o+.0722*n.data[r+2])/255;s.push([g(l,0,1),i/Math.max(1,n.width-1),e/Math.max(1,n.height-1),g(t.soilMoistureMean,0,1),g(t.etMean/10,0,1)])}return s}(i,t)}catch{n=[]}return n.length||(n=function(e){let t=function(e){let t=0;for(let i=0;i<e.length;i++)t=(t<<5)-t+e.charCodeAt(i);return()=>(t^=t<<13,t^=t>>17,Math.abs((t^=t<<5)%1e6)/1e6)}(`${e.ndviMean}:${e.ndviSpread}:${e.soilMoistureMean}:${e.etMean}`),i=[];for(let n=0;n<180;n++){let n=t(),r=t(),a=g(e.ndviMean+(t()-.5)*e.ndviSpread,-.1,.95),s=g(e.soilMoistureMean+(t()-.5)*.1,0,1),o=g(e.etMean/10+(t()-.5)*.15,0,1);i.push([a,n,r,s,o])}return i}(t)),function(e,t=3,i=14){if(!e.length)return[];let n=Math.min(t,e.length),r=e.slice(0,n).map(e=>[...e]),a=Array(e.length).fill(0);for(let t=0;t<i;t++){for(let t=0;t<e.length;t++){let i=0,n=Number.POSITIVE_INFINITY;for(let a=0;a<r.length;a++){let s=function(e,t){let i=0;for(let n=0;n<e.length;n++){let r=(e[n]||0)-(t[n]||0);i+=r*r}return Math.sqrt(i)}(e[t],r[a]);s<n&&(n=s,i=a)}a[t]=i}for(let t=0;t<r.length;t++){let i=e.filter((e,i)=>a[i]===t);if(!i.length)continue;let n=r[t].length,s=Array(n).fill(0);for(let e of i)for(let t=0;t<n;t++)s[t]+=e[t];for(let e=0;e<n;e++)s[e]/=i.length;r[t]=s}}return r.map((e,t)=>({id:t,count:a.filter(e=>e===t).length,centroid:e.map(e=>Number(e.toFixed(4)))}))}(n,3,12)}(e,p)},S=function(e,t,i){let n=[],r=C(e,t);return(e.soilMoistureMean<.2||r>.7)&&n.push({id:"irrigation-tighten",title:"Tighten irrigation scheduling",priority:_(Math.max(r,i)),reason:"Soil moisture trend indicates high water stress probability for the next cycle.",actions:["Apply shorter, higher-frequency irrigation events for the next 72 hours.","Inspect emitter uniformity in low-vigor zones.","Re-check NDVI and soil moisture after two irrigation cycles."],expectedImpact:Number((8+12*r).toFixed(1)),confidence:Number((.62+(1-i)*.2).toFixed(3)),timeWindow:"24-72h",evidence:[`Moisture deficit index ${e.moistureDeficitIndex.toFixed(2)}`,`Objective risk ${Math.round(100*r)}%`]}),(e.ndviSpread>.38||e.ndviVolatility>.12)&&n.push({id:"zone-scouting",title:"Run targeted zone scouting",priority:_(e.ndviSpread),reason:"Canopy variability is elevated, which suggests non-uniform stress drivers.",actions:["Scout low-vigor and transition zones first.","Record pest pressure and irrigation delivery observations.","Sample soil nutrients in two representative low-NDVI patches."],expectedImpact:Number((5+15*e.ndviSpread).toFixed(1)),confidence:Number((.58+(1-e.ndviVolatility)*.22).toFixed(3)),timeWindow:"48h",evidence:[`NDVI spread ${e.ndviSpread.toFixed(2)}`,`NDVI volatility ${e.ndviVolatility.toFixed(2)}`]}),e.humidity>82&&e.temperature>24&&n.push({id:"disease-watch",title:"Increase disease surveillance",priority:_(.63),reason:"Warm and humid conditions can increase disease pressure during canopy stress.",actions:["Inspect for foliar disease symptoms in dense canopy sections.","Prioritize morning scouting to detect early infection signs.","Track humidity trend over the next 3 days before intervention."],expectedImpact:Number((4.5+9*e.weatherStressIndex).toFixed(1)),confidence:Number((.56+(1-i)*.18).toFixed(3)),timeWindow:"48-96h",evidence:[`Humidity ${e.humidity.toFixed(0)}%`,`Weather stress index ${e.weatherStressIndex.toFixed(2)}`]}),n.length||n.push({id:"maintain-baseline",title:"Maintain baseline operations",priority:"low",reason:"Current indicators show stable conditions with manageable risk.",actions:["Continue standard irrigation schedule.","Re-run analysis in 5-7 days for drift detection.","Log field notes to improve future recommendation tuning."],expectedImpact:2.8,confidence:.69,timeWindow:"5-7d",evidence:["Risk profile within baseline thresholds."]}),n.slice(0,4)}(p,i,x.score),M=C(p,i),b=1-Math.min(1,Math.abs(v.risk7d-x.score)),A={engine:I,objective:i,confidence:Number(Math.max(.2,Math.min(.99,.6*y.score+.25*b+(1-M)*.15)).toFixed(4)),dataQuality:y,isSimulatedInputs:y.isSimulatedInputs,featureVector:p,forecast:v,anomaly:x,zones:w,recommendations:S,tasks:S.map((e,t)=>({id:`task-${t+1}-${e.id}`,title:e.title,impact:e.expectedImpact,confidence:e.confidence,timeWindow:e.timeWindow,owner:e.id.includes("irrigation")?"irrigation":e.id.includes("zone")?"scouting":"operations"})),providersTried:Array.isArray(e.providersTried)?e.providersTried:[],warnings:[...y.warnings]},N={...A,summary:function(e){let t=Math.round(100*e.forecast.risk7d),i="improving"===e.forecast.trend?"improving":"declining"===e.forecast.trend?"declining":"stable",n="high"===e.anomaly.level?`NDVI volatility is elevated and anomaly risk is ${Math.round(100*e.anomaly.score)}%.`:`Field trend is ${i} with ${t}% 7-day risk.`;return{whatChanged:n,why:e.anomaly.signals[0]||"Signals across NDVI, weather, and moisture are within expected range.",nextActions:e.recommendations[0]?.title||"Continue baseline monitoring.",recheckIn:"high"===e.anomaly.level?"24-48 hours":"5-7 days"}}(A)};return D(),k({eventId:(0,n.randomUUID)(),result:N}),N}async function j(e){let t=await F(e),i=String(e.prompt||""),n=null,r=null;try{n=await A({prompt:i,mode:e.mode,objective:e.objective,selectedCell:e.selectedCell||e?.context?.selectedCell||null,inference:t,history:e.history,context:e.context})}catch(e){n=null,r=e instanceof x?{message:e.message,attemptedModels:e.attemptedModels,retries:e.retries,retryAfterMs:e.retryAfterMs,lastFailure:e.lastFailure}:{message:String(e?.message||"gemini_unavailable"),attemptedModels:[],retries:0}}return{inference:t,chat:n,llmUnavailable:r}}function T(e,t){return function(e,t){let i=O(Number(t?.irrigationDelta||0),-.35,.6),n=O(Number(t?.waterBudget||.5),0,1),r=O(Number(t?.fertilizerDelta||0),-.2,.3),a=O(Number(t?.targetRisk||.35),.05,.95),s=O(.45*e.moistureDeficitIndex+.25*e.weatherStressIndex+.8*Math.max(0,.42-e.ndviMean),0,1),o=.52*i+.14*n,l=.1*i+.06*r-.02*e.dataLatencyPenalty,c=O(e.ndviMean+e.ndviDelta30+l,-.2,.95),d=O(s-.55*o+.05*Math.max(0,a-.55),.02,.98),u=P(100*i,1),m=P((c-(e.ndviMean+e.ndviDelta30))*65,1),h=d<s?"Scenario reduces near-term risk; use as next irrigation schedule candidate.":"Scenario increases near-term risk; tighten water plan or reduce stress drivers.",f=O(.55+(1-e.dataLatencyPenalty)*.2+(1-.2*Math.abs(i)),.35,.92);return{baselineRisk7d:P(s),scenarioRisk7d:P(d),baselineNdvi30d:P(e.ndviMean+e.ndviDelta30),scenarioNdvi30d:P(c),waterUseDeltaPct:u,yieldProxyDeltaPct:m,recommendation:h,confidence:P(f)}}(e,t)}},7153:(e,t)=>{var i;Object.defineProperty(t,"x",{enumerable:!0,get:function(){return i}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(i||(i={}))},1802:(e,t,i)=>{e.exports=i(145)}};