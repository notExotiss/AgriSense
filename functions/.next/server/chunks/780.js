"use strict";exports.id=780,exports.ids=[780],exports.modules={6316:(e,t,i)=>{i.d(t,{Z:()=>n});let n=(0,i(1373).Z)("loader-circle",[["path",{d:"M21 12a9 9 0 1 1-6.219-8.56",key:"13zald"}]])},116:(e,t,i)=>{i.d(t,{Z:()=>n});let n=(0,i(1373).Z)("triangle-alert",[["path",{d:"m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3",key:"wmoenq"}],["path",{d:"M12 9v4",key:"juzpu7"}],["path",{d:"M12 17h.01",key:"p32p05"}]])},9780:(e,t,i)=>{i.a(e,async(e,n)=>{try{i.r(t),i.d(t,{default:()=>f});var r=i(997),a=i(6689),o=i(6405),l=i(2949),d=i(8724),s=i(6316),c=i(116),u=e([l,d]);function m(e,t,i){return Math.max(t,Math.min(i,e))}function h(e,t,i,n=2){if(n<=0||t<3||i<3)return e;let r=e;for(let e=0;e<n;e++){let e=new Float32Array(t*i);for(let n=0;n<i;n++)for(let a=0;a<t;a++){let o=n*t+a,l=r[n*t+Math.max(0,a-1)],d=r[n*t+Math.min(t-1,a+1)],s=r[Math.max(0,n-1)*t+a],c=r[Math.min(i-1,n+1)*t+a];e[o]=(l+d+s+c+2*r[o])/6}r=e}return r}function p(e,t,i,n,r){var a,o,l,d;let s=m(n,0,1)*(t-1),c=m(r,0,1)*(i-1),u=Math.floor(s),h=Math.floor(c),p=Math.min(t-1,u+1),x=Math.min(i-1,h+1),f=s-u,g=(a=e[h*t+u],o=e[h*t+p],a+(o-a)*f),v=(l=e[x*t+u],d=e[x*t+p],l+(d-l)*f);return g+(v-g)*(c-h)}async function x(e,t){let i=await new Promise((e,i)=>{let n=new Image;n.onload=()=>e(n),n.onerror=()=>i(Error("hero_texture_load_failed")),n.src=`data:image/png;base64,${t}`}),n=new l.Texture(i);n.colorSpace=l.SRGBColorSpace,n.wrapS=l.ClampToEdgeWrapping,n.wrapT=l.ClampToEdgeWrapping,n.needsUpdate=!0;let r=e.capabilities.getMaxAnisotropy();return n.anisotropy=Math.max(2,Math.min(r,16)),n}function f(){let e=(0,a.useRef)(null),t=(0,a.useRef)(null),[i,n]=(0,a.useState)(null),[u,f]=(0,a.useState)(null),[g,v]=(0,a.useState)(null),[w,b]=(0,a.useState)(!0),[y,M]=(0,a.useState)(null),[N,j]=(0,a.useState)(null),[S,E]=(0,a.useState)("initializing"),[C,F]=(0,a.useState)(!0),T=(0,a.useRef)("initializing"),A=(0,a.useMemo)(()=>u?.legend?.stops||[],[u?.legend?.stops]);return((0,a.useEffect)(()=>{if("undefined"==typeof document)return;let e=document.createElement("div");return e.setAttribute("data-hero-cinematic-root","true"),document.body.appendChild(e),n(e),()=>{e.parentNode&&e.parentNode.removeChild(e)}},[]),(0,a.useEffect)(()=>{T.current="initializing",E("initializing"),F(!0)},[u?.generatedAt]),(0,a.useEffect)(()=>{let e=!0;return b(!0),M(null),(async()=>{try{let t=await fetch("/api/home/hero-map"),i=await t.json().catch(()=>({}));if(!t.ok||!i?.success||!i?.data)throw Error(i?.message||"hero_map_unavailable");if(!e)return;f(i.data)}catch(t){if(!e)return;M(String(t?.message||"hero_map_unavailable"))}finally{e&&b(!1)}})(),()=>{e=!1}},[]),(0,a.useEffect)(()=>{if(!u?.bbox)return;let e=!0;return(async()=>{try{let t=await fetch("/api/terrain/fetch",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({bbox:u.bbox,resolution:128,layer:"ndvi",quality:"high"})}),i=await t.json().catch(()=>({}));if(!e)return;if(!t.ok||!i?.success||i?.degraded||!Array.isArray(i?.data?.demGrid)||!i?.data?.width||!i?.data?.height){v(null);return}let n=i.data.width*i.data.height,r=new Float32Array(n);for(let e=0;e<n;e++){let t=Number(i.data.demGrid?.[e]);r[e]=Number.isFinite(t)?t:0}v({values:r,width:i.data.width,height:i.data.height,source:String(i.data.source||"terrain")})}catch{e&&v(null)}})(),()=>{e=!1}},[u?.bbox?.join(",")]),(0,a.useEffect)(()=>{if(!e.current||!u||C&&i&&!t.current)return;let n=e.current,r=t.current,a=new l.Scene;a.background=new l.Color(14673128);let o=n.clientWidth||900,s=n.clientHeight||520,c=new l.PerspectiveCamera(37,o/s,.1,2200);c.position.set(-24,88,150);let f=new l.WebGLRenderer({antialias:!0,alpha:!1});f.setPixelRatio(Math.min(2,window.devicePixelRatio||1)),f.outputColorSpace=l.SRGBColorSpace,f.toneMapping=l.ACESFilmicToneMapping,f.toneMappingExposure=1;let v=(e,t)=>{let i=Math.max(1,Math.floor(e)),n=Math.max(1,Math.floor(t));f.setSize(i,n,!1),c.aspect=i/n,c.updateProjectionMatrix()};r?(r.innerHTML="",r.style.left="0px",r.style.top="0px",r.style.width=`${window.innerWidth}px`,r.style.height=`${window.innerHeight}px`,r.style.borderRadius="0px",r.style.opacity="1",r.style.boxShadow="none",r.appendChild(f.domElement),v(window.innerWidth,window.innerHeight)):(n.innerHTML="",n.appendChild(f.domElement),v(o,s)),a.add(new l.AmbientLight(16777215,.86));let w=new l.DirectionalLight(16777215,1.08);w.position.set(95,120,58),a.add(w);let b=new l.DirectionalLight(15725558,.55);b.position.set(-95,90,-80),a.add(b);let y=h(function(e,t,i){let n=window.atob(e),r=new Uint8Array(n.length);for(let e=0;e<n.length;e++)r[e]=n.charCodeAt(e);let a=t*i,o=new Float32Array(r.buffer,r.byteOffset,Math.min(a,Math.floor(r.byteLength/4))),l=new Float32Array(a);for(let e=0;e<a;e++){let t=Number(o[e]??0);l[e]=Number.isFinite(t)?t:0}return l}(u.metricGrid.encoded,u.metricGrid.width,u.metricGrid.height),u.metricGrid.width,u.metricGrid.height,2),N=g?h(g.values,g.width,g.height,1):y,S=g?g.width:u.metricGrid.width,A=g?g.height:u.metricGrid.height,k=Math.max(1e-6,Math.abs(u.bbox[2]-u.bbox[0])),P=Math.max(1e-6,Math.abs(u.bbox[3]-u.bbox[1])),R=m(P/k,.62,1.65),G=m(Math.round(220*R),130,300),I=function(e,t,i,n,r){let a=new Float32Array(n*r);for(let o=0;o<r;o++){let l=o/Math.max(1,r-1);for(let r=0;r<n;r++){let d=r/Math.max(1,n-1);a[o*n+r]=p(e,t,i,d,l)}}return a}(N,S,A,220,G),H=function(e){let t=Number.POSITIVE_INFINITY,i=Number.NEGATIVE_INFINITY;for(let n=0;n<e.length;n++){let r=Number(e[n]);Number.isFinite(r)&&(r<t&&(t=r),r>i&&(i=r))}return Number.isFinite(t)&&Number.isFinite(i)&&!(i-t<1e-6)?{min:t,max:i}:{min:0,max:1}}(I),L=Math.max(1e-6,H.max-H.min),$=new Float32Array(I.length),_=g?84:68;for(let e=0;e<I.length;e++){let t=m((I[e]-H.min)/L,0,1),i=Math.pow(t,1.08),n=Math.round(i*_)/_;$[e]=i+(n-i)*.74}let D=162*R,z=new l.PlaneGeometry(162,D,219,G-1),W=z.attributes.position,U=g?62:40;for(let e=0;e<$.length;e++)W.setZ(e,$[e]*U);W.needsUpdate=!0,z.computeVertexNormals();let O=new d.OrbitControls(c,f.domElement);O.enabled=!1,O.enableDamping=!0,O.dampingFactor=.08,O.maxPolarAngle=Math.PI/2.06,O.minDistance=56,O.maxDistance=260,O.target.set(0,18,0);let V=null,B=null,Z=!0,q=0,Y=[],X=null,J=null,K=null,Q=null,ee=new l.Group;ee.rotation.x=-.06,a.add(ee);let et=!r,ei=!1,en=new l.Raycaster,er=new l.Vector2(0,0),ea=null,eo=e=>{if(!ea)return;let t=f.domElement.getBoundingClientRect();er.x=(e.clientX-t.left)/t.width*2-1,er.y=-((e.clientY-t.top)/t.height*2)+1,en.setFromCamera(er,c);let i=en.intersectObject(ea,!1)[0];if(!i||!i.uv){j(null);return}let n=p(y,u.metricGrid.width,u.metricGrid.height,i.uv.x,1-i.uv.y);j({ndvi:n,x:e.clientX-t.left,y:e.clientY-t.top})},el=()=>j(null);f.domElement.addEventListener("pointermove",eo),f.domElement.addEventListener("pointerleave",el),(async()=>{try{if(V=await x(f,u.outlinePng),B=await x(f,u.topoPng),!Z)return;let e=new l.BoxGeometry(170,10,D+8),t=new l.MeshStandardMaterial({color:9410204,roughness:.78,metalness:.04}),i=new l.Mesh(e,t);i.position.set(0,-7.2,0),ee.add(i),Y.push(()=>{e.dispose(),t.dispose()}),Q=new l.MeshStandardMaterial({map:V,color:new l.Color(15922679),metalness:.02,roughness:.84}),(ea=new l.Mesh(z,Q)).rotation.x=-Math.PI/2,ee.add(ea),J=new l.ShaderMaterial({uniforms:{uTopoTex:{value:B},uReveal:{value:.001}},vertexShader:`
            varying vec2 vUv;
            void main() {
              vUv = uv;
              gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
            }
          `,fragmentShader:`
            uniform sampler2D uTopoTex;
            uniform float uReveal;
            varying vec2 vUv;
            void main() {
              if (vUv.x > uReveal + 0.018) discard;
              float edge = smoothstep(uReveal + 0.02, uReveal - 0.02, vUv.x);
              vec4 topo = texture2D(uTopoTex, vUv);
              gl_FragColor = vec4(topo.rgb, edge);
            }
          `,transparent:!0,depthWrite:!1});let o=new l.Mesh(z,J);o.rotation.x=-Math.PI/2,o.position.y=.16,ee.add(o),K=new l.ShaderMaterial({uniforms:{uMaxHeight:{value:U},uDensity:{value:58},uThickness:{value:.048},uOpacity:{value:.72}},vertexShader:`
            varying float vHeight;
            uniform float uMaxHeight;
            void main() {
              vHeight = max(0.0, position.z / max(uMaxHeight, 0.001));
              gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
            }
          `,fragmentShader:`
            varying float vHeight;
            uniform float uDensity;
            uniform float uThickness;
            uniform float uOpacity;
            void main() {
              float f = fract(vHeight * uDensity);
              float d = min(f, 1.0 - f);
              float aa = fwidth(vHeight * uDensity) * 0.9;
              float line = 1.0 - smoothstep(uThickness, uThickness + aa, d);
              gl_FragColor = vec4(vec3(0.16, 0.18, 0.21), line * uOpacity);
            }
          `,transparent:!0,depthWrite:!1});let d=new l.Mesh(z,K);d.rotation.x=-Math.PI/2,d.position.y=.22,ee.add(d);let s=new l.WireframeGeometry(z);X=new l.LineBasicMaterial({color:1712168,transparent:!0,opacity:.12});let h=new l.LineSegments(s,X);h.rotation.x=-Math.PI/2,h.position.y=.1,ee.add(h);let p=performance.now(),g=e=>{T.current!==e&&(T.current=e,E(e))},w=e=>{var t,i,o,l,d,s;if(!Z)return;let u=e-p,h=.001,x=0;u<=520?g("initializing"):u<=2720?(g("revealing"),h=m((u-520)/2200,0,1)):u<=4520?(g("docking"),h=1,x=m((u-520-2200)/1800,0,1)):(g("interactive"),h=1,x=1,O.enabled=!0),J&&(J.uniforms.uReveal.value=h);let b=1-Math.pow(1-x,3);if(c.position.set(-24+32*b,88+28*b,150+56*b),O.target.set(0,18+-10*b,0),ee.scale.setScalar(2.3+-1.2999999999999998*b),ee.position.y=2.6+-3.8*b,ee.rotation.y=7e-5*e+(.22+-.22*b),r&&!et){let e=n.getBoundingClientRect(),a=(t=e.left,0+(t-0)*b),c=(i=e.top,0+(i-0)*b),u=(o=window.innerWidth,l=e.width,o+(l-o)*b),m=(d=window.innerHeight,s=e.height,d+(s-d)*b);r.style.left=`${a}px`,r.style.top=`${c}px`,r.style.width=`${u}px`,r.style.height=`${m}px`,r.style.borderRadius=`${Math.round(0+22*b)}px`,r.style.boxShadow=`0 ${Math.round(0+28*b)}px ${Math.round(0+70*b)}px rgba(0,0,0,${(0+.24*b).toFixed(3)})`,v(u,m)}"interactive"!==T.current||!r||et||(et=!0,n.innerHTML="",n.appendChild(f.domElement),v(n.clientWidth||900,n.clientHeight||520),ei||(ei=!0,F(!1))),O.update(),f.render(a,c),q=requestAnimationFrame(w)};q=requestAnimationFrame(w)}catch(e){if(!Z)return;M(String(e?.message||"hero_render_failed"))}})();let ed=()=>{if(r&&!et){let e=r.getBoundingClientRect();v(e.width,e.height)}else v(n.clientWidth||900,n.clientHeight||520)};return window.addEventListener("resize",ed),()=>{Z=!1,cancelAnimationFrame(q),window.removeEventListener("resize",ed),f.domElement.removeEventListener("pointermove",eo),f.domElement.removeEventListener("pointerleave",el),O.dispose(),z.dispose(),Q?.dispose(),J?.dispose(),K?.dispose(),X?.dispose(),V?.dispose(),B?.dispose(),f.dispose(),Y.forEach(e=>e()),f.domElement.parentNode===n&&n.removeChild(f.domElement),r&&f.domElement.parentNode===r&&r.removeChild(f.domElement)}},[u,g,i]),w)?r.jsx("div",{className:"flex h-[26rem] items-center justify-center rounded-2xl border border-border bg-card/70",children:(0,r.jsxs)("div",{className:"inline-flex items-center gap-2 text-sm text-muted-foreground",children:[r.jsx(s.Z,{className:"h-4 w-4 animate-spin"}),"Loading NDVI terrain sequence"]})}):y||!u?r.jsx("div",{className:"flex h-[26rem] items-center justify-center rounded-2xl border border-amber-300 bg-amber-50/70 px-4 text-center dark:border-amber-700 dark:bg-amber-950/30",children:(0,r.jsxs)("div",{className:"space-y-2",children:[(0,r.jsxs)("p",{className:"inline-flex items-center gap-2 text-sm font-medium text-amber-900 dark:text-amber-100",children:[r.jsx(c.Z,{className:"h-4 w-4"}),"Hero map currently unavailable"]}),r.jsx("p",{className:"text-xs text-amber-800 dark:text-amber-200",children:y||"Please retry in a moment."})]})}):(0,r.jsxs)("div",{className:"relative",children:[C&&i&&(0,o.createPortal)(r.jsx("div",{ref:t,className:"pointer-events-none fixed inset-0 z-[80] overflow-hidden bg-[#dfe4e8]"}),i),r.jsx("div",{ref:e,className:`h-[28rem] w-full overflow-hidden rounded-2xl border border-cyan-700/30 bg-[#dfe4e8] transition-opacity duration-500 ${C?"opacity-20":"opacity-100"}`}),!C&&(0,r.jsxs)(r.Fragment,{children:[r.jsx("div",{className:"absolute left-3 top-3 rounded-full border border-cyan-400/30 bg-[#081226]/80 px-3 py-1 text-[11px] uppercase tracking-[0.12em] text-cyan-100",children:"interactive"===S?"Interactive":S}),(0,r.jsxs)("div",{className:"absolute right-3 top-3 rounded-full border border-cyan-400/30 bg-[#081226]/80 px-3 py-1 text-[11px] text-cyan-100",children:[u.legend.metric.toUpperCase()," | ",g?.source||u.source]})]}),N&&!C&&(0,r.jsxs)("div",{className:"pointer-events-none absolute z-20 rounded-md border border-cyan-400/50 bg-[#081226]/90 px-2 py-1 text-[11px] text-cyan-100",style:{left:Math.min(N.x+14,(e.current?.clientWidth||0)-120),top:Math.max(8,N.y-26)},children:["NDVI ",N.ndvi.toFixed(3)]}),(0,r.jsxs)("div",{className:"mt-3 rounded-xl border border-border bg-card/70 p-3",children:[(0,r.jsxs)("div",{className:"flex items-center justify-between text-[11px] uppercase tracking-[0.12em] text-muted-foreground",children:[r.jsx("span",{children:"NDVI Legend"}),r.jsx("span",{children:u.legend.unit})]}),r.jsx("div",{className:"mt-2 h-3 w-full overflow-hidden rounded-sm border border-black/15",children:r.jsx("div",{className:"h-full w-full",style:{background:`linear-gradient(90deg, ${A.map(e=>`rgb(${e.color[0]}, ${e.color[1]}, ${e.color[2]})`).join(", ")})`}})}),(0,r.jsxs)("div",{className:"mt-1 flex items-center justify-between text-xs text-muted-foreground",children:[r.jsx("span",{children:u.legend.min.toFixed(3)}),r.jsx("span",{children:u.legend.max.toFixed(3)})]})]})]})}[l,d]=u.then?(await u)():u,n()}catch(e){n(e)}})}};